<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" id="dark-theme">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" id="light-theme">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --text-primary: #333333;
            --text-secondary: #666666; --border-color: #e1e5e9; --accent-color: #6366f1;
            --code-bg: #f8f9fa; --sidebar-bg: #ffffff; --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #0d1117; --bg-secondary: #161b22; --text-primary: #e6edf3;
            --text-secondary: #7d8590; --border-color: #30363d; --accent-color: #58a6ff;
            --code-bg: #161b22; --sidebar-bg: #0d1117; --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.6; 
            background-color: var(--bg-primary); 
            color: var(--text-primary); 
            transition: all 0.3s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .container { 
            display: flex; 
            min-height: 100vh;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        .sidebar { 
            width: 280px; 
            background-color: var(--sidebar-bg); 
            border-right: 1px solid var(--border-color); 
            position: fixed; 
            height: 100vh; 
            overflow-y: auto; 
            box-shadow: var(--shadow); 
            transition: transform 0.3s ease; 
            z-index: 200;
        }
        
        .main-content { 
            flex: 1; 
            margin-left: 280px; 
            transition: margin-left 0.3s ease;
            width: calc(100% - 280px);
            max-width: calc(100vw - 280px);
            overflow-x: hidden;
        }
        
        .header { 
            background-color: var(--sidebar-bg); 
            border-bottom: 1px solid var(--border-color); 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: var(--shadow);
        }
        
        .theme-toggle { 
            background: none; 
            border: 2px solid var(--border-color); 
            padding: 0.5rem 1rem; 
            border-radius: 6px; 
            cursor: pointer; 
            color: var(--text-primary); 
            font-size: 0.9rem; 
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .theme-toggle:hover { background-color: var(--bg-secondary); }
        
        .mobile-menu-btn { 
            display: none; 
            background: none; 
            border: 2px solid var(--border-color); 
            padding: 0.5rem; 
            border-radius: 6px; 
            cursor: pointer; 
            color: var(--text-primary); 
            font-size: 1.2rem; 
            transition: all 0.2s ease;
        }
        .mobile-menu-btn:hover { background-color: var(--bg-secondary); }
        
        .mobile-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 150; 
            opacity: 0; 
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .mobile-overlay.active { 
            opacity: 1; 
            pointer-events: auto;
        }
        
        .content { 
            padding: 2rem; 
            max-width: 1200px; 
            margin: 0 auto;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        h1 { 
            font-size: clamp(1.8rem, 4vw, 2.5rem); 
            margin-bottom: 1rem; 
            color: var(--text-primary); 
            border-bottom: 3px solid var(--accent-color); 
            padding-bottom: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        h2 { 
            font-size: clamp(1.4rem, 3vw, 2rem); 
            margin: 2rem 0 1rem 0; 
            color: var(--text-primary); 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .h2-link{
            font-weight:700;
        }
        
        h3 { 
            font-size: clamp(1.2rem, 2.5vw, 1.5rem); 
            margin: 1.5rem 0 1rem 0; 
            color: var(--accent-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        p { 
            margin-bottom: 1rem; 
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }
        
        .code-container { 
            position: relative; 
            margin: 1.5rem 0; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: var(--shadow);
            max-width: 100%;
        }
        
        .code-header { 
            background-color: var(--bg-secondary); 
            padding: 0.75rem 1rem; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .copy-btn { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 0.4rem 0.8rem; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.8rem;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        .copy-btn:hover { opacity: 0.9; }
        
        pre[class*="language-"] { 
            margin: 0 !important; 
            padding: 1rem !important;
            background: var(--code-bg) !important;
            border: none !important;
            border-radius: 0 !important;
            font-size: clamp(0.75rem, 2vw, 0.9rem) !important;
            line-height: 1.5 !important;
            overflow-x: auto !important;
            overflow-y: hidden !important;
            white-space: pre !important;
            word-wrap: normal !important;
            max-width: 100% !important;
            -webkit-overflow-scrolling: touch !important;
            scrollbar-width: thin !important;
            scrollbar-color: var(--accent-color) transparent !important;
        }
        
        pre[class*="language-"]::-webkit-scrollbar {
            height: 12px !important;
        }
        
        pre[class*="language-"]::-webkit-scrollbar-track {
            background: var(--bg-secondary) !important;
            border-radius: 6px !important;
        }
        
        pre[class*="language-"]::-webkit-scrollbar-thumb {
            background: var(--accent-color) !important;
            border-radius: 6px !important;
        }
        
        pre[class*="language-"]::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary) !important;
        }
        
        code[class*="language-"] { 
            background: transparent !important;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace !important;
            font-size: inherit !important;
            color: inherit !important;
            white-space: pre !important;
            word-wrap: normal !important;
            display: inline-block !important;
            min-width: max-content !important;
            width: auto !important;
        }
        
        [data-theme="dark"] .token.comment, [data-theme="dark"] .token.prolog, [data-theme="dark"] .token.doctype, [data-theme="dark"] .token.cdata { color: #7d8590 !important; font-style: italic !important; }
        [data-theme="dark"] .token.punctuation { color: #e6edf3 !important; }
        [data-theme="dark"] .token.property, [data-theme="dark"] .token.tag, [data-theme="dark"] .token.boolean, [data-theme="dark"] .token.number, [data-theme="dark"] .token.constant, .token.symbol, .token.deleted { color: #ff7b72 !important; }
        [data-theme="dark"] .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a5d6ff !important; }
        [data-theme="dark"] .token.operator, [data-theme="dark"] .token.entity, [data-theme="dark"] .token.url, .language-css .token.string, .style .token.string { color: #79c0ff !important; }
        [data-theme="dark"] .token.atrule, [data-theme="dark"] .token.attr-value, [data-theme="dark"] .token.keyword { color: #ff7b72 !important; }
        [data-theme="dark"] .token.function, [data-theme="dark"] .token.class-name { color: #d2a8ff !important; }
        [data-theme="dark"] .token.regex, [data-theme="dark"] .token.important, [data-theme="dark"] .token.variable { color: #ffa657 !important; }
        
        [data-theme="light"] .token.comment, [data-theme="light"] .token.prolog, [data-theme="light"] .token.doctype, [data-theme="light"] .token.cdata { color: #6a737d !important; }
        [data-theme="light"] .token.punctuation { color: #24292e !important; }
        [data-theme="light"] .token.property, .token.tag, .token.boolean, .token.number, .token.constant, .token.symbol, .token.deleted { color: #d73a49 !important; }
        [data-theme="light"] .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #032f62 !important; }
        [data-theme="light"] .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #24292e !important; }
        [data-theme="light"] .token.atrule, .token.attr-value, .token.keyword { color: #d73a49 !important; }
        [data-theme="light"] .token.function, .token.class-name { color: #6f42c1 !important; }
        [data-theme="light"] .token.regex, [data-theme="light"] .token.important, [data-theme="light"] .token.variable { color: #e36209 !important; }
        
        .toc { padding: 1rem; }
        .toc ul { list-style: none; }
        .toc li { margin: 0.5rem 0; }
        .toc a { 
            color: var(--text-secondary); 
            text-decoration: none; 
            display: block; 
            padding: 0.5rem; 
            border-radius: 6px; 
            transition: all 0.2s ease; 
            font-size: 0.9rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .toc a.active {
            color: blue !important;
             background-color: #5ec7ff2a;
}


        .toc a:hover { background-color: #0077ff16}
        
        @media (max-width: 767px) { 
            .sidebar { 
                transform: translateX(-100%);
                width: 85vw;
                max-width: 320px;
            }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { 
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
                overflow-x: auto;
            }
            .mobile-menu-btn { display: block; }
            .mobile-overlay { display: block; }
            .header { 
                padding: 0.75rem 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .content { 
                padding: 1rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .theme-toggle {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            .code-header {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            .copy-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.7rem;
            }
            pre[class*="language-"] {
                padding: 0.75rem !important;
                font-size: 0.75rem !important;
            }
            pre[class*="language-"]::-webkit-scrollbar {
                height: 10px !important;
            }
            .toc {
                padding: 0.75rem;
            }
            .toc a {
                font-size: 0.8rem;
                padding: 0.4rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.3rem; }
            h3 { font-size: 1.1rem; }
            .content { padding: 0.75rem; }
            .header { padding: 0.5rem; }
            .sidebar { width: 90vw; }
            pre[class*="language-"] {
                font-size: 0.7rem !important;
                padding: 0.5rem !important;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="toc">
                <h3 style="padding: 0.5rem; color: var(--text-primary);">Table of Contents</h3>
                <ul id="toc-list"></ul>
            </div>
        </nav>
        <main class="main-content">
            <header class="header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-menu-btn" id="mobile-menu-btn">â˜°</button>
                    <h2 style="margin: 0; color: var(--text-primary);">Documentation</h2>
                </div>
                <button class="theme-toggle" id="theme-toggle">ðŸŒ™ Dark Mode</button>
            </header>
            <div class="content" id="content">
<h2 id="-fundamentals-20-questions-">**Fundamentals (20 Questions)**</h2>

<h3 id="131-what-is-express-js-and-why-is-it-used-">131. What is Express.js and why is it used?</h3>

<p><strong>Answer:</strong> Express.js is a minimal, fast, and flexible Node.js web application framework that provides a robust set of features for web and mobile applications. It's built on top of Node.js and simplifies server-side development.</p>

<p><strong>Why it's used:</strong></p>

<p>- <strong>Simplicity</strong>: Minimal setup required to create web servers</p>
<p>- <strong>Middleware Support</strong>: Extensive middleware ecosystem</p>
<p>- <strong>Routing</strong>: Powerful routing capabilities</p>
<p>- <strong>Template Engine Support</strong>: Works with various template engines</p>
<p>- <strong>Performance</strong>: Fast and lightweight</p>
<p>- <strong>Community</strong>: Large community and extensive documentation</p>


<p><strong>Example Use Cases:</strong></p>

<p>- RESTful APIs</p>
<p>- Web applications</p>
<p>- Single Page Applications (SPAs)</p>
<p>- Microservices</p>
<p>- Real-time applications</p>


<h3 id="132-how-do-you-create-a-basic-express-server-">132. How do you create a basic Express server?</h3>

<p><strong>Answer:</strong> A basic Express server requires installing Express, creating an app instance, defining routes, and starting the server.</p>

<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20express%20%3D%20require('express')%3B%0Aconst%20app%20%3D%20express()%3B%0Aconst%20PORT%20%3D%203000%3B%0A%0A%2F%2F%20Basic%20route%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.send('Hello%20World!')%3B%0A%7D)%3B%0A%0A%2F%2F%20Start%20server%0Aapp.listen(PORT%2C%20()%20%3D%3E%20%7B%0A%20%20console.log(%60Server%20running%20on%20port%20%24%7BPORT%7D%60)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const express = require('express');
const app = express();
const PORT = 3000;

// Basic route
app.get('/', (req, res) =&gt; {
  res.send('Hello World!');
});

// Start server
app.listen(PORT, () =&gt; {
  console.log(`Server running on port ${PORT}`);
});
</code></pre>
</div>

<p><strong>Key Components:</strong></p>

<p>- `express()`: Creates Express application</p>
<p>- `app.get()`: Defines GET route</p>
<p>- `app.listen()`: Starts server on specified port</p>


<h3 id="133-what-is-middleware-in-express-js-">133. What is middleware in Express.js?</h3>

<p><strong>Answer:</strong> Middleware functions are functions that execute during the request-response cycle. They have access to request object (req), response object (res), and the next middleware function (next).</p>

<p><strong>Types of Middleware:</strong></p>

<p>- <strong>Application-level</strong>: Bound to app instance</p>
<p>- <strong>Router-level</strong>: Bound to router instance</p>
<p>- <strong>Error-handling</strong>: Handles errors</p>
<p>- <strong>Built-in</strong>: Express built-in middleware</p>
<p>- <strong>Third-party</strong>: External middleware packages</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Custom%20middleware%0Aconst%20logger%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20console.log(%60%24%7Breq.method%7D%20%24%7Breq.url%7D%20-%20%24%7Bnew%20Date().toISOString()%7D%60)%3B%0A%20%20next()%3B%20%2F%2F%20Pass%20control%20to%20next%20middleware%0A%7D%3B%0A%0Aapp.use(logger)%3B%20%2F%2F%20Application-level%20middleware%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Custom middleware
const logger = (req, res, next) =&gt; {
  console.log(`${req.method} ${req.url} - ${new Date().toISOString()}`);
  next(); // Pass control to next middleware
};

app.use(logger); // Application-level middleware
</code></pre>
</div>

<h3 id="134-how-does-the-middleware-stack-work-">134. How does the middleware stack work?</h3>

<p><strong>Answer:</strong> Express executes middleware functions in the order they are defined. Each middleware can modify req/res objects and must call `next()` to pass control to the next middleware.</p>

<p><strong>Execution Flow:</strong></p>

<p>1. Request comes in</p>
<p>2. First middleware executes</p>
<p>3. Calls `next()` to continue</p>
<p>4. Next middleware executes</p>
<p>5. Process continues until response is sent</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Middleware%20stack%20example%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20console.log('First%20middleware')%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20console.log('Second%20middleware')%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20console.log('Route%20handler')%3B%0A%20%20res.send('Response')%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Middleware stack example
app.use((req, res, next) =&gt; {
  console.log('First middleware');
  next();
});

app.use((req, res, next) =&gt; {
  console.log('Second middleware');
  next();
});

app.get('/', (req, res) =&gt; {
  console.log('Route handler');
  res.send('Response');
});
</code></pre>
</div>

<h3 id="135-what-is-the-difference-between-app-use-and-app-get-">135. What is the difference between `app.use()`and `app.get()`?</h3>

<p><strong>Answer:</strong></p>

<p><strong>`app.use()`:</strong></p>

<p>- Mounts middleware functions</p>
<p>- Executes for all HTTP methods</p>
<p>- Can be used without path (applies to all routes)</p>
<p>- Used for middleware that should run on multiple routes</p>


<p><strong>`app.get()`:</strong></p>

<p>- Defines route handler for GET requests only</p>
<p>- Specific to GET HTTP method</p>
<p>- Always requires a path</p>
<p>- Used for handling specific GET requests</p>


<p><strong>Examples:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20app.use()%20-%20runs%20for%20all%20methods%20and%20paths%20starting%20with%20%2Fapi%0Aapp.use('%2Fapi'%2C%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20console.log('API%20middleware')%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20app.get()%20-%20only%20for%20GET%20requests%20to%20%2Fusers%0Aapp.get('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20users%3A%20%5B%5D%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// app.use() - runs for all methods and paths starting with /api
app.use('/api', (req, res, next) =&gt; {
  console.log('API middleware');
  next();
});

// app.get() - only for GET requests to /users
app.get('/users', (req, res) =&gt; {
  res.json({ users: [] });
});
</code></pre>
</div>

<h3 id="136-what-are-route-parameters-vs-query-parameters-">136. What are route parameters vs query parameters?</h3>

<p><strong>Answer:</strong></p>

<p><strong>Route Parameters:</strong></p>

<p>- Part of the URL path</p>
<p>- Defined with colon syntax (:param)</p>
<p>- Accessed via `req.params`</p>
<p>- Used for resource identification</p>


<p><strong>Query Parameters:</strong></p>

<p>- Come after ? in URL</p>
<p>- Key-value pairs separated by &</p>
<p>- Accessed via `req.query`</p>
<p>- Used for filtering, sorting, pagination</p>


<p><strong>Examples:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Route%20parameters%3A%20%2Fusers%2F123%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20userId%20%3D%20req.params.id%3B%20%2F%2F%20%22123%22%0A%20%20res.json(%7B%20userId%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Query%20parameters%3A%20%2Fsearch%3Fname%3Djohn%26age%3D25%0Aapp.get('%2Fsearch'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20%7B%20name%2C%20age%20%7D%20%3D%20req.query%3B%20%2F%2F%20%7B%20name%3A%20%22john%22%2C%20age%3A%20%2225%22%20%7D%0A%20%20res.json(%7B%20name%2C%20age%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Route parameters: /users/123
app.get('/users/:id', (req, res) =&gt; {
  const userId = req.params.id; // "123"
  res.json({ userId });
});

// Query parameters: /search?name=john&age=25
app.get('/search', (req, res) =&gt; {
  const { name, age } = req.query; // { name: "john", age: "25" }
  res.json({ name, age });
});
</code></pre>
</div>

<h3 id="137-how-do-you-handle-different-http-methods-in-express-">137. How do you handle different HTTP methods in Express?</h3>

<p><strong>Answer:</strong> Express provides methods for all standard HTTP verbs. Each method corresponds to an HTTP verb and defines how to handle requests.</p>

<p><strong>Common HTTP Methods:</strong></p>

<p>- `app.get()` - GET requests</p>
<p>- `app.post()` - POST requests</p>
<p>- `app.put()` - PUT requests</p>
<p>- `app.patch()` - PATCH requests</p>
<p>- `app.delete()` - DELETE requests</p>
<p>- `app.all()` - All HTTP methods</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Different%20HTTP%20methods%20for%20same%20route%0Aapp.get('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Get%20all%20users'%20%7D)%3B%0A%7D)%3B%0A%0Aapp.post('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Create%20user'%20%7D)%3B%0A%7D)%3B%0A%0Aapp.put('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20%60Update%20user%20%24%7Breq.params.id%7D%60%20%7D)%3B%0A%7D)%3B%0A%0Aapp.delete('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20%60Delete%20user%20%24%7Breq.params.id%7D%60%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Different HTTP methods for same route
app.get('/users', (req, res) =&gt; {
  res.json({ message: 'Get all users' });
});

app.post('/users', (req, res) =&gt; {
  res.json({ message: 'Create user' });
});

app.put('/users/:id', (req, res) =&gt; {
  res.json({ message: `Update user ${req.params.id}` });
});

app.delete('/users/:id', (req, res) =&gt; {
  res.json({ message: `Delete user ${req.params.id}` });
});
</code></pre>
</div>

<h3 id="138-what-is-the-purpose-of-the-next-function-">138. What is the purpose of the `next()`function?</h3>

<p><strong>Answer:</strong> The `next()` function passes control to the next middleware function in the stack. It's crucial for middleware chaining and error handling.</p>

<p><strong>Usage Scenarios:</strong></p>

<p>- <strong>`next()`</strong>: Continue to next middleware</p>
<p>- <strong>`next(error)`</strong>: Skip to error handling middleware</p>
<p>- <strong>No `next()` call</strong>: Stops middleware chain (must send response)</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Authentication%20middleware%0Aconst%20authenticate%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20token%20%3D%20req.headers.authorization%3B%0A%20%20%0A%20%20if%20(!token)%20%7B%0A%20%20%20%20return%20next(new%20Error('No%20token%20provided'))%3B%20%2F%2F%20Error%20handling%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Verify%20token%20logic%20here%0A%20%20req.user%20%3D%20%7B%20id%3A%201%2C%20name%3A%20'John'%20%7D%3B%0A%20%20next()%3B%20%2F%2F%20Continue%20to%20next%20middleware%0A%7D%3B%0A%0Aapp.use('%2Fprotected'%2C%20authenticate)%3B%0A%0Aapp.get('%2Fprotected%2Fdata'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20data%3A%20'Protected%20data'%2C%20user%3A%20req.user%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Authentication middleware
const authenticate = (req, res, next) =&gt; {
  const token = req.headers.authorization;
  
  if (!token) {
    return next(new Error('No token provided')); // Error handling
  }
  
  // Verify token logic here
  req.user = { id: 1, name: 'John' };
  next(); // Continue to next middleware
};

app.use('/protected', authenticate);

app.get('/protected/data', (req, res) =&gt; {
  res.json({ data: 'Protected data', user: req.user });
});
</code></pre>
</div>

<h3 id="139-how-do-you-implement-nested-routing-in-express-">139. How do you implement nested routing in Express?</h3>

<p><strong>Answer:</strong> Nested routing allows organizing routes hierarchically using Express Router. You can mount routers on specific paths to create nested route structures.</p>

<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20express%20%3D%20require('express')%3B%0Aconst%20app%20%3D%20express()%3B%0A%0A%2F%2F%20Create%20routers%0Aconst%20userRouter%20%3D%20express.Router()%3B%0Aconst%20adminRouter%20%3D%20express.Router()%3B%0A%0A%2F%2F%20User%20routes%0AuserRouter.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'All%20users'%20%7D)%3B%0A%7D)%3B%0A%0AuserRouter.get('%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20%60User%20%24%7Breq.params.id%7D%60%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Admin%20routes%0AadminRouter.get('%2Fdashboard'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Admin%20dashboard'%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Mount%20routers%0Aapp.use('%2Fapi%2Fusers'%2C%20userRouter)%3B%20%2F%2F%20%2Fapi%2Fusers%2C%20%2Fapi%2Fusers%2F%3Aid%0Aapp.use('%2Fapi%2Fadmin'%2C%20adminRouter)%3B%20%2F%2F%20%2Fapi%2Fadmin%2Fdashboard%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const express = require('express');
const app = express();

// Create routers
const userRouter = express.Router();
const adminRouter = express.Router();

// User routes
userRouter.get('/', (req, res) =&gt; {
  res.json({ message: 'All users' });
});

userRouter.get('/:id', (req, res) =&gt; {
  res.json({ message: `User ${req.params.id}` });
});

// Admin routes
adminRouter.get('/dashboard', (req, res) =&gt; {
  res.json({ message: 'Admin dashboard' });
});

// Mount routers
app.use('/api/users', userRouter); // /api/users, /api/users/:id
app.use('/api/admin', adminRouter); // /api/admin/dashboard
</code></pre>
</div>

<h3 id="140-what-are-express-routers-and-how-do-you-use-them-">140. What are Express routers and how do you use them?</h3>

<p><strong>Answer:</strong> Express Router is a mini Express application that provides routing functionality. It helps organize routes into separate modules and enables modular, mountable route handlers.</p>

<p><strong>Benefits:</strong></p>

<p>- <strong>Modularity</strong>: Separate route logic</p>
<p>- <strong>Organization</strong>: Group related routes</p>
<p>- <strong>Reusability</strong>: Use same router in multiple places</p>
<p>- <strong>Middleware</strong>: Apply middleware to specific route groups</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20routes%2Fusers.js%0Aconst%20express%20%3D%20require('express')%3B%0Aconst%20router%20%3D%20express.Router()%3B%0A%0A%2F%2F%20Middleware%20specific%20to%20this%20router%0Arouter.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20console.log('User%20router%20middleware')%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0Arouter.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20users%3A%20%5B%5D%20%7D)%3B%0A%7D)%3B%0A%0Arouter.post('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'User%20created'%20%7D)%3B%0A%7D)%3B%0A%0Amodule.exports%20%3D%20router%3B%0A%0A%2F%2F%20app.js%0Aconst%20userRoutes%20%3D%20require('.%2Froutes%2Fusers')%3B%0Aapp.use('%2Fusers'%2C%20userRoutes)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// routes/users.js
const express = require('express');
const router = express.Router();

// Middleware specific to this router
router.use((req, res, next) =&gt; {
  console.log('User router middleware');
  next();
});

router.get('/', (req, res) =&gt; {
  res.json({ users: [] });
});

router.post('/', (req, res) =&gt; {
  res.json({ message: 'User created' });
});

module.exports = router;

// app.js
const userRoutes = require('./routes/users');
app.use('/users', userRoutes);
</code></pre>
</div>

<h3 id="141-how-do-you-serve-static-files-in-express-">141. How do you serve static files in Express?</h3>

<p><strong>Answer:</strong> Express provides `express.static()` built-in middleware to serve static files like images, CSS, JavaScript files, etc.</p>

<p><strong>Basic Usage:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Serve%20files%20from%20'public'%20directory%0Aapp.use(express.static('public'))%3B%0A%0A%2F%2F%20Files%20accessible%20at%3A%0A%2F%2F%20http%3A%2F%2Flocalhost%3A3000%2Fimages%2Flogo.png%0A%2F%2F%20http%3A%2F%2Flocalhost%3A3000%2Fcss%2Fstyle.css%0A%2F%2F%20http%3A%2F%2Flocalhost%3A3000%2Fjs%2Fapp.js%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Serve files from 'public' directory
app.use(express.static('public'));

// Files accessible at:
// http://localhost:3000/images/logo.png
// http://localhost:3000/css/style.css
// http://localhost:3000/js/app.js
</code></pre>
</div>

<p><strong>Advanced Usage:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Serve%20with%20virtual%20path%20prefix%0Aapp.use('%2Fstatic'%2C%20express.static('public'))%3B%0A%2F%2F%20Now%3A%20http%3A%2F%2Flocalhost%3A3000%2Fstatic%2Fimages%2Flogo.png%0A%0A%2F%2F%20Multiple%20static%20directories%0Aapp.use(express.static('public'))%3B%0Aapp.use(express.static('files'))%3B%0A%0A%2F%2F%20With%20options%0Aapp.use(express.static('public'%2C%20%7B%0A%20%20maxAge%3A%20'1d'%2C%20%2F%2F%20Cache%20for%201%20day%0A%20%20etag%3A%20false%2C%20%20%2F%2F%20Disable%20etag%0A%20%20index%3A%20false%20%20%2F%2F%20Disable%20directory%20indexing%0A%7D))%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Serve with virtual path prefix
app.use('/static', express.static('public'));
// Now: http://localhost:3000/static/images/logo.png

// Multiple static directories
app.use(express.static('public'));
app.use(express.static('files'));

// With options
app.use(express.static('public', {
  maxAge: '1d', // Cache for 1 day
  etag: false,  // Disable etag
  index: false  // Disable directory indexing
}));
</code></pre>
</div>

<h3 id="142-what-is-the-purpose-of-express-json-and-express-urlencoded-">142. What is the purpose of `express.json()`and `express.urlencoded()`?</h3>

<p><strong>Answer:</strong> These are built-in middleware functions for parsing incoming request bodies.</p>

<p><strong>`express.json()`:</strong></p>

<p>- Parses JSON payloads</p>
<p>- Populates `req.body` with parsed JSON</p>
<p>- Sets Content-Type to application/json</p>


<p><strong>`express.urlencoded()`:</strong></p>

<p>- Parses URL-encoded payloads (form data)</p>
<p>- Populates `req.body` with parsed data</p>
<p>- Sets Content-Type to application/x-www-form-urlencoded</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Parse%20JSON%20bodies%0Aapp.use(express.json())%3B%0A%0A%2F%2F%20Parse%20URL-encoded%20bodies%0Aapp.use(express.urlencoded(%7B%20extended%3A%20true%20%7D))%3B%0A%0Aapp.post('%2Fdata'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20console.log(req.body)%3B%20%2F%2F%20Parsed%20request%20body%0A%20%20res.json(%7B%20received%3A%20req.body%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20JSON%20request%3A%20%7B%22name%22%3A%20%22John%22%2C%20%22age%22%3A%2030%7D%0A%2F%2F%20Form%20request%3A%20name%3DJohn%26age%3D30%0A%2F%2F%20Both%20populate%20req.body%20appropriately%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Parse JSON bodies
app.use(express.json());

// Parse URL-encoded bodies
app.use(express.urlencoded({ extended: true }));

app.post('/data', (req, res) =&gt; {
  console.log(req.body); // Parsed request body
  res.json({ received: req.body });
});

// JSON request: {"name": "John", "age": 30}
// Form request: name=John&age=30
// Both populate req.body appropriately
</code></pre>
</div>

<h3 id="143-how-do-you-set-and-get-response-headers-">143. How do you set and get response headers?</h3>

<p><strong>Answer:</strong> Express provides methods to manipulate HTTP response headers.</p>

<p><strong>Setting Headers:</strong></p>

<p>- `res.set()` or `res.header()`: Set single or multiple headers</p>
<p>- `res.type()`: Set Content-Type</p>
<p>- `res.status()`: Set status code</p>


<p><strong>Getting Headers:</strong></p>

<p>- `req.get()` or `req.header()`: Get request headers</p>
<p>- `res.get()`: Get response headers</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="app.get('%2Fheaders'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Get%20request%20headers%0A%20%20const%20userAgent%20%3D%20req.get('User-Agent')%3B%0A%20%20const%20contentType%20%3D%20req.header('Content-Type')%3B%0A%20%20%0A%20%20%2F%2F%20Set%20response%20headers%0A%20%20res.set('X-Custom-Header'%2C%20'MyValue')%3B%0A%20%20res.set(%7B%0A%20%20%20%20'X-Powered-By'%3A%20'Express'%2C%0A%20%20%20%20'Cache-Control'%3A%20'no-cache'%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Set%20content%20type%0A%20%20res.type('json')%3B%0A%20%20%0A%20%20%2F%2F%20Set%20status%20and%20send%20response%0A%20%20res.status(200).json(%7B%0A%20%20%20%20userAgent%2C%0A%20%20%20%20contentType%2C%0A%20%20%20%20customHeader%3A%20res.get('X-Custom-Header')%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">app.get('/headers', (req, res) =&gt; {
  // Get request headers
  const userAgent = req.get('User-Agent');
  const contentType = req.header('Content-Type');
  
  // Set response headers
  res.set('X-Custom-Header', 'MyValue');
  res.set({
    'X-Powered-By': 'Express',
    'Cache-Control': 'no-cache'
  });
  
  // Set content type
  res.type('json');
  
  // Set status and send response
  res.status(200).json({
    userAgent,
    contentType,
    customHeader: res.get('X-Custom-Header')
  });
});
</code></pre>
</div>

<h3 id="144-what-is-res-locals-used-for-">144. What is `res.locals`used for?</h3>

<p><strong>Answer:</strong> `res.locals` is an object that contains response local variables scoped to the request. It's useful for passing data between middleware and making data available to templates.</p>

<p><strong>Use Cases:</strong></p>

<p>- Pass data to template engines</p>
<p>- Share data between middleware</p>
<p>- Store request-specific information</p>
<p>- Avoid polluting global scope</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Middleware%20to%20set%20user%20info%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20res.locals.user%20%3D%20req.user%20%7C%7C%20null%3B%0A%20%20res.locals.currentYear%20%3D%20new%20Date().getFullYear()%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Another%20middleware%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20res.locals.isAuthenticated%20%3D%20!!res.locals.user%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0Aapp.get('%2Fprofile'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20res.locals%20is%20available%20in%20templates%0A%20%20res.render('profile'%2C%20%7B%0A%20%20%20%20title%3A%20'Profile%20Page'%0A%20%20%20%20%2F%2F%20res.locals.user%2C%20res.locals.currentYear%20automatically%20available%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Middleware to set user info
app.use((req, res, next) =&gt; {
  res.locals.user = req.user || null;
  res.locals.currentYear = new Date().getFullYear();
  next();
});

// Another middleware
app.use((req, res, next) =&gt; {
  res.locals.isAuthenticated = !!res.locals.user;
  next();
});

app.get('/profile', (req, res) =&gt; {
  // res.locals is available in templates
  res.render('profile', {
    title: 'Profile Page'
    // res.locals.user, res.locals.currentYear automatically available
  });
});
</code></pre>
</div>

<h3 id="145-how-do-you-handle-cookies-in-express-">145. How do you handle cookies in Express?</h3>

<p><strong>Answer:</strong> Express handles cookies through `req.cookies` (reading) and `res.cookie()` (setting). The `cookie-parser` middleware is commonly used for enhanced cookie handling.</p>

<p><strong>Basic Cookie Handling:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20cookieParser%20%3D%20require('cookie-parser')%3B%0Aapp.use(cookieParser())%3B%0A%0Aapp.get('%2Fset-cookie'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Set%20cookie%0A%20%20res.cookie('username'%2C%20'john'%2C%20%7B%0A%20%20%20%20maxAge%3A%2024%20*%2060%20*%2060%20*%201000%2C%20%2F%2F%2024%20hours%0A%20%20%20%20httpOnly%3A%20true%2C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20Prevent%20XSS%0A%20%20%20%20secure%3A%20true%2C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20HTTPS%20only%0A%20%20%20%20sameSite%3A%20'strict'%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20CSRF%20protection%0A%20%20%7D)%3B%0A%20%20%0A%20%20res.send('Cookie%20set')%3B%0A%7D)%3B%0A%0Aapp.get('%2Fget-cookie'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Get%20cookie%0A%20%20const%20username%20%3D%20req.cookies.username%3B%0A%20%20res.json(%7B%20username%20%7D)%3B%0A%7D)%3B%0A%0Aapp.get('%2Fclear-cookie'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Clear%20cookie%0A%20%20res.clearCookie('username')%3B%0A%20%20res.send('Cookie%20cleared')%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const cookieParser = require('cookie-parser');
app.use(cookieParser());

app.get('/set-cookie', (req, res) =&gt; {
  // Set cookie
  res.cookie('username', 'john', {
    maxAge: 24 * 60 * 60 * 1000, // 24 hours
    httpOnly: true,               // Prevent XSS
    secure: true,                 // HTTPS only
    sameSite: 'strict'           // CSRF protection
  });
  
  res.send('Cookie set');
});

app.get('/get-cookie', (req, res) =&gt; {
  // Get cookie
  const username = req.cookies.username;
  res.json({ username });
});

app.get('/clear-cookie', (req, res) =&gt; {
  // Clear cookie
  res.clearCookie('username');
  res.send('Cookie cleared');
});
</code></pre>
</div>

<h3 id="146-what-are-template-engines-and-how-do-you-use-them-">146. What are template engines and how do you use them?</h3>

<p><strong>Answer:</strong> Template engines allow you to use static template files with dynamic data. They replace variables in template files with actual values at runtime.</p>

<p><strong>Popular Template Engines:</strong></p>

<p>- <strong>EJS</strong>: Embedded JavaScript</p>
<p>- <strong>Handlebars</strong>: Logic-less templates</p>
<p>- <strong>Pug</strong>: Clean, whitespace-sensitive syntax</p>
<p>- <strong>Mustache</strong>: Logic-less templates</p>


<p><strong>Example with EJS:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Set%20template%20engine%0Aapp.set('view%20engine'%2C%20'ejs')%3B%0Aapp.set('views'%2C%20'.%2Fviews')%3B%0A%0A%2F%2F%20Route%20using%20template%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20user%20%3D%20%7B%0A%20%20%20%20id%3A%20req.params.id%2C%0A%20%20%20%20name%3A%20'John%20Doe'%2C%0A%20%20%20%20email%3A%20'john%40example.com'%0A%20%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20Render%20template%20with%20data%0A%20%20res.render('user'%2C%20%7B%20%0A%20%20%20%20user%2C%0A%20%20%20%20title%3A%20'User%20Profile'%2C%0A%20%20%20%20currentYear%3A%20new%20Date().getFullYear()%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Set template engine
app.set('view engine', 'ejs');
app.set('views', './views');

// Route using template
app.get('/users/:id', (req, res) =&gt; {
  const user = {
    id: req.params.id,
    name: 'John Doe',
    email: 'john@example.com'
  };
  
  // Render template with data
  res.render('user', { 
    user,
    title: 'User Profile',
    currentYear: new Date().getFullYear()
  });
});
</code></pre>
</div>

<p><strong>Template file (views/user.ejs):</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">html</span>
        <button class="copy-btn" data-code="%3C!DOCTYPE%20html%3E%0A%3Chtml%3E%0A%3Chead%3E%0A%20%20%3Ctitle%3E%3C%25%3D%20title%20%25%3E%3C%2Ftitle%3E%0A%3C%2Fhead%3E%0A%3Cbody%3E%0A%20%20%3Ch1%3EUser%20Profile%3C%2Fh1%3E%0A%20%20%3Cp%3EName%3A%20%3C%25%3D%20user.name%20%25%3E%3C%2Fp%3E%0A%20%20%3Cp%3EEmail%3A%20%3C%25%3D%20user.email%20%25%3E%3C%2Fp%3E%0A%20%20%3Cfooter%3E%26copy%3B%20%3C%25%3D%20currentYear%20%25%3E%3C%2Ffooter%3E%0A%3C%2Fbody%3E%0A%3C%2Fhtml%3E%0A">Copy</button>
    </div>
    <pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;User Profile&lt;/h1&gt;
  &lt;p&gt;Name: &lt;%= user.name %&gt;&lt;/p&gt;
  &lt;p&gt;Email: &lt;%= user.email %&gt;&lt;/p&gt;
  &lt;footer&gt;&copy; &lt;%= currentYear %&gt;&lt;/footer&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
</div>

<h3 id="147-how-do-you-implement-route-chaining-">147. How do you implement route chaining?</h3>

<p><strong>Answer:</strong> Route chaining allows you to define multiple handlers for the same route, enabling modular and reusable middleware patterns.</p>

<p><strong>Methods:</strong></p>

<p>- Multiple callback functions</p>
<p>- Array of functions</p>
<p>- Combination of both</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Multiple%20callback%20functions%0Aapp.get('%2Fusers%2F%3Aid'%2C%20%0A%20%20%2F%2F%20Validation%20middleware%0A%20%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20if%20(!req.params.id.match(%2F%5E%5Cd%2B%24%2F))%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Invalid%20ID'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20next()%3B%0A%20%20%7D%2C%0A%20%20%2F%2F%20Authentication%20middleware%0A%20%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Check%20authentication%0A%20%20%20%20if%20(!req.headers.authorization)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Unauthorized'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20next()%3B%0A%20%20%7D%2C%0A%20%20%2F%2F%20Main%20handler%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20res.json(%7B%20user%3A%20%7B%20id%3A%20req.params.id%20%7D%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0A%2F%2F%20Array%20of%20functions%0Aconst%20validate%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%20%2F*%20validation%20*%2F%20next()%3B%20%7D%3B%0Aconst%20authenticate%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%20%2F*%20auth%20*%2F%20next()%3B%20%7D%3B%0Aconst%20getUser%20%3D%20(req%2C%20res)%20%3D%3E%20%7B%20%2F*%20get%20user%20*%2F%20%7D%3B%0A%0Aapp.get('%2Fusers%2F%3Aid'%2C%20%5Bvalidate%2C%20authenticate%2C%20getUser%5D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Multiple callback functions
app.get('/users/:id', 
  // Validation middleware
  (req, res, next) =&gt; {
    if (!req.params.id.match(/^\d+$/)) {
      return res.status(400).json({ error: 'Invalid ID' });
    }
    next();
  },
  // Authentication middleware
  (req, res, next) =&gt; {
    // Check authentication
    if (!req.headers.authorization) {
      return res.status(401).json({ error: 'Unauthorized' });
    }
    next();
  },
  // Main handler
  (req, res) =&gt; {
    res.json({ user: { id: req.params.id } });
  }
);

// Array of functions
const validate = (req, res, next) =&gt; { /* validation */ next(); };
const authenticate = (req, res, next) =&gt; { /* auth */ next(); };
const getUser = (req, res) =&gt; { /* get user */ };

app.get('/users/:id', [validate, authenticate, getUser]);
</code></pre>
</div>

<h3 id="148-what-is-the-significance-of-app-all-">148. What is the significance of `app.all()`?</h3>

<p><strong>Answer:</strong> `app.all()` matches all HTTP methods for a specified path. It's useful for applying middleware or handling logic that should run regardless of the HTTP method.</p>

<p><strong>Use Cases:</strong></p>

<p>- Apply middleware to all methods</p>
<p>- Handle preflight requests</p>
<p>- Implement method-agnostic logic</p>
<p>- Set up CORS headers</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Apply%20to%20all%20HTTP%20methods%0Aapp.all('%2Fapi%2F*'%2C%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20console.log(%60%24%7Breq.method%7D%20request%20to%20%24%7Breq.path%7D%60)%3B%0A%20%20res.header('Access-Control-Allow-Origin'%2C%20'*')%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Handle%20all%20methods%20for%20specific%20route%0Aapp.all('%2Fstatus'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%0A%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20status%3A%20'Server%20is%20running'%2C%0A%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Wildcard%20matching%0Aapp.all('*'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.status(404).json(%7B%20error%3A%20'Route%20not%20found'%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Apply to all HTTP methods
app.all('/api/*', (req, res, next) =&gt; {
  console.log(`${req.method} request to ${req.path}`);
  res.header('Access-Control-Allow-Origin', '*');
  next();
});

// Handle all methods for specific route
app.all('/status', (req, res) =&gt; {
  res.json({
    method: req.method,
    status: 'Server is running',
    timestamp: new Date().toISOString()
  });
});

// Wildcard matching
app.all('*', (req, res) =&gt; {
  res.status(404).json({ error: 'Route not found' });
});
</code></pre>
</div>

<h3 id="149-how-do-you-handle-404-errors-in-express-">149. How do you handle 404 errors in Express?</h3>

<p><strong>Answer:</strong> 404 errors occur when no route matches the request. Handle them by placing a catch-all middleware at the end of your middleware stack.</p>

<p><strong>Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20All%20your%20routes%20go%20here%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.send('Home%20page')%3B%0A%7D)%3B%0A%0Aapp.get('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20users%3A%20%5B%5D%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20404%20handler%20(must%20be%20last)%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20res.status(404).json(%7B%0A%20%20%20%20error%3A%20'Not%20Found'%2C%0A%20%20%20%20message%3A%20%60Route%20%24%7Breq.originalUrl%7D%20not%20found%60%2C%0A%20%20%20%20method%3A%20req.method%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Or%20with%20template%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20res.status(404).render('404'%2C%20%7B%0A%20%20%20%20url%3A%20req.originalUrl%2C%0A%20%20%20%20title%3A%20'Page%20Not%20Found'%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// All your routes go here
app.get('/', (req, res) =&gt; {
  res.send('Home page');
});

app.get('/users', (req, res) =&gt; {
  res.json({ users: [] });
});

// 404 handler (must be last)
app.use((req, res, next) =&gt; {
  res.status(404).json({
    error: 'Not Found',
    message: `Route ${req.originalUrl} not found`,
    method: req.method
  });
});

// Or with template
app.use((req, res, next) =&gt; {
  res.status(404).render('404', {
    url: req.originalUrl,
    title: 'Page Not Found'
  });
});
</code></pre>
</div>

<h3 id="150-what-are-the-best-practices-for-structuring-an-express-application-">150. What are the best practices for structuring an Express application?</h3>

<p><strong>Answer:</strong> Proper application structure improves maintainability, scalability, and team collaboration.</p>

<p><strong>Recommended Structure:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">plaintext</span>
        <button class="copy-btn" data-code="project%2F%0A%E2%94%9C%E2%94%80%E2%94%80%20app.js%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Main%20application%20file%0A%E2%94%9C%E2%94%80%E2%94%80%20server.js%20%20%20%20%20%20%20%20%20%20%20%23%20Server%20startup%0A%E2%94%9C%E2%94%80%E2%94%80%20package.json%0A%E2%94%9C%E2%94%80%E2%94%80%20.env%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Environment%20variables%0A%E2%94%9C%E2%94%80%E2%94%80%20config%2F%20%20%20%20%20%20%20%20%20%20%20%20%23%20Configuration%20files%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20database.js%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20config.js%0A%E2%94%9C%E2%94%80%E2%94%80%20controllers%2F%20%20%20%20%20%20%20%23%20Route%20handlers%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20userController.js%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20authController.js%0A%E2%94%9C%E2%94%80%E2%94%80%20middleware%2F%20%20%20%20%20%20%20%20%23%20Custom%20middleware%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20auth.js%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20validation.js%0A%E2%94%9C%E2%94%80%E2%94%80%20models%2F%20%20%20%20%20%20%20%20%20%20%20%23%20Data%20models%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20User.js%0A%E2%94%9C%E2%94%80%E2%94%80%20routes%2F%20%20%20%20%20%20%20%20%20%20%20%23%20Route%20definitions%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20index.js%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20users.js%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20auth.js%0A%E2%94%9C%E2%94%80%E2%94%80%20services%2F%20%20%20%20%20%20%20%20%20%23%20Business%20logic%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20userService.js%0A%E2%94%9C%E2%94%80%E2%94%80%20utils%2F%20%20%20%20%20%20%20%20%20%20%20%20%23%20Utility%20functions%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20helpers.js%0A%E2%94%9C%E2%94%80%E2%94%80%20tests%2F%20%20%20%20%20%20%20%20%20%20%20%20%23%20Test%20files%0A%E2%94%94%E2%94%80%E2%94%80%20public%2F%20%20%20%20%20%20%20%20%20%20%20%23%20Static%20files%0A%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20css%2F%0A%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20js%2F%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20images%2F%0A">Copy</button>
    </div>
    <pre><code class="language-plaintext">project/
â”œâ”€â”€ app.js              # Main application file
â”œâ”€â”€ server.js           # Server startup
â”œâ”€â”€ package.json
â”œâ”€â”€ .env               # Environment variables
â”œâ”€â”€ config/            # Configuration files
â”‚   â”œâ”€â”€ database.js
â”‚   â””â”€â”€ config.js
â”œâ”€â”€ controllers/       # Route handlers
â”‚   â”œâ”€â”€ userController.js
â”‚   â””â”€â”€ authController.js
â”œâ”€â”€ middleware/        # Custom middleware
â”‚   â”œâ”€â”€ auth.js
â”‚   â””â”€â”€ validation.js
â”œâ”€â”€ models/           # Data models
â”‚   â””â”€â”€ User.js
â”œâ”€â”€ routes/           # Route definitions
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ users.js
â”‚   â””â”€â”€ auth.js
â”œâ”€â”€ services/         # Business logic
â”‚   â””â”€â”€ userService.js
â”œâ”€â”€ utils/            # Utility functions
â”‚   â””â”€â”€ helpers.js
â”œâ”€â”€ tests/            # Test files
â””â”€â”€ public/           # Static files
    â”œâ”€â”€ css/
    â”œâ”€â”€ js/
    â””â”€â”€ images/
</code></pre>
</div>

<p><strong>Best Practices:</strong></p>

<p>1. <strong>Separation of Concerns</strong>: Separate routes, controllers, and business logic</p>
<p>2. <strong>Environment Configuration</strong>: Use environment variables</p>
<p>3. <strong>Error Handling</strong>: Centralized error handling</p>
<p>4. <strong>Validation</strong>: Input validation middleware</p>
<p>5. <strong>Security</strong>: Implement security best practices</p>
<p>6. <strong>Logging</strong>: Comprehensive logging</p>
<p>7. <strong>Testing</strong>: Unit and integration tests</p>


<p>---</p>

<h2 id="-advanced-concepts-20-questions-">**Advanced Concepts (20 Questions)**</h2>

<h3 id="151-how-do-you-implement-error-handling-middleware-">151. How do you implement error handling middleware?</h3>

<p><strong>Answer:</strong> Error handling middleware in Express has four parameters: `(err, req, res, next)`. It must be defined after all other middleware and routes.</p>

<p><strong>Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Custom%20error%20class%0Aclass%20AppError%20extends%20Error%20%7B%0A%20%20constructor(message%2C%20statusCode)%20%7B%0A%20%20%20%20super(message)%3B%0A%20%20%20%20this.statusCode%20%3D%20statusCode%3B%0A%20%20%20%20this.isOperational%20%3D%20true%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20Error%20handling%20middleware%0Aconst%20errorHandler%20%3D%20(err%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20let%20error%20%3D%20%7B%20...err%20%7D%3B%0A%20%20error.message%20%3D%20err.message%3B%0A%0A%20%20%2F%2F%20Log%20error%0A%20%20console.error(err)%3B%0A%0A%20%20%2F%2F%20Mongoose%20bad%20ObjectId%0A%20%20if%20(err.name%20%3D%3D%3D%20'CastError')%20%7B%0A%20%20%20%20const%20message%20%3D%20'Resource%20not%20found'%3B%0A%20%20%20%20error%20%3D%20new%20AppError(message%2C%20404)%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Mongoose%20duplicate%20key%0A%20%20if%20(err.code%20%3D%3D%3D%2011000)%20%7B%0A%20%20%20%20const%20message%20%3D%20'Duplicate%20field%20value%20entered'%3B%0A%20%20%20%20error%20%3D%20new%20AppError(message%2C%20400)%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Mongoose%20validation%20error%0A%20%20if%20(err.name%20%3D%3D%3D%20'ValidationError')%20%7B%0A%20%20%20%20const%20message%20%3D%20Object.values(err.errors).map(val%20%3D%3E%20val.message)%3B%0A%20%20%20%20error%20%3D%20new%20AppError(message%2C%20400)%3B%0A%20%20%7D%0A%0A%20%20res.status(error.statusCode%20%7C%7C%20500).json(%7B%0A%20%20%20%20success%3A%20false%2C%0A%20%20%20%20error%3A%20error.message%20%7C%7C%20'Server%20Error'%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20Use%20error%20handler%20(must%20be%20last)%0Aapp.use(errorHandler)%3B%0A%0A%2F%2F%20Usage%20in%20routes%0Aapp.get('%2Fusers%2F%3Aid'%2C%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(req.params.id)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20return%20next(new%20AppError('User%20not%20found'%2C%20404))%3B%0A%20%20%20%20%7D%0A%20%20%20%20res.json(user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20next(error)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Custom error class
class AppError extends Error {
  constructor(message, statusCode) {
    super(message);
    this.statusCode = statusCode;
    this.isOperational = true;
  }
}

// Error handling middleware
const errorHandler = (err, req, res, next) =&gt; {
  let error = { ...err };
  error.message = err.message;

  // Log error
  console.error(err);

  // Mongoose bad ObjectId
  if (err.name === 'CastError') {
    const message = 'Resource not found';
    error = new AppError(message, 404);
  }

  // Mongoose duplicate key
  if (err.code === 11000) {
    const message = 'Duplicate field value entered';
    error = new AppError(message, 400);
  }

  // Mongoose validation error
  if (err.name === 'ValidationError') {
    const message = Object.values(err.errors).map(val =&gt; val.message);
    error = new AppError(message, 400);
  }

  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Server Error'
  });
};

// Use error handler (must be last)
app.use(errorHandler);

// Usage in routes
app.get('/users/:id', async (req, res, next) =&gt; {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return next(new AppError('User not found', 404));
    }
    res.json(user);
  } catch (error) {
    next(error);
  }
});
</code></pre>
</div>

<h3 id="152-what-is-the-difference-between-synchronous-and-asynchronous-error-handling-">152. What is the difference between synchronous and asynchronous error handling?</h3>

<p><strong>Answer:</strong></p>

<p><strong>Synchronous Error Handling:</strong></p>

<p>- Errors thrown in synchronous code are automatically caught by Express</p>
<p>- Use try-catch blocks or let Express handle them</p>


<p><strong>Asynchronous Error Handling:</strong></p>

<p>- Errors in async operations must be explicitly passed to `next()`</p>
<p>- Unhandled promise rejections need special handling</p>


<p><strong>Examples:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Synchronous%20error%20(automatically%20caught)%0Aapp.get('%2Fsync-error'%2C%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20throw%20new%20Error('Synchronous%20error')%3B%20%2F%2F%20Express%20catches%20this%0A%7D)%3B%0A%0A%2F%2F%20Asynchronous%20error%20(must%20call%20next)%0Aapp.get('%2Fasync-error'%2C%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20throw%20new%20Error('Async%20error')%3B%0A%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20next(error)%3B%20%2F%2F%20Must%20explicitly%20pass%20to%20next%0A%20%20%20%20%7D%0A%20%20%7D%2C%20100)%3B%0A%7D)%3B%0A%0A%2F%2F%20Promise-based%20async%20error%0Aapp.get('%2Fpromise-error'%2C%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20await%20someAsyncOperation()%3B%0A%20%20%20%20res.json(%7B%20success%3A%20true%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20next(error)%3B%20%2F%2F%20Pass%20promise%20rejection%20to%20error%20handler%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Wrapper%20for%20async%20route%20handlers%0Aconst%20asyncHandler%20%3D%20(fn)%20%3D%3E%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20Promise.resolve(fn(req%2C%20res%2C%20next)).catch(next)%3B%0A%7D%3B%0A%0A%2F%2F%20Usage%0Aapp.get('%2Fusers'%2C%20asyncHandler(async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20users%20%3D%20await%20User.find()%3B%20%2F%2F%20Errors%20automatically%20passed%20to%20next%0A%20%20res.json(users)%3B%0A%7D))%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Synchronous error (automatically caught)
app.get('/sync-error', (req, res, next) =&gt; {
  throw new Error('Synchronous error'); // Express catches this
});

// Asynchronous error (must call next)
app.get('/async-error', (req, res, next) =&gt; {
  setTimeout(() =&gt; {
    try {
      throw new Error('Async error');
    } catch (error) {
      next(error); // Must explicitly pass to next
    }
  }, 100);
});

// Promise-based async error
app.get('/promise-error', async (req, res, next) =&gt; {
  try {
    await someAsyncOperation();
    res.json({ success: true });
  } catch (error) {
    next(error); // Pass promise rejection to error handler
  }
});

// Wrapper for async route handlers
const asyncHandler = (fn) =&gt; (req, res, next) =&gt; {
  Promise.resolve(fn(req, res, next)).catch(next);
};

// Usage
app.get('/users', asyncHandler(async (req, res) =&gt; {
  const users = await User.find(); // Errors automatically passed to next
  res.json(users);
}));
</code></pre>
</div>

<h3 id="153-how-do-you-implement-request-validation-middleware-">153. How do you implement request validation middleware?</h3>

<p><strong>Answer:</strong> Request validation ensures incoming data meets expected criteria. Popular libraries include Joi, express-validator, and Yup.</p>

<p><strong>Using express-validator:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20%7B%20body%2C%20param%2C%20query%2C%20validationResult%20%7D%20%3D%20require('express-validator')%3B%0A%0A%2F%2F%20Validation%20middleware%0Aconst%20validate%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20errors%20%3D%20validationResult(req)%3B%0A%20%20if%20(!errors.isEmpty())%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20success%3A%20false%2C%0A%20%20%20%20%20%20errors%3A%20errors.array()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20User%20creation%20validation%0Aconst%20validateCreateUser%20%3D%20%5B%0A%20%20body('email')%0A%20%20%20%20.isEmail()%0A%20%20%20%20.withMessage('Must%20be%20a%20valid%20email')%0A%20%20%20%20.normalizeEmail()%2C%0A%20%20body('password')%0A%20%20%20%20.isLength(%7B%20min%3A%206%20%7D)%0A%20%20%20%20.withMessage('Password%20must%20be%20at%20least%206%20characters')%0A%20%20%20%20.matches(%2F%5E(%3F%3D.*%5Ba-z%5D)(%3F%3D.*%5BA-Z%5D)(%3F%3D.*%5Cd)%2F)%0A%20%20%20%20.withMessage('Password%20must%20contain%20uppercase%2C%20lowercase%2C%20and%20number')%2C%0A%20%20body('name')%0A%20%20%20%20.trim()%0A%20%20%20%20.isLength(%7B%20min%3A%202%2C%20max%3A%2050%20%7D)%0A%20%20%20%20.withMessage('Name%20must%20be%20between%202%20and%2050%20characters')%2C%0A%20%20body('age')%0A%20%20%20%20.optional()%0A%20%20%20%20.isInt(%7B%20min%3A%2018%2C%20max%3A%20120%20%7D)%0A%20%20%20%20.withMessage('Age%20must%20be%20between%2018%20and%20120')%2C%0A%20%20validate%0A%5D%3B%0A%0A%2F%2F%20Route%20with%20validation%0Aapp.post('%2Fusers'%2C%20validateCreateUser%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Data%20is%20validated%20at%20this%20point%0A%20%20const%20%7B%20email%2C%20password%2C%20name%2C%20age%20%7D%20%3D%20req.body%3B%0A%20%20res.json(%7B%20message%3A%20'User%20created'%2C%20data%3A%20%7B%20email%2C%20name%2C%20age%20%7D%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Parameter%20validation%0Aconst%20validateUserId%20%3D%20%5B%0A%20%20param('id').isMongoId().withMessage('Invalid%20user%20ID')%2C%0A%20%20validate%0A%5D%3B%0A%0Aapp.get('%2Fusers%2F%3Aid'%2C%20validateUserId%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20userId%3A%20req.params.id%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const { body, param, query, validationResult } = require('express-validator');

// Validation middleware
const validate = (req, res, next) =&gt; {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      errors: errors.array()
    });
  }
  next();
};

// User creation validation
const validateCreateUser = [
  body('email')
    .isEmail()
    .withMessage('Must be a valid email')
    .normalizeEmail(),
  body('password')
    .isLength({ min: 6 })
    .withMessage('Password must be at least 6 characters')
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
    .withMessage('Password must contain uppercase, lowercase, and number'),
  body('name')
    .trim()
    .isLength({ min: 2, max: 50 })
    .withMessage('Name must be between 2 and 50 characters'),
  body('age')
    .optional()
    .isInt({ min: 18, max: 120 })
    .withMessage('Age must be between 18 and 120'),
  validate
];

// Route with validation
app.post('/users', validateCreateUser, (req, res) =&gt; {
  // Data is validated at this point
  const { email, password, name, age } = req.body;
  res.json({ message: 'User created', data: { email, name, age } });
});

// Parameter validation
const validateUserId = [
  param('id').isMongoId().withMessage('Invalid user ID'),
  validate
];

app.get('/users/:id', validateUserId, (req, res) =&gt; {
  res.json({ userId: req.params.id });
});
</code></pre>
</div>

<p><strong>Using Joi:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20Joi%20%3D%20require('joi')%3B%0A%0Aconst%20validateWithJoi%20%3D%20(schema)%20%3D%3E%20%7B%0A%20%20return%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20const%20%7B%20error%20%7D%20%3D%20schema.validate(req.body)%3B%0A%20%20%20%20if%20(error)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20success%3A%20false%2C%0A%20%20%20%20%20%20%20%20message%3A%20error.details%5B0%5D.message%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20next()%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0Aconst%20userSchema%20%3D%20Joi.object(%7B%0A%20%20email%3A%20Joi.string().email().required()%2C%0A%20%20password%3A%20Joi.string().min(6).required()%2C%0A%20%20name%3A%20Joi.string().min(2).max(50).required()%2C%0A%20%20age%3A%20Joi.number().integer().min(18).max(120).optional()%0A%7D)%3B%0A%0Aapp.post('%2Fusers'%2C%20validateWithJoi(userSchema)%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'User%20created'%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const Joi = require('joi');

const validateWithJoi = (schema) =&gt; {
  return (req, res, next) =&gt; {
    const { error } = schema.validate(req.body);
    if (error) {
      return res.status(400).json({
        success: false,
        message: error.details[0].message
      });
    }
    next();
  };
};

const userSchema = Joi.object({
  email: Joi.string().email().required(),
  password: Joi.string().min(6).required(),
  name: Joi.string().min(2).max(50).required(),
  age: Joi.number().integer().min(18).max(120).optional()
});

app.post('/users', validateWithJoi(userSchema), (req, res) =&gt; {
  res.json({ message: 'User created' });
});
</code></pre>
</div>

<h3 id="154-how-do-you-implement-api-versioning-in-express-">154. How do you implement API versioning in Express?</h3>

<p><strong>Answer:</strong> API versioning allows you to maintain multiple versions of your API simultaneously. Common strategies include URL versioning, header versioning, and query parameter versioning.</p>

<p><strong>URL Path Versioning:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Version%201%20routes%0Aconst%20v1Router%20%3D%20express.Router()%3B%0Av1Router.get('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20version%3A%20'v1'%2C%20users%3A%20%5B%5D%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Version%202%20routes%0Aconst%20v2Router%20%3D%20express.Router()%3B%0Av2Router.get('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20%0A%20%20%20%20version%3A%20'v2'%2C%20%0A%20%20%20%20users%3A%20%5B%5D%2C%0A%20%20%20%20metadata%3A%20%7B%20total%3A%200%2C%20page%3A%201%20%7D%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Mount%20versioned%20routes%0Aapp.use('%2Fapi%2Fv1'%2C%20v1Router)%3B%0Aapp.use('%2Fapi%2Fv2'%2C%20v2Router)%3B%0A%0A%2F%2F%20Default%20to%20latest%20version%0Aapp.use('%2Fapi'%2C%20v2Router)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Version 1 routes
const v1Router = express.Router();
v1Router.get('/users', (req, res) =&gt; {
  res.json({ version: 'v1', users: [] });
});

// Version 2 routes
const v2Router = express.Router();
v2Router.get('/users', (req, res) =&gt; {
  res.json({ 
    version: 'v2', 
    users: [],
    metadata: { total: 0, page: 1 }
  });
});

// Mount versioned routes
app.use('/api/v1', v1Router);
app.use('/api/v2', v2Router);

// Default to latest version
app.use('/api', v2Router);
</code></pre>
</div>

<p><strong>Header-based Versioning:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20versionMiddleware%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20version%20%3D%20req.headers%5B'api-version'%5D%20%7C%7C%20'v2'%3B%0A%20%20req.apiVersion%20%3D%20version%3B%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use('%2Fapi'%2C%20versionMiddleware)%3B%0A%0Aapp.get('%2Fapi%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20switch%20(req.apiVersion)%20%7B%0A%20%20%20%20case%20'v1'%3A%0A%20%20%20%20%20%20res.json(%7B%20version%3A%20'v1'%2C%20users%3A%20%5B%5D%20%7D)%3B%0A%20%20%20%20%20%20break%3B%0A%20%20%20%20case%20'v2'%3A%0A%20%20%20%20default%3A%0A%20%20%20%20%20%20res.json(%7B%20%0A%20%20%20%20%20%20%20%20version%3A%20'v2'%2C%20%0A%20%20%20%20%20%20%20%20users%3A%20%5B%5D%2C%0A%20%20%20%20%20%20%20%20metadata%3A%20%7B%20total%3A%200%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const versionMiddleware = (req, res, next) =&gt; {
  const version = req.headers['api-version'] || 'v2';
  req.apiVersion = version;
  next();
};

app.use('/api', versionMiddleware);

app.get('/api/users', (req, res) =&gt; {
  switch (req.apiVersion) {
    case 'v1':
      res.json({ version: 'v1', users: [] });
      break;
    case 'v2':
    default:
      res.json({ 
        version: 'v2', 
        users: [],
        metadata: { total: 0 }
      });
  }
});
</code></pre>
</div>

<p><strong>Query Parameter Versioning:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="app.get('%2Fapi%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20version%20%3D%20req.query.version%20%7C%7C%20'v2'%3B%0A%20%20%0A%20%20switch%20(version)%20%7B%0A%20%20%20%20case%20'v1'%3A%0A%20%20%20%20%20%20res.json(%7B%20version%3A%20'v1'%2C%20users%3A%20%5B%5D%20%7D)%3B%0A%20%20%20%20%20%20break%3B%0A%20%20%20%20case%20'v2'%3A%0A%20%20%20%20default%3A%0A%20%20%20%20%20%20res.json(%7B%20%0A%20%20%20%20%20%20%20%20version%3A%20'v2'%2C%20%0A%20%20%20%20%20%20%20%20users%3A%20%5B%5D%2C%0A%20%20%20%20%20%20%20%20metadata%3A%20%7B%20total%3A%200%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">app.get('/api/users', (req, res) =&gt; {
  const version = req.query.version || 'v2';
  
  switch (version) {
    case 'v1':
      res.json({ version: 'v1', users: [] });
      break;
    case 'v2':
    default:
      res.json({ 
        version: 'v2', 
        users: [],
        metadata: { total: 0 }
      });
  }
});
</code></pre>
</div>

<h3 id="155-what-is-content-negotiation-and-how-do-you-implement-it-">155. What is content negotiation and how do you implement it?</h3>

<p><strong>Answer:</strong> Content negotiation is the process of selecting the best representation for a response when there are multiple representations available. It's based on the Accept headers sent by the client.</p>

<p><strong>Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="app.get('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20users%20%3D%20%5B%0A%20%20%20%20%7B%20id%3A%201%2C%20name%3A%20'John'%2C%20email%3A%20'john%40example.com'%20%7D%2C%0A%20%20%20%20%7B%20id%3A%202%2C%20name%3A%20'Jane'%2C%20email%3A%20'jane%40example.com'%20%7D%0A%20%20%5D%3B%0A%0A%20%20res.format(%7B%0A%20%20%20%20%2F%2F%20JSON%20response%0A%20%20%20%20'application%2Fjson'%3A%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20res.json(%7B%20users%20%7D)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20XML%20response%0A%20%20%20%20'application%2Fxml'%3A%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20xml%20%3D%20%60%0A%20%20%20%20%20%20%20%20%3Cusers%3E%0A%20%20%20%20%20%20%20%20%20%20%24%7Busers.map(user%20%3D%3E%20%60%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cuser%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cid%3E%24%7Buser.id%7D%3C%2Fid%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cname%3E%24%7Buser.name%7D%3C%2Fname%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cemail%3E%24%7Buser.email%7D%3C%2Femail%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fuser%3E%0A%20%20%20%20%20%20%20%20%20%20%60).join('')%7D%0A%20%20%20%20%20%20%20%20%3C%2Fusers%3E%0A%20%20%20%20%20%20%60%3B%0A%20%20%20%20%20%20res.type('xml').send(xml)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20HTML%20response%0A%20%20%20%20'text%2Fhtml'%3A%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20html%20%3D%20%60%0A%20%20%20%20%20%20%20%20%3Chtml%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cbody%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Ch1%3EUsers%3C%2Fh1%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cul%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24%7Busers.map(user%20%3D%3E%20%60%3Cli%3E%24%7Buser.name%7D%20-%20%24%7Buser.email%7D%3C%2Fli%3E%60).join('')%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Ful%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%2Fbody%3E%0A%20%20%20%20%20%20%20%20%3C%2Fhtml%3E%0A%20%20%20%20%20%20%60%3B%0A%20%20%20%20%20%20res.send(html)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Default%20response%0A%20%20%20%20'default'%3A%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20res.status(406).json(%7B%20error%3A%20'Not%20Acceptable'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Manual%20content%20negotiation%0Aapp.get('%2Fdata'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20acceptHeader%20%3D%20req.get('Accept')%3B%0A%20%20%0A%20%20if%20(acceptHeader.includes('application%2Fjson'))%20%7B%0A%20%20%20%20res.json(%7B%20data%3A%20'JSON%20response'%20%7D)%3B%0A%20%20%7D%20else%20if%20(acceptHeader.includes('text%2Fplain'))%20%7B%0A%20%20%20%20res.type('text').send('Plain%20text%20response')%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20res.status(406).json(%7B%20error%3A%20'Not%20Acceptable'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">app.get('/users', (req, res) =&gt; {
  const users = [
    { id: 1, name: 'John', email: 'john@example.com' },
    { id: 2, name: 'Jane', email: 'jane@example.com' }
  ];

  res.format({
    // JSON response
    'application/json': () =&gt; {
      res.json({ users });
    },
    
    // XML response
    'application/xml': () =&gt; {
      const xml = `
        &lt;users&gt;
          ${users.map(user =&gt; `
            &lt;user&gt;
              &lt;id&gt;${user.id}&lt;/id&gt;
              &lt;name&gt;${user.name}&lt;/name&gt;
              &lt;email&gt;${user.email}&lt;/email&gt;
            &lt;/user&gt;
          `).join('')}
        &lt;/users&gt;
      `;
      res.type('xml').send(xml);
    },
    
    // HTML response
    'text/html': () =&gt; {
      const html = `
        &lt;html&gt;
          &lt;body&gt;
            &lt;h1&gt;Users&lt;/h1&gt;
            &lt;ul&gt;
              ${users.map(user =&gt; `&lt;li&gt;${user.name} - ${user.email}&lt;/li&gt;`).join('')}
            &lt;/ul&gt;
          &lt;/body&gt;
        &lt;/html&gt;
      `;
      res.send(html);
    },
    
    // Default response
    'default': () =&gt; {
      res.status(406).json({ error: 'Not Acceptable' });
    }
  });
});

// Manual content negotiation
app.get('/data', (req, res) =&gt; {
  const acceptHeader = req.get('Accept');
  
  if (acceptHeader.includes('application/json')) {
    res.json({ data: 'JSON response' });
  } else if (acceptHeader.includes('text/plain')) {
    res.type('text').send('Plain text response');
  } else {
    res.status(406).json({ error: 'Not Acceptable' });
  }
});
</code></pre>
</div>

<h3 id="156-how-do-you-handle-file-uploads-in-express-">156. How do you handle file uploads in Express?</h3>

<p><strong>Answer:</strong> File uploads in Express are typically handled using middleware like `multer` for multipart/form-data.</p>

<p><strong>Using Multer:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20multer%20%3D%20require('multer')%3B%0Aconst%20path%20%3D%20require('path')%3B%0A%0A%2F%2F%20Configure%20storage%0Aconst%20storage%20%3D%20multer.diskStorage(%7B%0A%20%20destination%3A%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%20%20cb(null%2C%20'uploads%2F')%3B%0A%20%20%7D%2C%0A%20%20filename%3A%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%20%20const%20uniqueSuffix%20%3D%20Date.now()%20%2B%20'-'%20%2B%20Math.round(Math.random()%20*%201E9)%3B%0A%20%20%20%20cb(null%2C%20file.fieldname%20%2B%20'-'%20%2B%20uniqueSuffix%20%2B%20path.extname(file.originalname))%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20File%20filter%0Aconst%20fileFilter%20%3D%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20const%20allowedTypes%20%3D%20%5B'image%2Fjpeg'%2C%20'image%2Fpng'%2C%20'image%2Fgif'%5D%3B%0A%20%20if%20(allowedTypes.includes(file.mimetype))%20%7B%0A%20%20%20%20cb(null%2C%20true)%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20cb(new%20Error('Invalid%20file%20type')%2C%20false)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Configure%20multer%0Aconst%20upload%20%3D%20multer(%7B%0A%20%20storage%3A%20storage%2C%0A%20%20limits%3A%20%7B%0A%20%20%20%20fileSize%3A%205%20*%201024%20*%201024%20%2F%2F%205MB%20limit%0A%20%20%7D%2C%0A%20%20fileFilter%3A%20fileFilter%0A%7D)%3B%0A%0A%2F%2F%20Single%20file%20upload%0Aapp.post('%2Fupload%2Fsingle'%2C%20upload.single('avatar')%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20if%20(!req.file)%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'No%20file%20uploaded'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20res.json(%7B%0A%20%20%20%20message%3A%20'File%20uploaded%20successfully'%2C%0A%20%20%20%20file%3A%20%7B%0A%20%20%20%20%20%20filename%3A%20req.file.filename%2C%0A%20%20%20%20%20%20originalname%3A%20req.file.originalname%2C%0A%20%20%20%20%20%20size%3A%20req.file.size%2C%0A%20%20%20%20%20%20path%3A%20req.file.path%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Multiple%20files%20upload%0Aapp.post('%2Fupload%2Fmultiple'%2C%20upload.array('photos'%2C%205)%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20if%20(!req.files%20%7C%7C%20req.files.length%20%3D%3D%3D%200)%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'No%20files%20uploaded'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20const%20files%20%3D%20req.files.map(file%20%3D%3E%20(%7B%0A%20%20%20%20filename%3A%20file.filename%2C%0A%20%20%20%20originalname%3A%20file.originalname%2C%0A%20%20%20%20size%3A%20file.size%0A%20%20%7D))%3B%0A%20%20%0A%20%20res.json(%7B%0A%20%20%20%20message%3A%20'Files%20uploaded%20successfully'%2C%0A%20%20%20%20files%3A%20files%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Memory%20storage%20(for%20cloud%20uploads)%0Aconst%20memoryUpload%20%3D%20multer(%7B%0A%20%20storage%3A%20multer.memoryStorage()%2C%0A%20%20limits%3A%20%7B%20fileSize%3A%205%20*%201024%20*%201024%20%7D%0A%7D)%3B%0A%0Aapp.post('%2Fupload%2Fmemory'%2C%20memoryUpload.single('file')%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20req.file.buffer%20contains%20the%20file%20data%0A%20%20%2F%2F%20Upload%20to%20cloud%20storage%20(AWS%20S3%2C%20Google%20Cloud%2C%20etc.)%0A%20%20res.json(%7B%0A%20%20%20%20message%3A%20'File%20received%20in%20memory'%2C%0A%20%20%20%20size%3A%20req.file.buffer.length%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const multer = require('multer');
const path = require('path');

// Configure storage
const storage = multer.diskStorage({
  destination: (req, file, cb) =&gt; {
    cb(null, 'uploads/');
  },
  filename: (req, file, cb) =&gt; {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

// File filter
const fileFilter = (req, file, cb) =&gt; {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('Invalid file type'), false);
  }
};

// Configure multer
const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB limit
  },
  fileFilter: fileFilter
});

// Single file upload
app.post('/upload/single', upload.single('avatar'), (req, res) =&gt; {
  if (!req.file) {
    return res.status(400).json({ error: 'No file uploaded' });
  }
  
  res.json({
    message: 'File uploaded successfully',
    file: {
      filename: req.file.filename,
      originalname: req.file.originalname,
      size: req.file.size,
      path: req.file.path
    }
  });
});

// Multiple files upload
app.post('/upload/multiple', upload.array('photos', 5), (req, res) =&gt; {
  if (!req.files || req.files.length === 0) {
    return res.status(400).json({ error: 'No files uploaded' });
  }
  
  const files = req.files.map(file =&gt; ({
    filename: file.filename,
    originalname: file.originalname,
    size: file.size
  }));
  
  res.json({
    message: 'Files uploaded successfully',
    files: files
  });
});

// Memory storage (for cloud uploads)
const memoryUpload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: 5 * 1024 * 1024 }
});

app.post('/upload/memory', memoryUpload.single('file'), (req, res) =&gt; {
  // req.file.buffer contains the file data
  // Upload to cloud storage (AWS S3, Google Cloud, etc.)
  res.json({
    message: 'File received in memory',
    size: req.file.buffer.length
  });
});
</code></pre>
</div>

<h3 id="157-what-is-cors-and-how-do-you-configure-it-properly-">157. What is CORS and how do you configure it properly?</h3>

<p><strong>Answer:</strong> CORS (Cross-Origin Resource Sharing) is a security feature that restricts web pages from making requests to a different domain than the one serving the web page.</p>

<p><strong>Basic CORS Setup:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20cors%20%3D%20require('cors')%3B%0A%0A%2F%2F%20Enable%20CORS%20for%20all%20routes%0Aapp.use(cors())%3B%0A%0A%2F%2F%20Custom%20CORS%20configuration%0Aconst%20corsOptions%20%3D%20%7B%0A%20%20origin%3A%20%5B'http%3A%2F%2Flocalhost%3A3000'%2C%20'https%3A%2F%2Fmyapp.com'%5D%2C%0A%20%20methods%3A%20%5B'GET'%2C%20'POST'%2C%20'PUT'%2C%20'DELETE'%5D%2C%0A%20%20allowedHeaders%3A%20%5B'Content-Type'%2C%20'Authorization'%5D%2C%0A%20%20credentials%3A%20true%2C%20%2F%2F%20Allow%20cookies%0A%20%20maxAge%3A%2086400%20%2F%2F%20Preflight%20cache%20duration%20(24%20hours)%0A%7D%3B%0A%0Aapp.use(cors(corsOptions))%3B%0A%0A%2F%2F%20Dynamic%20origin%0Aconst%20dynamicCors%20%3D%20%7B%0A%20%20origin%3A%20(origin%2C%20callback)%20%3D%3E%20%7B%0A%20%20%20%20const%20allowedOrigins%20%3D%20%5B'http%3A%2F%2Flocalhost%3A3000'%2C%20'https%3A%2F%2Fmyapp.com'%5D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Allow%20requests%20with%20no%20origin%20(mobile%20apps%2C%20Postman)%0A%20%20%20%20if%20(!origin)%20return%20callback(null%2C%20true)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(allowedOrigins.includes(origin))%20%7B%0A%20%20%20%20%20%20callback(null%2C%20true)%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20callback(new%20Error('Not%20allowed%20by%20CORS'))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%0Aapp.use(cors(dynamicCors))%3B%0A%0A%2F%2F%20Route-specific%20CORS%0Aapp.get('%2Fpublic-api'%2C%20cors()%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Public%20API'%20%7D)%3B%0A%7D)%3B%0A%0Aapp.get('%2Fprivate-api'%2C%20cors(corsOptions)%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Private%20API'%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Manual%20CORS%20headers%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20res.header('Access-Control-Allow-Origin'%2C%20'*')%3B%0A%20%20res.header('Access-Control-Allow-Methods'%2C%20'GET%2CPUT%2CPOST%2CDELETE%2COPTIONS')%3B%0A%20%20res.header('Access-Control-Allow-Headers'%2C%20'Content-Type%2C%20Authorization')%3B%0A%20%20%0A%20%20if%20(req.method%20%3D%3D%3D%20'OPTIONS')%20%7B%0A%20%20%20%20res.sendStatus(200)%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20next()%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const cors = require('cors');

// Enable CORS for all routes
app.use(cors());

// Custom CORS configuration
const corsOptions = {
  origin: ['http://localhost:3000', 'https://myapp.com'],
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true, // Allow cookies
  maxAge: 86400 // Preflight cache duration (24 hours)
};

app.use(cors(corsOptions));

// Dynamic origin
const dynamicCors = {
  origin: (origin, callback) =&gt; {
    const allowedOrigins = ['http://localhost:3000', 'https://myapp.com'];
    
    // Allow requests with no origin (mobile apps, Postman)
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  }
};

app.use(cors(dynamicCors));

// Route-specific CORS
app.get('/public-api', cors(), (req, res) =&gt; {
  res.json({ message: 'Public API' });
});

app.get('/private-api', cors(corsOptions), (req, res) =&gt; {
  res.json({ message: 'Private API' });
});

// Manual CORS headers
app.use((req, res, next) =&gt; {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
  } else {
    next();
  }
});
</code></pre>
</div>

<h3 id="158-how-do-you-implement-request-response-compression-">158. How do you implement request/response compression?</h3>

<p><strong>Answer:</strong> Compression reduces the size of response bodies, improving performance and reducing bandwidth usage.</p>

<p><strong>Using compression middleware:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20compression%20%3D%20require('compression')%3B%0A%0A%2F%2F%20Basic%20compression%0Aapp.use(compression())%3B%0A%0A%2F%2F%20Custom%20compression%20options%0Aapp.use(compression(%7B%0A%20%20level%3A%206%2C%20%20%20%20%20%20%20%20%2F%2F%20Compression%20level%20(1-9)%0A%20%20threshold%3A%201024%2C%20%2F%2F%20Only%20compress%20responses%20%3E%201KB%0A%20%20filter%3A%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Don't%20compress%20if%20client%20doesn't%20support%20it%0A%20%20%20%20if%20(req.headers%5B'x-no-compression'%5D)%20%7B%0A%20%20%20%20%20%20return%20false%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Use%20compression%20filter%0A%20%20%20%20return%20compression.filter(req%2C%20res)%3B%0A%20%20%7D%0A%7D))%3B%0A%0A%2F%2F%20Conditional%20compression%0Aapp.use(compression(%7B%0A%20%20filter%3A%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20const%20type%20%3D%20res.getHeader('Content-Type')%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Compress%20text-based%20responses%0A%20%20%20%20if%20(type%20%26%26%20(%0A%20%20%20%20%20%20type.includes('text%2F')%20%7C%7C%0A%20%20%20%20%20%20type.includes('application%2Fjson')%20%7C%7C%0A%20%20%20%20%20%20type.includes('application%2Fjavascript')%20%7C%7C%0A%20%20%20%20%20%20type.includes('application%2Fxml')%0A%20%20%20%20))%20%7B%0A%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20false%3B%0A%20%20%7D%0A%7D))%3B%0A%0A%2F%2F%20Route%20with%20large%20response%0Aapp.get('%2Flarge-data'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20largeData%20%3D%20%7B%0A%20%20%20%20users%3A%20new%20Array(1000).fill(null).map((_%2C%20i)%20%3D%3E%20(%7B%0A%20%20%20%20%20%20id%3A%20i%2C%0A%20%20%20%20%20%20name%3A%20%60User%20%24%7Bi%7D%60%2C%0A%20%20%20%20%20%20email%3A%20%60user%24%7Bi%7D%40example.com%60%2C%0A%20%20%20%20%20%20description%3A%20'A%20very%20long%20description%20that%20repeats%20many%20times...'%0A%20%20%20%20%7D))%0A%20%20%7D%3B%0A%20%20%0A%20%20res.json(largeData)%3B%20%2F%2F%20Will%20be%20compressed%20automatically%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const compression = require('compression');

// Basic compression
app.use(compression());

// Custom compression options
app.use(compression({
  level: 6,        // Compression level (1-9)
  threshold: 1024, // Only compress responses &gt; 1KB
  filter: (req, res) =&gt; {
    // Don't compress if client doesn't support it
    if (req.headers['x-no-compression']) {
      return false;
    }
    
    // Use compression filter
    return compression.filter(req, res);
  }
}));

// Conditional compression
app.use(compression({
  filter: (req, res) =&gt; {
    const type = res.getHeader('Content-Type');
    
    // Compress text-based responses
    if (type && (
      type.includes('text/') ||
      type.includes('application/json') ||
      type.includes('application/javascript') ||
      type.includes('application/xml')
    )) {
      return true;
    }
    
    return false;
  }
}));

// Route with large response
app.get('/large-data', (req, res) =&gt; {
  const largeData = {
    users: new Array(1000).fill(null).map((_, i) =&gt; ({
      id: i,
      name: `User ${i}`,
      email: `user${i}@example.com`,
      description: 'A very long description that repeats many times...'
    }))
  };
  
  res.json(largeData); // Will be compressed automatically
});
</code></pre>
</div>

<h3 id="159-how-do-you-implement-rate-limiting-in-express-">159. How do you implement rate limiting in Express?</h3>

<p><strong>Answer:</strong> Rate limiting prevents abuse by limiting the number of requests a client can make within a time window.</p>

<p><strong>Using express-rate-limit:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20rateLimit%20%3D%20require('express-rate-limit')%3B%0A%0A%2F%2F%20Basic%20rate%20limiting%0Aconst%20limiter%20%3D%20rateLimit(%7B%0A%20%20windowMs%3A%2015%20*%2060%20*%201000%2C%20%2F%2F%2015%20minutes%0A%20%20max%3A%20100%2C%20%2F%2F%20Limit%20each%20IP%20to%20100%20requests%20per%20windowMs%0A%20%20message%3A%20%7B%0A%20%20%20%20error%3A%20'Too%20many%20requests%20from%20this%20IP%2C%20please%20try%20again%20later.'%0A%20%20%7D%2C%0A%20%20standardHeaders%3A%20true%2C%20%2F%2F%20Return%20rate%20limit%20info%20in%20headers%0A%20%20legacyHeaders%3A%20false%2C%0A%7D)%3B%0A%0Aapp.use(limiter)%3B%0A%0A%2F%2F%20Strict%20rate%20limiting%20for%20auth%20endpoints%0Aconst%20authLimiter%20%3D%20rateLimit(%7B%0A%20%20windowMs%3A%2015%20*%2060%20*%201000%2C%0A%20%20max%3A%205%2C%20%2F%2F%20Only%205%20attempts%20per%2015%20minutes%0A%20%20skipSuccessfulRequests%3A%20true%2C%20%2F%2F%20Don't%20count%20successful%20requests%0A%20%20message%3A%20%7B%0A%20%20%20%20error%3A%20'Too%20many%20authentication%20attempts%2C%20please%20try%20again%20later.'%0A%20%20%7D%0A%7D)%3B%0A%0Aapp.use('%2Fauth'%2C%20authLimiter)%3B%0A%0A%2F%2F%20Custom%20key%20generator%20(rate%20limit%20per%20user)%0Aconst%20userLimiter%20%3D%20rateLimit(%7B%0A%20%20windowMs%3A%2060%20*%201000%2C%20%2F%2F%201%20minute%0A%20%20max%3A%2010%2C%0A%20%20keyGenerator%3A%20(req)%20%3D%3E%20%7B%0A%20%20%20%20return%20req.user%3F.id%20%7C%7C%20req.ip%3B%20%2F%2F%20Use%20user%20ID%20if%20authenticated%2C%20otherwise%20IP%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Different%20limits%20for%20different%20endpoints%0Aconst%20createAccountLimiter%20%3D%20rateLimit(%7B%0A%20%20windowMs%3A%2060%20*%2060%20*%201000%2C%20%2F%2F%201%20hour%0A%20%20max%3A%203%2C%20%2F%2F%20Only%203%20account%20creations%20per%20hour%20per%20IP%0A%20%20message%3A%20'Too%20many%20accounts%20created%20from%20this%20IP'%0A%7D)%3B%0A%0Aapp.post('%2Fregister'%2C%20createAccountLimiter%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Registration%20logic%0A%7D)%3B%0A%0A%2F%2F%20Custom%20store%20(Redis%20for%20distributed%20systems)%0Aconst%20RedisStore%20%3D%20require('rate-limit-redis')%3B%0Aconst%20redis%20%3D%20require('redis')%3B%0Aconst%20redisClient%20%3D%20redis.createClient()%3B%0A%0Aconst%20distributedLimiter%20%3D%20rateLimit(%7B%0A%20%20store%3A%20new%20RedisStore(%7B%0A%20%20%20%20client%3A%20redisClient%2C%0A%20%20%20%20prefix%3A%20'rl%3A'%20%2F%2F%20Key%20prefix%20in%20Redis%0A%20%20%7D)%2C%0A%20%20windowMs%3A%2015%20*%2060%20*%201000%2C%0A%20%20max%3A%20100%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const rateLimit = require('express-rate-limit');

// Basic rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // Limit each IP to 100 requests per windowMs
  message: {
    error: 'Too many requests from this IP, please try again later.'
  },
  standardHeaders: true, // Return rate limit info in headers
  legacyHeaders: false,
});

app.use(limiter);

// Strict rate limiting for auth endpoints
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5, // Only 5 attempts per 15 minutes
  skipSuccessfulRequests: true, // Don't count successful requests
  message: {
    error: 'Too many authentication attempts, please try again later.'
  }
});

app.use('/auth', authLimiter);

// Custom key generator (rate limit per user)
const userLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 minute
  max: 10,
  keyGenerator: (req) =&gt; {
    return req.user?.id || req.ip; // Use user ID if authenticated, otherwise IP
  }
});

// Different limits for different endpoints
const createAccountLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 3, // Only 3 account creations per hour per IP
  message: 'Too many accounts created from this IP'
});

app.post('/register', createAccountLimiter, (req, res) =&gt; {
  // Registration logic
});

// Custom store (Redis for distributed systems)
const RedisStore = require('rate-limit-redis');
const redis = require('redis');
const redisClient = redis.createClient();

const distributedLimiter = rateLimit({
  store: new RedisStore({
    client: redisClient,
    prefix: 'rl:' // Key prefix in Redis
  }),
  windowMs: 15 * 60 * 1000,
  max: 100
});
</code></pre>
</div>

<h3 id="160-what-is-helmet-js-and-why-do-you-use-it-">160. What is Helmet.js and why do you use it?</h3>

<p><strong>Answer:</strong> Helmet.js is a security middleware that sets various HTTP headers to help protect Express applications from common vulnerabilities.</p>

<p><strong>Security Headers Set by Helmet:</strong></p>

<p>- Content Security Policy (CSP)</p>
<p>- X-Frame-Options (prevents clickjacking)</p>
<p>- X-Content-Type-Options (prevents MIME sniffing)</p>
<p>- Strict-Transport-Security (enforces HTTPS)</p>
<p>- X-XSS-Protection (XSS filtering)</p>


<p><strong>Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20helmet%20%3D%20require('helmet')%3B%0A%0A%2F%2F%20Basic%20helmet%20usage%20(applies%20all%20default%20protections)%0Aapp.use(helmet())%3B%0A%0A%2F%2F%20Custom%20helmet%20configuration%0Aapp.use(helmet(%7B%0A%20%20contentSecurityPolicy%3A%20%7B%0A%20%20%20%20directives%3A%20%7B%0A%20%20%20%20%20%20defaultSrc%3A%20%5B%22'self'%22%5D%2C%0A%20%20%20%20%20%20styleSrc%3A%20%5B%22'self'%22%2C%20%22'unsafe-inline'%22%2C%20%22https%3A%2F%2Ffonts.googleapis.com%22%5D%2C%0A%20%20%20%20%20%20fontSrc%3A%20%5B%22'self'%22%2C%20%22https%3A%2F%2Ffonts.gstatic.com%22%5D%2C%0A%20%20%20%20%20%20scriptSrc%3A%20%5B%22'self'%22%2C%20%22https%3A%2F%2Fcdn.jsdelivr.net%22%5D%2C%0A%20%20%20%20%20%20imgSrc%3A%20%5B%22'self'%22%2C%20%22data%3A%22%2C%20%22https%3A%22%5D%2C%0A%20%20%20%20%20%20connectSrc%3A%20%5B%22'self'%22%2C%20%22https%3A%2F%2Fapi.example.com%22%5D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20hsts%3A%20%7B%0A%20%20%20%20maxAge%3A%2031536000%2C%20%2F%2F%201%20year%0A%20%20%20%20includeSubDomains%3A%20true%2C%0A%20%20%20%20preload%3A%20true%0A%20%20%7D%0A%7D))%3B%0A%0A%2F%2F%20Individual%20helmet%20features%0Aapp.use(helmet.noSniff())%3B%20%2F%2F%20X-Content-Type-Options%3A%20nosniff%0Aapp.use(helmet.frameguard(%7B%20action%3A%20'deny'%20%7D))%3B%20%2F%2F%20X-Frame-Options%3A%20DENY%0Aapp.use(helmet.xssFilter())%3B%20%2F%2F%20X-XSS-Protection%3A%201%3B%20mode%3Dblock%0A%0A%2F%2F%20Disable%20specific%20features%0Aapp.use(helmet(%7B%0A%20%20contentSecurityPolicy%3A%20false%2C%20%2F%2F%20Disable%20CSP%0A%20%20crossOriginEmbedderPolicy%3A%20false%0A%7D))%3B%0A%0A%2F%2F%20Environment-specific%20configuration%0Aif%20(process.env.NODE_ENV%20%3D%3D%3D%20'production')%20%7B%0A%20%20app.use(helmet(%7B%0A%20%20%20%20hsts%3A%20%7B%0A%20%20%20%20%20%20maxAge%3A%2031536000%2C%0A%20%20%20%20%20%20includeSubDomains%3A%20true%2C%0A%20%20%20%20%20%20preload%3A%20true%0A%20%20%20%20%7D%0A%20%20%7D))%3B%0A%7D%20else%20%7B%0A%20%20app.use(helmet(%7B%0A%20%20%20%20hsts%3A%20false%20%2F%2F%20Disable%20HSTS%20in%20development%0A%20%20%7D))%3B%0A%7D%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const helmet = require('helmet');

// Basic helmet usage (applies all default protections)
app.use(helmet());

// Custom helmet configuration
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      scriptSrc: ["'self'", "https://cdn.jsdelivr.net"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.example.com"]
    }
  },
  hsts: {
    maxAge: 31536000, // 1 year
    includeSubDomains: true,
    preload: true
  }
}));

// Individual helmet features
app.use(helmet.noSniff()); // X-Content-Type-Options: nosniff
app.use(helmet.frameguard({ action: 'deny' })); // X-Frame-Options: DENY
app.use(helmet.xssFilter()); // X-XSS-Protection: 1; mode=block

// Disable specific features
app.use(helmet({
  contentSecurityPolicy: false, // Disable CSP
  crossOriginEmbedderPolicy: false
}));

// Environment-specific configuration
if (process.env.NODE_ENV === 'production') {
  app.use(helmet({
    hsts: {
      maxAge: 31536000,
      includeSubDomains: true,
      preload: true
    }
  }));
} else {
  app.use(helmet({
    hsts: false // Disable HSTS in development
  }));
}
</code></pre>
</div>

<p><strong>Headers Added by Helmet:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">plaintext</span>
        <button class="copy-btn" data-code="Content-Security-Policy%3A%20default-src%20'self'%0AX-Frame-Options%3A%20SAMEORIGIN%0AX-Content-Type-Options%3A%20nosniff%0AStrict-Transport-Security%3A%20max-age%3D31536000%3B%20includeSubDomains%0AX-XSS-Protection%3A%201%3B%20mode%3Dblock%0AReferrer-Policy%3A%20no-referrer%0A">Copy</button>
    </div>
    <pre><code class="language-plaintext">Content-Security-Policy: default-src 'self'
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-XSS-Protection: 1; mode=block
Referrer-Policy: no-referrer
</code></pre>
</div>

<p>Thought for 2s### 161. How do you implement custom middleware for logging?</p>

<p><strong>Answer:</strong> Custom logging middleware captures request information, response details, and execution time for monitoring and debugging purposes.</p>

<p><strong>Basic Logging Middleware:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20fs%20%3D%20require('fs')%3B%0Aconst%20path%20%3D%20require('path')%3B%0A%0A%2F%2F%20Simple%20console%20logger%0Aconst%20simpleLogger%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20timestamp%20%3D%20new%20Date().toISOString()%3B%0A%20%20const%20method%20%3D%20req.method%3B%0A%20%20const%20url%20%3D%20req.originalUrl%3B%0A%20%20const%20ip%20%3D%20req.ip%20%7C%7C%20req.connection.remoteAddress%3B%0A%20%20%0A%20%20console.log(%60%5B%24%7Btimestamp%7D%5D%20%24%7Bmethod%7D%20%24%7Burl%7D%20-%20%24%7Bip%7D%60)%3B%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Advanced%20logger%20with%20response%20time%0Aconst%20advancedLogger%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20start%20%3D%20Date.now()%3B%0A%20%20%0A%20%20%2F%2F%20Override%20res.end%20to%20capture%20response%20details%0A%20%20const%20originalEnd%20%3D%20res.end%3B%0A%20%20res.end%20%3D%20function(...args)%20%7B%0A%20%20%20%20const%20duration%20%3D%20Date.now()%20-%20start%3B%0A%20%20%20%20const%20statusCode%20%3D%20res.statusCode%3B%0A%20%20%20%20const%20contentLength%20%3D%20res.get('Content-Length')%20%7C%7C%200%3B%0A%20%20%20%20%0A%20%20%20%20console.log(%60%24%7Breq.method%7D%20%24%7Breq.originalUrl%7D%20%24%7BstatusCode%7D%20%24%7Bduration%7Dms%20%24%7BcontentLength%7Dbytes%60)%3B%0A%20%20%20%20%0A%20%20%20%20originalEnd.apply(this%2C%20args)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20File-based%20logger%0Aconst%20fileLogger%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20logEntry%20%3D%20%7B%0A%20%20%20%20timestamp%3A%20new%20Date().toISOString()%2C%0A%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20url%3A%20req.originalUrl%2C%0A%20%20%20%20ip%3A%20req.ip%2C%0A%20%20%20%20userAgent%3A%20req.get('User-Agent')%2C%0A%20%20%20%20headers%3A%20req.headers%0A%20%20%7D%3B%0A%20%20%0A%20%20const%20logString%20%3D%20JSON.stringify(logEntry)%20%2B%20'%5Cn'%3B%0A%20%20const%20logPath%20%3D%20path.join(__dirname%2C%20'logs'%2C%20'access.log')%3B%0A%20%20%0A%20%20fs.appendFile(logPath%2C%20logString%2C%20(err)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20console.error('Logging%20error%3A'%2C%20err)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(advancedLogger)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const fs = require('fs');
const path = require('path');

// Simple console logger
const simpleLogger = (req, res, next) =&gt; {
  const timestamp = new Date().toISOString();
  const method = req.method;
  const url = req.originalUrl;
  const ip = req.ip || req.connection.remoteAddress;
  
  console.log(`[${timestamp}] ${method} ${url} - ${ip}`);
  next();
};

// Advanced logger with response time
const advancedLogger = (req, res, next) =&gt; {
  const start = Date.now();
  
  // Override res.end to capture response details
  const originalEnd = res.end;
  res.end = function(...args) {
    const duration = Date.now() - start;
    const statusCode = res.statusCode;
    const contentLength = res.get('Content-Length') || 0;
    
    console.log(`${req.method} ${req.originalUrl} ${statusCode} ${duration}ms ${contentLength}bytes`);
    
    originalEnd.apply(this, args);
  };
  
  next();
};

// File-based logger
const fileLogger = (req, res, next) =&gt; {
  const logEntry = {
    timestamp: new Date().toISOString(),
    method: req.method,
    url: req.originalUrl,
    ip: req.ip,
    userAgent: req.get('User-Agent'),
    headers: req.headers
  };
  
  const logString = JSON.stringify(logEntry) + '\n';
  const logPath = path.join(__dirname, 'logs', 'access.log');
  
  fs.appendFile(logPath, logString, (err) =&gt; {
    if (err) console.error('Logging error:', err);
  });
  
  next();
};

app.use(advancedLogger);
</code></pre>
</div>

<p><strong>Using Winston for Production Logging:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20winston%20%3D%20require('winston')%3B%0A%0A%2F%2F%20Configure%20Winston%0Aconst%20logger%20%3D%20winston.createLogger(%7B%0A%20%20level%3A%20'info'%2C%0A%20%20format%3A%20winston.format.combine(%0A%20%20%20%20winston.format.timestamp()%2C%0A%20%20%20%20winston.format.errors(%7B%20stack%3A%20true%20%7D)%2C%0A%20%20%20%20winston.format.json()%0A%20%20)%2C%0A%20%20transports%3A%20%5B%0A%20%20%20%20new%20winston.transports.File(%7B%20filename%3A%20'logs%2Ferror.log'%2C%20level%3A%20'error'%20%7D)%2C%0A%20%20%20%20new%20winston.transports.File(%7B%20filename%3A%20'logs%2Fcombined.log'%20%7D)%0A%20%20%5D%0A%7D)%3B%0A%0Aif%20(process.env.NODE_ENV%20!%3D%3D%20'production')%20%7B%0A%20%20logger.add(new%20winston.transports.Console(%7B%0A%20%20%20%20format%3A%20winston.format.simple()%0A%20%20%7D))%3B%0A%7D%0A%0A%2F%2F%20Winston%20middleware%0Aconst%20winstonLogger%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20start%20%3D%20Date.now()%3B%0A%20%20%0A%20%20res.on('finish'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20duration%20%3D%20Date.now()%20-%20start%3B%0A%20%20%20%20logger.info(%7B%0A%20%20%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20%20%20url%3A%20req.originalUrl%2C%0A%20%20%20%20%20%20statusCode%3A%20res.statusCode%2C%0A%20%20%20%20%20%20duration%3A%20%60%24%7Bduration%7Dms%60%2C%0A%20%20%20%20%20%20ip%3A%20req.ip%2C%0A%20%20%20%20%20%20userAgent%3A%20req.get('User-Agent')%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(winstonLogger)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const winston = require('winston');

// Configure Winston
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' })
  ]
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

// Winston middleware
const winstonLogger = (req, res, next) =&gt; {
  const start = Date.now();
  
  res.on('finish', () =&gt; {
    const duration = Date.now() - start;
    logger.info({
      method: req.method,
      url: req.originalUrl,
      statusCode: res.statusCode,
      duration: `${duration}ms`,
      ip: req.ip,
      userAgent: req.get('User-Agent')
    });
  });
  
  next();
};

app.use(winstonLogger);
</code></pre>
</div>

<h3 id="162-what-is-the-purpose-of-app-param-middleware-">162. What is the purpose of `app.param()`middleware?</h3>

<p><strong>Answer:</strong> `app.param()` is used to add callback triggers to route parameters. It runs before any route handler that uses the specified parameter.</p>

<p><strong>Use Cases:</strong></p>

<p>- Parameter validation</p>
<p>- Database lookups</p>
<p>- Parameter transformation</p>
<p>- Caching parameter-based data</p>


<p><strong>Example:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Parameter%20middleware%20for%20user%20ID%0Aapp.param('userId'%2C%20async%20(req%2C%20res%2C%20next%2C%20userId)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20%2F%2F%20Validate%20parameter%20format%0A%20%20%20%20if%20(!userId.match(%2F%5E%5Cd%2B%24%2F))%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Invalid%20user%20ID%20format'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Fetch%20user%20from%20database%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(userId)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'User%20not%20found'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Attach%20user%20to%20request%20object%0A%20%20%20%20req.user%20%3D%20user%3B%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20next(error)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Routes%20using%20the%20parameter%0Aapp.get('%2Fusers%2F%3AuserId'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20req.user%20is%20already%20available%0A%20%20res.json(req.user)%3B%0A%7D)%3B%0A%0Aapp.put('%2Fusers%2F%3AuserId'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20req.user%20is%20already%20available%0A%20%20res.json(%7B%20message%3A%20%60Updating%20user%20%24%7Breq.user.name%7D%60%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Multiple%20parameter%20middleware%0Aapp.param('postId'%2C%20async%20(req%2C%20res%2C%20next%2C%20postId)%20%3D%3E%20%7B%0A%20%20const%20post%20%3D%20await%20Post.findById(postId)%3B%0A%20%20if%20(!post)%20%7B%0A%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'Post%20not%20found'%20%7D)%3B%0A%20%20%7D%0A%20%20req.post%20%3D%20post%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Route%20with%20multiple%20parameters%0Aapp.get('%2Fusers%2F%3AuserId%2Fposts%2F%3ApostId'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Both%20req.user%20and%20req.post%20are%20available%0A%20%20res.json(%7B%0A%20%20%20%20user%3A%20req.user%2C%0A%20%20%20%20post%3A%20req.post%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Parameter%20transformation%0Aapp.param('category'%2C%20(req%2C%20res%2C%20next%2C%20category)%20%3D%3E%20%7B%0A%20%20req.params.category%20%3D%20category.toLowerCase().trim()%3B%0A%20%20next()%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Parameter middleware for user ID
app.param('userId', async (req, res, next, userId) =&gt; {
  try {
    // Validate parameter format
    if (!userId.match(/^\d+$/)) {
      return res.status(400).json({ error: 'Invalid user ID format' });
    }
    
    // Fetch user from database
    const user = await User.findById(userId);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    // Attach user to request object
    req.user = user;
    next();
  } catch (error) {
    next(error);
  }
});

// Routes using the parameter
app.get('/users/:userId', (req, res) =&gt; {
  // req.user is already available
  res.json(req.user);
});

app.put('/users/:userId', (req, res) =&gt; {
  // req.user is already available
  res.json({ message: `Updating user ${req.user.name}` });
});

// Multiple parameter middleware
app.param('postId', async (req, res, next, postId) =&gt; {
  const post = await Post.findById(postId);
  if (!post) {
    return res.status(404).json({ error: 'Post not found' });
  }
  req.post = post;
  next();
});

// Route with multiple parameters
app.get('/users/:userId/posts/:postId', (req, res) =&gt; {
  // Both req.user and req.post are available
  res.json({
    user: req.user,
    post: req.post
  });
});

// Parameter transformation
app.param('category', (req, res, next, category) =&gt; {
  req.params.category = category.toLowerCase().trim();
  next();
});
</code></pre>
</div>

<h3 id="163-how-do-you-implement-custom-response-methods-">163. How do you implement custom response methods?</h3>

<p><strong>Answer:</strong> Custom response methods extend the Express response object with application-specific functionality.</p>

<p><strong>Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Extend%20response%20object%20with%20custom%20methods%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Success%20response%20method%0A%20%20res.success%20%3D%20function(data%2C%20message%20%3D%20'Success')%20%7B%0A%20%20%20%20return%20this.status(200).json(%7B%0A%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20message%2C%0A%20%20%20%20%20%20data%0A%20%20%20%20%7D)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20Error%20response%20method%0A%20%20res.error%20%3D%20function(message%2C%20statusCode%20%3D%20500%2C%20errors%20%3D%20null)%20%7B%0A%20%20%20%20return%20this.status(statusCode).json(%7B%0A%20%20%20%20%20%20success%3A%20false%2C%0A%20%20%20%20%20%20message%2C%0A%20%20%20%20%20%20errors%0A%20%20%20%20%7D)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20Paginated%20response%20method%0A%20%20res.paginate%20%3D%20function(data%2C%20page%2C%20limit%2C%20total)%20%7B%0A%20%20%20%20const%20totalPages%20%3D%20Math.ceil(total%20%2F%20limit)%3B%0A%20%20%20%20return%20this.status(200).json(%7B%0A%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20data%2C%0A%20%20%20%20%20%20pagination%3A%20%7B%0A%20%20%20%20%20%20%20%20page%3A%20parseInt(page)%2C%0A%20%20%20%20%20%20%20%20limit%3A%20parseInt(limit)%2C%0A%20%20%20%20%20%20%20%20total%2C%0A%20%20%20%20%20%20%20%20totalPages%2C%0A%20%20%20%20%20%20%20%20hasNext%3A%20page%20%3C%20totalPages%2C%0A%20%20%20%20%20%20%20%20hasPrev%3A%20page%20%3E%201%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20API%20response%20with%20metadata%0A%20%20res.apiResponse%20%3D%20function(data%2C%20meta%20%3D%20%7B%7D)%20%7B%0A%20%20%20%20return%20this.status(200).json(%7B%0A%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20data%2C%0A%20%20%20%20%20%20meta%3A%20%7B%0A%20%20%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%2C%0A%20%20%20%20%20%20%20%20version%3A%20'1.0'%2C%0A%20%20%20%20%20%20%20%20...meta%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Usage%20in%20routes%0Aapp.get('%2Fusers'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20users%20%3D%20await%20User.find()%3B%0A%20%20%20%20res.success(users%2C%20'Users%20retrieved%20successfully')%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.error('Failed%20to%20retrieve%20users'%2C%20500)%3B%0A%20%20%7D%0A%7D)%3B%0A%0Aapp.get('%2Fposts'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20page%20%3D%20parseInt(req.query.page)%20%7C%7C%201%3B%0A%20%20%20%20const%20limit%20%3D%20parseInt(req.query.limit)%20%7C%7C%2010%3B%0A%20%20%20%20const%20skip%20%3D%20(page%20-%201)%20*%20limit%3B%0A%20%20%20%20%0A%20%20%20%20const%20posts%20%3D%20await%20Post.find().skip(skip).limit(limit)%3B%0A%20%20%20%20const%20total%20%3D%20await%20Post.countDocuments()%3B%0A%20%20%20%20%0A%20%20%20%20res.paginate(posts%2C%20page%2C%20limit%2C%20total)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.error('Failed%20to%20retrieve%20posts')%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Global%20method%20extension%20(alternative%20approach)%0Aconst%20express%20%3D%20require('express')%3B%0A%0Aexpress.response.success%20%3D%20function(data%2C%20message%20%3D%20'Success')%20%7B%0A%20%20return%20this.status(200).json(%7B%0A%20%20%20%20success%3A%20true%2C%0A%20%20%20%20message%2C%0A%20%20%20%20data%0A%20%20%7D)%3B%0A%7D%3B%0A%0Aexpress.response.error%20%3D%20function(message%2C%20statusCode%20%3D%20500)%20%7B%0A%20%20return%20this.status(statusCode).json(%7B%0A%20%20%20%20success%3A%20false%2C%0A%20%20%20%20message%0A%20%20%7D)%3B%0A%7D%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Extend response object with custom methods
app.use((req, res, next) =&gt; {
  // Success response method
  res.success = function(data, message = 'Success') {
    return this.status(200).json({
      success: true,
      message,
      data
    });
  };
  
  // Error response method
  res.error = function(message, statusCode = 500, errors = null) {
    return this.status(statusCode).json({
      success: false,
      message,
      errors
    });
  };
  
  // Paginated response method
  res.paginate = function(data, page, limit, total) {
    const totalPages = Math.ceil(total / limit);
    return this.status(200).json({
      success: true,
      data,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        totalPages,
        hasNext: page &lt; totalPages,
        hasPrev: page &gt; 1
      }
    });
  };
  
  // API response with metadata
  res.apiResponse = function(data, meta = {}) {
    return this.status(200).json({
      success: true,
      data,
      meta: {
        timestamp: new Date().toISOString(),
        version: '1.0',
        ...meta
      }
    });
  };
  
  next();
});

// Usage in routes
app.get('/users', async (req, res) =&gt; {
  try {
    const users = await User.find();
    res.success(users, 'Users retrieved successfully');
  } catch (error) {
    res.error('Failed to retrieve users', 500);
  }
});

app.get('/posts', async (req, res) =&gt; {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    const skip = (page - 1) * limit;
    
    const posts = await Post.find().skip(skip).limit(limit);
    const total = await Post.countDocuments();
    
    res.paginate(posts, page, limit, total);
  } catch (error) {
    res.error('Failed to retrieve posts');
  }
});

// Global method extension (alternative approach)
const express = require('express');

express.response.success = function(data, message = 'Success') {
  return this.status(200).json({
    success: true,
    message,
    data
  });
};

express.response.error = function(message, statusCode = 500) {
  return this.status(statusCode).json({
    success: false,
    message
  });
};
</code></pre>
</div>

<h3 id="164-how-do-you-handle-different-environments-in-express-">164. How do you handle different environments in Express?</h3>

<p><strong>Answer:</strong> Environment configuration allows different settings for development, testing, and production environments.</p>

<p><strong>Environment Setup:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20config%2Fconfig.js%0Aconst%20config%20%3D%20%7B%0A%20%20development%3A%20%7B%0A%20%20%20%20port%3A%20process.env.PORT%20%7C%7C%203000%2C%0A%20%20%20%20database%3A%20%7B%0A%20%20%20%20%20%20host%3A%20'localhost'%2C%0A%20%20%20%20%20%20port%3A%205432%2C%0A%20%20%20%20%20%20name%3A%20'myapp_dev'%0A%20%20%20%20%7D%2C%0A%20%20%20%20logging%3A%20%7B%0A%20%20%20%20%20%20level%3A%20'debug'%2C%0A%20%20%20%20%20%20console%3A%20true%0A%20%20%20%20%7D%2C%0A%20%20%20%20cors%3A%20%7B%0A%20%20%20%20%20%20origin%3A%20%5B'http%3A%2F%2Flocalhost%3A3000'%2C%20'http%3A%2F%2Flocalhost%3A3001'%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20security%3A%20%7B%0A%20%20%20%20%20%20helmet%3A%20false%2C%0A%20%20%20%20%20%20rateLimit%3A%20false%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20test%3A%20%7B%0A%20%20%20%20port%3A%20process.env.PORT%20%7C%7C%203001%2C%0A%20%20%20%20database%3A%20%7B%0A%20%20%20%20%20%20host%3A%20'localhost'%2C%0A%20%20%20%20%20%20port%3A%205432%2C%0A%20%20%20%20%20%20name%3A%20'myapp_test'%0A%20%20%20%20%7D%2C%0A%20%20%20%20logging%3A%20%7B%0A%20%20%20%20%20%20level%3A%20'error'%2C%0A%20%20%20%20%20%20console%3A%20false%0A%20%20%20%20%7D%2C%0A%20%20%20%20cors%3A%20%7B%0A%20%20%20%20%20%20origin%3A%20'*'%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20production%3A%20%7B%0A%20%20%20%20port%3A%20process.env.PORT%20%7C%7C%2080%2C%0A%20%20%20%20database%3A%20%7B%0A%20%20%20%20%20%20host%3A%20process.env.DB_HOST%2C%0A%20%20%20%20%20%20port%3A%20process.env.DB_PORT%2C%0A%20%20%20%20%20%20name%3A%20process.env.DB_NAME%0A%20%20%20%20%7D%2C%0A%20%20%20%20logging%3A%20%7B%0A%20%20%20%20%20%20level%3A%20'info'%2C%0A%20%20%20%20%20%20console%3A%20false%2C%0A%20%20%20%20%20%20file%3A%20true%0A%20%20%20%20%7D%2C%0A%20%20%20%20cors%3A%20%7B%0A%20%20%20%20%20%20origin%3A%20process.env.ALLOWED_ORIGINS%3F.split('%2C')%20%7C%7C%20%5B%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20security%3A%20%7B%0A%20%20%20%20%20%20helmet%3A%20true%2C%0A%20%20%20%20%20%20rateLimit%3A%20true%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%0Aconst%20env%20%3D%20process.env.NODE_ENV%20%7C%7C%20'development'%3B%0Amodule.exports%20%3D%20config%5Benv%5D%3B%0A%0A%2F%2F%20app.js%0Aconst%20config%20%3D%20require('.%2Fconfig%2Fconfig')%3B%0A%0A%2F%2F%20Environment-specific%20middleware%0Aif%20(config.security.helmet)%20%7B%0A%20%20app.use(helmet())%3B%0A%7D%0A%0Aif%20(config.security.rateLimit)%20%7B%0A%20%20const%20rateLimit%20%3D%20require('express-rate-limit')%3B%0A%20%20app.use(rateLimit(%7B%0A%20%20%20%20windowMs%3A%2015%20*%2060%20*%201000%2C%0A%20%20%20%20max%3A%20100%0A%20%20%7D))%3B%0A%7D%0A%0A%2F%2F%20CORS%20configuration%0Aapp.use(cors(%7B%0A%20%20origin%3A%20config.cors.origin%2C%0A%20%20credentials%3A%20true%0A%7D))%3B%0A%0A%2F%2F%20Logging%20configuration%0Aif%20(config.logging.console)%20%7B%0A%20%20app.use(morgan('dev'))%3B%0A%7D%0A%0A%2F%2F%20Environment-specific%20error%20handling%0Aif%20(process.env.NODE_ENV%20%3D%3D%3D%20'production')%20%7B%0A%20%20app.use((err%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'Internal%20Server%20Error'%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%20else%20%7B%0A%20%20app.use((err%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20res.status(500).json(%7B%0A%20%20%20%20%20%20error%3A%20err.message%2C%0A%20%20%20%20%20%20stack%3A%20err.stack%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%0A%0Aapp.listen(config.port%2C%20()%20%3D%3E%20%7B%0A%20%20console.log(%60Server%20running%20in%20%24%7Bprocess.env.NODE_ENV%7D%20mode%20on%20port%20%24%7Bconfig.port%7D%60)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// config/config.js
const config = {
  development: {
    port: process.env.PORT || 3000,
    database: {
      host: 'localhost',
      port: 5432,
      name: 'myapp_dev'
    },
    logging: {
      level: 'debug',
      console: true
    },
    cors: {
      origin: ['http://localhost:3000', 'http://localhost:3001']
    },
    security: {
      helmet: false,
      rateLimit: false
    }
  },
  
  test: {
    port: process.env.PORT || 3001,
    database: {
      host: 'localhost',
      port: 5432,
      name: 'myapp_test'
    },
    logging: {
      level: 'error',
      console: false
    },
    cors: {
      origin: '*'
    }
  },
  
  production: {
    port: process.env.PORT || 80,
    database: {
      host: process.env.DB_HOST,
      port: process.env.DB_PORT,
      name: process.env.DB_NAME
    },
    logging: {
      level: 'info',
      console: false,
      file: true
    },
    cors: {
      origin: process.env.ALLOWED_ORIGINS?.split(',') || []
    },
    security: {
      helmet: true,
      rateLimit: true
    }
  }
};

const env = process.env.NODE_ENV || 'development';
module.exports = config[env];

// app.js
const config = require('./config/config');

// Environment-specific middleware
if (config.security.helmet) {
  app.use(helmet());
}

if (config.security.rateLimit) {
  const rateLimit = require('express-rate-limit');
  app.use(rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 100
  }));
}

// CORS configuration
app.use(cors({
  origin: config.cors.origin,
  credentials: true
}));

// Logging configuration
if (config.logging.console) {
  app.use(morgan('dev'));
}

// Environment-specific error handling
if (process.env.NODE_ENV === 'production') {
  app.use((err, req, res, next) =&gt; {
    res.status(500).json({ error: 'Internal Server Error' });
  });
} else {
  app.use((err, req, res, next) =&gt; {
    res.status(500).json({
      error: err.message,
      stack: err.stack
    });
  });
}

app.listen(config.port, () =&gt; {
  console.log(`Server running in ${process.env.NODE_ENV} mode on port ${config.port}`);
});
</code></pre>
</div>

<p><strong>Environment Variables (.env files):</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">shellscript</span>
        <button class="copy-btn" data-code="%23%20.env.development%0ANODE_ENV%3Ddevelopment%0APORT%3D3000%0ADB_HOST%3Dlocalhost%0ADB_PORT%3D5432%0ADB_NAME%3Dmyapp_dev%0AJWT_SECRET%3Ddev_secret_key%0ALOG_LEVEL%3Ddebug%0A%0A%23%20.env.production%0ANODE_ENV%3Dproduction%0APORT%3D80%0ADB_HOST%3Dprod-db-server%0ADB_PORT%3D5432%0ADB_NAME%3Dmyapp_prod%0AJWT_SECRET%3Dsuper_secure_production_key%0ALOG_LEVEL%3Dinfo%0AALLOWED_ORIGINS%3Dhttps%3A%2F%2Fmyapp.com%2Chttps%3A%2F%2Fwww.myapp.com%0A">Copy</button>
    </div>
    <pre><code class="language-shellscript"># .env.development
NODE_ENV=development
PORT=3000
DB_HOST=localhost
DB_PORT=5432
DB_NAME=myapp_dev
JWT_SECRET=dev_secret_key
LOG_LEVEL=debug

# .env.production
NODE_ENV=production
PORT=80
DB_HOST=prod-db-server
DB_PORT=5432
DB_NAME=myapp_prod
JWT_SECRET=super_secure_production_key
LOG_LEVEL=info
ALLOWED_ORIGINS=https://myapp.com,https://www.myapp.com
</code></pre>
</div>

<h3 id="165-what-is-the-difference-between-res-send-res-json-and-res-end-">165. What is the difference between `res.send()`, `res.json()`, and `res.end()`?</h3>

<p><strong>Answer:</strong></p>

<p><strong>`res.send()`:</strong></p>

<p>- General-purpose response method</p>
<p>- Automatically sets Content-Type based on data type</p>
<p>- Can send strings, objects, arrays, buffers</p>
<p>- Calls `res.end()` internally</p>


<p><strong>`res.json()`:</strong></p>

<p>- Specifically for JSON responses</p>
<p>- Always sets Content-Type to application/json</p>
<p>- Converts data to JSON string</p>
<p>- Calls `res.send()` internally</p>


<p><strong>`res.end()`:</strong></p>

<p>- Low-level method to end response</p>
<p>- Doesn't set Content-Type automatically</p>
<p>- Sends raw data without processing</p>
<p>- Must be called to complete response</p>


<p><strong>Examples:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="app.get('%2Fsend-string'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.send('Hello%20World')%3B%20%2F%2F%20Content-Type%3A%20text%2Fhtml%0A%7D)%3B%0A%0Aapp.get('%2Fsend-object'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.send(%7B%20message%3A%20'Hello'%20%7D)%3B%20%2F%2F%20Content-Type%3A%20application%2Fjson%0A%7D)%3B%0A%0Aapp.get('%2Fsend-array'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.send(%5B1%2C%202%2C%203%5D)%3B%20%2F%2F%20Content-Type%3A%20application%2Fjson%0A%7D)%3B%0A%0Aapp.get('%2Fjson-response'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Hello'%20%7D)%3B%20%2F%2F%20Content-Type%3A%20application%2Fjson%0A%7D)%3B%0A%0Aapp.get('%2Fjson-with-status'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.status(201).json(%7B%20created%3A%20true%20%7D)%3B%20%2F%2F%20Status%20201%20%2B%20JSON%0A%7D)%3B%0A%0Aapp.get('%2Fend-response'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.setHeader('Content-Type'%2C%20'text%2Fplain')%3B%0A%20%20res.end('Raw%20response')%3B%20%2F%2F%20Must%20set%20Content-Type%20manually%0A%7D)%3B%0A%0A%2F%2F%20Comparison%0Aapp.get('%2Fcomparison'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20data%20%3D%20%7B%20name%3A%20'John'%2C%20age%3A%2030%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20These%20are%20equivalent%20for%20objects%3A%0A%20%20%2F%2F%20res.send(data)%3B%0A%20%20%2F%2F%20res.json(data)%3B%0A%20%20%0A%20%20%2F%2F%20res.end()%20requires%20manual%20JSON%20conversion%3A%0A%20%20%2F%2F%20res.setHeader('Content-Type'%2C%20'application%2Fjson')%3B%0A%20%20%2F%2F%20res.end(JSON.stringify(data))%3B%0A%20%20%0A%20%20res.json(data)%3B%20%2F%2F%20Preferred%20for%20JSON%20responses%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">app.get('/send-string', (req, res) =&gt; {
  res.send('Hello World'); // Content-Type: text/html
});

app.get('/send-object', (req, res) =&gt; {
  res.send({ message: 'Hello' }); // Content-Type: application/json
});

app.get('/send-array', (req, res) =&gt; {
  res.send([1, 2, 3]); // Content-Type: application/json
});

app.get('/json-response', (req, res) =&gt; {
  res.json({ message: 'Hello' }); // Content-Type: application/json
});

app.get('/json-with-status', (req, res) =&gt; {
  res.status(201).json({ created: true }); // Status 201 + JSON
});

app.get('/end-response', (req, res) =&gt; {
  res.setHeader('Content-Type', 'text/plain');
  res.end('Raw response'); // Must set Content-Type manually
});

// Comparison
app.get('/comparison', (req, res) =&gt; {
  const data = { name: 'John', age: 30 };
  
  // These are equivalent for objects:
  // res.send(data);
  // res.json(data);
  
  // res.end() requires manual JSON conversion:
  // res.setHeader('Content-Type', 'application/json');
  // res.end(JSON.stringify(data));
  
  res.json(data); // Preferred for JSON responses
});
</code></pre>
</div>

<h3 id="166-how-do-you-implement-graceful-shutdown-in-express-">166. How do you implement graceful shutdown in Express?</h3>

<p><strong>Answer:</strong> Graceful shutdown ensures the application closes cleanly, finishing ongoing requests and closing database connections properly.</p>

<p><strong>Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20express%20%3D%20require('express')%3B%0Aconst%20app%20%3D%20express()%3B%0A%0Alet%20server%3B%0Alet%20isShuttingDown%20%3D%20false%3B%0A%0A%2F%2F%20Middleware%20to%20reject%20new%20requests%20during%20shutdown%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(isShuttingDown)%20%7B%0A%20%20%20%20res.set('Connection'%2C%20'close')%3B%0A%20%20%20%20return%20res.status(503).json(%7B%0A%20%20%20%20%20%20error%3A%20'Server%20is%20shutting%20down'%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Your%20routes%20here%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Server%20is%20running'%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Start%20server%0Aserver%20%3D%20app.listen(3000%2C%20()%20%3D%3E%20%7B%0A%20%20console.log('Server%20started%20on%20port%203000')%3B%0A%7D)%3B%0A%0A%2F%2F%20Graceful%20shutdown%20function%0Aconst%20gracefulShutdown%20%3D%20(signal)%20%3D%3E%20%7B%0A%20%20console.log(%60Received%20%24%7Bsignal%7D.%20Starting%20graceful%20shutdown...%60)%3B%0A%20%20isShuttingDown%20%3D%20true%3B%0A%20%20%0A%20%20%2F%2F%20Stop%20accepting%20new%20connections%0A%20%20server.close((err)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20console.error('Error%20during%20server%20close%3A'%2C%20err)%3B%0A%20%20%20%20%20%20process.exit(1)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20console.log('HTTP%20server%20closed')%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Close%20database%20connections%0A%20%20%20%20closeDatabase()%0A%20%20%20%20%20%20.then(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20console.log('Database%20connections%20closed')%3B%0A%20%20%20%20%20%20%20%20console.log('Graceful%20shutdown%20completed')%3B%0A%20%20%20%20%20%20%20%20process.exit(0)%3B%0A%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20.catch((err)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20console.error('Error%20closing%20database%3A'%2C%20err)%3B%0A%20%20%20%20%20%20%20%20process.exit(1)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Force%20shutdown%20after%20timeout%0A%20%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20console.error('Forced%20shutdown%20due%20to%20timeout')%3B%0A%20%20%20%20process.exit(1)%3B%0A%20%20%7D%2C%2010000)%3B%20%2F%2F%2010%20seconds%20timeout%0A%7D%3B%0A%0A%2F%2F%20Database%20cleanup%20function%0Aconst%20closeDatabase%20%3D%20async%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20Close%20MongoDB%20connection%0A%20%20if%20(mongoose.connection.readyState%20%3D%3D%3D%201)%20%7B%0A%20%20%20%20await%20mongoose.connection.close()%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Close%20Redis%20connection%0A%20%20if%20(redisClient%20%26%26%20redisClient.connected)%20%7B%0A%20%20%20%20await%20redisClient.quit()%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Close%20other%20connections...%0A%7D%3B%0A%0A%2F%2F%20Handle%20shutdown%20signals%0Aprocess.on('SIGTERM'%2C%20()%20%3D%3E%20gracefulShutdown('SIGTERM'))%3B%0Aprocess.on('SIGINT'%2C%20()%20%3D%3E%20gracefulShutdown('SIGINT'))%3B%0A%0A%2F%2F%20Handle%20uncaught%20exceptions%0Aprocess.on('uncaughtException'%2C%20(err)%20%3D%3E%20%7B%0A%20%20console.error('Uncaught%20Exception%3A'%2C%20err)%3B%0A%20%20gracefulShutdown('uncaughtException')%3B%0A%7D)%3B%0A%0Aprocess.on('unhandledRejection'%2C%20(reason%2C%20promise)%20%3D%3E%20%7B%0A%20%20console.error('Unhandled%20Rejection%20at%3A'%2C%20promise%2C%20'reason%3A'%2C%20reason)%3B%0A%20%20gracefulShutdown('unhandledRejection')%3B%0A%7D)%3B%0A%0A%2F%2F%20Health%20check%20endpoint%0Aapp.get('%2Fhealth'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20if%20(isShuttingDown)%20%7B%0A%20%20%20%20return%20res.status(503).json(%7B%20status%3A%20'shutting%20down'%20%7D)%3B%0A%20%20%7D%0A%20%20res.json(%7B%20status%3A%20'healthy'%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const express = require('express');
const app = express();

let server;
let isShuttingDown = false;

// Middleware to reject new requests during shutdown
app.use((req, res, next) =&gt; {
  if (isShuttingDown) {
    res.set('Connection', 'close');
    return res.status(503).json({
      error: 'Server is shutting down'
    });
  }
  next();
});

// Your routes here
app.get('/', (req, res) =&gt; {
  res.json({ message: 'Server is running' });
});

// Start server
server = app.listen(3000, () =&gt; {
  console.log('Server started on port 3000');
});

// Graceful shutdown function
const gracefulShutdown = (signal) =&gt; {
  console.log(`Received ${signal}. Starting graceful shutdown...`);
  isShuttingDown = true;
  
  // Stop accepting new connections
  server.close((err) =&gt; {
    if (err) {
      console.error('Error during server close:', err);
      process.exit(1);
    }
    
    console.log('HTTP server closed');
    
    // Close database connections
    closeDatabase()
      .then(() =&gt; {
        console.log('Database connections closed');
        console.log('Graceful shutdown completed');
        process.exit(0);
      })
      .catch((err) =&gt; {
        console.error('Error closing database:', err);
        process.exit(1);
      });
  });
  
  // Force shutdown after timeout
  setTimeout(() =&gt; {
    console.error('Forced shutdown due to timeout');
    process.exit(1);
  }, 10000); // 10 seconds timeout
};

// Database cleanup function
const closeDatabase = async () =&gt; {
  // Close MongoDB connection
  if (mongoose.connection.readyState === 1) {
    await mongoose.connection.close();
  }
  
  // Close Redis connection
  if (redisClient && redisClient.connected) {
    await redisClient.quit();
  }
  
  // Close other connections...
};

// Handle shutdown signals
process.on('SIGTERM', () =&gt; gracefulShutdown('SIGTERM'));
process.on('SIGINT', () =&gt; gracefulShutdown('SIGINT'));

// Handle uncaught exceptions
process.on('uncaughtException', (err) =&gt; {
  console.error('Uncaught Exception:', err);
  gracefulShutdown('uncaughtException');
});

process.on('unhandledRejection', (reason, promise) =&gt; {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
  gracefulShutdown('unhandledRejection');
});

// Health check endpoint
app.get('/health', (req, res) =&gt; {
  if (isShuttingDown) {
    return res.status(503).json({ status: 'shutting down' });
  }
  res.json({ status: 'healthy' });
});
</code></pre>
</div>

<h3 id="167-how-do-you-implement-request-timeout-handling-">167. How do you implement request timeout handling?</h3>

<p><strong>Answer:</strong> Request timeouts prevent long-running requests from consuming server resources indefinitely.</p>

<p><strong>Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Basic%20timeout%20middleware%0Aconst%20requestTimeout%20%3D%20(timeout%20%3D%2030000)%20%3D%3E%20%7B%0A%20%20return%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Set%20timeout%0A%20%20%20%20const%20timer%20%3D%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(!res.headersSent)%20%7B%0A%20%20%20%20%20%20%20%20res.status(408).json(%7B%0A%20%20%20%20%20%20%20%20%20%20error%3A%20'Request%20Timeout'%2C%0A%20%20%20%20%20%20%20%20%20%20message%3A%20%60Request%20took%20longer%20than%20%24%7Btimeout%7Dms%60%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%20timeout)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Clear%20timeout%20when%20response%20is%20sent%0A%20%20%20%20res.on('finish'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20clearTimeout(timer)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20res.on('close'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20clearTimeout(timer)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Apply%20timeout%20globally%0Aapp.use(requestTimeout(30000))%3B%20%2F%2F%2030%20seconds%0A%0A%2F%2F%20Route-specific%20timeout%0Aapp.get('%2Fslow-operation'%2C%20%0A%20%20requestTimeout(60000)%2C%20%2F%2F%2060%20seconds%20for%20this%20route%0A%20%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20const%20result%20%3D%20await%20performSlowOperation()%3B%0A%20%20%20%20%20%20res.json(result)%3B%0A%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A)%3B%0A%0A%2F%2F%20Advanced%20timeout%20with%20cleanup%0Aconst%20advancedTimeout%20%3D%20(timeout%20%3D%2030000)%20%3D%3E%20%7B%0A%20%20return%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20let%20isTimedOut%20%3D%20false%3B%0A%20%20%20%20%0A%20%20%20%20const%20timer%20%3D%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20isTimedOut%20%3D%20true%3B%0A%20%20%20%20%20%20if%20(!res.headersSent)%20%7B%0A%20%20%20%20%20%20%20%20res.status(408).json(%7B%0A%20%20%20%20%20%20%20%20%20%20error%3A%20'Request%20Timeout'%2C%0A%20%20%20%20%20%20%20%20%20%20requestId%3A%20req.id%2C%0A%20%20%20%20%20%20%20%20%20%20timeout%3A%20timeout%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%20timeout)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Add%20timeout%20info%20to%20request%0A%20%20%20%20req.setTimeout%20%3D%20(newTimeout)%20%3D%3E%20%7B%0A%20%20%20%20%20%20clearTimeout(timer)%3B%0A%20%20%20%20%20%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20(!res.headersSent%20%26%26%20!isTimedOut)%20%7B%0A%20%20%20%20%20%20%20%20%20%20res.status(408).json(%7B%20error%3A%20'Request%20Timeout'%20%7D)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%2C%20newTimeout)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Cleanup%0A%20%20%20%20const%20cleanup%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20clearTimeout(timer)%3B%0A%20%20%20%20%20%20isTimedOut%20%3D%20true%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20res.on('finish'%2C%20cleanup)%3B%0A%20%20%20%20res.on('close'%2C%20cleanup)%3B%0A%20%20%20%20res.on('error'%2C%20cleanup)%3B%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Using%20connect-timeout%20package%0Aconst%20timeout%20%3D%20require('connect-timeout')%3B%0A%0Aapp.use(timeout('30s'))%3B%0A%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(!req.timedout)%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Timeout%20error%20handler%0Aapp.use((err%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(req.timedout)%20%7B%0A%20%20%20%20res.status(408).json(%7B%0A%20%20%20%20%20%20error%3A%20'Request%20Timeout'%2C%0A%20%20%20%20%20%20message%3A%20'The%20request%20took%20too%20long%20to%20process'%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20next(err)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Basic timeout middleware
const requestTimeout = (timeout = 30000) =&gt; {
  return (req, res, next) =&gt; {
    // Set timeout
    const timer = setTimeout(() =&gt; {
      if (!res.headersSent) {
        res.status(408).json({
          error: 'Request Timeout',
          message: `Request took longer than ${timeout}ms`
        });
      }
    }, timeout);
    
    // Clear timeout when response is sent
    res.on('finish', () =&gt; {
      clearTimeout(timer);
    });
    
    res.on('close', () =&gt; {
      clearTimeout(timer);
    });
    
    next();
  };
};

// Apply timeout globally
app.use(requestTimeout(30000)); // 30 seconds

// Route-specific timeout
app.get('/slow-operation', 
  requestTimeout(60000), // 60 seconds for this route
  async (req, res) =&gt; {
    try {
      const result = await performSlowOperation();
      res.json(result);
    } catch (error) {
      res.status(500).json({ error: error.message });
    }
  }
);

// Advanced timeout with cleanup
const advancedTimeout = (timeout = 30000) =&gt; {
  return (req, res, next) =&gt; {
    let isTimedOut = false;
    
    const timer = setTimeout(() =&gt; {
      isTimedOut = true;
      if (!res.headersSent) {
        res.status(408).json({
          error: 'Request Timeout',
          requestId: req.id,
          timeout: timeout
        });
      }
    }, timeout);
    
    // Add timeout info to request
    req.setTimeout = (newTimeout) =&gt; {
      clearTimeout(timer);
      setTimeout(() =&gt; {
        if (!res.headersSent && !isTimedOut) {
          res.status(408).json({ error: 'Request Timeout' });
        }
      }, newTimeout);
    };
    
    // Cleanup
    const cleanup = () =&gt; {
      clearTimeout(timer);
      isTimedOut = true;
    };
    
    res.on('finish', cleanup);
    res.on('close', cleanup);
    res.on('error', cleanup);
    
    next();
  };
};

// Using connect-timeout package
const timeout = require('connect-timeout');

app.use(timeout('30s'));

app.use((req, res, next) =&gt; {
  if (!req.timedout) next();
});

// Timeout error handler
app.use((err, req, res, next) =&gt; {
  if (req.timedout) {
    res.status(408).json({
      error: 'Request Timeout',
      message: 'The request took too long to process'
    });
  } else {
    next(err);
  }
});
</code></pre>
</div>

<h3 id="168-what-are-express-generators-and-how-do-you-use-them-">168. What are Express generators and how do you use them?</h3>

<p><strong>Answer:</strong> Express generators are command-line tools that create Express application skeletons quickly with predefined structure and configurations.</p>

<p><strong>Installation and Usage:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">shellscript</span>
        <button class="copy-btn" data-code="%23%20Install%20Express%20generator%20globally%0Anpm%20install%20-g%20express-generator%0A%0A%23%20Generate%20basic%20Express%20app%0Aexpress%20myapp%0A%0A%23%20Generate%20with%20specific%20template%20engine%0Aexpress%20--view%3Dejs%20myapp%0Aexpress%20--view%3Dpug%20myapp%0Aexpress%20--view%3Dhbs%20myapp%0A%0A%23%20Generate%20with%20CSS%20preprocessor%0Aexpress%20--css%3Dsass%20myapp%0Aexpress%20--css%3Dless%20myapp%0Aexpress%20--css%3Dstylus%20myapp%0A%0A%23%20Generate%20without%20view%20engine%20(API%20only)%0Aexpress%20--no-view%20myapp%0A%0A%23%20Generate%20with%20Git%20ignore%0Aexpress%20--git%20myapp%0A%0A%23%20Complete%20example%0Aexpress%20--view%3Dejs%20--css%3Dsass%20--git%20myapi%0A">Copy</button>
    </div>
    <pre><code class="language-shellscript"># Install Express generator globally
npm install -g express-generator

# Generate basic Express app
express myapp

# Generate with specific template engine
express --view=ejs myapp
express --view=pug myapp
express --view=hbs myapp

# Generate with CSS preprocessor
express --css=sass myapp
express --css=less myapp
express --css=stylus myapp

# Generate without view engine (API only)
express --no-view myapp

# Generate with Git ignore
express --git myapp

# Complete example
express --view=ejs --css=sass --git myapi
</code></pre>
</div>

<p><strong>Generated Structure:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">plaintext</span>
        <button class="copy-btn" data-code="myapp%2F%0A%E2%94%9C%E2%94%80%E2%94%80%20app.js%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Main%20application%20file%0A%E2%94%9C%E2%94%80%E2%94%80%20package.json%20%20%20%20%20%20%20%20%23%20Dependencies%20and%20scripts%0A%E2%94%9C%E2%94%80%E2%94%80%20bin%2F%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20www%20%20%20%20%20%20%20%20%20%20%20%20%23%20Server%20startup%20script%0A%E2%94%9C%E2%94%80%E2%94%80%20public%2F%20%20%20%20%20%20%20%20%20%20%20%20%23%20Static%20files%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20images%2F%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20javascripts%2F%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20stylesheets%2F%0A%E2%94%82%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20style.css%0A%E2%94%9C%E2%94%80%E2%94%80%20routes%2F%20%20%20%20%20%20%20%20%20%20%20%20%23%20Route%20modules%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20index.js%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20users.js%0A%E2%94%94%E2%94%80%E2%94%80%20views%2F%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Template%20files%0A%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20error.jade%0A%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20index.jade%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20layout.jade%0A">Copy</button>
    </div>
    <pre><code class="language-plaintext">myapp/
â”œâ”€â”€ app.js              # Main application file
â”œâ”€â”€ package.json        # Dependencies and scripts
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ www            # Server startup script
â”œâ”€â”€ public/            # Static files
â”‚   â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ javascripts/
â”‚   â””â”€â”€ stylesheets/
â”‚       â””â”€â”€ style.css
â”œâ”€â”€ routes/            # Route modules
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ users.js
â””â”€â”€ views/             # Template files
    â”œâ”€â”€ error.jade
    â”œâ”€â”€ index.jade
    â””â”€â”€ layout.jade
</code></pre>
</div>

<p><strong>Generated app.js Structure:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="var%20createError%20%3D%20require('http-errors')%3B%0Avar%20express%20%3D%20require('express')%3B%0Avar%20path%20%3D%20require('path')%3B%0Avar%20cookieParser%20%3D%20require('cookie-parser')%3B%0Avar%20logger%20%3D%20require('morgan')%3B%0A%0Avar%20indexRouter%20%3D%20require('.%2Froutes%2Findex')%3B%0Avar%20usersRouter%20%3D%20require('.%2Froutes%2Fusers')%3B%0A%0Avar%20app%20%3D%20express()%3B%0A%0A%2F%2F%20view%20engine%20setup%0Aapp.set('views'%2C%20path.join(__dirname%2C%20'views'))%3B%0Aapp.set('view%20engine'%2C%20'jade')%3B%0A%0Aapp.use(logger('dev'))%3B%0Aapp.use(express.json())%3B%0Aapp.use(express.urlencoded(%7B%20extended%3A%20false%20%7D))%3B%0Aapp.use(cookieParser())%3B%0Aapp.use(express.static(path.join(__dirname%2C%20'public')))%3B%0A%0Aapp.use('%2F'%2C%20indexRouter)%3B%0Aapp.use('%2Fusers'%2C%20usersRouter)%3B%0A%0A%2F%2F%20catch%20404%20and%20forward%20to%20error%20handler%0Aapp.use(function(req%2C%20res%2C%20next)%20%7B%0A%20%20next(createError(404))%3B%0A%7D)%3B%0A%0A%2F%2F%20error%20handler%0Aapp.use(function(err%2C%20req%2C%20res%2C%20next)%20%7B%0A%20%20res.locals.message%20%3D%20err.message%3B%0A%20%20res.locals.error%20%3D%20req.app.get('env')%20%3D%3D%3D%20'development'%20%3F%20err%20%3A%20%7B%7D%3B%0A%20%20res.status(err.status%20%7C%7C%20500)%3B%0A%20%20res.render('error')%3B%0A%7D)%3B%0A%0Amodule.exports%20%3D%20app%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">var createError = require('http-errors');
var express = require('express');
var path = require('path');
var cookieParser = require('cookie-parser');
var logger = require('morgan');

var indexRouter = require('./routes/index');
var usersRouter = require('./routes/users');

var app = express();

// view engine setup
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'jade');

app.use(logger('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, 'public')));

app.use('/', indexRouter);
app.use('/users', usersRouter);

// catch 404 and forward to error handler
app.use(function(req, res, next) {
  next(createError(404));
});

// error handler
app.use(function(err, req, res, next) {
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};
  res.status(err.status || 500);
  res.render('error');
});

module.exports = app;
</code></pre>
</div>

<p><strong>Custom Generator Creation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Create%20custom%20generator%0Aconst%20express%20%3D%20require('express')%3B%0Aconst%20fs%20%3D%20require('fs')%3B%0Aconst%20path%20%3D%20require('path')%3B%0A%0Aconst%20createExpressApp%20%3D%20(appName%2C%20options%20%3D%20%7B%7D)%20%3D%3E%20%7B%0A%20%20const%20appDir%20%3D%20path.join(process.cwd()%2C%20appName)%3B%0A%20%20%0A%20%20%2F%2F%20Create%20directory%20structure%0A%20%20fs.mkdirSync(appDir)%3B%0A%20%20fs.mkdirSync(path.join(appDir%2C%20'routes'))%3B%0A%20%20fs.mkdirSync(path.join(appDir%2C%20'middleware'))%3B%0A%20%20fs.mkdirSync(path.join(appDir%2C%20'controllers'))%3B%0A%20%20%0A%20%20%2F%2F%20Generate%20package.json%0A%20%20const%20packageJson%20%3D%20%7B%0A%20%20%20%20name%3A%20appName%2C%0A%20%20%20%20version%3A%20'1.0.0'%2C%0A%20%20%20%20scripts%3A%20%7B%0A%20%20%20%20%20%20start%3A%20'node%20app.js'%2C%0A%20%20%20%20%20%20dev%3A%20'nodemon%20app.js'%0A%20%20%20%20%7D%2C%0A%20%20%20%20dependencies%3A%20%7B%0A%20%20%20%20%20%20express%3A%20'%5E4.18.0'%2C%0A%20%20%20%20%20%20cors%3A%20'%5E2.8.5'%2C%0A%20%20%20%20%20%20helmet%3A%20'%5E6.0.0'%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%20%20%0A%20%20fs.writeFileSync(%0A%20%20%20%20path.join(appDir%2C%20'package.json')%2C%0A%20%20%20%20JSON.stringify(packageJson%2C%20null%2C%202)%0A%20%20)%3B%0A%20%20%0A%20%20%2F%2F%20Generate%20app.js%0A%20%20const%20appTemplate%20%3D%20%60%0Aconst%20express%20%3D%20require('express')%3B%0Aconst%20cors%20%3D%20require('cors')%3B%0Aconst%20helmet%20%3D%20require('helmet')%3B%0A%0Aconst%20app%20%3D%20express()%3B%0Aconst%20PORT%20%3D%20process.env.PORT%20%7C%7C%203000%3B%0A%0A%2F%2F%20Middleware%0Aapp.use(helmet())%3B%0Aapp.use(cors())%3B%0Aapp.use(express.json())%3B%0A%0A%2F%2F%20Routes%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Welcome%20to%20%24%7BappName%7D'%20%7D)%3B%0A%7D)%3B%0A%0Aapp.listen(PORT%2C%20()%20%3D%3E%20%7B%0A%20%20console.log(%5C%60Server%20running%20on%20port%20%5C%24%7BPORT%7D%5C%60)%3B%0A%7D)%3B%0A%20%20%60%3B%0A%20%20%0A%20%20fs.writeFileSync(path.join(appDir%2C%20'app.js')%2C%20appTemplate.trim())%3B%0A%7D%3B%0A%0A%2F%2F%20Usage%0AcreateExpressApp('my-api')%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Create custom generator
const express = require('express');
const fs = require('fs');
const path = require('path');

const createExpressApp = (appName, options = {}) =&gt; {
  const appDir = path.join(process.cwd(), appName);
  
  // Create directory structure
  fs.mkdirSync(appDir);
  fs.mkdirSync(path.join(appDir, 'routes'));
  fs.mkdirSync(path.join(appDir, 'middleware'));
  fs.mkdirSync(path.join(appDir, 'controllers'));
  
  // Generate package.json
  const packageJson = {
    name: appName,
    version: '1.0.0',
    scripts: {
      start: 'node app.js',
      dev: 'nodemon app.js'
    },
    dependencies: {
      express: '^4.18.0',
      cors: '^2.8.5',
      helmet: '^6.0.0'
    }
  };
  
  fs.writeFileSync(
    path.join(appDir, 'package.json'),
    JSON.stringify(packageJson, null, 2)
  );
  
  // Generate app.js
  const appTemplate = `
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(helmet());
app.use(cors());
app.use(express.json());

// Routes
app.get('/', (req, res) =&gt; {
  res.json({ message: 'Welcome to ${appName}' });
});

app.listen(PORT, () =&gt; {
  console.log(\`Server running on port \${PORT}\`);
});
  `;
  
  fs.writeFileSync(path.join(appDir, 'app.js'), appTemplate.trim());
};

// Usage
createExpressApp('my-api');
</code></pre>
</div>

<h3 id="169-how-do-you-implement-websocket-support-in-express-">169. How do you implement WebSocket support in Express?</h3>

<p><strong>Answer:</strong> WebSockets enable real-time, bidirectional communication between client and server. Express can be integrated with WebSocket libraries like Socket.io or ws.</p>

<p><strong>Using Socket.io:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20express%20%3D%20require('express')%3B%0Aconst%20http%20%3D%20require('http')%3B%0Aconst%20socketIo%20%3D%20require('socket.io')%3B%0A%0Aconst%20app%20%3D%20express()%3B%0Aconst%20server%20%3D%20http.createServer(app)%3B%0Aconst%20io%20%3D%20socketIo(server%2C%20%7B%0A%20%20cors%3A%20%7B%0A%20%20%20%20origin%3A%20%22http%3A%2F%2Flocalhost%3A3000%22%2C%0A%20%20%20%20methods%3A%20%5B%22GET%22%2C%20%22POST%22%5D%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Express%20routes%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.sendFile(__dirname%20%2B%20'%2Findex.html')%3B%0A%7D)%3B%0A%0A%2F%2F%20Socket.io%20connection%20handling%0Aio.on('connection'%2C%20(socket)%20%3D%3E%20%7B%0A%20%20console.log('User%20connected%3A'%2C%20socket.id)%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20custom%20events%0A%20%20socket.on('message'%2C%20(data)%20%3D%3E%20%7B%0A%20%20%20%20console.log('Message%20received%3A'%2C%20data)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Broadcast%20to%20all%20clients%0A%20%20%20%20io.emit('message'%2C%20%7B%0A%20%20%20%20%20%20id%3A%20socket.id%2C%0A%20%20%20%20%20%20message%3A%20data.message%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20private%20messages%0A%20%20socket.on('private_message'%2C%20(data)%20%3D%3E%20%7B%0A%20%20%20%20socket.to(data.recipientId).emit('private_message'%2C%20%7B%0A%20%20%20%20%20%20from%3A%20socket.id%2C%0A%20%20%20%20%20%20message%3A%20data.message%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20room%20joining%0A%20%20socket.on('join_room'%2C%20(room)%20%3D%3E%20%7B%0A%20%20%20%20socket.join(room)%3B%0A%20%20%20%20socket.to(room).emit('user_joined'%2C%20%7B%0A%20%20%20%20%20%20userId%3A%20socket.id%2C%0A%20%20%20%20%20%20room%3A%20room%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20disconnection%0A%20%20socket.on('disconnect'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20console.log('User%20disconnected%3A'%2C%20socket.id)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0Aserver.listen(3000%2C%20()%20%3D%3E%20%7B%0A%20%20console.log('Server%20running%20on%20port%203000')%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const express = require('express');
const http = require('http');
const socketIo = require('socket.io');

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: "http://localhost:3000",
    methods: ["GET", "POST"]
  }
});

// Express routes
app.get('/', (req, res) =&gt; {
  res.sendFile(__dirname + '/index.html');
});

// Socket.io connection handling
io.on('connection', (socket) =&gt; {
  console.log('User connected:', socket.id);
  
  // Handle custom events
  socket.on('message', (data) =&gt; {
    console.log('Message received:', data);
    
    // Broadcast to all clients
    io.emit('message', {
      id: socket.id,
      message: data.message,
      timestamp: new Date().toISOString()
    });
  });
  
  // Handle private messages
  socket.on('private_message', (data) =&gt; {
    socket.to(data.recipientId).emit('private_message', {
      from: socket.id,
      message: data.message
    });
  });
  
  // Handle room joining
  socket.on('join_room', (room) =&gt; {
    socket.join(room);
    socket.to(room).emit('user_joined', {
      userId: socket.id,
      room: room
    });
  });
  
  // Handle disconnection
  socket.on('disconnect', () =&gt; {
    console.log('User disconnected:', socket.id);
  });
});

server.listen(3000, () =&gt; {
  console.log('Server running on port 3000');
});
</code></pre>
</div>

<p><strong>Using native WebSocket (ws library):</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20express%20%3D%20require('express')%3B%0Aconst%20WebSocket%20%3D%20require('ws')%3B%0Aconst%20http%20%3D%20require('http')%3B%0A%0Aconst%20app%20%3D%20express()%3B%0Aconst%20server%20%3D%20http.createServer(app)%3B%0Aconst%20wss%20%3D%20new%20WebSocket.Server(%7B%20server%20%7D)%3B%0A%0A%2F%2F%20Express%20routes%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.send('WebSocket%20server%20running')%3B%0A%7D)%3B%0A%0A%2F%2F%20WebSocket%20connection%20handling%0Awss.on('connection'%2C%20(ws%2C%20req)%20%3D%3E%20%7B%0A%20%20console.log('New%20WebSocket%20connection')%3B%0A%20%20%0A%20%20%2F%2F%20Send%20welcome%20message%0A%20%20ws.send(JSON.stringify(%7B%0A%20%20%20%20type%3A%20'welcome'%2C%0A%20%20%20%20message%3A%20'Connected%20to%20WebSocket%20server'%0A%20%20%7D))%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20messages%0A%20%20ws.on('message'%2C%20(data)%20%3D%3E%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20const%20message%20%3D%20JSON.parse(data)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20switch%20(message.type)%20%7B%0A%20%20%20%20%20%20%20%20case%20'chat'%3A%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20Broadcast%20to%20all%20clients%0A%20%20%20%20%20%20%20%20%20%20wss.clients.forEach((client)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(client%20!%3D%3D%20ws%20%26%26%20client.readyState%20%3D%3D%3D%20WebSocket.OPEN)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20client.send(JSON.stringify(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'chat'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20message%3A%20message.content%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20case%20'ping'%3A%0A%20%20%20%20%20%20%20%20%20%20ws.send(JSON.stringify(%7B%20type%3A%20'pong'%20%7D))%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20console.error('Error%20parsing%20message%3A'%2C%20error)%3B%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20connection%20close%0A%20%20ws.on('close'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20console.log('WebSocket%20connection%20closed')%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20errors%0A%20%20ws.on('error'%2C%20(error)%20%3D%3E%20%7B%0A%20%20%20%20console.error('WebSocket%20error%3A'%2C%20error)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0Aserver.listen(3000%2C%20()%20%3D%3E%20%7B%0A%20%20console.log('Server%20with%20WebSocket%20support%20running%20on%20port%203000')%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const express = require('express');
const WebSocket = require('ws');
const http = require('http');

const app = express();
const server = http.createServer(app);
const wss = new WebSocket.Server({ server });

// Express routes
app.get('/', (req, res) =&gt; {
  res.send('WebSocket server running');
});

// WebSocket connection handling
wss.on('connection', (ws, req) =&gt; {
  console.log('New WebSocket connection');
  
  // Send welcome message
  ws.send(JSON.stringify({
    type: 'welcome',
    message: 'Connected to WebSocket server'
  }));
  
  // Handle messages
  ws.on('message', (data) =&gt; {
    try {
      const message = JSON.parse(data);
      
      switch (message.type) {
        case 'chat':
          // Broadcast to all clients
          wss.clients.forEach((client) =&gt; {
            if (client !== ws && client.readyState === WebSocket.OPEN) {
              client.send(JSON.stringify({
                type: 'chat',
                message: message.content,
                timestamp: new Date().toISOString()
              }));
            }
          });
          break;
          
        case 'ping':
          ws.send(JSON.stringify({ type: 'pong' }));
          break;
      }
    } catch (error) {
      console.error('Error parsing message:', error);
    }
  });
  
  // Handle connection close
  ws.on('close', () =&gt; {
    console.log('WebSocket connection closed');
  });
  
  // Handle errors
  ws.on('error', (error) =&gt; {
    console.error('WebSocket error:', error);
  });
});

server.listen(3000, () =&gt; {
  console.log('Server with WebSocket support running on port 3000');
});
</code></pre>
</div>

<p><strong>Integration with Express Authentication:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20jwt%20%3D%20require('jsonwebtoken')%3B%0A%0A%2F%2F%20Middleware%20for%20WebSocket%20authentication%0Aconst%20authenticateSocket%20%3D%20(socket%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20token%20%3D%20socket.handshake.auth.token%3B%0A%20%20%0A%20%20if%20(!token)%20%7B%0A%20%20%20%20return%20next(new%20Error('Authentication%20error'))%3B%0A%20%20%7D%0A%20%20%0A%20%20try%20%7B%0A%20%20%20%20const%20decoded%20%3D%20jwt.verify(token%2C%20process.env.JWT_SECRET)%3B%0A%20%20%20%20socket.userId%20%3D%20decoded.id%3B%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20next(new%20Error('Authentication%20error'))%3B%0A%20%20%7D%0A%7D%3B%0A%0Aio.use(authenticateSocket)%3B%0A%0Aio.on('connection'%2C%20(socket)%20%3D%3E%20%7B%0A%20%20console.log(%60Authenticated%20user%20%24%7Bsocket.userId%7D%20connected%60)%3B%0A%20%20%0A%20%20%2F%2F%20User-specific%20room%0A%20%20socket.join(%60user_%24%7Bsocket.userId%7D%60)%3B%0A%20%20%0A%20%20%2F%2F%20Send%20personalized%20data%0A%20%20socket.emit('user_data'%2C%20%7B%0A%20%20%20%20userId%3A%20socket.userId%2C%0A%20%20%20%20message%3A%20'Welcome%20back!'%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const jwt = require('jsonwebtoken');

// Middleware for WebSocket authentication
const authenticateSocket = (socket, next) =&gt; {
  const token = socket.handshake.auth.token;
  
  if (!token) {
    return next(new Error('Authentication error'));
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    socket.userId = decoded.id;
    next();
  } catch (error) {
    next(new Error('Authentication error'));
  }
};

io.use(authenticateSocket);

io.on('connection', (socket) =&gt; {
  console.log(`Authenticated user ${socket.userId} connected`);
  
  // User-specific room
  socket.join(`user_${socket.userId}`);
  
  // Send personalized data
  socket.emit('user_data', {
    userId: socket.userId,
    message: 'Welcome back!'
  });
});
</code></pre>
</div>

<h3 id="170-how-do-you-implement-server-sent-events-sse-in-express-">170. How do you implement server-sent events (SSE) in Express?</h3>

<p><strong>Answer:</strong> Server-Sent Events (SSE) allow the server to push data to the client over a single HTTP connection, ideal for real-time updates like notifications, live feeds, or progress updates.</p>

<p><strong>Basic SSE Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20express%20%3D%20require('express')%3B%0Aconst%20app%20%3D%20express()%3B%0A%0A%2F%2F%20SSE%20endpoint%0Aapp.get('%2Fevents'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Set%20SSE%20headers%0A%20%20res.writeHead(200%2C%20%7B%0A%20%20%20%20'Content-Type'%3A%20'text%2Fevent-stream'%2C%0A%20%20%20%20'Cache-Control'%3A%20'no-cache'%2C%0A%20%20%20%20'Connection'%3A%20'keep-alive'%2C%0A%20%20%20%20'Access-Control-Allow-Origin'%3A%20'*'%2C%0A%20%20%20%20'Access-Control-Allow-Headers'%3A%20'Cache-Control'%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Send%20initial%20connection%20message%0A%20%20res.write('data%3A%20Connected%20to%20SSE%5Cn%5Cn')%3B%0A%20%20%0A%20%20%2F%2F%20Send%20periodic%20updates%0A%20%20const%20intervalId%20%3D%20setInterval(()%20%3D%3E%20%7B%0A%20%20%20%20const%20data%20%3D%20%7B%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%2C%0A%20%20%20%20%20%20message%3A%20'Server%20update'%2C%0A%20%20%20%20%20%20random%3A%20Math.random()%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20res.write(%60data%3A%20%24%7BJSON.stringify(data)%7D%5Cn%5Cn%60)%3B%0A%20%20%7D%2C%205000)%3B%0A%20%20%0A%20%20%2F%2F%20Handle%20client%20disconnect%0A%20%20req.on('close'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20console.log('Client%20disconnected%20from%20SSE')%3B%0A%20%20%20%20clearInterval(intervalId)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20req.on('error'%2C%20(err)%20%3D%3E%20%7B%0A%20%20%20%20console.error('SSE%20error%3A'%2C%20err)%3B%0A%20%20%20%20clearInterval(intervalId)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Advanced%20SSE%20with%20event%20types%0Aapp.get('%2Fnotifications'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.writeHead(200%2C%20%7B%0A%20%20%20%20'Content-Type'%3A%20'text%2Fevent-stream'%2C%0A%20%20%20%20'Cache-Control'%3A%20'no-cache'%2C%0A%20%20%20%20'Connection'%3A%20'keep-alive'%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Send%20different%20event%20types%0A%20%20const%20sendEvent%20%3D%20(eventType%2C%20data)%20%3D%3E%20%7B%0A%20%20%20%20res.write(%60event%3A%20%24%7BeventType%7D%5Cn%60)%3B%0A%20%20%20%20res.write(%60data%3A%20%24%7BJSON.stringify(data)%7D%5Cn%5Cn%60)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20Welcome%20event%0A%20%20sendEvent('welcome'%2C%20%7B%20message%3A%20'Connected%20to%20notifications'%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Simulate%20different%20notification%20types%0A%20%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20sendEvent('notification'%2C%20%7B%0A%20%20%20%20%20%20type%3A%20'info'%2C%0A%20%20%20%20%20%20title%3A%20'New%20Message'%2C%0A%20%20%20%20%20%20body%3A%20'You%20have%20a%20new%20message'%0A%20%20%20%20%7D)%3B%0A%20%20%7D%2C%202000)%3B%0A%20%20%0A%20%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20sendEvent('alert'%2C%20%7B%0A%20%20%20%20%20%20type%3A%20'warning'%2C%0A%20%20%20%20%20%20title%3A%20'System%20Alert'%2C%0A%20%20%20%20%20%20body%3A%20'Server%20maintenance%20in%2010%20minutes'%0A%20%20%20%20%7D)%3B%0A%20%20%7D%2C%205000)%3B%0A%20%20%0A%20%20req.on('close'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20console.log('Notification%20client%20disconnected')%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20SSE%20with%20authentication%0Aapp.get('%2Fprivate-events'%2C%20authenticateUser%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.writeHead(200%2C%20%7B%0A%20%20%20%20'Content-Type'%3A%20'text%2Fevent-stream'%2C%0A%20%20%20%20'Cache-Control'%3A%20'no-cache'%2C%0A%20%20%20%20'Connection'%3A%20'keep-alive'%0A%20%20%7D)%3B%0A%20%20%0A%20%20const%20userId%20%3D%20req.user.id%3B%0A%20%20%0A%20%20%2F%2F%20Send%20user-specific%20events%0A%20%20const%20sendUserEvent%20%3D%20(data)%20%3D%3E%20%7B%0A%20%20%20%20res.write(%60data%3A%20%24%7BJSON.stringify(%7B%0A%20%20%20%20%20%20userId%2C%0A%20%20%20%20%20%20...data%0A%20%20%20%20%7D)%7D%5Cn%5Cn%60)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20sendUserEvent(%7B%20message%3A%20%60Welcome%20%24%7Breq.user.name%7D%60%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Listen%20for%20user-specific%20events%20(from%20database%2C%20Redis%2C%20etc.)%0A%20%20const%20eventListener%20%3D%20(event)%20%3D%3E%20%7B%0A%20%20%20%20if%20(event.userId%20%3D%3D%3D%20userId)%20%7B%0A%20%20%20%20%20%20sendUserEvent(event.data)%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20Add%20listener%20(pseudo-code)%0A%20%20eventEmitter.on('user-event'%2C%20eventListener)%3B%0A%20%20%0A%20%20req.on('close'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20eventEmitter.off('user-event'%2C%20eventListener)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Client-side%20JavaScript%20example%0Aapp.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.send(%60%0A%20%20%20%20%3C!DOCTYPE%20html%3E%0A%20%20%20%20%3Chtml%3E%0A%20%20%20%20%3Chead%3E%0A%20%20%20%20%20%20%3Ctitle%3ESSE%20Example%3C%2Ftitle%3E%0A%20%20%20%20%3C%2Fhead%3E%0A%20%20%20%20%3Cbody%3E%0A%20%20%20%20%20%20%3Cdiv%20id%3D%22messages%22%3E%3C%2Fdiv%3E%0A%20%20%20%20%20%20%3Cscript%3E%0A%20%20%20%20%20%20%20%20const%20eventSource%20%3D%20new%20EventSource('%2Fevents')%3B%0A%20%20%20%20%20%20%20%20const%20messages%20%3D%20document.getElementById('messages')%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20eventSource.onmessage%20%3D%20function(event)%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20data%20%3D%20JSON.parse(event.data)%3B%0A%20%20%20%20%20%20%20%20%20%20messages.innerHTML%20%2B%3D%20'%3Cp%3E'%20%2B%20data.message%20%2B%20'%20-%20'%20%2B%20data.timestamp%20%2B%20'%3C%2Fp%3E'%3B%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20Listen%20for%20specific%20event%20types%0A%20%20%20%20%20%20%20%20eventSource.addEventListener('notification'%2C%20function(event)%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20data%20%3D%20JSON.parse(event.data)%3B%0A%20%20%20%20%20%20%20%20%20%20console.log('Notification%3A'%2C%20data)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20eventSource.addEventListener('alert'%2C%20function(event)%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20data%20%3D%20JSON.parse(event.data)%3B%0A%20%20%20%20%20%20%20%20%20%20alert(data.title%20%2B%20'%3A%20'%20%2B%20data.body)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20eventSource.onerror%20%3D%20function(event)%20%7B%0A%20%20%20%20%20%20%20%20%20%20console.error('SSE%20error%3A'%2C%20event)%3B%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%3C%2Fscript%3E%0A%20%20%20%20%3C%2Fbody%3E%0A%20%20%20%20%3C%2Fhtml%3E%0A%20%20%60)%3B%0A%7D)%3B%0A%0Aapp.listen(3000%2C%20()%20%3D%3E%20%7B%0A%20%20console.log('SSE%20server%20running%20on%20port%203000')%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const express = require('express');
const app = express();

// SSE endpoint
app.get('/events', (req, res) =&gt; {
  // Set SSE headers
  res.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Cache-Control'
  });
  
  // Send initial connection message
  res.write('data: Connected to SSE\n\n');
  
  // Send periodic updates
  const intervalId = setInterval(() =&gt; {
    const data = {
      timestamp: new Date().toISOString(),
      message: 'Server update',
      random: Math.random()
    };
    
    res.write(`data: ${JSON.stringify(data)}\n\n`);
  }, 5000);
  
  // Handle client disconnect
  req.on('close', () =&gt; {
    console.log('Client disconnected from SSE');
    clearInterval(intervalId);
  });
  
  req.on('error', (err) =&gt; {
    console.error('SSE error:', err);
    clearInterval(intervalId);
  });
});

// Advanced SSE with event types
app.get('/notifications', (req, res) =&gt; {
  res.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive'
  });
  
  // Send different event types
  const sendEvent = (eventType, data) =&gt; {
    res.write(`event: ${eventType}\n`);
    res.write(`data: ${JSON.stringify(data)}\n\n`);
  };
  
  // Welcome event
  sendEvent('welcome', { message: 'Connected to notifications' });
  
  // Simulate different notification types
  setTimeout(() =&gt; {
    sendEvent('notification', {
      type: 'info',
      title: 'New Message',
      body: 'You have a new message'
    });
  }, 2000);
  
  setTimeout(() =&gt; {
    sendEvent('alert', {
      type: 'warning',
      title: 'System Alert',
      body: 'Server maintenance in 10 minutes'
    });
  }, 5000);
  
  req.on('close', () =&gt; {
    console.log('Notification client disconnected');
  });
});

// SSE with authentication
app.get('/private-events', authenticateUser, (req, res) =&gt; {
  res.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive'
  });
  
  const userId = req.user.id;
  
  // Send user-specific events
  const sendUserEvent = (data) =&gt; {
    res.write(`data: ${JSON.stringify({
      userId,
      ...data
    })}\n\n`);
  };
  
  sendUserEvent({ message: `Welcome ${req.user.name}` });
  
  // Listen for user-specific events (from database, Redis, etc.)
  const eventListener = (event) =&gt; {
    if (event.userId === userId) {
      sendUserEvent(event.data);
    }
  };
  
  // Add listener (pseudo-code)
  eventEmitter.on('user-event', eventListener);
  
  req.on('close', () =&gt; {
    eventEmitter.off('user-event', eventListener);
  });
});

// Client-side JavaScript example
app.get('/', (req, res) =&gt; {
  res.send(`
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;SSE Example&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id="messages"&gt;&lt;/div&gt;
      &lt;script&gt;
        const eventSource = new EventSource('/events');
        const messages = document.getElementById('messages');
        
        eventSource.onmessage = function(event) {
          const data = JSON.parse(event.data);
          messages.innerHTML += '&lt;p&gt;' + data.message + ' - ' + data.timestamp + '&lt;/p&gt;';
        };
        
        // Listen for specific event types
        eventSource.addEventListener('notification', function(event) {
          const data = JSON.parse(event.data);
          console.log('Notification:', data);
        });
        
        eventSource.addEventListener('alert', function(event) {
          const data = JSON.parse(event.data);
          alert(data.title + ': ' + data.body);
        });
        
        eventSource.onerror = function(event) {
          console.error('SSE error:', event);
        };
      &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
  `);
});

app.listen(3000, () =&gt; {
  console.log('SSE server running on port 3000');
});
</code></pre>
</div>

<p>---</p>

<h2 id="-testing-security-20-questions-">**Testing & Security (20 Questions)**</h2>

<h3 id="171-how-do-you-write-unit-tests-for-express-routes-">171. How do you write unit tests for Express routes?</h3>

<p><strong>Answer:</strong> Unit testing Express routes involves testing route handlers in isolation using testing frameworks like Jest, Mocha, or Supertest.</p>

<p><strong>Using Jest and Supertest:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20routes%2Fusers.js%0Aconst%20express%20%3D%20require('express')%3B%0Aconst%20router%20%3D%20express.Router()%3B%0A%0Arouter.get('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20users%3A%20%5B%5D%20%7D)%3B%0A%7D)%3B%0A%0Arouter.post('%2F'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20%7B%20name%2C%20email%20%7D%20%3D%20req.body%3B%0A%20%20%0A%20%20if%20(!name%20%7C%7C%20!email)%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Name%20and%20email%20are%20required'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20const%20user%20%3D%20%7B%20id%3A%201%2C%20name%2C%20email%20%7D%3B%0A%20%20res.status(201).json(user)%3B%0A%7D)%3B%0A%0Arouter.get('%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20id%20%3D%20parseInt(req.params.id)%3B%0A%20%20%0A%20%20if%20(isNaN(id))%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Invalid%20user%20ID'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20if%20(id%20%3D%3D%3D%20999)%20%7B%0A%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'User%20not%20found'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20res.json(%7B%20id%2C%20name%3A%20'John%20Doe'%2C%20email%3A%20'john%40example.com'%20%7D)%3B%0A%7D)%3B%0A%0Amodule.exports%20%3D%20router%3B%0A%0A%2F%2F%20tests%2Fusers.test.js%0Aconst%20request%20%3D%20require('supertest')%3B%0Aconst%20express%20%3D%20require('express')%3B%0Aconst%20userRoutes%20%3D%20require('..%2Froutes%2Fusers')%3B%0A%0Aconst%20app%20%3D%20express()%3B%0Aapp.use(express.json())%3B%0Aapp.use('%2Fusers'%2C%20userRoutes)%3B%0A%0Adescribe('User%20Routes'%2C%20()%20%3D%3E%20%7B%0A%20%20describe('GET%20%2Fusers'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20return%20empty%20users%20array'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.get('%2Fusers')%0A%20%20%20%20%20%20%20%20.expect(200)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body).toEqual(%7B%20users%3A%20%5B%5D%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('POST%20%2Fusers'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20create%20a%20new%20user'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20userData%20%3D%20%7B%0A%20%20%20%20%20%20%20%20name%3A%20'John%20Doe'%2C%0A%20%20%20%20%20%20%20%20email%3A%20'john%40example.com'%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fusers')%0A%20%20%20%20%20%20%20%20.send(userData)%0A%20%20%20%20%20%20%20%20.expect(201)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body).toMatchObject(%7B%0A%20%20%20%20%20%20%20%20id%3A%20expect.any(Number)%2C%0A%20%20%20%20%20%20%20%20name%3A%20userData.name%2C%0A%20%20%20%20%20%20%20%20email%3A%20userData.email%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20return%20400%20for%20missing%20name'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fusers')%0A%20%20%20%20%20%20%20%20.send(%7B%20email%3A%20'john%40example.com'%20%7D)%0A%20%20%20%20%20%20%20%20.expect(400)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body.error).toBe('Name%20and%20email%20are%20required')%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20return%20400%20for%20missing%20email'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fusers')%0A%20%20%20%20%20%20%20%20.send(%7B%20name%3A%20'John%20Doe'%20%7D)%0A%20%20%20%20%20%20%20%20.expect(400)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body.error).toBe('Name%20and%20email%20are%20required')%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('GET%20%2Fusers%2F%3Aid'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20return%20user%20by%20ID'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.get('%2Fusers%2F1')%0A%20%20%20%20%20%20%20%20.expect(200)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body).toMatchObject(%7B%0A%20%20%20%20%20%20%20%20id%3A%201%2C%0A%20%20%20%20%20%20%20%20name%3A%20expect.any(String)%2C%0A%20%20%20%20%20%20%20%20email%3A%20expect.any(String)%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20return%20400%20for%20invalid%20ID'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.get('%2Fusers%2Finvalid')%0A%20%20%20%20%20%20%20%20.expect(400)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body.error).toBe('Invalid%20user%20ID')%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20return%20404%20for%20non-existent%20user'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.get('%2Fusers%2F999')%0A%20%20%20%20%20%20%20%20.expect(404)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body.error).toBe('User%20not%20found')%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// routes/users.js
const express = require('express');
const router = express.Router();

router.get('/', (req, res) =&gt; {
  res.json({ users: [] });
});

router.post('/', (req, res) =&gt; {
  const { name, email } = req.body;
  
  if (!name || !email) {
    return res.status(400).json({ error: 'Name and email are required' });
  }
  
  const user = { id: 1, name, email };
  res.status(201).json(user);
});

router.get('/:id', (req, res) =&gt; {
  const id = parseInt(req.params.id);
  
  if (isNaN(id)) {
    return res.status(400).json({ error: 'Invalid user ID' });
  }
  
  if (id === 999) {
    return res.status(404).json({ error: 'User not found' });
  }
  
  res.json({ id, name: 'John Doe', email: 'john@example.com' });
});

module.exports = router;

// tests/users.test.js
const request = require('supertest');
const express = require('express');
const userRoutes = require('../routes/users');

const app = express();
app.use(express.json());
app.use('/users', userRoutes);

describe('User Routes', () =&gt; {
  describe('GET /users', () =&gt; {
    it('should return empty users array', async () =&gt; {
      const response = await request(app)
        .get('/users')
        .expect(200);
      
      expect(response.body).toEqual({ users: [] });
    });
  });
  
  describe('POST /users', () =&gt; {
    it('should create a new user', async () =&gt; {
      const userData = {
        name: 'John Doe',
        email: 'john@example.com'
      };
      
      const response = await request(app)
        .post('/users')
        .send(userData)
        .expect(201);
      
      expect(response.body).toMatchObject({
        id: expect.any(Number),
        name: userData.name,
        email: userData.email
      });
    });
    
    it('should return 400 for missing name', async () =&gt; {
      const response = await request(app)
        .post('/users')
        .send({ email: 'john@example.com' })
        .expect(400);
      
      expect(response.body.error).toBe('Name and email are required');
    });
    
    it('should return 400 for missing email', async () =&gt; {
      const response = await request(app)
        .post('/users')
        .send({ name: 'John Doe' })
        .expect(400);
      
      expect(response.body.error).toBe('Name and email are required');
    });
  });
  
  describe('GET /users/:id', () =&gt; {
    it('should return user by ID', async () =&gt; {
      const response = await request(app)
        .get('/users/1')
        .expect(200);
      
      expect(response.body).toMatchObject({
        id: 1,
        name: expect.any(String),
        email: expect.any(String)
      });
    });
    
    it('should return 400 for invalid ID', async () =&gt; {
      const response = await request(app)
        .get('/users/invalid')
        .expect(400);
      
      expect(response.body.error).toBe('Invalid user ID');
    });
    
    it('should return 404 for non-existent user', async () =&gt; {
      const response = await request(app)
        .get('/users/999')
        .expect(404);
      
      expect(response.body.error).toBe('User not found');
    });
  });
});
</code></pre>
</div>

<p><strong>Testing with Mocked Dependencies:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20controllers%2FuserController.js%0Aconst%20User%20%3D%20require('..%2Fmodels%2FUser')%3B%0A%0Aconst%20getUsers%20%3D%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20users%20%3D%20await%20User.find()%3B%0A%20%20%20%20res.json(users)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0Aconst%20createUser%20%3D%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20new%20User(req.body)%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20res.status(201).json(user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(400).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0Amodule.exports%20%3D%20%7B%20getUsers%2C%20createUser%20%7D%3B%0A%0A%2F%2F%20tests%2FuserController.test.js%0Aconst%20%7B%20getUsers%2C%20createUser%20%7D%20%3D%20require('..%2Fcontrollers%2FuserController')%3B%0Aconst%20User%20%3D%20require('..%2Fmodels%2FUser')%3B%0A%0A%2F%2F%20Mock%20the%20User%20model%0Ajest.mock('..%2Fmodels%2FUser')%3B%0A%0Adescribe('User%20Controller'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20req%2C%20res%3B%0A%20%20%0A%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20req%20%3D%20%7B%0A%20%20%20%20%20%20body%3A%20%7B%7D%2C%0A%20%20%20%20%20%20params%3A%20%7B%7D%2C%0A%20%20%20%20%20%20query%3A%20%7B%7D%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20res%20%3D%20%7B%0A%20%20%20%20%20%20json%3A%20jest.fn().mockReturnThis()%2C%0A%20%20%20%20%20%20status%3A%20jest.fn().mockReturnThis()%0A%20%20%20%20%7D%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20afterEach(()%20%3D%3E%20%7B%0A%20%20%20%20jest.clearAllMocks()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('getUsers'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20return%20all%20users'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20mockUsers%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%7B%20id%3A%201%2C%20name%3A%20'John'%2C%20email%3A%20'john%40example.com'%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20id%3A%202%2C%20name%3A%20'Jane'%2C%20email%3A%20'jane%40example.com'%20%7D%0A%20%20%20%20%20%20%5D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20User.find.mockResolvedValue(mockUsers)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20await%20getUsers(req%2C%20res)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(User.find).toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(res.json).toHaveBeenCalledWith(mockUsers)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20handle%20database%20errors'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20errorMessage%20%3D%20'Database%20connection%20failed'%3B%0A%20%20%20%20%20%20User.find.mockRejectedValue(new%20Error(errorMessage))%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20await%20getUsers(req%2C%20res)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(res.status).toHaveBeenCalledWith(500)%3B%0A%20%20%20%20%20%20expect(res.json).toHaveBeenCalledWith(%7B%20error%3A%20errorMessage%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('createUser'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20create%20a%20new%20user'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20userData%20%3D%20%7B%20name%3A%20'John'%2C%20email%3A%20'john%40example.com'%20%7D%3B%0A%20%20%20%20%20%20const%20savedUser%20%3D%20%7B%20id%3A%201%2C%20...userData%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20req.body%20%3D%20userData%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20mockUser%20%3D%20%7B%0A%20%20%20%20%20%20%20%20save%3A%20jest.fn().mockResolvedValue(savedUser)%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20User.mockImplementation(()%20%3D%3E%20mockUser)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20await%20createUser(req%2C%20res)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(User).toHaveBeenCalledWith(userData)%3B%0A%20%20%20%20%20%20expect(mockUser.save).toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(res.status).toHaveBeenCalledWith(201)%3B%0A%20%20%20%20%20%20expect(res.json).toHaveBeenCalledWith(savedUser)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// controllers/userController.js
const User = require('../models/User');

const getUsers = async (req, res) =&gt; {
  try {
    const users = await User.find();
    res.json(users);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

const createUser = async (req, res) =&gt; {
  try {
    const user = new User(req.body);
    await user.save();
    res.status(201).json(user);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
};

module.exports = { getUsers, createUser };

// tests/userController.test.js
const { getUsers, createUser } = require('../controllers/userController');
const User = require('../models/User');

// Mock the User model
jest.mock('../models/User');

describe('User Controller', () =&gt; {
  let req, res;
  
  beforeEach(() =&gt; {
    req = {
      body: {},
      params: {},
      query: {}
    };
    
    res = {
      json: jest.fn().mockReturnThis(),
      status: jest.fn().mockReturnThis()
    };
  });
  
  afterEach(() =&gt; {
    jest.clearAllMocks();
  });
  
  describe('getUsers', () =&gt; {
    it('should return all users', async () =&gt; {
      const mockUsers = [
        { id: 1, name: 'John', email: 'john@example.com' },
        { id: 2, name: 'Jane', email: 'jane@example.com' }
      ];
      
      User.find.mockResolvedValue(mockUsers);
      
      await getUsers(req, res);
      
      expect(User.find).toHaveBeenCalled();
      expect(res.json).toHaveBeenCalledWith(mockUsers);
    });
    
    it('should handle database errors', async () =&gt; {
      const errorMessage = 'Database connection failed';
      User.find.mockRejectedValue(new Error(errorMessage));
      
      await getUsers(req, res);
      
      expect(res.status).toHaveBeenCalledWith(500);
      expect(res.json).toHaveBeenCalledWith({ error: errorMessage });
    });
  });
  
  describe('createUser', () =&gt; {
    it('should create a new user', async () =&gt; {
      const userData = { name: 'John', email: 'john@example.com' };
      const savedUser = { id: 1, ...userData };
      
      req.body = userData;
      
      const mockUser = {
        save: jest.fn().mockResolvedValue(savedUser)
      };
      
      User.mockImplementation(() =&gt; mockUser);
      
      await createUser(req, res);
      
      expect(User).toHaveBeenCalledWith(userData);
      expect(mockUser.save).toHaveBeenCalled();
      expect(res.status).toHaveBeenCalledWith(201);
      expect(res.json).toHaveBeenCalledWith(savedUser);
    });
  });
});
</code></pre>
</div>

<h3 id="172-how-do-you-implement-integration-tests-for-express-apis-">172. How do you implement integration tests for Express APIs?</h3>

<p><strong>Answer:</strong> Integration tests verify that different parts of the application work together correctly, including database interactions, middleware, and external services.</p>

<p><strong>Database Integration Tests:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20tests%2Fintegration%2Fusers.integration.test.js%0Aconst%20request%20%3D%20require('supertest')%3B%0Aconst%20mongoose%20%3D%20require('mongoose')%3B%0Aconst%20app%20%3D%20require('..%2F..%2Fapp')%3B%0Aconst%20User%20%3D%20require('..%2F..%2Fmodels%2FUser')%3B%0A%0Adescribe('User%20API%20Integration%20Tests'%2C%20()%20%3D%3E%20%7B%0A%20%20beforeAll(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Connect%20to%20test%20database%0A%20%20%20%20const%20mongoUri%20%3D%20process.env.MONGODB_TEST_URI%20%7C%7C%20'mongodb%3A%2F%2Flocalhost%3A27017%2Ftest_db'%3B%0A%20%20%20%20await%20mongoose.connect(mongoUri)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20beforeEach(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Clean%20database%20before%20each%20test%0A%20%20%20%20await%20User.deleteMany(%7B%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20afterAll(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Clean%20up%20and%20close%20connection%0A%20%20%20%20await%20User.deleteMany(%7B%7D)%3B%0A%20%20%20%20await%20mongoose.connection.close()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('POST%20%2Fapi%2Fusers'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20create%20user%20in%20database'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20userData%20%3D%20%7B%0A%20%20%20%20%20%20%20%20name%3A%20'John%20Doe'%2C%0A%20%20%20%20%20%20%20%20email%3A%20'john%40example.com'%2C%0A%20%20%20%20%20%20%20%20password%3A%20'password123'%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fapi%2Fusers')%0A%20%20%20%20%20%20%20%20.send(userData)%0A%20%20%20%20%20%20%20%20.expect(201)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Verify%20response%0A%20%20%20%20%20%20expect(response.body).toMatchObject(%7B%0A%20%20%20%20%20%20%20%20name%3A%20userData.name%2C%0A%20%20%20%20%20%20%20%20email%3A%20userData.email%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20expect(response.body.password).toBeUndefined()%3B%20%2F%2F%20Password%20should%20not%20be%20returned%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Verify%20database%0A%20%20%20%20%20%20const%20userInDb%20%3D%20await%20User.findById(response.body.id)%3B%0A%20%20%20%20%20%20expect(userInDb).toBeTruthy()%3B%0A%20%20%20%20%20%20expect(userInDb.name).toBe(userData.name)%3B%0A%20%20%20%20%20%20expect(userInDb.email).toBe(userData.email)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20not%20create%20user%20with%20duplicate%20email'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20userData%20%3D%20%7B%0A%20%20%20%20%20%20%20%20name%3A%20'John%20Doe'%2C%0A%20%20%20%20%20%20%20%20email%3A%20'john%40example.com'%2C%0A%20%20%20%20%20%20%20%20password%3A%20'password123'%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Create%20first%20user%0A%20%20%20%20%20%20await%20User.create(userData)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Try%20to%20create%20duplicate%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fapi%2Fusers')%0A%20%20%20%20%20%20%20%20.send(userData)%0A%20%20%20%20%20%20%20%20.expect(400)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body.error).toContain('email')%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Verify%20only%20one%20user%20exists%0A%20%20%20%20%20%20const%20userCount%20%3D%20await%20User.countDocuments(%7B%20email%3A%20userData.email%20%7D)%3B%0A%20%20%20%20%20%20expect(userCount).toBe(1)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('GET%20%2Fapi%2Fusers'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20return%20all%20users%20from%20database'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Create%20test%20users%0A%20%20%20%20%20%20const%20users%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%7B%20name%3A%20'John'%2C%20email%3A%20'john%40example.com'%2C%20password%3A%20'pass1'%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20name%3A%20'Jane'%2C%20email%3A%20'jane%40example.com'%2C%20password%3A%20'pass2'%20%7D%0A%20%20%20%20%20%20%5D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20await%20User.create(users)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.get('%2Fapi%2Fusers')%0A%20%20%20%20%20%20%20%20.expect(200)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body).toHaveLength(2)%3B%0A%20%20%20%20%20%20expect(response.body%5B0%5D).toMatchObject(%7B%0A%20%20%20%20%20%20%20%20name%3A%20'John'%2C%0A%20%20%20%20%20%20%20%20email%3A%20'john%40example.com'%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20expect(response.body%5B1%5D).toMatchObject(%7B%0A%20%20%20%20%20%20%20%20name%3A%20'Jane'%2C%0A%20%20%20%20%20%20%20%20email%3A%20'jane%40example.com'%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('Authentication%20Integration'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20let%20authToken%3B%0A%20%20%20%20let%20testUser%3B%0A%20%20%20%20%0A%20%20%20%20beforeEach(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Create%20and%20authenticate%20user%0A%20%20%20%20%20%20testUser%20%3D%20await%20User.create(%7B%0A%20%20%20%20%20%20%20%20name%3A%20'Test%20User'%2C%0A%20%20%20%20%20%20%20%20email%3A%20'test%40example.com'%2C%0A%20%20%20%20%20%20%20%20password%3A%20'password123'%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20loginResponse%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fapi%2Fauth%2Flogin')%0A%20%20%20%20%20%20%20%20.send(%7B%0A%20%20%20%20%20%20%20%20%20%20email%3A%20'test%40example.com'%2C%0A%20%20%20%20%20%20%20%20%20%20password%3A%20'password123'%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20authToken%20%3D%20loginResponse.body.token%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20access%20protected%20route%20with%20valid%20token'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.get('%2Fapi%2Fusers%2Fprofile')%0A%20%20%20%20%20%20%20%20.set('Authorization'%2C%20%60Bearer%20%24%7BauthToken%7D%60)%0A%20%20%20%20%20%20%20%20.expect(200)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body.email).toBe(testUser.email)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20reject%20access%20without%20token'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20request(app)%0A%20%20%20%20%20%20%20%20.get('%2Fapi%2Fusers%2Fprofile')%0A%20%20%20%20%20%20%20%20.expect(401)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// tests/integration/users.integration.test.js
const request = require('supertest');
const mongoose = require('mongoose');
const app = require('../../app');
const User = require('../../models/User');

describe('User API Integration Tests', () =&gt; {
  beforeAll(async () =&gt; {
    // Connect to test database
    const mongoUri = process.env.MONGODB_TEST_URI || 'mongodb://localhost:27017/test_db';
    await mongoose.connect(mongoUri);
  });
  
  beforeEach(async () =&gt; {
    // Clean database before each test
    await User.deleteMany({});
  });
  
  afterAll(async () =&gt; {
    // Clean up and close connection
    await User.deleteMany({});
    await mongoose.connection.close();
  });
  
  describe('POST /api/users', () =&gt; {
    it('should create user in database', async () =&gt; {
      const userData = {
        name: 'John Doe',
        email: 'john@example.com',
        password: 'password123'
      };
      
      const response = await request(app)
        .post('/api/users')
        .send(userData)
        .expect(201);
      
      // Verify response
      expect(response.body).toMatchObject({
        name: userData.name,
        email: userData.email
      });
      expect(response.body.password).toBeUndefined(); // Password should not be returned
      
      // Verify database
      const userInDb = await User.findById(response.body.id);
      expect(userInDb).toBeTruthy();
      expect(userInDb.name).toBe(userData.name);
      expect(userInDb.email).toBe(userData.email);
    });
    
    it('should not create user with duplicate email', async () =&gt; {
      const userData = {
        name: 'John Doe',
        email: 'john@example.com',
        password: 'password123'
      };
      
      // Create first user
      await User.create(userData);
      
      // Try to create duplicate
      const response = await request(app)
        .post('/api/users')
        .send(userData)
        .expect(400);
      
      expect(response.body.error).toContain('email');
      
      // Verify only one user exists
      const userCount = await User.countDocuments({ email: userData.email });
      expect(userCount).toBe(1);
    });
  });
  
  describe('GET /api/users', () =&gt; {
    it('should return all users from database', async () =&gt; {
      // Create test users
      const users = [
        { name: 'John', email: 'john@example.com', password: 'pass1' },
        { name: 'Jane', email: 'jane@example.com', password: 'pass2' }
      ];
      
      await User.create(users);
      
      const response = await request(app)
        .get('/api/users')
        .expect(200);
      
      expect(response.body).toHaveLength(2);
      expect(response.body[0]).toMatchObject({
        name: 'John',
        email: 'john@example.com'
      });
      expect(response.body[1]).toMatchObject({
        name: 'Jane',
        email: 'jane@example.com'
      });
    });
  });
  
  describe('Authentication Integration', () =&gt; {
    let authToken;
    let testUser;
    
    beforeEach(async () =&gt; {
      // Create and authenticate user
      testUser = await User.create({
        name: 'Test User',
        email: 'test@example.com',
        password: 'password123'
      });
      
      const loginResponse = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'test@example.com',
          password: 'password123'
        });
      
      authToken = loginResponse.body.token;
    });
    
    it('should access protected route with valid token', async () =&gt; {
      const response = await request(app)
        .get('/api/users/profile')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);
      
      expect(response.body.email).toBe(testUser.email);
    });
    
    it('should reject access without token', async () =&gt; {
      await request(app)
        .get('/api/users/profile')
        .expect(401);
    });
  });
});
</code></pre>
</div>

<p><strong>Testing with External Services:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20tests%2Fintegration%2Fpayment.integration.test.js%0Aconst%20request%20%3D%20require('supertest')%3B%0Aconst%20nock%20%3D%20require('nock')%3B%20%2F%2F%20For%20mocking%20HTTP%20requests%0Aconst%20app%20%3D%20require('..%2F..%2Fapp')%3B%0A%0Adescribe('Payment%20Integration%20Tests'%2C%20()%20%3D%3E%20%7B%0A%20%20afterEach(()%20%3D%3E%20%7B%0A%20%20%20%20nock.cleanAll()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('POST%20%2Fapi%2Fpayments'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20process%20payment%20with%20external%20service'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Mock%20external%20payment%20service%0A%20%20%20%20%20%20nock('https%3A%2F%2Fapi.stripe.com')%0A%20%20%20%20%20%20%20%20.post('%2Fv1%2Fcharges')%0A%20%20%20%20%20%20%20%20.reply(200%2C%20%7B%0A%20%20%20%20%20%20%20%20%20%20id%3A%20'ch_test_123'%2C%0A%20%20%20%20%20%20%20%20%20%20status%3A%20'succeeded'%2C%0A%20%20%20%20%20%20%20%20%20%20amount%3A%202000%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20paymentData%20%3D%20%7B%0A%20%20%20%20%20%20%20%20amount%3A%202000%2C%0A%20%20%20%20%20%20%20%20currency%3A%20'usd'%2C%0A%20%20%20%20%20%20%20%20source%3A%20'tok_visa'%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fapi%2Fpayments')%0A%20%20%20%20%20%20%20%20.send(paymentData)%0A%20%20%20%20%20%20%20%20.expect(200)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body).toMatchObject(%7B%0A%20%20%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20%20%20chargeId%3A%20'ch_test_123'%2C%0A%20%20%20%20%20%20%20%20amount%3A%202000%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20handle%20payment%20service%20errors'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Mock%20payment%20service%20error%0A%20%20%20%20%20%20nock('https%3A%2F%2Fapi.stripe.com')%0A%20%20%20%20%20%20%20%20.post('%2Fv1%2Fcharges')%0A%20%20%20%20%20%20%20%20.reply(400%2C%20%7B%0A%20%20%20%20%20%20%20%20%20%20error%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20message%3A%20'Your%20card%20was%20declined.'%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20paymentData%20%3D%20%7B%0A%20%20%20%20%20%20%20%20amount%3A%202000%2C%0A%20%20%20%20%20%20%20%20currency%3A%20'usd'%2C%0A%20%20%20%20%20%20%20%20source%3A%20'tok_chargeDeclined'%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20const%20response%20%3D%20await%20request(app)%0A%20%20%20%20%20%20%20%20.post('%2Fapi%2Fpayments')%0A%20%20%20%20%20%20%20%20.send(paymentData)%0A%20%20%20%20%20%20%20%20.expect(400)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(response.body.error).toContain('declined')%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// tests/integration/payment.integration.test.js
const request = require('supertest');
const nock = require('nock'); // For mocking HTTP requests
const app = require('../../app');

describe('Payment Integration Tests', () =&gt; {
  afterEach(() =&gt; {
    nock.cleanAll();
  });
  
  describe('POST /api/payments', () =&gt; {
    it('should process payment with external service', async () =&gt; {
      // Mock external payment service
      nock('https://api.stripe.com')
        .post('/v1/charges')
        .reply(200, {
          id: 'ch_test_123',
          status: 'succeeded',
          amount: 2000
        });
      
      const paymentData = {
        amount: 2000,
        currency: 'usd',
        source: 'tok_visa'
      };
      
      const response = await request(app)
        .post('/api/payments')
        .send(paymentData)
        .expect(200);
      
      expect(response.body).toMatchObject({
        success: true,
        chargeId: 'ch_test_123',
        amount: 2000
      });
    });
    
    it('should handle payment service errors', async () =&gt; {
      // Mock payment service error
      nock('https://api.stripe.com')
        .post('/v1/charges')
        .reply(400, {
          error: {
            message: 'Your card was declined.'
          }
        });
      
      const paymentData = {
        amount: 2000,
        currency: 'usd',
        source: 'tok_chargeDeclined'
      };
      
      const response = await request(app)
        .post('/api/payments')
        .send(paymentData)
        .expect(400);
      
      expect(response.body.error).toContain('declined');
    });
  });
});
</code></pre>
</div>

<h3 id="173-what-are-the-common-security-vulnerabilities-in-express-applications-">173. What are the common security vulnerabilities in Express applications?</h3>

<p><strong>Answer:</strong> Express applications face various security threats that developers must address to ensure application safety.</p>

<p><strong>Common Vulnerabilities:</strong></p>

<p><strong>1. Cross-Site Scripting (XSS):</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Vulnerable%20code%0Aapp.get('%2Fsearch'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20query%20%3D%20req.query.q%3B%0A%20%20res.send(%60%3Ch1%3ESearch%20results%20for%3A%20%24%7Bquery%7D%3C%2Fh1%3E%60)%3B%20%2F%2F%20XSS%20vulnerability%0A%7D)%3B%0A%0A%2F%2F%20Secure%20implementation%0Aapp.get('%2Fsearch'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20query%20%3D%20req.query.q%3B%0A%20%20const%20sanitizedQuery%20%3D%20escapeHtml(query)%3B%20%2F%2F%20Sanitize%20input%0A%20%20res.send(%60%3Ch1%3ESearch%20results%20for%3A%20%24%7BsanitizedQuery%7D%3C%2Fh1%3E%60)%3B%0A%7D)%3B%0A%0A%2F%2F%20Using%20template%20engine%20(automatically%20escapes)%0Aapp.get('%2Fsearch'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.render('search'%2C%20%7B%20query%3A%20req.query.q%20%7D)%3B%20%2F%2F%20Template%20engine%20handles%20escaping%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Vulnerable code
app.get('/search', (req, res) =&gt; {
  const query = req.query.q;
  res.send(`&lt;h1&gt;Search results for: ${query}&lt;/h1&gt;`); // XSS vulnerability
});

// Secure implementation
app.get('/search', (req, res) =&gt; {
  const query = req.query.q;
  const sanitizedQuery = escapeHtml(query); // Sanitize input
  res.send(`&lt;h1&gt;Search results for: ${sanitizedQuery}&lt;/h1&gt;`);
});

// Using template engine (automatically escapes)
app.get('/search', (req, res) =&gt; {
  res.render('search', { query: req.query.q }); // Template engine handles escaping
});
</code></pre>
</div>

<p><strong>2. SQL Injection:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Vulnerable%20code%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20query%20%3D%20%60SELECT%20*%20FROM%20users%20WHERE%20id%20%3D%20%24%7Breq.params.id%7D%60%3B%20%2F%2F%20SQL%20injection%0A%20%20db.query(query%2C%20(err%2C%20results)%20%3D%3E%20%7B%0A%20%20%20%20res.json(results)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Secure%20implementation%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20query%20%3D%20'SELECT%20*%20FROM%20users%20WHERE%20id%20%3D%20%3F'%3B%20%2F%2F%20Parameterized%20query%0A%20%20db.query(query%2C%20%5Breq.params.id%5D%2C%20(err%2C%20results)%20%3D%3E%20%7B%0A%20%20%20%20res.json(results)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Vulnerable code
app.get('/users/:id', (req, res) =&gt; {
  const query = `SELECT * FROM users WHERE id = ${req.params.id}`; // SQL injection
  db.query(query, (err, results) =&gt; {
    res.json(results);
  });
});

// Secure implementation
app.get('/users/:id', (req, res) =&gt; {
  const query = 'SELECT * FROM users WHERE id = ?'; // Parameterized query
  db.query(query, [req.params.id], (err, results) =&gt; {
    res.json(results);
  });
});
</code></pre>
</div>

<p><strong>3. Cross-Site Request Forgery (CSRF):</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20csrf%20%3D%20require('csurf')%3B%0A%0A%2F%2F%20CSRF%20protection%0Aconst%20csrfProtection%20%3D%20csrf(%7B%20cookie%3A%20true%20%7D)%3B%0A%0Aapp.use(csrfProtection)%3B%0A%0Aapp.get('%2Fform'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.render('form'%2C%20%7B%20csrfToken%3A%20req.csrfToken()%20%7D)%3B%0A%7D)%3B%0A%0Aapp.post('%2Ftransfer'%2C%20csrfProtection%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Protected%20against%20CSRF%20attacks%0A%20%20const%20%7B%20amount%2C%20recipient%20%7D%20%3D%20req.body%3B%0A%20%20%2F%2F%20Process%20transfer%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const csrf = require('csurf');

// CSRF protection
const csrfProtection = csrf({ cookie: true });

app.use(csrfProtection);

app.get('/form', (req, res) =&gt; {
  res.render('form', { csrfToken: req.csrfToken() });
});

app.post('/transfer', csrfProtection, (req, res) =&gt; {
  // Protected against CSRF attacks
  const { amount, recipient } = req.body;
  // Process transfer
});
</code></pre>
</div>

<p><strong>4. Insecure Direct Object References:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Vulnerable%20code%0Aapp.get('%2Fdocuments%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20document%20%3D%20getDocument(req.params.id)%3B%0A%20%20res.json(document)%3B%20%2F%2F%20No%20authorization%20check%0A%7D)%3B%0A%0A%2F%2F%20Secure%20implementation%0Aapp.get('%2Fdocuments%2F%3Aid'%2C%20authenticateUser%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20document%20%3D%20getDocument(req.params.id)%3B%0A%20%20%0A%20%20%2F%2F%20Check%20if%20user%20owns%20the%20document%0A%20%20if%20(document.userId%20!%3D%3D%20req.user.id)%20%7B%0A%20%20%20%20return%20res.status(403).json(%7B%20error%3A%20'Access%20denied'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20res.json(document)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Vulnerable code
app.get('/documents/:id', (req, res) =&gt; {
  const document = getDocument(req.params.id);
  res.json(document); // No authorization check
});

// Secure implementation
app.get('/documents/:id', authenticateUser, (req, res) =&gt; {
  const document = getDocument(req.params.id);
  
  // Check if user owns the document
  if (document.userId !== req.user.id) {
    return res.status(403).json({ error: 'Access denied' });
  }
  
  res.json(document);
});
</code></pre>
</div>

<p><strong>5. Sensitive Data Exposure:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Vulnerable%20code%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20user%20%3D%20getUserById(req.params.id)%3B%0A%20%20res.json(user)%3B%20%2F%2F%20Exposes%20password%2C%20SSN%2C%20etc.%0A%7D)%3B%0A%0A%2F%2F%20Secure%20implementation%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20user%20%3D%20getUserById(req.params.id)%3B%0A%20%20const%20safeUser%20%3D%20%7B%0A%20%20%20%20id%3A%20user.id%2C%0A%20%20%20%20name%3A%20user.name%2C%0A%20%20%20%20email%3A%20user.email%0A%20%20%20%20%2F%2F%20Exclude%20sensitive%20fields%0A%20%20%7D%3B%0A%20%20res.json(safeUser)%3B%0A%7D)%3B%0A%0A%2F%2F%20Using%20projection%0Aconst%20user%20%3D%20await%20User.findById(id).select('-password%20-ssn%20-creditCard')%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Vulnerable code
app.get('/users/:id', (req, res) =&gt; {
  const user = getUserById(req.params.id);
  res.json(user); // Exposes password, SSN, etc.
});

// Secure implementation
app.get('/users/:id', (req, res) =&gt; {
  const user = getUserById(req.params.id);
  const safeUser = {
    id: user.id,
    name: user.name,
    email: user.email
    // Exclude sensitive fields
  };
  res.json(safeUser);
});

// Using projection
const user = await User.findById(id).select('-password -ssn -creditCard');
</code></pre>
</div>

<p><strong>6. Insufficient Authentication:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Weak%20authentication%0Aapp.post('%2Flogin'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20%7B%20username%2C%20password%20%7D%20%3D%20req.body%3B%0A%20%20const%20user%20%3D%20users.find(u%20%3D%3E%20u.username%20%3D%3D%3D%20username%20%26%26%20u.password%20%3D%3D%3D%20password)%3B%0A%20%20%2F%2F%20Plain%20text%20password%20comparison%0A%7D)%3B%0A%0A%2F%2F%20Strong%20authentication%0Aconst%20bcrypt%20%3D%20require('bcrypt')%3B%0A%0Aapp.post('%2Flogin'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20%7B%20username%2C%20password%20%7D%20%3D%20req.body%3B%0A%20%20const%20user%20%3D%20await%20User.findOne(%7B%20username%20%7D)%3B%0A%20%20%0A%20%20if%20(!user%20%7C%7C%20!await%20bcrypt.compare(password%2C%20user.hashedPassword))%20%7B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Generate%20JWT%20token%0A%20%20const%20token%20%3D%20jwt.sign(%7B%20userId%3A%20user.id%20%7D%2C%20process.env.JWT_SECRET)%3B%0A%20%20res.json(%7B%20token%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Weak authentication
app.post('/login', (req, res) =&gt; {
  const { username, password } = req.body;
  const user = users.find(u =&gt; u.username === username && u.password === password);
  // Plain text password comparison
});

// Strong authentication
const bcrypt = require('bcrypt');

app.post('/login', async (req, res) =&gt; {
  const { username, password } = req.body;
  const user = await User.findOne({ username });
  
  if (!user || !await bcrypt.compare(password, user.hashedPassword)) {
    return res.status(401).json({ error: 'Invalid credentials' });
  }
  
  // Generate JWT token
  const token = jwt.sign({ userId: user.id }, process.env.JWT_SECRET);
  res.json({ token });
});
</code></pre>
</div>

<h3 id="174-how-do-you-implement-input-validation-and-sanitization-">174. How do you implement input validation and sanitization?</h3>

<p><strong>Answer:</strong> Input validation and sanitization prevent malicious data from entering your application and causing security vulnerabilities.</p>

<p><strong>Using express-validator:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20%7B%20body%2C%20param%2C%20query%2C%20validationResult%20%7D%20%3D%20require('express-validator')%3B%0Aconst%20validator%20%3D%20require('validator')%3B%0A%0A%2F%2F%20Validation%20middleware%0Aconst%20validate%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20errors%20%3D%20validationResult(req)%3B%0A%20%20if%20(!errors.isEmpty())%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20success%3A%20false%2C%0A%20%20%20%20%20%20errors%3A%20errors.array()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20User%20registration%20validation%0Aconst%20validateUserRegistration%20%3D%20%5B%0A%20%20body('email')%0A%20%20%20%20.isEmail()%0A%20%20%20%20.withMessage('Must%20be%20a%20valid%20email')%0A%20%20%20%20.normalizeEmail()%20%2F%2F%20Sanitization%0A%20%20%20%20.custom(async%20(email)%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20existingUser%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20%20%20if%20(existingUser)%20%7B%0A%20%20%20%20%20%20%20%20throw%20new%20Error('Email%20already%20in%20use')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%2C%0A%20%20%0A%20%20body('password')%0A%20%20%20%20.isLength(%7B%20min%3A%208%20%7D)%0A%20%20%20%20.withMessage('Password%20must%20be%20at%20least%208%20characters')%0A%20%20%20%20.matches(%2F%5E(%3F%3D.*%5Ba-z%5D)(%3F%3D.*%5BA-Z%5D)(%3F%3D.*%5Cd)(%3F%3D.*%5B%40%24!%25*%3F%26%5D)%5BA-Za-z%5Cd%40%24!%25*%3F%26%5D%2F)%0A%20%20%20%20.withMessage('Password%20must%20contain%20uppercase%2C%20lowercase%2C%20number%2C%20and%20special%20character')%2C%0A%20%20%0A%20%20body('name')%0A%20%20%20%20.trim()%20%2F%2F%20Remove%20whitespace%0A%20%20%20%20.escape()%20%2F%2F%20Escape%20HTML%20characters%0A%20%20%20%20.isLength(%7B%20min%3A%202%2C%20max%3A%2050%20%7D)%0A%20%20%20%20.withMessage('Name%20must%20be%20between%202%20and%2050%20characters')%0A%20%20%20%20.matches(%2F%5E%5Ba-zA-Z%5Cs%5D%2B%24%2F)%0A%20%20%20%20.withMessage('Name%20can%20only%20contain%20letters%20and%20spaces')%2C%0A%20%20%0A%20%20body('age')%0A%20%20%20%20.optional()%0A%20%20%20%20.isInt(%7B%20min%3A%2018%2C%20max%3A%20120%20%7D)%0A%20%20%20%20.withMessage('Age%20must%20be%20between%2018%20and%20120')%0A%20%20%20%20.toInt()%2C%20%2F%2F%20Convert%20to%20integer%0A%20%20%0A%20%20body('phone')%0A%20%20%20%20.optional()%0A%20%20%20%20.isMobilePhone()%0A%20%20%20%20.withMessage('Must%20be%20a%20valid%20phone%20number')%2C%0A%20%20%0A%20%20validate%0A%5D%3B%0A%0Aapp.post('%2Fregister'%2C%20validateUserRegistration%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Data%20is%20validated%20and%20sanitized%0A%20%20const%20%7B%20email%2C%20password%2C%20name%2C%20age%2C%20phone%20%7D%20%3D%20req.body%3B%0A%20%20%0A%20%20%2F%2F%20Hash%20password%0A%20%20const%20hashedPassword%20%3D%20await%20bcrypt.hash(password%2C%2012)%3B%0A%20%20%0A%20%20const%20user%20%3D%20new%20User(%7B%0A%20%20%20%20email%2C%0A%20%20%20%20password%3A%20hashedPassword%2C%0A%20%20%20%20name%2C%0A%20%20%20%20age%2C%0A%20%20%20%20phone%0A%20%20%7D)%3B%0A%20%20%0A%20%20await%20user.save()%3B%0A%20%20res.status(201).json(%7B%20message%3A%20'User%20created%20successfully'%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Advanced%20validation%20with%20custom%20sanitizers%0Aconst%20validateBlogPost%20%3D%20%5B%0A%20%20body('title')%0A%20%20%20%20.trim()%0A%20%20%20%20.escape()%0A%20%20%20%20.isLength(%7B%20min%3A%205%2C%20max%3A%20100%20%7D)%0A%20%20%20%20.withMessage('Title%20must%20be%20between%205%20and%20100%20characters')%2C%0A%20%20%0A%20%20body('content')%0A%20%20%20%20.trim()%0A%20%20%20%20.isLength(%7B%20min%3A%2010%2C%20max%3A%205000%20%7D)%0A%20%20%20%20.withMessage('Content%20must%20be%20between%2010%20and%205000%20characters')%0A%20%20%20%20.custom((value)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Custom%20sanitization%20-%20remove%20script%20tags%0A%20%20%20%20%20%20const%20sanitized%20%3D%20value.replace(%2F%3Cscript%5Cb%5B%5E%3C%5D*(%3F%3A(%3F!%3C%5C%2Fscript%3E)%3C%5B%5E%3C%5D*)*%3C%5C%2Fscript%3E%2Fgi%2C%20'')%3B%0A%20%20%20%20%20%20return%20sanitized%3B%0A%20%20%20%20%7D)%2C%0A%20%20%0A%20%20body('tags')%0A%20%20%20%20.optional()%0A%20%20%20%20.isArray()%0A%20%20%20%20.withMessage('Tags%20must%20be%20an%20array')%0A%20%20%20%20.custom((tags)%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(tags.length%20%3E%2010)%20%7B%0A%20%20%20%20%20%20%20%20throw%20new%20Error('Maximum%2010%20tags%20allowed')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20tags.every(tag%20%3D%3E%20typeof%20tag%20%3D%3D%3D%20'string'%20%26%26%20tag.length%20%3C%3D%2020)%3B%0A%20%20%20%20%7D)%2C%0A%20%20%0A%20%20body('category')%0A%20%20%20%20.isIn(%5B'tech'%2C%20'lifestyle'%2C%20'business'%2C%20'health'%5D)%0A%20%20%20%20.withMessage('Invalid%20category')%2C%0A%20%20%0A%20%20validate%0A%5D%3B%0A%0A%2F%2F%20File%20upload%20validation%0Aconst%20validateFileUpload%20%3D%20%5B%0A%20%20body('description')%0A%20%20%20%20.optional()%0A%20%20%20%20.trim()%0A%20%20%20%20.escape()%0A%20%20%20%20.isLength(%7B%20max%3A%20500%20%7D)%0A%20%20%20%20.withMessage('Description%20cannot%20exceed%20500%20characters')%2C%0A%20%20%0A%20%20validate%0A%5D%3B%0A%0Aconst%20upload%20%3D%20multer(%7B%0A%20%20limits%3A%20%7B%0A%20%20%20%20fileSize%3A%205%20*%201024%20*%201024%20%2F%2F%205MB%0A%20%20%7D%2C%0A%20%20fileFilter%3A%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Validate%20file%20type%0A%20%20%20%20const%20allowedTypes%20%3D%20%5B'image%2Fjpeg'%2C%20'image%2Fpng'%2C%20'image%2Fgif'%5D%3B%0A%20%20%20%20if%20(allowedTypes.includes(file.mimetype))%20%7B%0A%20%20%20%20%20%20cb(null%2C%20true)%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20cb(new%20Error('Invalid%20file%20type')%2C%20false)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D)%3B%0A%0Aapp.post('%2Fupload'%2C%20%0A%20%20upload.single('image')%2C%20%0A%20%20validateFileUpload%2C%20%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20File%20and%20data%20are%20validated%0A%20%20%20%20res.json(%7B%20message%3A%20'File%20uploaded%20successfully'%20%7D)%3B%0A%20%20%7D%0A)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const { body, param, query, validationResult } = require('express-validator');
const validator = require('validator');

// Validation middleware
const validate = (req, res, next) =&gt; {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      errors: errors.array()
    });
  }
  next();
};

// User registration validation
const validateUserRegistration = [
  body('email')
    .isEmail()
    .withMessage('Must be a valid email')
    .normalizeEmail() // Sanitization
    .custom(async (email) =&gt; {
      const existingUser = await User.findOne({ email });
      if (existingUser) {
        throw new Error('Email already in use');
      }
    }),
  
  body('password')
    .isLength({ min: 8 })
    .withMessage('Password must be at least 8 characters')
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/)
    .withMessage('Password must contain uppercase, lowercase, number, and special character'),
  
  body('name')
    .trim() // Remove whitespace
    .escape() // Escape HTML characters
    .isLength({ min: 2, max: 50 })
    .withMessage('Name must be between 2 and 50 characters')
    .matches(/^[a-zA-Z\s]+$/)
    .withMessage('Name can only contain letters and spaces'),
  
  body('age')
    .optional()
    .isInt({ min: 18, max: 120 })
    .withMessage('Age must be between 18 and 120')
    .toInt(), // Convert to integer
  
  body('phone')
    .optional()
    .isMobilePhone()
    .withMessage('Must be a valid phone number'),
  
  validate
];

app.post('/register', validateUserRegistration, async (req, res) =&gt; {
  // Data is validated and sanitized
  const { email, password, name, age, phone } = req.body;
  
  // Hash password
  const hashedPassword = await bcrypt.hash(password, 12);
  
  const user = new User({
    email,
    password: hashedPassword,
    name,
    age,
    phone
  });
  
  await user.save();
  res.status(201).json({ message: 'User created successfully' });
});

// Advanced validation with custom sanitizers
const validateBlogPost = [
  body('title')
    .trim()
    .escape()
    .isLength({ min: 5, max: 100 })
    .withMessage('Title must be between 5 and 100 characters'),
  
  body('content')
    .trim()
    .isLength({ min: 10, max: 5000 })
    .withMessage('Content must be between 10 and 5000 characters')
    .custom((value) =&gt; {
      // Custom sanitization - remove script tags
      const sanitized = value.replace(/&lt;script\b[^&lt;]*(?:(?!&lt;\/script&gt;)&lt;[^&lt;]*)*&lt;\/script&gt;/gi, '');
      return sanitized;
    }),
  
  body('tags')
    .optional()
    .isArray()
    .withMessage('Tags must be an array')
    .custom((tags) =&gt; {
      if (tags.length &gt; 10) {
        throw new Error('Maximum 10 tags allowed');
      }
      return tags.every(tag =&gt; typeof tag === 'string' && tag.length &lt;= 20);
    }),
  
  body('category')
    .isIn(['tech', 'lifestyle', 'business', 'health'])
    .withMessage('Invalid category'),
  
  validate
];

// File upload validation
const validateFileUpload = [
  body('description')
    .optional()
    .trim()
    .escape()
    .isLength({ max: 500 })
    .withMessage('Description cannot exceed 500 characters'),
  
  validate
];

const upload = multer({
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB
  },
  fileFilter: (req, file, cb) =&gt; {
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('Invalid file type'), false);
    }
  }
});

app.post('/upload', 
  upload.single('image'), 
  validateFileUpload, 
  (req, res) =&gt; {
    // File and data are validated
    res.json({ message: 'File uploaded successfully' });
  }
);
</code></pre>
</div>

<p><strong>Custom Sanitization Functions:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20DOMPurify%20%3D%20require('isomorphic-dompurify')%3B%0Aconst%20xss%20%3D%20require('xss')%3B%0A%0A%2F%2F%20HTML%20sanitization%0Aconst%20sanitizeHtml%20%3D%20(html)%20%3D%3E%20%7B%0A%20%20return%20DOMPurify.sanitize(html%2C%20%7B%0A%20%20%20%20ALLOWED_TAGS%3A%20%5B'p'%2C%20'br'%2C%20'strong'%2C%20'em'%2C%20'ul'%2C%20'ol'%2C%20'li'%5D%2C%0A%20%20%20%20ALLOWED_ATTR%3A%20%5B%5D%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20XSS%20protection%0Aconst%20sanitizeInput%20%3D%20(input)%20%3D%3E%20%7B%0A%20%20return%20xss(input%2C%20%7B%0A%20%20%20%20whiteList%3A%20%7B%7D%2C%20%2F%2F%20No%20HTML%20tags%20allowed%0A%20%20%20%20stripIgnoreTag%3A%20true%2C%0A%20%20%20%20stripIgnoreTagBody%3A%20%5B'script'%5D%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20SQL%20injection%20prevention%0Aconst%20sanitizeSqlInput%20%3D%20(input)%20%3D%3E%20%7B%0A%20%20return%20input.replace(%2F%5B'%22%5C%5C%3B%5D%2Fg%2C%20'')%3B%20%2F%2F%20Remove%20dangerous%20characters%0A%7D%3B%0A%0A%2F%2F%20Custom%20middleware%20for%20sanitization%0Aconst%20sanitizeMiddleware%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Sanitize%20all%20string%20inputs%0A%20%20const%20sanitizeObject%20%3D%20(obj)%20%3D%3E%20%7B%0A%20%20%20%20for%20(let%20key%20in%20obj)%20%7B%0A%20%20%20%20%20%20if%20(typeof%20obj%5Bkey%5D%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20obj%5Bkey%5D%20%3D%20sanitizeInput(obj%5Bkey%5D)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(typeof%20obj%5Bkey%5D%20%3D%3D%3D%20'object'%20%26%26%20obj%5Bkey%5D%20!%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20sanitizeObject(obj%5Bkey%5D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%20%20%0A%20%20if%20(req.body)%20sanitizeObject(req.body)%3B%0A%20%20if%20(req.query)%20sanitizeObject(req.query)%3B%0A%20%20if%20(req.params)%20sanitizeObject(req.params)%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(sanitizeMiddleware)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const DOMPurify = require('isomorphic-dompurify');
const xss = require('xss');

// HTML sanitization
const sanitizeHtml = (html) =&gt; {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li'],
    ALLOWED_ATTR: []
  });
};

// XSS protection
const sanitizeInput = (input) =&gt; {
  return xss(input, {
    whiteList: {}, // No HTML tags allowed
    stripIgnoreTag: true,
    stripIgnoreTagBody: ['script']
  });
};

// SQL injection prevention
const sanitizeSqlInput = (input) =&gt; {
  return input.replace(/['"\\;]/g, ''); // Remove dangerous characters
};

// Custom middleware for sanitization
const sanitizeMiddleware = (req, res, next) =&gt; {
  // Sanitize all string inputs
  const sanitizeObject = (obj) =&gt; {
    for (let key in obj) {
      if (typeof obj[key] === 'string') {
        obj[key] = sanitizeInput(obj[key]);
      } else if (typeof obj[key] === 'object' && obj[key] !== null) {
        sanitizeObject(obj[key]);
      }
    }
  };
  
  if (req.body) sanitizeObject(req.body);
  if (req.query) sanitizeObject(req.query);
  if (req.params) sanitizeObject(req.params);
  
  next();
};

app.use(sanitizeMiddleware);
</code></pre>
</div>
<p>Thought for 2s### 175. How do you prevent SQL injection in Express applications?</p>

<p><strong>Answer:</strong> SQL injection occurs when malicious SQL code is inserted into application queries. Prevention involves using parameterized queries, input validation, and proper escaping.</p>

<p><strong>Prevention Techniques:</strong></p>

<p><strong>1. Parameterized Queries/Prepared Statements:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20mysql%20%3D%20require('mysql2')%3B%0A%0A%2F%2F%20Vulnerable%20code%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20query%20%3D%20%60SELECT%20*%20FROM%20users%20WHERE%20id%20%3D%20%24%7Breq.params.id%7D%60%3B%0A%20%20db.query(query%2C%20(err%2C%20results)%20%3D%3E%20%7B%0A%20%20%20%20res.json(results)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Secure%20implementation%0Aapp.get('%2Fusers%2F%3Aid'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20query%20%3D%20'SELECT%20*%20FROM%20users%20WHERE%20id%20%3D%20%3F'%3B%0A%20%20db.query(query%2C%20%5Breq.params.id%5D%2C%20(err%2C%20results)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20return%20res.status(500).json(%7B%20error%3A%20'Database%20error'%20%7D)%3B%0A%20%20%20%20res.json(results)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Multiple%20parameters%0Aapp.get('%2Fusers'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20%7B%20name%2C%20email%2C%20age%20%7D%20%3D%20req.query%3B%0A%20%20const%20query%20%3D%20'SELECT%20*%20FROM%20users%20WHERE%20name%20LIKE%20%3F%20AND%20email%20%3D%20%3F%20AND%20age%20%3E%20%3F'%3B%0A%20%20const%20params%20%3D%20%5B%60%25%24%7Bname%7D%25%60%2C%20email%2C%20parseInt(age)%20%7C%7C%200%5D%3B%0A%20%20%0A%20%20db.query(query%2C%20params%2C%20(err%2C%20results)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20return%20res.status(500).json(%7B%20error%3A%20'Database%20error'%20%7D)%3B%0A%20%20%20%20res.json(results)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const mysql = require('mysql2');

// Vulnerable code
app.get('/users/:id', (req, res) =&gt; {
  const query = `SELECT * FROM users WHERE id = ${req.params.id}`;
  db.query(query, (err, results) =&gt; {
    res.json(results);
  });
});

// Secure implementation
app.get('/users/:id', (req, res) =&gt; {
  const query = 'SELECT * FROM users WHERE id = ?';
  db.query(query, [req.params.id], (err, results) =&gt; {
    if (err) return res.status(500).json({ error: 'Database error' });
    res.json(results);
  });
});

// Multiple parameters
app.get('/users', (req, res) =&gt; {
  const { name, email, age } = req.query;
  const query = 'SELECT * FROM users WHERE name LIKE ? AND email = ? AND age &gt; ?';
  const params = [`%${name}%`, email, parseInt(age) || 0];
  
  db.query(query, params, (err, results) =&gt; {
    if (err) return res.status(500).json({ error: 'Database error' });
    res.json(results);
  });
});
</code></pre>
</div>

<p><strong>2. Using ORM/Query Builders:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Sequelize%20ORM%0Aconst%20%7B%20User%20%7D%20%3D%20require('..%2Fmodels')%3B%0A%0Aapp.get('%2Fusers%2F%3Aid'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.findByPk(req.params.id)%3B%20%2F%2F%20Automatically%20parameterized%0A%20%20%20%20res.json(user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Knex.js%20Query%20Builder%0Aconst%20knex%20%3D%20require('knex')(config)%3B%0A%0Aapp.get('%2Fusers'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20users%20%3D%20await%20knex('users')%0A%20%20%20%20%20%20.where('name'%2C%20'like'%2C%20%60%25%24%7Breq.query.name%7D%25%60)%0A%20%20%20%20%20%20.andWhere('age'%2C%20'%3E'%2C%20req.query.age%20%7C%7C%200)%3B%0A%20%20%20%20res.json(users)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Sequelize ORM
const { User } = require('../models');

app.get('/users/:id', async (req, res) =&gt; {
  try {
    const user = await User.findByPk(req.params.id); // Automatically parameterized
    res.json(user);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Knex.js Query Builder
const knex = require('knex')(config);

app.get('/users', async (req, res) =&gt; {
  try {
    const users = await knex('users')
      .where('name', 'like', `%${req.query.name}%`)
      .andWhere('age', '&gt;', req.query.age || 0);
    res.json(users);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
</code></pre>
</div>

<p><strong>3. Input Validation and Sanitization:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20%7B%20param%2C%20query%2C%20validationResult%20%7D%20%3D%20require('express-validator')%3B%0A%0Aconst%20validateUserId%20%3D%20%5B%0A%20%20param('id').isInt(%7B%20min%3A%201%20%7D).withMessage('ID%20must%20be%20a%20positive%20integer')%2C%0A%20%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20const%20errors%20%3D%20validationResult(req)%3B%0A%20%20%20%20if%20(!errors.isEmpty())%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20errors%3A%20errors.array()%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20next()%3B%0A%20%20%7D%0A%5D%3B%0A%0Aapp.get('%2Fusers%2F%3Aid'%2C%20validateUserId%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20query%20%3D%20'SELECT%20*%20FROM%20users%20WHERE%20id%20%3D%20%3F'%3B%0A%20%20db.query(query%2C%20%5Breq.params.id%5D%2C%20(err%2C%20results)%20%3D%3E%20%7B%0A%20%20%20%20res.json(results)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const { param, query, validationResult } = require('express-validator');

const validateUserId = [
  param('id').isInt({ min: 1 }).withMessage('ID must be a positive integer'),
  (req, res, next) =&gt; {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    next();
  }
];

app.get('/users/:id', validateUserId, (req, res) =&gt; {
  const query = 'SELECT * FROM users WHERE id = ?';
  db.query(query, [req.params.id], (err, results) =&gt; {
    res.json(results);
  });
});
</code></pre>
</div>

<h3 id="176-how-do-you-implement-authentication-middleware-">176. How do you implement authentication middleware?</h3>

<p><strong>Answer:</strong> Authentication middleware verifies user identity and protects routes from unauthorized access.</p>

<p><strong>JWT-based Authentication:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20jwt%20%3D%20require('jsonwebtoken')%3B%0Aconst%20bcrypt%20%3D%20require('bcrypt')%3B%0A%0A%2F%2F%20Authentication%20middleware%0Aconst%20authenticateToken%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20authHeader%20%3D%20req.headers%5B'authorization'%5D%3B%0A%20%20const%20token%20%3D%20authHeader%20%26%26%20authHeader.split('%20')%5B1%5D%3B%20%2F%2F%20Bearer%20TOKEN%0A%20%20%0A%20%20if%20(!token)%20%7B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Access%20token%20required'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20jwt.verify(token%2C%20process.env.JWT_SECRET%2C%20(err%2C%20user)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20return%20res.status(403).json(%7B%20error%3A%20'Invalid%20or%20expired%20token'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20req.user%20%3D%20user%3B%0A%20%20%20%20next()%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20Optional%20authentication%20(for%20routes%20that%20work%20with%2Fwithout%20auth)%0Aconst%20optionalAuth%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20authHeader%20%3D%20req.headers%5B'authorization'%5D%3B%0A%20%20const%20token%20%3D%20authHeader%20%26%26%20authHeader.split('%20')%5B1%5D%3B%0A%20%20%0A%20%20if%20(token)%20%7B%0A%20%20%20%20jwt.verify(token%2C%20process.env.JWT_SECRET%2C%20(err%2C%20user)%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(!err)%20%7B%0A%20%20%20%20%20%20%20%20req.user%20%3D%20user%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Role-based%20authentication%0Aconst%20requireRole%20%3D%20(roles)%20%3D%3E%20%7B%0A%20%20return%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20if%20(!req.user)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Authentication%20required'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(!roles.includes(req.user.role))%20%7B%0A%20%20%20%20%20%20return%20res.status(403).json(%7B%20error%3A%20'Insufficient%20permissions'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Login%20route%0Aapp.post('%2Flogin'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20email%2C%20password%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Find%20user%0A%20%20%20%20const%20user%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Verify%20password%0A%20%20%20%20const%20validPassword%20%3D%20await%20bcrypt.compare(password%2C%20user.password)%3B%0A%20%20%20%20if%20(!validPassword)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Generate%20token%0A%20%20%20%20const%20token%20%3D%20jwt.sign(%0A%20%20%20%20%20%20%7B%20%0A%20%20%20%20%20%20%20%20id%3A%20user.id%2C%20%0A%20%20%20%20%20%20%20%20email%3A%20user.email%2C%20%0A%20%20%20%20%20%20%20%20role%3A%20user.role%20%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20process.env.JWT_SECRET%2C%0A%20%20%20%20%20%20%7B%20expiresIn%3A%20'24h'%20%7D%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20%0A%20%20%20%20%20%20token%2C%20%0A%20%20%20%20%20%20user%3A%20%7B%20%0A%20%20%20%20%20%20%20%20id%3A%20user.id%2C%20%0A%20%20%20%20%20%20%20%20email%3A%20user.email%2C%20%0A%20%20%20%20%20%20%20%20name%3A%20user.name%20%0A%20%20%20%20%20%20%7D%20%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Protected%20routes%0Aapp.get('%2Fprofile'%2C%20authenticateToken%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20user%3A%20req.user%20%7D)%3B%0A%7D)%3B%0A%0Aapp.get('%2Fadmin'%2C%20authenticateToken%2C%20requireRole(%5B'admin'%5D)%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20message%3A%20'Admin%20access%20granted'%20%7D)%3B%0A%7D)%3B%0A%0Aapp.get('%2Fposts'%2C%20optionalAuth%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20posts%20%3D%20await%20Post.find()%3B%0A%20%20%0A%20%20%2F%2F%20Add%20user-specific%20data%20if%20authenticated%0A%20%20if%20(req.user)%20%7B%0A%20%20%20%20%2F%2F%20Add%20like%20status%2C%20bookmarks%2C%20etc.%0A%20%20%20%20posts.forEach(post%20%3D%3E%20%7B%0A%20%20%20%20%20%20post.isLiked%20%3D%20post.likes.includes(req.user.id)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20res.json(posts)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');

// Authentication middleware
const authenticateToken = (req, res, next) =&gt; {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
  
  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }
  
  jwt.verify(token, process.env.JWT_SECRET, (err, user) =&gt; {
    if (err) {
      return res.status(403).json({ error: 'Invalid or expired token' });
    }
    
    req.user = user;
    next();
  });
};

// Optional authentication (for routes that work with/without auth)
const optionalAuth = (req, res, next) =&gt; {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];
  
  if (token) {
    jwt.verify(token, process.env.JWT_SECRET, (err, user) =&gt; {
      if (!err) {
        req.user = user;
      }
    });
  }
  
  next();
};

// Role-based authentication
const requireRole = (roles) =&gt; {
  return (req, res, next) =&gt; {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }
    
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    
    next();
  };
};

// Login route
app.post('/login', async (req, res) =&gt; {
  try {
    const { email, password } = req.body;
    
    // Find user
    const user = await User.findOne({ email });
    if (!user) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Verify password
    const validPassword = await bcrypt.compare(password, user.password);
    if (!validPassword) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Generate token
    const token = jwt.sign(
      { 
        id: user.id, 
        email: user.email, 
        role: user.role 
      },
      process.env.JWT_SECRET,
      { expiresIn: '24h' }
    );
    
    res.json({ 
      token, 
      user: { 
        id: user.id, 
        email: user.email, 
        name: user.name 
      } 
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Protected routes
app.get('/profile', authenticateToken, (req, res) =&gt; {
  res.json({ user: req.user });
});

app.get('/admin', authenticateToken, requireRole(['admin']), (req, res) =&gt; {
  res.json({ message: 'Admin access granted' });
});

app.get('/posts', optionalAuth, async (req, res) =&gt; {
  const posts = await Post.find();
  
  // Add user-specific data if authenticated
  if (req.user) {
    // Add like status, bookmarks, etc.
    posts.forEach(post =&gt; {
      post.isLiked = post.likes.includes(req.user.id);
    });
  }
  
  res.json(posts);
});
</code></pre>
</div>

<h3 id="177-how-do-you-implement-authorization-role-based-access-control-">177. How do you implement authorization (role-based access control)?</h3>

<p><strong>Answer:</strong> Authorization determines what authenticated users can access based on their roles and permissions.</p>

<p><strong>Role-Based Access Control (RBAC):</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20User%20model%20with%20roles%0Aconst%20userSchema%20%3D%20%7B%0A%20%20id%3A%20Number%2C%0A%20%20email%3A%20String%2C%0A%20%20role%3A%20String%2C%20%2F%2F%20'user'%2C%20'admin'%2C%20'moderator'%0A%20%20permissions%3A%20%5BString%5D%20%2F%2F%20%5B'read%3Aposts'%2C%20'write%3Aposts'%2C%20'delete%3Aposts'%5D%0A%7D%3B%0A%0A%2F%2F%20Role%20definitions%0Aconst%20ROLES%20%3D%20%7B%0A%20%20USER%3A%20'user'%2C%0A%20%20MODERATOR%3A%20'moderator'%2C%0A%20%20ADMIN%3A%20'admin'%0A%7D%3B%0A%0Aconst%20PERMISSIONS%20%3D%20%7B%0A%20%20READ_POSTS%3A%20'read%3Aposts'%2C%0A%20%20WRITE_POSTS%3A%20'write%3Aposts'%2C%0A%20%20DELETE_POSTS%3A%20'delete%3Aposts'%2C%0A%20%20MANAGE_USERS%3A%20'manage%3Ausers'%0A%7D%3B%0A%0A%2F%2F%20Role%20hierarchy%0Aconst%20ROLE_PERMISSIONS%20%3D%20%7B%0A%20%20%5BROLES.USER%5D%3A%20%5BPERMISSIONS.READ_POSTS%5D%2C%0A%20%20%5BROLES.MODERATOR%5D%3A%20%5B%0A%20%20%20%20PERMISSIONS.READ_POSTS%2C%0A%20%20%20%20PERMISSIONS.WRITE_POSTS%2C%0A%20%20%20%20PERMISSIONS.DELETE_POSTS%0A%20%20%5D%2C%0A%20%20%5BROLES.ADMIN%5D%3A%20%5B%0A%20%20%20%20PERMISSIONS.READ_POSTS%2C%0A%20%20%20%20PERMISSIONS.WRITE_POSTS%2C%0A%20%20%20%20PERMISSIONS.DELETE_POSTS%2C%0A%20%20%20%20PERMISSIONS.MANAGE_USERS%0A%20%20%5D%0A%7D%3B%0A%0A%2F%2F%20Authorization%20middleware%0Aconst%20requirePermission%20%3D%20(permission)%20%3D%3E%20%7B%0A%20%20return%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20if%20(!req.user)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Authentication%20required'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20userPermissions%20%3D%20ROLE_PERMISSIONS%5Breq.user.role%5D%20%7C%7C%20%5B%5D%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!userPermissions.includes(permission))%20%7B%0A%20%20%20%20%20%20return%20res.status(403).json(%7B%20%0A%20%20%20%20%20%20%20%20error%3A%20'Insufficient%20permissions'%2C%0A%20%20%20%20%20%20%20%20required%3A%20permission%2C%0A%20%20%20%20%20%20%20%20userRole%3A%20req.user.role%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Resource%20ownership%20check%0Aconst%20requireOwnership%20%3D%20(resourceType)%20%3D%3E%20%7B%0A%20%20return%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20let%20resource%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20switch%20(resourceType)%20%7B%0A%20%20%20%20%20%20%20%20case%20'post'%3A%0A%20%20%20%20%20%20%20%20%20%20resource%20%3D%20await%20Post.findById(req.params.id)%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20case%20'comment'%3A%0A%20%20%20%20%20%20%20%20%20%20resource%20%3D%20await%20Comment.findById(req.params.id)%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20default%3A%0A%20%20%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Invalid%20resource%20type'%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20if%20(!resource)%20%7B%0A%20%20%20%20%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'Resource%20not%20found'%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Check%20ownership%20or%20admin%20role%0A%20%20%20%20%20%20if%20(resource.userId%20!%3D%3D%20req.user.id%20%26%26%20req.user.role%20!%3D%3D%20ROLES.ADMIN)%20%7B%0A%20%20%20%20%20%20%20%20return%20res.status(403).json(%7B%20error%3A%20'Access%20denied'%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20req.resource%20%3D%20resource%3B%0A%20%20%20%20%20%20next()%3B%0A%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Dynamic%20permission%20checking%0Aconst%20checkPermission%20%3D%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20%7B%20action%2C%20resource%20%7D%20%3D%20req.body%3B%0A%20%20%0A%20%20%2F%2F%20Check%20if%20user%20has%20specific%20permission%0A%20%20const%20hasPermission%20%3D%20await%20checkUserPermission(req.user.id%2C%20action%2C%20resource)%3B%0A%20%20%0A%20%20if%20(!hasPermission)%20%7B%0A%20%20%20%20return%20res.status(403).json(%7B%20error%3A%20'Permission%20denied'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Route%20implementations%0Aapp.get('%2Fposts'%2C%20%0A%20%20authenticateToken%2C%20%0A%20%20requirePermission(PERMISSIONS.READ_POSTS)%2C%20%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20User%20can%20read%20posts%0A%20%20%20%20res.json(%7B%20posts%3A%20%5B%5D%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0Aapp.post('%2Fposts'%2C%20%0A%20%20authenticateToken%2C%20%0A%20%20requirePermission(PERMISSIONS.WRITE_POSTS)%2C%20%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20User%20can%20create%20posts%0A%20%20%20%20res.json(%7B%20message%3A%20'Post%20created'%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0Aapp.delete('%2Fposts%2F%3Aid'%2C%20%0A%20%20authenticateToken%2C%20%0A%20%20requireOwnership('post')%2C%0A%20%20requirePermission(PERMISSIONS.DELETE_POSTS)%2C%20%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20User%20can%20delete%20their%20own%20posts%20or%20admin%20can%20delete%20any%0A%20%20%20%20res.json(%7B%20message%3A%20'Post%20deleted'%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0Aapp.get('%2Fadmin%2Fusers'%2C%20%0A%20%20authenticateToken%2C%20%0A%20%20requirePermission(PERMISSIONS.MANAGE_USERS)%2C%20%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Only%20admins%20can%20manage%20users%0A%20%20%20%20res.json(%7B%20users%3A%20%5B%5D%20%7D)%3B%0A%20%20%7D%0A)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// User model with roles
const userSchema = {
  id: Number,
  email: String,
  role: String, // 'user', 'admin', 'moderator'
  permissions: [String] // ['read:posts', 'write:posts', 'delete:posts']
};

// Role definitions
const ROLES = {
  USER: 'user',
  MODERATOR: 'moderator',
  ADMIN: 'admin'
};

const PERMISSIONS = {
  READ_POSTS: 'read:posts',
  WRITE_POSTS: 'write:posts',
  DELETE_POSTS: 'delete:posts',
  MANAGE_USERS: 'manage:users'
};

// Role hierarchy
const ROLE_PERMISSIONS = {
  [ROLES.USER]: [PERMISSIONS.READ_POSTS],
  [ROLES.MODERATOR]: [
    PERMISSIONS.READ_POSTS,
    PERMISSIONS.WRITE_POSTS,
    PERMISSIONS.DELETE_POSTS
  ],
  [ROLES.ADMIN]: [
    PERMISSIONS.READ_POSTS,
    PERMISSIONS.WRITE_POSTS,
    PERMISSIONS.DELETE_POSTS,
    PERMISSIONS.MANAGE_USERS
  ]
};

// Authorization middleware
const requirePermission = (permission) =&gt; {
  return (req, res, next) =&gt; {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }
    
    const userPermissions = ROLE_PERMISSIONS[req.user.role] || [];
    
    if (!userPermissions.includes(permission)) {
      return res.status(403).json({ 
        error: 'Insufficient permissions',
        required: permission,
        userRole: req.user.role
      });
    }
    
    next();
  };
};

// Resource ownership check
const requireOwnership = (resourceType) =&gt; {
  return async (req, res, next) =&gt; {
    try {
      let resource;
      
      switch (resourceType) {
        case 'post':
          resource = await Post.findById(req.params.id);
          break;
        case 'comment':
          resource = await Comment.findById(req.params.id);
          break;
        default:
          return res.status(400).json({ error: 'Invalid resource type' });
      }
      
      if (!resource) {
        return res.status(404).json({ error: 'Resource not found' });
      }
      
      // Check ownership or admin role
      if (resource.userId !== req.user.id && req.user.role !== ROLES.ADMIN) {
        return res.status(403).json({ error: 'Access denied' });
      }
      
      req.resource = resource;
      next();
    } catch (error) {
      res.status(500).json({ error: error.message });
    }
  };
};

// Dynamic permission checking
const checkPermission = async (req, res, next) =&gt; {
  const { action, resource } = req.body;
  
  // Check if user has specific permission
  const hasPermission = await checkUserPermission(req.user.id, action, resource);
  
  if (!hasPermission) {
    return res.status(403).json({ error: 'Permission denied' });
  }
  
  next();
};

// Route implementations
app.get('/posts', 
  authenticateToken, 
  requirePermission(PERMISSIONS.READ_POSTS), 
  (req, res) =&gt; {
    // User can read posts
    res.json({ posts: [] });
  }
);

app.post('/posts', 
  authenticateToken, 
  requirePermission(PERMISSIONS.WRITE_POSTS), 
  (req, res) =&gt; {
    // User can create posts
    res.json({ message: 'Post created' });
  }
);

app.delete('/posts/:id', 
  authenticateToken, 
  requireOwnership('post'),
  requirePermission(PERMISSIONS.DELETE_POSTS), 
  (req, res) =&gt; {
    // User can delete their own posts or admin can delete any
    res.json({ message: 'Post deleted' });
  }
);

app.get('/admin/users', 
  authenticateToken, 
  requirePermission(PERMISSIONS.MANAGE_USERS), 
  (req, res) =&gt; {
    // Only admins can manage users
    res.json({ users: [] });
  }
);
</code></pre>
</div>

<h3 id="178-how-do-you-secure-express-applications-against-common-attacks-">178. How do you secure Express applications against common attacks?</h3>

<p><strong>Answer:</strong> Securing Express applications requires implementing multiple layers of protection against various attack vectors.</p>

<p><strong>Comprehensive Security Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20helmet%20%3D%20require('helmet')%3B%0Aconst%20rateLimit%20%3D%20require('express-rate-limit')%3B%0Aconst%20mongoSanitize%20%3D%20require('express-mongo-sanitize')%3B%0Aconst%20xss%20%3D%20require('xss-clean')%3B%0Aconst%20hpp%20%3D%20require('hpp')%3B%0A%0A%2F%2F%20Security%20middleware%20stack%0Aapp.use(helmet(%7B%0A%20%20contentSecurityPolicy%3A%20%7B%0A%20%20%20%20directives%3A%20%7B%0A%20%20%20%20%20%20defaultSrc%3A%20%5B%22'self'%22%5D%2C%0A%20%20%20%20%20%20styleSrc%3A%20%5B%22'self'%22%2C%20%22'unsafe-inline'%22%2C%20%22https%3A%2F%2Ffonts.googleapis.com%22%5D%2C%0A%20%20%20%20%20%20fontSrc%3A%20%5B%22'self'%22%2C%20%22https%3A%2F%2Ffonts.gstatic.com%22%5D%2C%0A%20%20%20%20%20%20scriptSrc%3A%20%5B%22'self'%22%5D%2C%0A%20%20%20%20%20%20imgSrc%3A%20%5B%22'self'%22%2C%20%22data%3A%22%2C%20%22https%3A%22%5D%2C%0A%20%20%20%20%7D%2C%0A%20%20%7D%2C%0A%20%20hsts%3A%20%7B%0A%20%20%20%20maxAge%3A%2031536000%2C%0A%20%20%20%20includeSubDomains%3A%20true%2C%0A%20%20%20%20preload%3A%20true%0A%20%20%7D%0A%7D))%3B%0A%0A%2F%2F%20Rate%20limiting%0Aconst%20limiter%20%3D%20rateLimit(%7B%0A%20%20windowMs%3A%2015%20*%2060%20*%201000%2C%20%2F%2F%2015%20minutes%0A%20%20max%3A%20100%2C%20%2F%2F%20limit%20each%20IP%20to%20100%20requests%20per%20windowMs%0A%20%20message%3A%20'Too%20many%20requests%20from%20this%20IP'%2C%0A%20%20standardHeaders%3A%20true%2C%0A%20%20legacyHeaders%3A%20false%2C%0A%7D)%3B%0A%0Aconst%20authLimiter%20%3D%20rateLimit(%7B%0A%20%20windowMs%3A%2015%20*%2060%20*%201000%2C%0A%20%20max%3A%205%2C%20%2F%2F%205%20login%20attempts%20per%2015%20minutes%0A%20%20skipSuccessfulRequests%3A%20true%2C%0A%7D)%3B%0A%0Aapp.use('%2Fapi%2F'%2C%20limiter)%3B%0Aapp.use('%2Fauth%2F'%2C%20authLimiter)%3B%0A%0A%2F%2F%20Data%20sanitization%0Aapp.use(mongoSanitize())%3B%20%2F%2F%20Prevent%20NoSQL%20injection%0Aapp.use(xss())%3B%20%2F%2F%20Clean%20user%20input%20from%20malicious%20HTML%0Aapp.use(hpp())%3B%20%2F%2F%20Prevent%20HTTP%20Parameter%20Pollution%0A%0A%2F%2F%20CORS%20configuration%0Aapp.use(cors(%7B%0A%20%20origin%3A%20process.env.ALLOWED_ORIGINS%3F.split('%2C')%20%7C%7C%20'http%3A%2F%2Flocalhost%3A3000'%2C%0A%20%20credentials%3A%20true%2C%0A%20%20optionsSuccessStatus%3A%20200%0A%7D))%3B%0A%0A%2F%2F%20Input%20validation%20middleware%0Aconst%20validateInput%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Remove%20null%20bytes%0A%20%20const%20sanitizeString%20%3D%20(str)%20%3D%3E%20%7B%0A%20%20%20%20return%20str.replace(%2F%5C0%2Fg%2C%20'')%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20const%20sanitizeObject%20%3D%20(obj)%20%3D%3E%20%7B%0A%20%20%20%20for%20(let%20key%20in%20obj)%20%7B%0A%20%20%20%20%20%20if%20(typeof%20obj%5Bkey%5D%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20obj%5Bkey%5D%20%3D%20sanitizeString(obj%5Bkey%5D)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(typeof%20obj%5Bkey%5D%20%3D%3D%3D%20'object'%20%26%26%20obj%5Bkey%5D%20!%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20sanitizeObject(obj%5Bkey%5D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%20%20%0A%20%20if%20(req.body)%20sanitizeObject(req.body)%3B%0A%20%20if%20(req.query)%20sanitizeObject(req.query)%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(validateInput)%3B%0A%0A%2F%2F%20CSRF%20protection%0Aconst%20csrf%20%3D%20require('csurf')%3B%0Aconst%20csrfProtection%20%3D%20csrf(%7B%20%0A%20%20cookie%3A%20%7B%0A%20%20%20%20httpOnly%3A%20true%2C%0A%20%20%20%20secure%3A%20process.env.NODE_ENV%20%3D%3D%3D%20'production'%2C%0A%20%20%20%20sameSite%3A%20'strict'%0A%20%20%7D%0A%7D)%3B%0A%0Aapp.use(csrfProtection)%3B%0A%0A%2F%2F%20Session%20security%0Aapp.use(session(%7B%0A%20%20secret%3A%20process.env.SESSION_SECRET%2C%0A%20%20resave%3A%20false%2C%0A%20%20saveUninitialized%3A%20false%2C%0A%20%20cookie%3A%20%7B%0A%20%20%20%20secure%3A%20process.env.NODE_ENV%20%3D%3D%3D%20'production'%2C%0A%20%20%20%20httpOnly%3A%20true%2C%0A%20%20%20%20maxAge%3A%2024%20*%2060%20*%2060%20*%201000%2C%20%2F%2F%2024%20hours%0A%20%20%20%20sameSite%3A%20'strict'%0A%20%20%7D%2C%0A%20%20store%3A%20new%20RedisStore(%7B%20client%3A%20redisClient%20%7D)%0A%7D))%3B%0A%0A%2F%2F%20File%20upload%20security%0Aconst%20multer%20%3D%20require('multer')%3B%0Aconst%20path%20%3D%20require('path')%3B%0A%0Aconst%20storage%20%3D%20multer.diskStorage(%7B%0A%20%20destination%3A%20'uploads%2F'%2C%0A%20%20filename%3A%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Generate%20safe%20filename%0A%20%20%20%20const%20uniqueSuffix%20%3D%20Date.now()%20%2B%20'-'%20%2B%20Math.round(Math.random()%20*%201E9)%3B%0A%20%20%20%20cb(null%2C%20'file-'%20%2B%20uniqueSuffix%20%2B%20path.extname(file.originalname))%3B%0A%20%20%7D%0A%7D)%3B%0A%0Aconst%20upload%20%3D%20multer(%7B%0A%20%20storage%3A%20storage%2C%0A%20%20limits%3A%20%7B%0A%20%20%20%20fileSize%3A%205%20*%201024%20*%201024%2C%20%2F%2F%205MB%0A%20%20%20%20files%3A%205%0A%20%20%7D%2C%0A%20%20fileFilter%3A%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%20%20const%20allowedTypes%20%3D%20%2Fjpeg%7Cjpg%7Cpng%7Cgif%7Cpdf%7Cdoc%7Cdocx%2F%3B%0A%20%20%20%20const%20extname%20%3D%20allowedTypes.test(path.extname(file.originalname).toLowerCase())%3B%0A%20%20%20%20const%20mimetype%20%3D%20allowedTypes.test(file.mimetype)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(mimetype%20%26%26%20extname)%20%7B%0A%20%20%20%20%20%20return%20cb(null%2C%20true)%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20cb(new%20Error('Invalid%20file%20type'))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Security%20headers%20middleware%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20res.setHeader('X-Content-Type-Options'%2C%20'nosniff')%3B%0A%20%20res.setHeader('X-Frame-Options'%2C%20'DENY')%3B%0A%20%20res.setHeader('X-XSS-Protection'%2C%20'1%3B%20mode%3Dblock')%3B%0A%20%20res.setHeader('Referrer-Policy'%2C%20'strict-origin-when-cross-origin')%3B%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Error%20handling%20that%20doesn't%20leak%20information%0Aapp.use((err%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20console.error(err.stack)%3B%0A%20%20%0A%20%20if%20(process.env.NODE_ENV%20%3D%3D%3D%20'production')%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'Internal%20Server%20Error'%20%7D)%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20res.status(500).json(%7B%20%0A%20%20%20%20%20%20error%3A%20err.message%2C%0A%20%20%20%20%20%20stack%3A%20err.stack%20%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const mongoSanitize = require('express-mongo-sanitize');
const xss = require('xss-clean');
const hpp = require('hpp');

// Security middleware stack
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: 'Too many requests from this IP',
  standardHeaders: true,
  legacyHeaders: false,
});

const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5, // 5 login attempts per 15 minutes
  skipSuccessfulRequests: true,
});

app.use('/api/', limiter);
app.use('/auth/', authLimiter);

// Data sanitization
app.use(mongoSanitize()); // Prevent NoSQL injection
app.use(xss()); // Clean user input from malicious HTML
app.use(hpp()); // Prevent HTTP Parameter Pollution

// CORS configuration
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || 'http://localhost:3000',
  credentials: true,
  optionsSuccessStatus: 200
}));

// Input validation middleware
const validateInput = (req, res, next) =&gt; {
  // Remove null bytes
  const sanitizeString = (str) =&gt; {
    return str.replace(/\0/g, '');
  };
  
  const sanitizeObject = (obj) =&gt; {
    for (let key in obj) {
      if (typeof obj[key] === 'string') {
        obj[key] = sanitizeString(obj[key]);
      } else if (typeof obj[key] === 'object' && obj[key] !== null) {
        sanitizeObject(obj[key]);
      }
    }
  };
  
  if (req.body) sanitizeObject(req.body);
  if (req.query) sanitizeObject(req.query);
  
  next();
};

app.use(validateInput);

// CSRF protection
const csrf = require('csurf');
const csrfProtection = csrf({ 
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict'
  }
});

app.use(csrfProtection);

// Session security
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000, // 24 hours
    sameSite: 'strict'
  },
  store: new RedisStore({ client: redisClient })
}));

// File upload security
const multer = require('multer');
const path = require('path');

const storage = multer.diskStorage({
  destination: 'uploads/',
  filename: (req, file, cb) =&gt; {
    // Generate safe filename
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, 'file-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB
    files: 5
  },
  fileFilter: (req, file, cb) =&gt; {
    const allowedTypes = /jpeg|jpg|png|gif|pdf|doc|docx/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);
    
    if (mimetype && extname) {
      return cb(null, true);
    } else {
      cb(new Error('Invalid file type'));
    }
  }
});

// Security headers middleware
app.use((req, res, next) =&gt; {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  next();
});

// Error handling that doesn't leak information
app.use((err, req, res, next) =&gt; {
  console.error(err.stack);
  
  if (process.env.NODE_ENV === 'production') {
    res.status(500).json({ error: 'Internal Server Error' });
  } else {
    res.status(500).json({ 
      error: err.message,
      stack: err.stack 
    });
  }
});
</code></pre>
</div>

<h3 id="179-how-do-you-implement-https-and-ssl-tls-in-express-">179. How do you implement HTTPS and SSL/TLS in Express?</h3>

<p><strong>Answer:</strong> HTTPS encrypts data in transit and authenticates the server. Implementation involves SSL/TLS certificates and proper configuration.</p>

<p><strong>HTTPS Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20express%20%3D%20require('express')%3B%0Aconst%20https%20%3D%20require('https')%3B%0Aconst%20http%20%3D%20require('http')%3B%0Aconst%20fs%20%3D%20require('fs')%3B%0Aconst%20path%20%3D%20require('path')%3B%0A%0Aconst%20app%20%3D%20express()%3B%0A%0A%2F%2F%20Force%20HTTPS%20in%20production%0Aif%20(process.env.NODE_ENV%20%3D%3D%3D%20'production')%20%7B%0A%20%20app.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20if%20(req.header('x-forwarded-proto')%20!%3D%3D%20'https')%20%7B%0A%20%20%20%20%20%20res.redirect(%60https%3A%2F%2F%24%7Breq.header('host')%7D%24%7Breq.url%7D%60)%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20next()%3B%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%7D%0A%0A%2F%2F%20SSL%20certificate%20configuration%0Aconst%20sslOptions%20%3D%20%7B%0A%20%20key%3A%20fs.readFileSync(path.join(__dirname%2C%20'ssl'%2C%20'private-key.pem'))%2C%0A%20%20cert%3A%20fs.readFileSync(path.join(__dirname%2C%20'ssl'%2C%20'certificate.pem'))%2C%0A%20%20%2F%2F%20For%20intermediate%20certificates%0A%20%20ca%3A%20fs.readFileSync(path.join(__dirname%2C%20'ssl'%2C%20'ca-bundle.pem'))%0A%7D%3B%0A%0A%2F%2F%20Create%20HTTPS%20server%0Aconst%20httpsServer%20%3D%20https.createServer(sslOptions%2C%20app)%3B%0A%0A%2F%2F%20Create%20HTTP%20server%20for%20redirect%0Aconst%20httpApp%20%3D%20express()%3B%0AhttpApp.use((req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.redirect(301%2C%20%60https%3A%2F%2F%24%7Breq.headers.host%7D%24%7Breq.url%7D%60)%3B%0A%7D)%3B%0A%0Aconst%20httpServer%20%3D%20http.createServer(httpApp)%3B%0A%0A%2F%2F%20Start%20servers%0Aconst%20PORT%20%3D%20process.env.PORT%20%7C%7C%203000%3B%0Aconst%20HTTPS_PORT%20%3D%20process.env.HTTPS_PORT%20%7C%7C%203443%3B%0A%0Aif%20(process.env.NODE_ENV%20%3D%3D%3D%20'production')%20%7B%0A%20%20httpsServer.listen(HTTPS_PORT%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20console.log(%60HTTPS%20Server%20running%20on%20port%20%24%7BHTTPS_PORT%7D%60)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20httpServer.listen(80%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20console.log('HTTP%20Server%20running%20on%20port%2080%20(redirecting%20to%20HTTPS)')%3B%0A%20%20%7D)%3B%0A%7D%20else%20%7B%0A%20%20%2F%2F%20Development%20server%20(HTTP%20only)%0A%20%20app.listen(PORT%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20console.log(%60Development%20server%20running%20on%20port%20%24%7BPORT%7D%60)%3B%0A%20%20%7D)%3B%0A%7D%0A%0A%2F%2F%20Security%20headers%20for%20HTTPS%0Aapp.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(req.secure%20%7C%7C%20req.headers%5B'x-forwarded-proto'%5D%20%3D%3D%3D%20'https')%20%7B%0A%20%20%20%20res.setHeader('Strict-Transport-Security'%2C%20'max-age%3D31536000%3B%20includeSubDomains%3B%20preload')%3B%0A%20%20%7D%0A%20%20next()%3B%0A%7D)%3B%0A%0A%2F%2F%20Let's%20Encrypt%20integration%20(for%20automatic%20SSL)%0Aconst%20acme%20%3D%20require('acme-client')%3B%0A%0Aconst%20setupLetsEncrypt%20%3D%20async%20()%20%3D%3E%20%7B%0A%20%20const%20client%20%3D%20new%20acme.Client(%7B%0A%20%20%20%20directoryUrl%3A%20acme.directory.letsencrypt.production%2C%0A%20%20%20%20accountKey%3A%20await%20acme.crypto.createPrivateKey()%0A%20%20%7D)%3B%0A%20%20%0A%20%20const%20%5Bkey%2C%20csr%5D%20%3D%20await%20acme.crypto.createCsr(%7B%0A%20%20%20%20commonName%3A%20'example.com'%2C%0A%20%20%20%20altNames%3A%20%5B'www.example.com'%5D%0A%20%20%7D)%3B%0A%20%20%0A%20%20const%20cert%20%3D%20await%20client.auto(%7B%0A%20%20%20%20csr%2C%0A%20%20%20%20email%3A%20'admin%40example.com'%2C%0A%20%20%20%20termsOfServiceAgreed%3A%20true%2C%0A%20%20%20%20challengeCreateFn%3A%20async%20(authz%2C%20challenge%2C%20keyAuthorization)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20HTTP-01%20challenge%0A%20%20%20%20%20%20app.get(%60%2F.well-known%2Facme-challenge%2F%24%7Bchallenge.token%7D%60%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20res.send(keyAuthorization)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20challengeRemoveFn%3A%20async%20(authz%2C%20challenge%2C%20keyAuthorization)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Clean%20up%20challenge%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Save%20certificate%0A%20%20fs.writeFileSync('ssl%2Fprivate-key.pem'%2C%20key)%3B%0A%20%20fs.writeFileSync('ssl%2Fcertificate.pem'%2C%20cert)%3B%0A%7D%3B%0A%0A%2F%2F%20Proxy%20configuration%20(for%20reverse%20proxy%20setups)%0Aapp.set('trust%20proxy'%2C%201)%3B%20%2F%2F%20Trust%20first%20proxy%0A%0A%2F%2F%20Cookie%20security%20for%20HTTPS%0Aapp.use(session(%7B%0A%20%20secret%3A%20process.env.SESSION_SECRET%2C%0A%20%20cookie%3A%20%7B%0A%20%20%20%20secure%3A%20process.env.NODE_ENV%20%3D%3D%3D%20'production'%2C%20%2F%2F%20HTTPS%20only%20in%20production%0A%20%20%20%20httpOnly%3A%20true%2C%0A%20%20%20%20sameSite%3A%20'strict'%0A%20%20%7D%0A%7D))%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const express = require('express');
const https = require('https');
const http = require('http');
const fs = require('fs');
const path = require('path');

const app = express();

// Force HTTPS in production
if (process.env.NODE_ENV === 'production') {
  app.use((req, res, next) =&gt; {
    if (req.header('x-forwarded-proto') !== 'https') {
      res.redirect(`https://${req.header('host')}${req.url}`);
    } else {
      next();
    }
  });
}

// SSL certificate configuration
const sslOptions = {
  key: fs.readFileSync(path.join(__dirname, 'ssl', 'private-key.pem')),
  cert: fs.readFileSync(path.join(__dirname, 'ssl', 'certificate.pem')),
  // For intermediate certificates
  ca: fs.readFileSync(path.join(__dirname, 'ssl', 'ca-bundle.pem'))
};

// Create HTTPS server
const httpsServer = https.createServer(sslOptions, app);

// Create HTTP server for redirect
const httpApp = express();
httpApp.use((req, res) =&gt; {
  res.redirect(301, `https://${req.headers.host}${req.url}`);
});

const httpServer = http.createServer(httpApp);

// Start servers
const PORT = process.env.PORT || 3000;
const HTTPS_PORT = process.env.HTTPS_PORT || 3443;

if (process.env.NODE_ENV === 'production') {
  httpsServer.listen(HTTPS_PORT, () =&gt; {
    console.log(`HTTPS Server running on port ${HTTPS_PORT}`);
  });
  
  httpServer.listen(80, () =&gt; {
    console.log('HTTP Server running on port 80 (redirecting to HTTPS)');
  });
} else {
  // Development server (HTTP only)
  app.listen(PORT, () =&gt; {
    console.log(`Development server running on port ${PORT}`);
  });
}

// Security headers for HTTPS
app.use((req, res, next) =&gt; {
  if (req.secure || req.headers['x-forwarded-proto'] === 'https') {
    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload');
  }
  next();
});

// Let's Encrypt integration (for automatic SSL)
const acme = require('acme-client');

const setupLetsEncrypt = async () =&gt; {
  const client = new acme.Client({
    directoryUrl: acme.directory.letsencrypt.production,
    accountKey: await acme.crypto.createPrivateKey()
  });
  
  const [key, csr] = await acme.crypto.createCsr({
    commonName: 'example.com',
    altNames: ['www.example.com']
  });
  
  const cert = await client.auto({
    csr,
    email: 'admin@example.com',
    termsOfServiceAgreed: true,
    challengeCreateFn: async (authz, challenge, keyAuthorization) =&gt; {
      // HTTP-01 challenge
      app.get(`/.well-known/acme-challenge/${challenge.token}`, (req, res) =&gt; {
        res.send(keyAuthorization);
      });
    },
    challengeRemoveFn: async (authz, challenge, keyAuthorization) =&gt; {
      // Clean up challenge
    }
  });
  
  // Save certificate
  fs.writeFileSync('ssl/private-key.pem', key);
  fs.writeFileSync('ssl/certificate.pem', cert);
};

// Proxy configuration (for reverse proxy setups)
app.set('trust proxy', 1); // Trust first proxy

// Cookie security for HTTPS
app.use(session({
  secret: process.env.SESSION_SECRET,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only in production
    httpOnly: true,
    sameSite: 'strict'
  }
}));
</code></pre>
</div>

<h3 id="180-how-do-you-implement-session-management-securely-">180. How do you implement session management securely?</h3>

<p><strong>Answer:</strong> Secure session management prevents session hijacking, fixation, and other session-based attacks.</p>

<p><strong>Secure Session Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20session%20%3D%20require('express-session')%3B%0Aconst%20RedisStore%20%3D%20require('connect-redis')(session)%3B%0Aconst%20redis%20%3D%20require('redis')%3B%0Aconst%20crypto%20%3D%20require('crypto')%3B%0A%0A%2F%2F%20Redis%20client%20for%20session%20storage%0Aconst%20redisClient%20%3D%20redis.createClient(%7B%0A%20%20host%3A%20process.env.REDIS_HOST%20%7C%7C%20'localhost'%2C%0A%20%20port%3A%20process.env.REDIS_PORT%20%7C%7C%206379%2C%0A%20%20password%3A%20process.env.REDIS_PASSWORD%0A%7D)%3B%0A%0A%2F%2F%20Session%20configuration%0Aconst%20sessionConfig%20%3D%20%7B%0A%20%20store%3A%20new%20RedisStore(%7B%20client%3A%20redisClient%20%7D)%2C%0A%20%20secret%3A%20process.env.SESSION_SECRET%20%7C%7C%20crypto.randomBytes(64).toString('hex')%2C%0A%20%20name%3A%20'sessionId'%2C%20%2F%2F%20Don't%20use%20default%20name%0A%20%20resave%3A%20false%2C%0A%20%20saveUninitialized%3A%20false%2C%0A%20%20rolling%3A%20true%2C%20%2F%2F%20Reset%20expiration%20on%20activity%0A%20%20cookie%3A%20%7B%0A%20%20%20%20secure%3A%20process.env.NODE_ENV%20%3D%3D%3D%20'production'%2C%20%2F%2F%20HTTPS%20only%0A%20%20%20%20httpOnly%3A%20true%2C%20%2F%2F%20Prevent%20XSS%0A%20%20%20%20maxAge%3A%2030%20*%2060%20*%201000%2C%20%2F%2F%2030%20minutes%0A%20%20%20%20sameSite%3A%20'strict'%20%2F%2F%20CSRF%20protection%0A%20%20%7D%2C%0A%20%20genid%3A%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Generate%20cryptographically%20secure%20session%20ID%0A%20%20%20%20return%20crypto.randomBytes(32).toString('hex')%3B%0A%20%20%7D%0A%7D%3B%0A%0Aapp.use(session(sessionConfig))%3B%0A%0A%2F%2F%20Session%20security%20middleware%0Aconst%20sessionSecurity%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Regenerate%20session%20ID%20on%20login%0A%20%20if%20(req.session%20%26%26%20req.session.user%20%26%26%20!req.session.regenerated)%20%7B%0A%20%20%20%20req.session.regenerate((err)%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20%20%20return%20next(err)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20req.session.regenerated%20%3D%20true%3B%0A%20%20%20%20%20%20next()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20next()%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Login%20with%20session%20management%0Aapp.post('%2Flogin'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20email%2C%20password%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Validate%20credentials%0A%20%20%20%20const%20user%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20if%20(!user%20%7C%7C%20!await%20bcrypt.compare(password%2C%20user.password))%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Regenerate%20session%20ID%20to%20prevent%20session%20fixation%0A%20%20%20%20req.session.regenerate((err)%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20%20%20return%20res.status(500).json(%7B%20error%3A%20'Session%20error'%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Store%20user%20info%20in%20session%0A%20%20%20%20%20%20req.session.user%20%3D%20%7B%0A%20%20%20%20%20%20%20%20id%3A%20user.id%2C%0A%20%20%20%20%20%20%20%20email%3A%20user.email%2C%0A%20%20%20%20%20%20%20%20role%3A%20user.role%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Track%20session%20metadata%0A%20%20%20%20%20%20req.session.loginTime%20%3D%20new%20Date()%3B%0A%20%20%20%20%20%20req.session.ipAddress%20%3D%20req.ip%3B%0A%20%20%20%20%20%20req.session.userAgent%20%3D%20req.get('User-Agent')%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20res.json(%7B%20%0A%20%20%20%20%20%20%20%20message%3A%20'Login%20successful'%2C%0A%20%20%20%20%20%20%20%20user%3A%20req.session.user%20%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Session%20validation%20middleware%0Aconst%20validateSession%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(!req.session%20%7C%7C%20!req.session.user)%20%7B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Not%20authenticated'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Check%20session%20age%0A%20%20const%20sessionAge%20%3D%20Date.now()%20-%20new%20Date(req.session.loginTime).getTime()%3B%0A%20%20const%20maxAge%20%3D%2024%20*%2060%20*%2060%20*%201000%3B%20%2F%2F%2024%20hours%0A%20%20%0A%20%20if%20(sessionAge%20%3E%20maxAge)%20%7B%0A%20%20%20%20req.session.destroy()%3B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Session%20expired'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Validate%20IP%20address%20(optional%2C%20can%20be%20problematic%20with%20mobile%20users)%0A%20%20if%20(req.session.ipAddress%20!%3D%3D%20req.ip)%20%7B%0A%20%20%20%20console.warn(%60IP%20mismatch%20for%20user%20%24%7Breq.session.user.id%7D%60)%3B%0A%20%20%20%20%2F%2F%20Optionally%20destroy%20session%20or%20require%20re-authentication%0A%20%20%7D%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Logout%0Aapp.post('%2Flogout'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20if%20(req.session)%20%7B%0A%20%20%20%20req.session.destroy((err)%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20%20%20return%20res.status(500).json(%7B%20error%3A%20'Could%20not%20log%20out'%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20res.clearCookie('sessionId')%3B%0A%20%20%20%20%20%20res.json(%7B%20message%3A%20'Logged%20out%20successfully'%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20res.json(%7B%20message%3A%20'No%20active%20session'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Session%20cleanup%20(remove%20expired%20sessions)%0Aconst%20cleanupSessions%20%3D%20()%20%3D%3E%20%7B%0A%20%20redisClient.keys('sess%3A*'%2C%20(err%2C%20keys)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20return%3B%0A%20%20%20%20%0A%20%20%20%20keys.forEach(key%20%3D%3E%20%7B%0A%20%20%20%20%20%20redisClient.get(key%2C%20(err%2C%20session)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20(err)%20return%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20sessionData%20%3D%20JSON.parse(session)%3B%0A%20%20%20%20%20%20%20%20%20%20const%20loginTime%20%3D%20new%20Date(sessionData.loginTime)%3B%0A%20%20%20%20%20%20%20%20%20%20const%20age%20%3D%20Date.now()%20-%20loginTime.getTime()%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20if%20(age%20%3E%2024%20*%2060%20*%2060%20*%201000)%20%7B%20%2F%2F%2024%20hours%0A%20%20%20%20%20%20%20%20%20%20%20%20redisClient.del(key)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20Invalid%20session%20data%2C%20remove%20it%0A%20%20%20%20%20%20%20%20%20%20redisClient.del(key)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20Run%20cleanup%20every%20hour%0AsetInterval(cleanupSessions%2C%2060%20*%2060%20*%201000)%3B%0A%0A%2F%2F%20Protected%20route%0Aapp.get('%2Fprofile'%2C%20validateSession%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%20user%3A%20req.session.user%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const session = require('express-session');
const RedisStore = require('connect-redis')(session);
const redis = require('redis');
const crypto = require('crypto');

// Redis client for session storage
const redisClient = redis.createClient({
  host: process.env.REDIS_HOST || 'localhost',
  port: process.env.REDIS_PORT || 6379,
  password: process.env.REDIS_PASSWORD
});

// Session configuration
const sessionConfig = {
  store: new RedisStore({ client: redisClient }),
  secret: process.env.SESSION_SECRET || crypto.randomBytes(64).toString('hex'),
  name: 'sessionId', // Don't use default name
  resave: false,
  saveUninitialized: false,
  rolling: true, // Reset expiration on activity
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only
    httpOnly: true, // Prevent XSS
    maxAge: 30 * 60 * 1000, // 30 minutes
    sameSite: 'strict' // CSRF protection
  },
  genid: () =&gt; {
    // Generate cryptographically secure session ID
    return crypto.randomBytes(32).toString('hex');
  }
};

app.use(session(sessionConfig));

// Session security middleware
const sessionSecurity = (req, res, next) =&gt; {
  // Regenerate session ID on login
  if (req.session && req.session.user && !req.session.regenerated) {
    req.session.regenerate((err) =&gt; {
      if (err) {
        return next(err);
      }
      req.session.regenerated = true;
      next();
    });
  } else {
    next();
  }
};

// Login with session management
app.post('/login', async (req, res) =&gt; {
  try {
    const { email, password } = req.body;
    
    // Validate credentials
    const user = await User.findOne({ email });
    if (!user || !await bcrypt.compare(password, user.password)) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Regenerate session ID to prevent session fixation
    req.session.regenerate((err) =&gt; {
      if (err) {
        return res.status(500).json({ error: 'Session error' });
      }
      
      // Store user info in session
      req.session.user = {
        id: user.id,
        email: user.email,
        role: user.role
      };
      
      // Track session metadata
      req.session.loginTime = new Date();
      req.session.ipAddress = req.ip;
      req.session.userAgent = req.get('User-Agent');
      
      res.json({ 
        message: 'Login successful',
        user: req.session.user 
      });
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Session validation middleware
const validateSession = (req, res, next) =&gt; {
  if (!req.session || !req.session.user) {
    return res.status(401).json({ error: 'Not authenticated' });
  }
  
  // Check session age
  const sessionAge = Date.now() - new Date(req.session.loginTime).getTime();
  const maxAge = 24 * 60 * 60 * 1000; // 24 hours
  
  if (sessionAge &gt; maxAge) {
    req.session.destroy();
    return res.status(401).json({ error: 'Session expired' });
  }
  
  // Validate IP address (optional, can be problematic with mobile users)
  if (req.session.ipAddress !== req.ip) {
    console.warn(`IP mismatch for user ${req.session.user.id}`);
    // Optionally destroy session or require re-authentication
  }
  
  next();
};

// Logout
app.post('/logout', (req, res) =&gt; {
  if (req.session) {
    req.session.destroy((err) =&gt; {
      if (err) {
        return res.status(500).json({ error: 'Could not log out' });
      }
      res.clearCookie('sessionId');
      res.json({ message: 'Logged out successfully' });
    });
  } else {
    res.json({ message: 'No active session' });
  }
});

// Session cleanup (remove expired sessions)
const cleanupSessions = () =&gt; {
  redisClient.keys('sess:*', (err, keys) =&gt; {
    if (err) return;
    
    keys.forEach(key =&gt; {
      redisClient.get(key, (err, session) =&gt; {
        if (err) return;
        
        try {
          const sessionData = JSON.parse(session);
          const loginTime = new Date(sessionData.loginTime);
          const age = Date.now() - loginTime.getTime();
          
          if (age &gt; 24 * 60 * 60 * 1000) { // 24 hours
            redisClient.del(key);
          }
        } catch (e) {
          // Invalid session data, remove it
          redisClient.del(key);
        }
      });
    });
  });
};

// Run cleanup every hour
setInterval(cleanupSessions, 60 * 60 * 1000);

// Protected route
app.get('/profile', validateSession, (req, res) =&gt; {
  res.json({ user: req.session.user });
});
</code></pre>
</div>

<h3 id="181-how-do-you-handle-password-hashing-and-storage-">181. How do you handle password hashing and storage?</h3>

<p><strong>Answer:</strong> Secure password handling involves proper hashing algorithms, salting, and storage practices to protect user credentials.</p>

<p><strong>Password Security Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20bcrypt%20%3D%20require('bcrypt')%3B%0Aconst%20crypto%20%3D%20require('crypto')%3B%0Aconst%20zxcvbn%20%3D%20require('zxcvbn')%3B%20%2F%2F%20Password%20strength%20checker%0A%0A%2F%2F%20Password%20hashing%20configuration%0Aconst%20SALT_ROUNDS%20%3D%2012%3B%20%2F%2F%20Adjust%20based%20on%20server%20performance%0A%0A%2F%2F%20Password%20strength%20validation%0Aconst%20validatePasswordStrength%20%3D%20(password)%20%3D%3E%20%7B%0A%20%20const%20result%20%3D%20zxcvbn(password)%3B%0A%20%20%0A%20%20return%20%7B%0A%20%20%20%20isStrong%3A%20result.score%20%3E%3D%203%2C%20%2F%2F%200-4%20scale%0A%20%20%20%20score%3A%20result.score%2C%0A%20%20%20%20feedback%3A%20result.feedback%2C%0A%20%20%20%20crackTime%3A%20result.crack_times_display.offline_slow_hashing_1e4_per_second%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Password%20hashing%0Aconst%20hashPassword%20%3D%20async%20(password)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20%2F%2F%20Generate%20salt%20and%20hash%0A%20%20%20%20const%20salt%20%3D%20await%20bcrypt.genSalt(SALT_ROUNDS)%3B%0A%20%20%20%20const%20hashedPassword%20%3D%20await%20bcrypt.hash(password%2C%20salt)%3B%0A%20%20%20%20return%20hashedPassword%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20throw%20new%20Error('Password%20hashing%20failed')%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Password%20verification%0Aconst%20verifyPassword%20%3D%20async%20(password%2C%20hashedPassword)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20return%20await%20bcrypt.compare(password%2C%20hashedPassword)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20throw%20new%20Error('Password%20verification%20failed')%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20User%20registration%20with%20secure%20password%20handling%0Aapp.post('%2Fregister'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20email%2C%20password%2C%20confirmPassword%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Basic%20validation%0A%20%20%20%20if%20(!email%20%7C%7C%20!password%20%7C%7C%20!confirmPassword)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'All%20fields%20are%20required'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(password%20!%3D%3D%20confirmPassword)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Passwords%20do%20not%20match'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20password%20strength%0A%20%20%20%20const%20strengthCheck%20%3D%20validatePasswordStrength(password)%3B%0A%20%20%20%20if%20(!strengthCheck.isStrong)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'Password%20is%20too%20weak'%2C%0A%20%20%20%20%20%20%20%20feedback%3A%20strengthCheck.feedback%2C%0A%20%20%20%20%20%20%20%20score%3A%20strengthCheck.score%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20if%20user%20exists%0A%20%20%20%20const%20existingUser%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20if%20(existingUser)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'User%20already%20exists'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Hash%20password%0A%20%20%20%20const%20hashedPassword%20%3D%20await%20hashPassword(password)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Create%20user%0A%20%20%20%20const%20user%20%3D%20new%20User(%7B%0A%20%20%20%20%20%20email%2C%0A%20%20%20%20%20%20password%3A%20hashedPassword%2C%0A%20%20%20%20%20%20createdAt%3A%20new%20Date()%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20res.status(201).json(%7B%0A%20%20%20%20%20%20message%3A%20'User%20created%20successfully'%2C%0A%20%20%20%20%20%20user%3A%20%7B%20id%3A%20user.id%2C%20email%3A%20user.email%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Login%20with%20secure%20password%20verification%0Aapp.post('%2Flogin'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20email%2C%20password%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Find%20user%0A%20%20%20%20const%20user%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Use%20same%20timing%20to%20prevent%20user%20enumeration%0A%20%20%20%20%20%20await%20bcrypt.hash('dummy'%2C%20SALT_ROUNDS)%3B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Verify%20password%0A%20%20%20%20const%20isValidPassword%20%3D%20await%20verifyPassword(password%2C%20user.password)%3B%0A%20%20%20%20if%20(!isValidPassword)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Update%20last%20login%0A%20%20%20%20user.lastLogin%20%3D%20new%20Date()%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Generate%20JWT%20token%0A%20%20%20%20const%20token%20%3D%20jwt.sign(%0A%20%20%20%20%20%20%7B%20id%3A%20user.id%2C%20email%3A%20user.email%20%7D%2C%0A%20%20%20%20%20%20process.env.JWT_SECRET%2C%0A%20%20%20%20%20%20%7B%20expiresIn%3A%20'24h'%20%7D%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%0A%20%20%20%20%20%20message%3A%20'Login%20successful'%2C%0A%20%20%20%20%20%20token%2C%0A%20%20%20%20%20%20user%3A%20%7B%20id%3A%20user.id%2C%20email%3A%20user.email%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Password%20change%0Aapp.put('%2Fchange-password'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20currentPassword%2C%20newPassword%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Get%20user%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(req.user.id)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'User%20not%20found'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Verify%20current%20password%0A%20%20%20%20const%20isValidPassword%20%3D%20await%20verifyPassword(currentPassword%2C%20user.password)%3B%0A%20%20%20%20if%20(!isValidPassword)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Current%20password%20is%20incorrect'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20new%20password%20strength%0A%20%20%20%20const%20strengthCheck%20%3D%20validatePasswordStrength(newPassword)%3B%0A%20%20%20%20if%20(!strengthCheck.isStrong)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'New%20password%20is%20too%20weak'%2C%0A%20%20%20%20%20%20%20%20feedback%3A%20strengthCheck.feedback%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20if%20new%20password%20is%20different%20from%20current%0A%20%20%20%20const%20isSamePassword%20%3D%20await%20verifyPassword(newPassword%2C%20user.password)%3B%0A%20%20%20%20if%20(isSamePassword)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'New%20password%20must%20be%20different'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Hash%20new%20password%0A%20%20%20%20const%20hashedNewPassword%20%3D%20await%20hashPassword(newPassword)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Update%20password%0A%20%20%20%20user.password%20%3D%20hashedNewPassword%3B%0A%20%20%20%20user.passwordChangedAt%20%3D%20new%20Date()%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20message%3A%20'Password%20changed%20successfully'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Password%20reset%20functionality%0Aconst%20generateResetToken%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20crypto.randomBytes(32).toString('hex')%3B%0A%7D%3B%0A%0Aapp.post('%2Fforgot-password'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20email%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20const%20user%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Don't%20reveal%20if%20email%20exists%0A%20%20%20%20%20%20return%20res.json(%7B%20message%3A%20'If%20email%20exists%2C%20reset%20link%20has%20been%20sent'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Generate%20reset%20token%0A%20%20%20%20const%20resetToken%20%3D%20generateResetToken()%3B%0A%20%20%20%20const%20resetTokenExpiry%20%3D%20new%20Date(Date.now()%20%2B%2060%20*%2060%20*%201000)%3B%20%2F%2F%201%20hour%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Hash%20reset%20token%20before%20storing%0A%20%20%20%20const%20hashedResetToken%20%3D%20crypto%0A%20%20%20%20%20%20.createHash('sha256')%0A%20%20%20%20%20%20.update(resetToken)%0A%20%20%20%20%20%20.digest('hex')%3B%0A%20%20%20%20%0A%20%20%20%20user.passwordResetToken%20%3D%20hashedResetToken%3B%0A%20%20%20%20user.passwordResetExpires%20%3D%20resetTokenExpiry%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Send%20email%20with%20reset%20token%20(implementation%20depends%20on%20email%20service)%0A%20%20%20%20%2F%2F%20await%20sendPasswordResetEmail(user.email%2C%20resetToken)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20message%3A%20'If%20email%20exists%2C%20reset%20link%20has%20been%20sent'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0Aapp.post('%2Freset-password'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20token%2C%20newPassword%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Hash%20the%20token%20to%20compare%20with%20stored%20hash%0A%20%20%20%20const%20hashedToken%20%3D%20crypto%0A%20%20%20%20%20%20.createHash('sha256')%0A%20%20%20%20%20%20.update(token)%0A%20%20%20%20%20%20.digest('hex')%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Find%20user%20with%20valid%20reset%20token%0A%20%20%20%20const%20user%20%3D%20await%20User.findOne(%7B%0A%20%20%20%20%20%20passwordResetToken%3A%20hashedToken%2C%0A%20%20%20%20%20%20passwordResetExpires%3A%20%7B%20%24gt%3A%20new%20Date()%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Invalid%20or%20expired%20reset%20token'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Validate%20new%20password%0A%20%20%20%20const%20strengthCheck%20%3D%20validatePasswordStrength(newPassword)%3B%0A%20%20%20%20if%20(!strengthCheck.isStrong)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'Password%20is%20too%20weak'%2C%0A%20%20%20%20%20%20%20%20feedback%3A%20strengthCheck.feedback%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Hash%20new%20password%0A%20%20%20%20const%20hashedPassword%20%3D%20await%20hashPassword(newPassword)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Update%20user%0A%20%20%20%20user.password%20%3D%20hashedPassword%3B%0A%20%20%20%20user.passwordResetToken%20%3D%20undefined%3B%0A%20%20%20%20user.passwordResetExpires%20%3D%20undefined%3B%0A%20%20%20%20user.passwordChangedAt%20%3D%20new%20Date()%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20message%3A%20'Password%20reset%20successful'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const bcrypt = require('bcrypt');
const crypto = require('crypto');
const zxcvbn = require('zxcvbn'); // Password strength checker

// Password hashing configuration
const SALT_ROUNDS = 12; // Adjust based on server performance

// Password strength validation
const validatePasswordStrength = (password) =&gt; {
  const result = zxcvbn(password);
  
  return {
    isStrong: result.score &gt;= 3, // 0-4 scale
    score: result.score,
    feedback: result.feedback,
    crackTime: result.crack_times_display.offline_slow_hashing_1e4_per_second
  };
};

// Password hashing
const hashPassword = async (password) =&gt; {
  try {
    // Generate salt and hash
    const salt = await bcrypt.genSalt(SALT_ROUNDS);
    const hashedPassword = await bcrypt.hash(password, salt);
    return hashedPassword;
  } catch (error) {
    throw new Error('Password hashing failed');
  }
};

// Password verification
const verifyPassword = async (password, hashedPassword) =&gt; {
  try {
    return await bcrypt.compare(password, hashedPassword);
  } catch (error) {
    throw new Error('Password verification failed');
  }
};

// User registration with secure password handling
app.post('/register', async (req, res) =&gt; {
  try {
    const { email, password, confirmPassword } = req.body;
    
    // Basic validation
    if (!email || !password || !confirmPassword) {
      return res.status(400).json({ error: 'All fields are required' });
    }
    
    if (password !== confirmPassword) {
      return res.status(400).json({ error: 'Passwords do not match' });
    }
    
    // Check password strength
    const strengthCheck = validatePasswordStrength(password);
    if (!strengthCheck.isStrong) {
      return res.status(400).json({
        error: 'Password is too weak',
        feedback: strengthCheck.feedback,
        score: strengthCheck.score
      });
    }
    
    // Check if user exists
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ error: 'User already exists' });
    }
    
    // Hash password
    const hashedPassword = await hashPassword(password);
    
    // Create user
    const user = new User({
      email,
      password: hashedPassword,
      createdAt: new Date()
    });
    
    await user.save();
    
    res.status(201).json({
      message: 'User created successfully',
      user: { id: user.id, email: user.email }
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Login with secure password verification
app.post('/login', async (req, res) =&gt; {
  try {
    const { email, password } = req.body;
    
    // Find user
    const user = await User.findOne({ email });
    if (!user) {
      // Use same timing to prevent user enumeration
      await bcrypt.hash('dummy', SALT_ROUNDS);
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Verify password
    const isValidPassword = await verifyPassword(password, user.password);
    if (!isValidPassword) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Update last login
    user.lastLogin = new Date();
    await user.save();
    
    // Generate JWT token
    const token = jwt.sign(
      { id: user.id, email: user.email },
      process.env.JWT_SECRET,
      { expiresIn: '24h' }
    );
    
    res.json({
      message: 'Login successful',
      token,
      user: { id: user.id, email: user.email }
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Password change
app.put('/change-password', authenticateToken, async (req, res) =&gt; {
  try {
    const { currentPassword, newPassword } = req.body;
    
    // Get user
    const user = await User.findById(req.user.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    // Verify current password
    const isValidPassword = await verifyPassword(currentPassword, user.password);
    if (!isValidPassword) {
      return res.status(401).json({ error: 'Current password is incorrect' });
    }
    
    // Check new password strength
    const strengthCheck = validatePasswordStrength(newPassword);
    if (!strengthCheck.isStrong) {
      return res.status(400).json({
        error: 'New password is too weak',
        feedback: strengthCheck.feedback
      });
    }
    
    // Check if new password is different from current
    const isSamePassword = await verifyPassword(newPassword, user.password);
    if (isSamePassword) {
      return res.status(400).json({ error: 'New password must be different' });
    }
    
    // Hash new password
    const hashedNewPassword = await hashPassword(newPassword);
    
    // Update password
    user.password = hashedNewPassword;
    user.passwordChangedAt = new Date();
    await user.save();
    
    res.json({ message: 'Password changed successfully' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Password reset functionality
const generateResetToken = () =&gt; {
  return crypto.randomBytes(32).toString('hex');
};

app.post('/forgot-password', async (req, res) =&gt; {
  try {
    const { email } = req.body;
    
    const user = await User.findOne({ email });
    if (!user) {
      // Don't reveal if email exists
      return res.json({ message: 'If email exists, reset link has been sent' });
    }
    
    // Generate reset token
    const resetToken = generateResetToken();
    const resetTokenExpiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour
    
    // Hash reset token before storing
    const hashedResetToken = crypto
      .createHash('sha256')
      .update(resetToken)
      .digest('hex');
    
    user.passwordResetToken = hashedResetToken;
    user.passwordResetExpires = resetTokenExpiry;
    await user.save();
    
    // Send email with reset token (implementation depends on email service)
    // await sendPasswordResetEmail(user.email, resetToken);
    
    res.json({ message: 'If email exists, reset link has been sent' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.post('/reset-password', async (req, res) =&gt; {
  try {
    const { token, newPassword } = req.body;
    
    // Hash the token to compare with stored hash
    const hashedToken = crypto
      .createHash('sha256')
      .update(token)
      .digest('hex');
    
    // Find user with valid reset token
    const user = await User.findOne({
      passwordResetToken: hashedToken,
      passwordResetExpires: { $gt: new Date() }
    });
    
    if (!user) {
      return res.status(400).json({ error: 'Invalid or expired reset token' });
    }
    
    // Validate new password
    const strengthCheck = validatePasswordStrength(newPassword);
    if (!strengthCheck.isStrong) {
      return res.status(400).json({
        error: 'Password is too weak',
        feedback: strengthCheck.feedback
      });
    }
    
    // Hash new password
    const hashedPassword = await hashPassword(newPassword);
    
    // Update user
    user.password = hashedPassword;
    user.passwordResetToken = undefined;
    user.passwordResetExpires = undefined;
    user.passwordChangedAt = new Date();
    await user.save();
    
    res.json({ message: 'Password reset successful' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
</code></pre>
</div>

<h3 id="182-how-do-you-implement-api-key-authentication-">182. How do you implement API key authentication?</h3>

<p><strong>Answer:</strong> API key authentication provides a simple way to authenticate API requests, commonly used for service-to-service communication.</p>

<p><strong>API Key Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20crypto%20%3D%20require('crypto')%3B%0A%0A%2F%2F%20API%20Key%20model%0Aconst%20apiKeySchema%20%3D%20%7B%0A%20%20id%3A%20String%2C%0A%20%20key%3A%20String%2C%20%2F%2F%20Hashed%20API%20key%0A%20%20name%3A%20String%2C%20%2F%2F%20Human-readable%20name%0A%20%20userId%3A%20String%2C%20%2F%2F%20Owner%20of%20the%20API%20key%0A%20%20permissions%3A%20%5BString%5D%2C%20%2F%2F%20Scoped%20permissions%0A%20%20rateLimit%3A%20Number%2C%20%2F%2F%20Requests%20per%20hour%0A%20%20isActive%3A%20Boolean%2C%0A%20%20lastUsed%3A%20Date%2C%0A%20%20createdAt%3A%20Date%2C%0A%20%20expiresAt%3A%20Date%0A%7D%3B%0A%0A%2F%2F%20Generate%20API%20key%0Aconst%20generateApiKey%20%3D%20()%20%3D%3E%20%7B%0A%20%20const%20prefix%20%3D%20'ak_'%3B%20%2F%2F%20API%20key%20prefix%0A%20%20const%20randomBytes%20%3D%20crypto.randomBytes(32).toString('hex')%3B%0A%20%20return%20prefix%20%2B%20randomBytes%3B%0A%7D%3B%0A%0A%2F%2F%20Hash%20API%20key%20for%20storage%0Aconst%20hashApiKey%20%3D%20(apiKey)%20%3D%3E%20%7B%0A%20%20return%20crypto.createHash('sha256').update(apiKey).digest('hex')%3B%0A%7D%3B%0A%0A%2F%2F%20Create%20API%20key%0Aapp.post('%2Fapi-keys'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20name%2C%20permissions%2C%20rateLimit%2C%20expiresIn%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Generate%20API%20key%0A%20%20%20%20const%20apiKey%20%3D%20generateApiKey()%3B%0A%20%20%20%20const%20hashedKey%20%3D%20hashApiKey(apiKey)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Calculate%20expiration%0A%20%20%20%20let%20expiresAt%20%3D%20null%3B%0A%20%20%20%20if%20(expiresIn)%20%7B%0A%20%20%20%20%20%20expiresAt%20%3D%20new%20Date(Date.now()%20%2B%20expiresIn%20*%2024%20*%2060%20*%2060%20*%201000)%3B%20%2F%2F%20days%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Create%20API%20key%20record%0A%20%20%20%20const%20apiKeyRecord%20%3D%20new%20ApiKey(%7B%0A%20%20%20%20%20%20key%3A%20hashedKey%2C%0A%20%20%20%20%20%20name%2C%0A%20%20%20%20%20%20userId%3A%20req.user.id%2C%0A%20%20%20%20%20%20permissions%3A%20permissions%20%7C%7C%20%5B'read'%5D%2C%0A%20%20%20%20%20%20rateLimit%3A%20rateLimit%20%7C%7C%201000%2C%20%2F%2F%20Default%201000%20requests%20per%20hour%0A%20%20%20%20%20%20isActive%3A%20true%2C%0A%20%20%20%20%20%20createdAt%3A%20new%20Date()%2C%0A%20%20%20%20%20%20expiresAt%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20await%20apiKeyRecord.save()%3B%0A%20%20%20%20%0A%20%20%20%20res.status(201).json(%7B%0A%20%20%20%20%20%20message%3A%20'API%20key%20created%20successfully'%2C%0A%20%20%20%20%20%20apiKey%3A%20apiKey%2C%20%2F%2F%20Return%20unhashed%20key%20only%20once%0A%20%20%20%20%20%20id%3A%20apiKeyRecord.id%2C%0A%20%20%20%20%20%20name%3A%20apiKeyRecord.name%2C%0A%20%20%20%20%20%20permissions%3A%20apiKeyRecord.permissions%2C%0A%20%20%20%20%20%20rateLimit%3A%20apiKeyRecord.rateLimit%2C%0A%20%20%20%20%20%20expiresAt%3A%20apiKeyRecord.expiresAt%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20API%20key%20authentication%20middleware%0Aconst%20authenticateApiKey%20%3D%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20apiKey%20%3D%20req.headers%5B'x-api-key'%5D%20%7C%7C%20req.query.api_key%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!apiKey)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'API%20key%20required'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Validate%20API%20key%20format%0A%20%20%20%20if%20(!apiKey.startsWith('ak_'))%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20API%20key%20format'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Hash%20the%20provided%20key%0A%20%20%20%20const%20hashedKey%20%3D%20hashApiKey(apiKey)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Find%20API%20key%20in%20database%0A%20%20%20%20const%20apiKeyRecord%20%3D%20await%20ApiKey.findOne(%7B%0A%20%20%20%20%20%20key%3A%20hashedKey%2C%0A%20%20%20%20%20%20isActive%3A%20true%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!apiKeyRecord)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20API%20key'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20expiration%0A%20%20%20%20if%20(apiKeyRecord.expiresAt%20%26%26%20apiKeyRecord.expiresAt%20%3C%20new%20Date())%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'API%20key%20expired'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Rate%20limiting%20check%0A%20%20%20%20const%20hourAgo%20%3D%20new%20Date(Date.now()%20-%2060%20*%2060%20*%201000)%3B%0A%20%20%20%20const%20recentRequests%20%3D%20await%20ApiRequest.countDocuments(%7B%0A%20%20%20%20%20%20apiKeyId%3A%20apiKeyRecord.id%2C%0A%20%20%20%20%20%20timestamp%3A%20%7B%20%24gte%3A%20hourAgo%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(recentRequests%20%3E%3D%20apiKeyRecord.rateLimit)%20%7B%0A%20%20%20%20%20%20return%20res.status(429).json(%7B%20%0A%20%20%20%20%20%20%20%20error%3A%20'Rate%20limit%20exceeded'%2C%0A%20%20%20%20%20%20%20%20limit%3A%20apiKeyRecord.rateLimit%2C%0A%20%20%20%20%20%20%20%20resetTime%3A%20new%20Date(Date.now()%20%2B%2060%20*%2060%20*%201000)%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Log%20API%20request%0A%20%20%20%20await%20ApiRequest.create(%7B%0A%20%20%20%20%20%20apiKeyId%3A%20apiKeyRecord.id%2C%0A%20%20%20%20%20%20endpoint%3A%20req.path%2C%0A%20%20%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20%20%20ip%3A%20req.ip%2C%0A%20%20%20%20%20%20userAgent%3A%20req.get('User-Agent')%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date()%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Update%20last%20used%0A%20%20%20%20apiKeyRecord.lastUsed%20%3D%20new%20Date()%3B%0A%20%20%20%20await%20apiKeyRecord.save()%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Attach%20API%20key%20info%20to%20request%0A%20%20%20%20req.apiKey%20%3D%20%7B%0A%20%20%20%20%20%20id%3A%20apiKeyRecord.id%2C%0A%20%20%20%20%20%20userId%3A%20apiKeyRecord.userId%2C%0A%20%20%20%20%20%20permissions%3A%20apiKeyRecord.permissions%2C%0A%20%20%20%20%20%20name%3A%20apiKeyRecord.name%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'Authentication%20error'%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Permission%20checking%20middleware%0Aconst%20requireApiPermission%20%3D%20(permission)%20%3D%3E%20%7B%0A%20%20return%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20if%20(!req.apiKey)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'API%20key%20required'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(!req.apiKey.permissions.includes(permission)%20%26%26%20%0A%20%20%20%20%20%20%20%20!req.apiKey.permissions.includes('admin'))%20%7B%0A%20%20%20%20%20%20return%20res.status(403).json(%7B%20%0A%20%20%20%20%20%20%20%20error%3A%20'Insufficient%20permissions'%2C%0A%20%20%20%20%20%20%20%20required%3A%20permission%2C%0A%20%20%20%20%20%20%20%20available%3A%20req.apiKey.permissions%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Protected%20API%20routes%0Aapp.get('%2Fapi%2Fdata'%2C%20%0A%20%20authenticateApiKey%2C%20%0A%20%20requireApiPermission('read')%2C%20%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20res.json(%7B%20%0A%20%20%20%20%20%20data%3A%20'Protected%20data'%2C%0A%20%20%20%20%20%20apiKey%3A%20req.apiKey.name%20%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0Aapp.post('%2Fapi%2Fdata'%2C%20%0A%20%20authenticateApiKey%2C%20%0A%20%20requireApiPermission('write')%2C%20%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20res.json(%7B%20message%3A%20'Data%20created'%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0A%2F%2F%20List%20user's%20API%20keys%0Aapp.get('%2Fapi-keys'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20apiKeys%20%3D%20await%20ApiKey.find(%7B%20%0A%20%20%20%20%20%20userId%3A%20req.user.id%20%0A%20%20%20%20%7D).select('-key')%3B%20%2F%2F%20Don't%20return%20hashed%20keys%0A%20%20%20%20%0A%20%20%20%20res.json(apiKeys)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Revoke%20API%20key%0Aapp.delete('%2Fapi-keys%2F%3Aid'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20apiKey%20%3D%20await%20ApiKey.findOne(%7B%0A%20%20%20%20%20%20_id%3A%20req.params.id%2C%0A%20%20%20%20%20%20userId%3A%20req.user.id%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!apiKey)%20%7B%0A%20%20%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'API%20key%20not%20found'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20apiKey.isActive%20%3D%20false%3B%0A%20%20%20%20await%20apiKey.save()%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20message%3A%20'API%20key%20revoked'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20API%20usage%20analytics%0Aapp.get('%2Fapi-keys%2F%3Aid%2Fusage'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20apiKey%20%3D%20await%20ApiKey.findOne(%7B%0A%20%20%20%20%20%20_id%3A%20req.params.id%2C%0A%20%20%20%20%20%20userId%3A%20req.user.id%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!apiKey)%20%7B%0A%20%20%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'API%20key%20not%20found'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20usage%20%3D%20await%20ApiRequest.aggregate(%5B%0A%20%20%20%20%20%20%7B%20%24match%3A%20%7B%20apiKeyId%3A%20apiKey.id%20%7D%20%7D%2C%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%24group%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20_id%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20date%3A%20%7B%20%24dateToString%3A%20%7B%20format%3A%20'%25Y-%25m-%25d'%2C%20date%3A%20'%24timestamp'%20%7D%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20endpoint%3A%20'%24endpoint'%0A%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20count%3A%20%7B%20%24sum%3A%201%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7B%20%24sort%3A%20%7B%20'_id.date'%3A%20-1%20%7D%20%7D%0A%20%20%20%20%5D)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20usage%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const crypto = require('crypto');

// API Key model
const apiKeySchema = {
  id: String,
  key: String, // Hashed API key
  name: String, // Human-readable name
  userId: String, // Owner of the API key
  permissions: [String], // Scoped permissions
  rateLimit: Number, // Requests per hour
  isActive: Boolean,
  lastUsed: Date,
  createdAt: Date,
  expiresAt: Date
};

// Generate API key
const generateApiKey = () =&gt; {
  const prefix = 'ak_'; // API key prefix
  const randomBytes = crypto.randomBytes(32).toString('hex');
  return prefix + randomBytes;
};

// Hash API key for storage
const hashApiKey = (apiKey) =&gt; {
  return crypto.createHash('sha256').update(apiKey).digest('hex');
};

// Create API key
app.post('/api-keys', authenticateToken, async (req, res) =&gt; {
  try {
    const { name, permissions, rateLimit, expiresIn } = req.body;
    
    // Generate API key
    const apiKey = generateApiKey();
    const hashedKey = hashApiKey(apiKey);
    
    // Calculate expiration
    let expiresAt = null;
    if (expiresIn) {
      expiresAt = new Date(Date.now() + expiresIn * 24 * 60 * 60 * 1000); // days
    }
    
    // Create API key record
    const apiKeyRecord = new ApiKey({
      key: hashedKey,
      name,
      userId: req.user.id,
      permissions: permissions || ['read'],
      rateLimit: rateLimit || 1000, // Default 1000 requests per hour
      isActive: true,
      createdAt: new Date(),
      expiresAt
    });
    
    await apiKeyRecord.save();
    
    res.status(201).json({
      message: 'API key created successfully',
      apiKey: apiKey, // Return unhashed key only once
      id: apiKeyRecord.id,
      name: apiKeyRecord.name,
      permissions: apiKeyRecord.permissions,
      rateLimit: apiKeyRecord.rateLimit,
      expiresAt: apiKeyRecord.expiresAt
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// API key authentication middleware
const authenticateApiKey = async (req, res, next) =&gt; {
  try {
    const apiKey = req.headers['x-api-key'] || req.query.api_key;
    
    if (!apiKey) {
      return res.status(401).json({ error: 'API key required' });
    }
    
    // Validate API key format
    if (!apiKey.startsWith('ak_')) {
      return res.status(401).json({ error: 'Invalid API key format' });
    }
    
    // Hash the provided key
    const hashedKey = hashApiKey(apiKey);
    
    // Find API key in database
    const apiKeyRecord = await ApiKey.findOne({
      key: hashedKey,
      isActive: true
    });
    
    if (!apiKeyRecord) {
      return res.status(401).json({ error: 'Invalid API key' });
    }
    
    // Check expiration
    if (apiKeyRecord.expiresAt && apiKeyRecord.expiresAt &lt; new Date()) {
      return res.status(401).json({ error: 'API key expired' });
    }
    
    // Rate limiting check
    const hourAgo = new Date(Date.now() - 60 * 60 * 1000);
    const recentRequests = await ApiRequest.countDocuments({
      apiKeyId: apiKeyRecord.id,
      timestamp: { $gte: hourAgo }
    });
    
    if (recentRequests &gt;= apiKeyRecord.rateLimit) {
      return res.status(429).json({ 
        error: 'Rate limit exceeded',
        limit: apiKeyRecord.rateLimit,
        resetTime: new Date(Date.now() + 60 * 60 * 1000)
      });
    }
    
    // Log API request
    await ApiRequest.create({
      apiKeyId: apiKeyRecord.id,
      endpoint: req.path,
      method: req.method,
      ip: req.ip,
      userAgent: req.get('User-Agent'),
      timestamp: new Date()
    });
    
    // Update last used
    apiKeyRecord.lastUsed = new Date();
    await apiKeyRecord.save();
    
    // Attach API key info to request
    req.apiKey = {
      id: apiKeyRecord.id,
      userId: apiKeyRecord.userId,
      permissions: apiKeyRecord.permissions,
      name: apiKeyRecord.name
    };
    
    next();
  } catch (error) {
    res.status(500).json({ error: 'Authentication error' });
  }
};

// Permission checking middleware
const requireApiPermission = (permission) =&gt; {
  return (req, res, next) =&gt; {
    if (!req.apiKey) {
      return res.status(401).json({ error: 'API key required' });
    }
    
    if (!req.apiKey.permissions.includes(permission) && 
        !req.apiKey.permissions.includes('admin')) {
      return res.status(403).json({ 
        error: 'Insufficient permissions',
        required: permission,
        available: req.apiKey.permissions
      });
    }
    
    next();
  };
};

// Protected API routes
app.get('/api/data', 
  authenticateApiKey, 
  requireApiPermission('read'), 
  (req, res) =&gt; {
    res.json({ 
      data: 'Protected data',
      apiKey: req.apiKey.name 
    });
  }
);

app.post('/api/data', 
  authenticateApiKey, 
  requireApiPermission('write'), 
  (req, res) =&gt; {
    res.json({ message: 'Data created' });
  }
);

// List user's API keys
app.get('/api-keys', authenticateToken, async (req, res) =&gt; {
  try {
    const apiKeys = await ApiKey.find({ 
      userId: req.user.id 
    }).select('-key'); // Don't return hashed keys
    
    res.json(apiKeys);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Revoke API key
app.delete('/api-keys/:id', authenticateToken, async (req, res) =&gt; {
  try {
    const apiKey = await ApiKey.findOne({
      _id: req.params.id,
      userId: req.user.id
    });
    
    if (!apiKey) {
      return res.status(404).json({ error: 'API key not found' });
    }
    
    apiKey.isActive = false;
    await apiKey.save();
    
    res.json({ message: 'API key revoked' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// API usage analytics
app.get('/api-keys/:id/usage', authenticateToken, async (req, res) =&gt; {
  try {
    const apiKey = await ApiKey.findOne({
      _id: req.params.id,
      userId: req.user.id
    });
    
    if (!apiKey) {
      return res.status(404).json({ error: 'API key not found' });
    }
    
    const usage = await ApiRequest.aggregate([
      { $match: { apiKeyId: apiKey.id } },
      {
        $group: {
          _id: {
            date: { $dateToString: { format: '%Y-%m-%d', date: '$timestamp' } },
            endpoint: '$endpoint'
          },
          count: { $sum: 1 }
        }
      },
      { $sort: { '_id.date': -1 } }
    ]);
    
    res.json({ usage });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
</code></pre>
</div>

<h3 id="183-how-do-you-implement-oauth-2-0-in-express-">183. How do you implement OAuth 2.0 in Express?</h3>

<p><strong>Answer:</strong> OAuth 2.0 allows users to authenticate using third-party providers like Google, Facebook, or GitHub without sharing passwords.</p>

<p><strong>OAuth 2.0 Implementation with Passport.js:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20passport%20%3D%20require('passport')%3B%0Aconst%20GoogleStrategy%20%3D%20require('passport-google-oauth20').Strategy%3B%0Aconst%20GitHubStrategy%20%3D%20require('passport-github2').Strategy%3B%0Aconst%20FacebookStrategy%20%3D%20require('passport-facebook').Strategy%3B%0A%0A%2F%2F%20Passport%20configuration%0Apassport.use(new%20GoogleStrategy(%7B%0A%20%20clientID%3A%20process.env.GOOGLE_CLIENT_ID%2C%0A%20%20clientSecret%3A%20process.env.GOOGLE_CLIENT_SECRET%2C%0A%20%20callbackURL%3A%20'%2Fauth%2Fgoogle%2Fcallback'%0A%7D%2C%20async%20(accessToken%2C%20refreshToken%2C%20profile%2C%20done)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20%2F%2F%20Check%20if%20user%20exists%0A%20%20%20%20let%20user%20%3D%20await%20User.findOne(%7B%20googleId%3A%20profile.id%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(user)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Update%20user%20info%0A%20%20%20%20%20%20user.lastLogin%20%3D%20new%20Date()%3B%0A%20%20%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%20%20return%20done(null%2C%20user)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20if%20user%20exists%20with%20same%20email%0A%20%20%20%20user%20%3D%20await%20User.findOne(%7B%20email%3A%20profile.emails%5B0%5D.value%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(user)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Link%20Google%20account%20to%20existing%20user%0A%20%20%20%20%20%20user.googleId%20%3D%20profile.id%3B%0A%20%20%20%20%20%20user.lastLogin%20%3D%20new%20Date()%3B%0A%20%20%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%20%20return%20done(null%2C%20user)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Create%20new%20user%0A%20%20%20%20user%20%3D%20new%20User(%7B%0A%20%20%20%20%20%20googleId%3A%20profile.id%2C%0A%20%20%20%20%20%20email%3A%20profile.emails%5B0%5D.value%2C%0A%20%20%20%20%20%20name%3A%20profile.displayName%2C%0A%20%20%20%20%20%20avatar%3A%20profile.photos%5B0%5D.value%2C%0A%20%20%20%20%20%20provider%3A%20'google'%2C%0A%20%20%20%20%20%20createdAt%3A%20new%20Date()%2C%0A%20%20%20%20%20%20lastLogin%3A%20new%20Date()%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20done(null%2C%20user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20done(error%2C%20null)%3B%0A%20%20%7D%0A%7D))%3B%0A%0A%2F%2F%20GitHub%20Strategy%0Apassport.use(new%20GitHubStrategy(%7B%0A%20%20clientID%3A%20process.env.GITHUB_CLIENT_ID%2C%0A%20%20clientSecret%3A%20process.env.GITHUB_CLIENT_SECRET%2C%0A%20%20callbackURL%3A%20'%2Fauth%2Fgithub%2Fcallback'%0A%7D%2C%20async%20(accessToken%2C%20refreshToken%2C%20profile%2C%20done)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20let%20user%20%3D%20await%20User.findOne(%7B%20githubId%3A%20profile.id%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(user)%20%7B%0A%20%20%20%20%20%20user.lastLogin%20%3D%20new%20Date()%3B%0A%20%20%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%20%20return%20done(null%2C%20user)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Create%20new%20user%0A%20%20%20%20user%20%3D%20new%20User(%7B%0A%20%20%20%20%20%20githubId%3A%20profile.id%2C%0A%20%20%20%20%20%20email%3A%20profile.emails%3F.%5B0%5D%3F.value%2C%0A%20%20%20%20%20%20name%3A%20profile.displayName%20%7C%7C%20profile.username%2C%0A%20%20%20%20%20%20username%3A%20profile.username%2C%0A%20%20%20%20%20%20avatar%3A%20profile.photos%5B0%5D.value%2C%0A%20%20%20%20%20%20provider%3A%20'github'%2C%0A%20%20%20%20%20%20createdAt%3A%20new%20Date()%2C%0A%20%20%20%20%20%20lastLogin%3A%20new%20Date()%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20done(null%2C%20user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20done(error%2C%20null)%3B%0A%20%20%7D%0A%7D))%3B%0A%0A%2F%2F%20Serialize%2Fdeserialize%20user%20for%20session%0Apassport.serializeUser((user%2C%20done)%20%3D%3E%20%7B%0A%20%20done(null%2C%20user.id)%3B%0A%7D)%3B%0A%0Apassport.deserializeUser(async%20(id%2C%20done)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(id)%3B%0A%20%20%20%20done(null%2C%20user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20done(error%2C%20null)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Initialize%20Passport%0Aapp.use(passport.initialize())%3B%0Aapp.use(passport.session())%3B%0A%0A%2F%2F%20OAuth%20routes%0Aapp.get('%2Fauth%2Fgoogle'%2C%0A%20%20passport.authenticate('google'%2C%20%7B%20scope%3A%20%5B'profile'%2C%20'email'%5D%20%7D)%0A)%3B%0A%0Aapp.get('%2Fauth%2Fgoogle%2Fcallback'%2C%0A%20%20passport.authenticate('google'%2C%20%7B%20failureRedirect%3A%20'%2Flogin'%20%7D)%2C%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Generate%20JWT%20token%0A%20%20%20%20const%20token%20%3D%20jwt.sign(%0A%20%20%20%20%20%20%7B%20id%3A%20req.user.id%2C%20email%3A%20req.user.email%20%7D%2C%0A%20%20%20%20%20%20process.env.JWT_SECRET%2C%0A%20%20%20%20%20%20%7B%20expiresIn%3A%20'24h'%20%7D%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Redirect%20with%20token%20(or%20set%20cookie)%0A%20%20%20%20res.redirect(%60%24%7Bprocess.env.CLIENT_URL%7D%2Fauth%2Fsuccess%3Ftoken%3D%24%7Btoken%7D%60)%3B%0A%20%20%7D%0A)%3B%0A%0Aapp.get('%2Fauth%2Fgithub'%2C%0A%20%20passport.authenticate('github'%2C%20%7B%20scope%3A%20%5B'user%3Aemail'%5D%20%7D)%0A)%3B%0A%0Aapp.get('%2Fauth%2Fgithub%2Fcallback'%2C%0A%20%20passport.authenticate('github'%2C%20%7B%20failureRedirect%3A%20'%2Flogin'%20%7D)%2C%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20const%20token%20%3D%20jwt.sign(%0A%20%20%20%20%20%20%7B%20id%3A%20req.user.id%2C%20email%3A%20req.user.email%20%7D%2C%0A%20%20%20%20%20%20process.env.JWT_SECRET%2C%0A%20%20%20%20%20%20%7B%20expiresIn%3A%20'24h'%20%7D%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20res.redirect(%60%24%7Bprocess.env.CLIENT_URL%7D%2Fauth%2Fsuccess%3Ftoken%3D%24%7Btoken%7D%60)%3B%0A%20%20%7D%0A)%3B%0A%0A%2F%2F%20Manual%20OAuth%202.0%20implementation%20(without%20Passport)%0Aconst%20axios%20%3D%20require('axios')%3B%0A%0A%2F%2F%20OAuth%20configuration%0Aconst%20oauthConfig%20%3D%20%7B%0A%20%20google%3A%20%7B%0A%20%20%20%20clientId%3A%20process.env.GOOGLE_CLIENT_ID%2C%0A%20%20%20%20clientSecret%3A%20process.env.GOOGLE_CLIENT_SECRET%2C%0A%20%20%20%20redirectUri%3A%20process.env.GOOGLE_REDIRECT_URI%2C%0A%20%20%20%20scope%3A%20'openid%20profile%20email'%2C%0A%20%20%20%20authUrl%3A%20'https%3A%2F%2Faccounts.google.com%2Fo%2Foauth2%2Fv2%2Fauth'%2C%0A%20%20%20%20tokenUrl%3A%20'https%3A%2F%2Foauth2.googleapis.com%2Ftoken'%2C%0A%20%20%20%20userInfoUrl%3A%20'https%3A%2F%2Fwww.googleapis.com%2Foauth2%2Fv2%2Fuserinfo'%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Generate%20OAuth%20URL%0Aapp.get('%2Fauth%2Fgoogle%2Furl'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20state%20%3D%20crypto.randomBytes(32).toString('hex')%3B%0A%20%20req.session.oauthState%20%3D%20state%3B%0A%20%20%0A%20%20const%20params%20%3D%20new%20URLSearchParams(%7B%0A%20%20%20%20client_id%3A%20oauthConfig.google.clientId%2C%0A%20%20%20%20redirect_uri%3A%20oauthConfig.google.redirectUri%2C%0A%20%20%20%20scope%3A%20oauthConfig.google.scope%2C%0A%20%20%20%20response_type%3A%20'code'%2C%0A%20%20%20%20state%3A%20state%0A%20%20%7D)%3B%0A%20%20%0A%20%20const%20authUrl%20%3D%20%60%24%7BoauthConfig.google.authUrl%7D%3F%24%7Bparams%7D%60%3B%0A%20%20res.json(%7B%20authUrl%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Handle%20OAuth%20callback%0Aapp.get('%2Fauth%2Fgoogle%2Fcallback'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20code%2C%20state%20%7D%20%3D%20req.query%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Verify%20state%20parameter%0A%20%20%20%20if%20(state%20!%3D%3D%20req.session.oauthState)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Invalid%20state%20parameter'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Exchange%20code%20for%20access%20token%0A%20%20%20%20const%20tokenResponse%20%3D%20await%20axios.post(oauthConfig.google.tokenUrl%2C%20%7B%0A%20%20%20%20%20%20client_id%3A%20oauthConfig.google.clientId%2C%0A%20%20%20%20%20%20client_secret%3A%20oauthConfig.google.clientSecret%2C%0A%20%20%20%20%20%20code%3A%20code%2C%0A%20%20%20%20%20%20grant_type%3A%20'authorization_code'%2C%0A%20%20%20%20%20%20redirect_uri%3A%20oauthConfig.google.redirectUri%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20access_token%20%7D%20%3D%20tokenResponse.data%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Get%20user%20info%0A%20%20%20%20const%20userResponse%20%3D%20await%20axios.get(oauthConfig.google.userInfoUrl%2C%20%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20Authorization%3A%20%60Bearer%20%24%7Baccess_token%7D%60%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20const%20userInfo%20%3D%20userResponse.data%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Find%20or%20create%20user%0A%20%20%20%20let%20user%20%3D%20await%20User.findOne(%7B%20googleId%3A%20userInfo.id%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20user%20%3D%20new%20User(%7B%0A%20%20%20%20%20%20%20%20googleId%3A%20userInfo.id%2C%0A%20%20%20%20%20%20%20%20email%3A%20userInfo.email%2C%0A%20%20%20%20%20%20%20%20name%3A%20userInfo.name%2C%0A%20%20%20%20%20%20%20%20avatar%3A%20userInfo.picture%2C%0A%20%20%20%20%20%20%20%20provider%3A%20'google'%2C%0A%20%20%20%20%20%20%20%20createdAt%3A%20new%20Date()%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Generate%20JWT%20token%0A%20%20%20%20const%20token%20%3D%20jwt.sign(%0A%20%20%20%20%20%20%7B%20id%3A%20user.id%2C%20email%3A%20user.email%20%7D%2C%0A%20%20%20%20%20%20process.env.JWT_SECRET%2C%0A%20%20%20%20%20%20%7B%20expiresIn%3A%20'24h'%20%7D%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20token%2C%20user%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'OAuth%20authentication%20failed'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Logout%0Aapp.post('%2Flogout'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20req.logout((err)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20return%20res.status(500).json(%7B%20error%3A%20'Logout%20failed'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20req.session.destroy()%3B%0A%20%20%20%20res.json(%7B%20message%3A%20'Logged%20out%20successfully'%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Link%2Funlink%20social%20accounts%0Aapp.post('%2Fauth%2Flink%2Fgoogle'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20accessToken%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Get%20Google%20user%20info%0A%20%20%20%20const%20userResponse%20%3D%20await%20axios.get(oauthConfig.google.userInfoUrl%2C%20%7B%0A%20%20%20%20%20%20headers%3A%20%7B%20Authorization%3A%20%60Bearer%20%24%7BaccessToken%7D%60%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20const%20googleUser%20%3D%20userResponse.data%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20if%20Google%20account%20is%20already%20linked%20to%20another%20user%0A%20%20%20%20const%20existingUser%20%3D%20await%20User.findOne(%7B%20googleId%3A%20googleUser.id%20%7D)%3B%0A%20%20%20%20if%20(existingUser%20%26%26%20existingUser.id%20!%3D%3D%20req.user.id)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Google%20account%20already%20linked%20to%20another%20user'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Link%20Google%20account%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(req.user.id)%3B%0A%20%20%20%20user.googleId%20%3D%20googleUser.id%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20message%3A%20'Google%20account%20linked%20successfully'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'Failed%20to%20link%20Google%20account'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0Aapp.delete('%2Fauth%2Funlink%2Fgoogle'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(req.user.id)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20if%20user%20has%20other%20authentication%20methods%0A%20%20%20%20if%20(!user.password%20%26%26%20!user.githubId%20%26%26%20!user.facebookId)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20%0A%20%20%20%20%20%20%20%20error%3A%20'Cannot%20unlink%20last%20authentication%20method'%20%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20user.googleId%20%3D%20undefined%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20message%3A%20'Google%20account%20unlinked%20successfully'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'Failed%20to%20unlink%20Google%20account'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const passport = require('passport');
const GoogleStrategy = require('passport-google-oauth20').Strategy;
const GitHubStrategy = require('passport-github2').Strategy;
const FacebookStrategy = require('passport-facebook').Strategy;

// Passport configuration
passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  callbackURL: '/auth/google/callback'
}, async (accessToken, refreshToken, profile, done) =&gt; {
  try {
    // Check if user exists
    let user = await User.findOne({ googleId: profile.id });
    
    if (user) {
      // Update user info
      user.lastLogin = new Date();
      await user.save();
      return done(null, user);
    }
    
    // Check if user exists with same email
    user = await User.findOne({ email: profile.emails[0].value });
    
    if (user) {
      // Link Google account to existing user
      user.googleId = profile.id;
      user.lastLogin = new Date();
      await user.save();
      return done(null, user);
    }
    
    // Create new user
    user = new User({
      googleId: profile.id,
      email: profile.emails[0].value,
      name: profile.displayName,
      avatar: profile.photos[0].value,
      provider: 'google',
      createdAt: new Date(),
      lastLogin: new Date()
    });
    
    await user.save();
    done(null, user);
  } catch (error) {
    done(error, null);
  }
}));

// GitHub Strategy
passport.use(new GitHubStrategy({
  clientID: process.env.GITHUB_CLIENT_ID,
  clientSecret: process.env.GITHUB_CLIENT_SECRET,
  callbackURL: '/auth/github/callback'
}, async (accessToken, refreshToken, profile, done) =&gt; {
  try {
    let user = await User.findOne({ githubId: profile.id });
    
    if (user) {
      user.lastLogin = new Date();
      await user.save();
      return done(null, user);
    }
    
    // Create new user
    user = new User({
      githubId: profile.id,
      email: profile.emails?.[0]?.value,
      name: profile.displayName || profile.username,
      username: profile.username,
      avatar: profile.photos[0].value,
      provider: 'github',
      createdAt: new Date(),
      lastLogin: new Date()
    });
    
    await user.save();
    done(null, user);
  } catch (error) {
    done(error, null);
  }
}));

// Serialize/deserialize user for session
passport.serializeUser((user, done) =&gt; {
  done(null, user.id);
});

passport.deserializeUser(async (id, done) =&gt; {
  try {
    const user = await User.findById(id);
    done(null, user);
  } catch (error) {
    done(error, null);
  }
});

// Initialize Passport
app.use(passport.initialize());
app.use(passport.session());

// OAuth routes
app.get('/auth/google',
  passport.authenticate('google', { scope: ['profile', 'email'] })
);

app.get('/auth/google/callback',
  passport.authenticate('google', { failureRedirect: '/login' }),
  (req, res) =&gt; {
    // Generate JWT token
    const token = jwt.sign(
      { id: req.user.id, email: req.user.email },
      process.env.JWT_SECRET,
      { expiresIn: '24h' }
    );
    
    // Redirect with token (or set cookie)
    res.redirect(`${process.env.CLIENT_URL}/auth/success?token=${token}`);
  }
);

app.get('/auth/github',
  passport.authenticate('github', { scope: ['user:email'] })
);

app.get('/auth/github/callback',
  passport.authenticate('github', { failureRedirect: '/login' }),
  (req, res) =&gt; {
    const token = jwt.sign(
      { id: req.user.id, email: req.user.email },
      process.env.JWT_SECRET,
      { expiresIn: '24h' }
    );
    
    res.redirect(`${process.env.CLIENT_URL}/auth/success?token=${token}`);
  }
);

// Manual OAuth 2.0 implementation (without Passport)
const axios = require('axios');

// OAuth configuration
const oauthConfig = {
  google: {
    clientId: process.env.GOOGLE_CLIENT_ID,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    redirectUri: process.env.GOOGLE_REDIRECT_URI,
    scope: 'openid profile email',
    authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
    tokenUrl: 'https://oauth2.googleapis.com/token',
    userInfoUrl: 'https://www.googleapis.com/oauth2/v2/userinfo'
  }
};

// Generate OAuth URL
app.get('/auth/google/url', (req, res) =&gt; {
  const state = crypto.randomBytes(32).toString('hex');
  req.session.oauthState = state;
  
  const params = new URLSearchParams({
    client_id: oauthConfig.google.clientId,
    redirect_uri: oauthConfig.google.redirectUri,
    scope: oauthConfig.google.scope,
    response_type: 'code',
    state: state
  });
  
  const authUrl = `${oauthConfig.google.authUrl}?${params}`;
  res.json({ authUrl });
});

// Handle OAuth callback
app.get('/auth/google/callback', async (req, res) =&gt; {
  try {
    const { code, state } = req.query;
    
    // Verify state parameter
    if (state !== req.session.oauthState) {
      return res.status(400).json({ error: 'Invalid state parameter' });
    }
    
    // Exchange code for access token
    const tokenResponse = await axios.post(oauthConfig.google.tokenUrl, {
      client_id: oauthConfig.google.clientId,
      client_secret: oauthConfig.google.clientSecret,
      code: code,
      grant_type: 'authorization_code',
      redirect_uri: oauthConfig.google.redirectUri
    });
    
    const { access_token } = tokenResponse.data;
    
    // Get user info
    const userResponse = await axios.get(oauthConfig.google.userInfoUrl, {
      headers: {
        Authorization: `Bearer ${access_token}`
      }
    });
    
    const userInfo = userResponse.data;
    
    // Find or create user
    let user = await User.findOne({ googleId: userInfo.id });
    
    if (!user) {
      user = new User({
        googleId: userInfo.id,
        email: userInfo.email,
        name: userInfo.name,
        avatar: userInfo.picture,
        provider: 'google',
        createdAt: new Date()
      });
      await user.save();
    }
    
    // Generate JWT token
    const token = jwt.sign(
      { id: user.id, email: user.email },
      process.env.JWT_SECRET,
      { expiresIn: '24h' }
    );
    
    res.json({ token, user });
  } catch (error) {
    res.status(500).json({ error: 'OAuth authentication failed' });
  }
});

// Logout
app.post('/logout', (req, res) =&gt; {
  req.logout((err) =&gt; {
    if (err) {
      return res.status(500).json({ error: 'Logout failed' });
    }
    req.session.destroy();
    res.json({ message: 'Logged out successfully' });
  });
});

// Link/unlink social accounts
app.post('/auth/link/google', authenticateToken, async (req, res) =&gt; {
  try {
    const { accessToken } = req.body;
    
    // Get Google user info
    const userResponse = await axios.get(oauthConfig.google.userInfoUrl, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    
    const googleUser = userResponse.data;
    
    // Check if Google account is already linked to another user
    const existingUser = await User.findOne({ googleId: googleUser.id });
    if (existingUser && existingUser.id !== req.user.id) {
      return res.status(400).json({ error: 'Google account already linked to another user' });
    }
    
    // Link Google account
    const user = await User.findById(req.user.id);
    user.googleId = googleUser.id;
    await user.save();
    
    res.json({ message: 'Google account linked successfully' });
  } catch (error) {
    res.status(500).json({ error: 'Failed to link Google account' });
  }
});

app.delete('/auth/unlink/google', authenticateToken, async (req, res) =&gt; {
  try {
    const user = await User.findById(req.user.id);
    
    // Check if user has other authentication methods
    if (!user.password && !user.githubId && !user.facebookId) {
      return res.status(400).json({ 
        error: 'Cannot unlink last authentication method' 
      });
    }
    
    user.googleId = undefined;
    await user.save();
    
    res.json({ message: 'Google account unlinked successfully' });
  } catch (error) {
    res.status(500).json({ error: 'Failed to unlink Google account' });
  }
});
</code></pre>
</div>

<h3 id="184-how-do-you-implement-jwt-json-web-tokens-authentication-">184. How do you implement JWT (JSON Web Tokens) authentication?</h3>

<p><strong>Answer:</strong> JWT provides stateless authentication by encoding user information in a signed token that can be verified without server-side storage.</p>

<p><strong>JWT Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20jwt%20%3D%20require('jsonwebtoken')%3B%0Aconst%20crypto%20%3D%20require('crypto')%3B%0A%0A%2F%2F%20JWT%20configuration%0Aconst%20JWT_CONFIG%20%3D%20%7B%0A%20%20accessTokenSecret%3A%20process.env.JWT_ACCESS_SECRET%2C%0A%20%20refreshTokenSecret%3A%20process.env.JWT_REFRESH_SECRET%2C%0A%20%20accessTokenExpiry%3A%20'15m'%2C%20%2F%2F%20Short-lived%20access%20token%0A%20%20refreshTokenExpiry%3A%20'7d'%2C%20%2F%2F%20Long-lived%20refresh%20token%0A%20%20issuer%3A%20'myapp.com'%2C%0A%20%20audience%3A%20'myapp-users'%0A%7D%3B%0A%0A%2F%2F%20Generate%20token%20pair%0Aconst%20generateTokens%20%3D%20(payload)%20%3D%3E%20%7B%0A%20%20const%20accessToken%20%3D%20jwt.sign(%0A%20%20%20%20payload%2C%0A%20%20%20%20JWT_CONFIG.accessTokenSecret%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20expiresIn%3A%20JWT_CONFIG.accessTokenExpiry%2C%0A%20%20%20%20%20%20issuer%3A%20JWT_CONFIG.issuer%2C%0A%20%20%20%20%20%20audience%3A%20JWT_CONFIG.audience%0A%20%20%20%20%7D%0A%20%20)%3B%0A%20%20%0A%20%20const%20refreshToken%20%3D%20jwt.sign(%0A%20%20%20%20%7B%20userId%3A%20payload.id%20%7D%2C%0A%20%20%20%20JWT_CONFIG.refreshTokenSecret%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20expiresIn%3A%20JWT_CONFIG.refreshTokenExpiry%2C%0A%20%20%20%20%20%20issuer%3A%20JWT_CONFIG.issuer%2C%0A%20%20%20%20%20%20audience%3A%20JWT_CONFIG.audience%0A%20%20%20%20%7D%0A%20%20)%3B%0A%20%20%0A%20%20return%20%7B%20accessToken%2C%20refreshToken%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Verify%20access%20token%20middleware%0Aconst%20verifyAccessToken%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20authHeader%20%3D%20req.headers.authorization%3B%0A%20%20const%20token%20%3D%20authHeader%20%26%26%20authHeader.split('%20')%5B1%5D%3B%20%2F%2F%20Bearer%20TOKEN%0A%20%20%0A%20%20if%20(!token)%20%7B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Access%20token%20required'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20jwt.verify(token%2C%20JWT_CONFIG.accessTokenSecret%2C%20%7B%0A%20%20%20%20issuer%3A%20JWT_CONFIG.issuer%2C%0A%20%20%20%20audience%3A%20JWT_CONFIG.audience%0A%20%20%7D%2C%20(err%2C%20decoded)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20if%20(err.name%20%3D%3D%3D%20'TokenExpiredError')%20%7B%0A%20%20%20%20%20%20%20%20return%20res.status(401).json(%7B%20%0A%20%20%20%20%20%20%20%20%20%20error%3A%20'Token%20expired'%2C%0A%20%20%20%20%20%20%20%20%20%20code%3A%20'TOKEN_EXPIRED'%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20res.status(403).json(%7B%20error%3A%20'Invalid%20token'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20req.user%20%3D%20decoded%3B%0A%20%20%20%20next()%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20Verify%20refresh%20token%0Aconst%20verifyRefreshToken%20%3D%20(token)%20%3D%3E%20%7B%0A%20%20return%20new%20Promise((resolve%2C%20reject)%20%3D%3E%20%7B%0A%20%20%20%20jwt.verify(token%2C%20JWT_CONFIG.refreshTokenSecret%2C%20%7B%0A%20%20%20%20%20%20issuer%3A%20JWT_CONFIG.issuer%2C%0A%20%20%20%20%20%20audience%3A%20JWT_CONFIG.audience%0A%20%20%20%20%7D%2C%20(err%2C%20decoded)%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20%20%20reject(err)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20resolve(decoded)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20Login%20endpoint%0Aapp.post('%2Fauth%2Flogin'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20email%2C%20password%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Validate%20credentials%0A%20%20%20%20const%20user%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20if%20(!user%20%7C%7C%20!await%20bcrypt.compare(password%2C%20user.password))%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Generate%20tokens%0A%20%20%20%20const%20tokenPayload%20%3D%20%7B%0A%20%20%20%20%20%20id%3A%20user.id%2C%0A%20%20%20%20%20%20email%3A%20user.email%2C%0A%20%20%20%20%20%20role%3A%20user.role%2C%0A%20%20%20%20%20%20iat%3A%20Math.floor(Date.now()%20%2F%201000)%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20accessToken%2C%20refreshToken%20%7D%20%3D%20generateTokens(tokenPayload)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Store%20refresh%20token%20(hashed)%0A%20%20%20%20const%20hashedRefreshToken%20%3D%20crypto%0A%20%20%20%20%20%20.createHash('sha256')%0A%20%20%20%20%20%20.update(refreshToken)%0A%20%20%20%20%20%20.digest('hex')%3B%0A%20%20%20%20%0A%20%20%20%20user.refreshTokens%20%3D%20user.refreshTokens%20%7C%7C%20%5B%5D%3B%0A%20%20%20%20user.refreshTokens.push(%7B%0A%20%20%20%20%20%20token%3A%20hashedRefreshToken%2C%0A%20%20%20%20%20%20createdAt%3A%20new%20Date()%2C%0A%20%20%20%20%20%20userAgent%3A%20req.get('User-Agent')%2C%0A%20%20%20%20%20%20ipAddress%3A%20req.ip%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Limit%20number%20of%20refresh%20tokens%20per%20user%0A%20%20%20%20if%20(user.refreshTokens.length%20%3E%205)%20%7B%0A%20%20%20%20%20%20user.refreshTokens%20%3D%20user.refreshTokens.slice(-5)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Set%20refresh%20token%20as%20httpOnly%20cookie%0A%20%20%20%20res.cookie('refreshToken'%2C%20refreshToken%2C%20%7B%0A%20%20%20%20%20%20httpOnly%3A%20true%2C%0A%20%20%20%20%20%20secure%3A%20process.env.NODE_ENV%20%3D%3D%3D%20'production'%2C%0A%20%20%20%20%20%20sameSite%3A%20'strict'%2C%0A%20%20%20%20%20%20maxAge%3A%207%20*%2024%20*%2060%20*%2060%20*%201000%20%2F%2F%207%20days%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%0A%20%20%20%20%20%20accessToken%2C%0A%20%20%20%20%20%20user%3A%20%7B%0A%20%20%20%20%20%20%20%20id%3A%20user.id%2C%0A%20%20%20%20%20%20%20%20email%3A%20user.email%2C%0A%20%20%20%20%20%20%20%20name%3A%20user.name%2C%0A%20%20%20%20%20%20%20%20role%3A%20user.role%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Token%20refresh%20endpoint%0Aapp.post('%2Fauth%2Frefresh'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20refreshToken%20%3D%20req.cookies.refreshToken%20%7C%7C%20req.body.refreshToken%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!refreshToken)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Refresh%20token%20required'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Verify%20refresh%20token%0A%20%20%20%20const%20decoded%20%3D%20await%20verifyRefreshToken(refreshToken)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Find%20user%20and%20verify%20refresh%20token%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(decoded.userId)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20refresh%20token'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20hashedRefreshToken%20%3D%20crypto%0A%20%20%20%20%20%20.createHash('sha256')%0A%20%20%20%20%20%20.update(refreshToken)%0A%20%20%20%20%20%20.digest('hex')%3B%0A%20%20%20%20%0A%20%20%20%20const%20tokenExists%20%3D%20user.refreshTokens.some(%0A%20%20%20%20%20%20token%20%3D%3E%20token.token%20%3D%3D%3D%20hashedRefreshToken%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!tokenExists)%20%7B%0A%20%20%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Invalid%20refresh%20token'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Generate%20new%20access%20token%0A%20%20%20%20const%20tokenPayload%20%3D%20%7B%0A%20%20%20%20%20%20id%3A%20user.id%2C%0A%20%20%20%20%20%20email%3A%20user.email%2C%0A%20%20%20%20%20%20role%3A%20user.role%2C%0A%20%20%20%20%20%20iat%3A%20Math.floor(Date.now()%20%2F%201000)%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20accessToken%2C%20refreshToken%3A%20newRefreshToken%20%7D%20%3D%20generateTokens(tokenPayload)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Replace%20old%20refresh%20token%20with%20new%20one%0A%20%20%20%20user.refreshTokens%20%3D%20user.refreshTokens.filter(%0A%20%20%20%20%20%20token%20%3D%3E%20token.token%20!%3D%3D%20hashedRefreshToken%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20const%20hashedNewRefreshToken%20%3D%20crypto%0A%20%20%20%20%20%20.createHash('sha256')%0A%20%20%20%20%20%20.update(newRefreshToken)%0A%20%20%20%20%20%20.digest('hex')%3B%0A%20%20%20%20%0A%20%20%20%20user.refreshTokens.push(%7B%0A%20%20%20%20%20%20token%3A%20hashedNewRefreshToken%2C%0A%20%20%20%20%20%20createdAt%3A%20new%20Date()%2C%0A%20%20%20%20%20%20userAgent%3A%20req.get('User-Agent')%2C%0A%20%20%20%20%20%20ipAddress%3A%20req.ip%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Set%20new%20refresh%20token%20cookie%0A%20%20%20%20res.cookie('refreshToken'%2C%20newRefreshToken%2C%20%7B%0A%20%20%20%20%20%20httpOnly%3A%20true%2C%0A%20%20%20%20%20%20secure%3A%20process.env.NODE_ENV%20%3D%3D%3D%20'production'%2C%0A%20%20%20%20%20%20sameSite%3A%20'strict'%2C%0A%20%20%20%20%20%20maxAge%3A%207%20*%2024%20*%2060%20*%2060%20*%201000%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%20accessToken%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(401).json(%7B%20error%3A%20'Invalid%20refresh%20token'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Logout%20endpoint%0Aapp.post('%2Fauth%2Flogout'%2C%20verifyAccessToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20refreshToken%20%3D%20req.cookies.refreshToken%3B%0A%20%20%20%20%0A%20%20%20%20if%20(refreshToken)%20%7B%0A%20%20%20%20%20%20const%20hashedRefreshToken%20%3D%20crypto%0A%20%20%20%20%20%20%20%20.createHash('sha256')%0A%20%20%20%20%20%20%20%20.update(refreshToken)%0A%20%20%20%20%20%20%20%20.digest('hex')%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Remove%20refresh%20token%20from%20user%0A%20%20%20%20%20%20const%20user%20%3D%20await%20User.findById(req.user.id)%3B%0A%20%20%20%20%20%20if%20(user)%20%7B%0A%20%20%20%20%20%20%20%20user.refreshTokens%20%3D%20user.refreshTokens.filter(%0A%20%20%20%20%20%20%20%20%20%20token%20%3D%3E%20token.token%20!%3D%3D%20hashedRefreshToken%0A%20%20%20%20%20%20%20%20)%3B%0A%20%20%20%20%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Clear%20refresh%20token%20cookie%0A%20%20%20%20res.clearCookie('refreshToken')%3B%0A%20%20%20%20res.json(%7B%20message%3A%20'Logged%20out%20successfully'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Logout%20from%20all%20devices%0Aapp.post('%2Fauth%2Flogout-all'%2C%20verifyAccessToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(req.user.id)%3B%0A%20%20%20%20if%20(user)%20%7B%0A%20%20%20%20%20%20user.refreshTokens%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20res.clearCookie('refreshToken')%3B%0A%20%20%20%20res.json(%7B%20message%3A%20'Logged%20out%20from%20all%20devices'%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Protected%20route%20example%0Aapp.get('%2Fprofile'%2C%20verifyAccessToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(req.user.id).select('-password%20-refreshTokens')%3B%0A%20%20%20%20res.json(user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20JWT%20blacklist%20for%20immediate%20token%20revocation%20(optional)%0Aconst%20tokenBlacklist%20%3D%20new%20Set()%3B%0A%0Aconst%20checkBlacklist%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20token%20%3D%20req.headers.authorization%3F.split('%20')%5B1%5D%3B%0A%20%20%0A%20%20if%20(token%20%26%26%20tokenBlacklist.has(token))%20%7B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Token%20revoked'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Revoke%20token%20endpoint%0Aapp.post('%2Fauth%2Frevoke'%2C%20verifyAccessToken%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20token%20%3D%20req.headers.authorization.split('%20')%5B1%5D%3B%0A%20%20tokenBlacklist.add(token)%3B%0A%20%20%0A%20%20%2F%2F%20In%20production%2C%20store%20blacklist%20in%20Redis%20with%20TTL%0A%20%20res.json(%7B%20message%3A%20'Token%20revoked'%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Use%20blacklist%20check%20before%20token%20verification%0Aapp.use('%2Fapi'%2C%20checkBlacklist%2C%20verifyAccessToken)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const jwt = require('jsonwebtoken');
const crypto = require('crypto');

// JWT configuration
const JWT_CONFIG = {
  accessTokenSecret: process.env.JWT_ACCESS_SECRET,
  refreshTokenSecret: process.env.JWT_REFRESH_SECRET,
  accessTokenExpiry: '15m', // Short-lived access token
  refreshTokenExpiry: '7d', // Long-lived refresh token
  issuer: 'myapp.com',
  audience: 'myapp-users'
};

// Generate token pair
const generateTokens = (payload) =&gt; {
  const accessToken = jwt.sign(
    payload,
    JWT_CONFIG.accessTokenSecret,
    {
      expiresIn: JWT_CONFIG.accessTokenExpiry,
      issuer: JWT_CONFIG.issuer,
      audience: JWT_CONFIG.audience
    }
  );
  
  const refreshToken = jwt.sign(
    { userId: payload.id },
    JWT_CONFIG.refreshTokenSecret,
    {
      expiresIn: JWT_CONFIG.refreshTokenExpiry,
      issuer: JWT_CONFIG.issuer,
      audience: JWT_CONFIG.audience
    }
  );
  
  return { accessToken, refreshToken };
};

// Verify access token middleware
const verifyAccessToken = (req, res, next) =&gt; {
  const authHeader = req.headers.authorization;
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
  
  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }
  
  jwt.verify(token, JWT_CONFIG.accessTokenSecret, {
    issuer: JWT_CONFIG.issuer,
    audience: JWT_CONFIG.audience
  }, (err, decoded) =&gt; {
    if (err) {
      if (err.name === 'TokenExpiredError') {
        return res.status(401).json({ 
          error: 'Token expired',
          code: 'TOKEN_EXPIRED'
        });
      }
      return res.status(403).json({ error: 'Invalid token' });
    }
    
    req.user = decoded;
    next();
  });
};

// Verify refresh token
const verifyRefreshToken = (token) =&gt; {
  return new Promise((resolve, reject) =&gt; {
    jwt.verify(token, JWT_CONFIG.refreshTokenSecret, {
      issuer: JWT_CONFIG.issuer,
      audience: JWT_CONFIG.audience
    }, (err, decoded) =&gt; {
      if (err) {
        reject(err);
      } else {
        resolve(decoded);
      }
    });
  });
};

// Login endpoint
app.post('/auth/login', async (req, res) =&gt; {
  try {
    const { email, password } = req.body;
    
    // Validate credentials
    const user = await User.findOne({ email });
    if (!user || !await bcrypt.compare(password, user.password)) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Generate tokens
    const tokenPayload = {
      id: user.id,
      email: user.email,
      role: user.role,
      iat: Math.floor(Date.now() / 1000)
    };
    
    const { accessToken, refreshToken } = generateTokens(tokenPayload);
    
    // Store refresh token (hashed)
    const hashedRefreshToken = crypto
      .createHash('sha256')
      .update(refreshToken)
      .digest('hex');
    
    user.refreshTokens = user.refreshTokens || [];
    user.refreshTokens.push({
      token: hashedRefreshToken,
      createdAt: new Date(),
      userAgent: req.get('User-Agent'),
      ipAddress: req.ip
    });
    
    // Limit number of refresh tokens per user
    if (user.refreshTokens.length &gt; 5) {
      user.refreshTokens = user.refreshTokens.slice(-5);
    }
    
    await user.save();
    
    // Set refresh token as httpOnly cookie
    res.cookie('refreshToken', refreshToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'strict',
      maxAge: 7 * 24 * 60 * 60 * 1000 // 7 days
    });
    
    res.json({
      accessToken,
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role
      }
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Token refresh endpoint
app.post('/auth/refresh', async (req, res) =&gt; {
  try {
    const refreshToken = req.cookies.refreshToken || req.body.refreshToken;
    
    if (!refreshToken) {
      return res.status(401).json({ error: 'Refresh token required' });
    }
    
    // Verify refresh token
    const decoded = await verifyRefreshToken(refreshToken);
    
    // Find user and verify refresh token
    const user = await User.findById(decoded.userId);
    if (!user) {
      return res.status(401).json({ error: 'Invalid refresh token' });
    }
    
    const hashedRefreshToken = crypto
      .createHash('sha256')
      .update(refreshToken)
      .digest('hex');
    
    const tokenExists = user.refreshTokens.some(
      token =&gt; token.token === hashedRefreshToken
    );
    
    if (!tokenExists) {
      return res.status(401).json({ error: 'Invalid refresh token' });
    }
    
    // Generate new access token
    const tokenPayload = {
      id: user.id,
      email: user.email,
      role: user.role,
      iat: Math.floor(Date.now() / 1000)
    };
    
    const { accessToken, refreshToken: newRefreshToken } = generateTokens(tokenPayload);
    
    // Replace old refresh token with new one
    user.refreshTokens = user.refreshTokens.filter(
      token =&gt; token.token !== hashedRefreshToken
    );
    
    const hashedNewRefreshToken = crypto
      .createHash('sha256')
      .update(newRefreshToken)
      .digest('hex');
    
    user.refreshTokens.push({
      token: hashedNewRefreshToken,
      createdAt: new Date(),
      userAgent: req.get('User-Agent'),
      ipAddress: req.ip
    });
    
    await user.save();
    
    // Set new refresh token cookie
    res.cookie('refreshToken', newRefreshToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'strict',
      maxAge: 7 * 24 * 60 * 60 * 1000
    });
    
    res.json({ accessToken });
  } catch (error) {
    res.status(401).json({ error: 'Invalid refresh token' });
  }
});

// Logout endpoint
app.post('/auth/logout', verifyAccessToken, async (req, res) =&gt; {
  try {
    const refreshToken = req.cookies.refreshToken;
    
    if (refreshToken) {
      const hashedRefreshToken = crypto
        .createHash('sha256')
        .update(refreshToken)
        .digest('hex');
      
      // Remove refresh token from user
      const user = await User.findById(req.user.id);
      if (user) {
        user.refreshTokens = user.refreshTokens.filter(
          token =&gt; token.token !== hashedRefreshToken
        );
        await user.save();
      }
    }
    
    // Clear refresh token cookie
    res.clearCookie('refreshToken');
    res.json({ message: 'Logged out successfully' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Logout from all devices
app.post('/auth/logout-all', verifyAccessToken, async (req, res) =&gt; {
  try {
    const user = await User.findById(req.user.id);
    if (user) {
      user.refreshTokens = [];
      await user.save();
    }
    
    res.clearCookie('refreshToken');
    res.json({ message: 'Logged out from all devices' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Protected route example
app.get('/profile', verifyAccessToken, async (req, res) =&gt; {
  try {
    const user = await User.findById(req.user.id).select('-password -refreshTokens');
    res.json(user);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// JWT blacklist for immediate token revocation (optional)
const tokenBlacklist = new Set();

const checkBlacklist = (req, res, next) =&gt; {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (token && tokenBlacklist.has(token)) {
    return res.status(401).json({ error: 'Token revoked' });
  }
  
  next();
};

// Revoke token endpoint
app.post('/auth/revoke', verifyAccessToken, (req, res) =&gt; {
  const token = req.headers.authorization.split(' ')[1];
  tokenBlacklist.add(token);
  
  // In production, store blacklist in Redis with TTL
  res.json({ message: 'Token revoked' });
});

// Use blacklist check before token verification
app.use('/api', checkBlacklist, verifyAccessToken);
</code></pre>
</div>

<h3 id="185-how-do-you-test-express-middleware-">185. How do you test Express middleware?</h3>

<p><strong>Answer:</strong> Testing middleware involves isolating the middleware function and testing its behavior with mock request/response objects.</p>

<p><strong>Middleware Testing Examples:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20middleware%2Fauth.js%0Aconst%20jwt%20%3D%20require('jsonwebtoken')%3B%0A%0Aconst%20authenticateToken%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20authHeader%20%3D%20req.headers%5B'authorization'%5D%3B%0A%20%20const%20token%20%3D%20authHeader%20%26%26%20authHeader.split('%20')%5B1%5D%3B%0A%20%20%0A%20%20if%20(!token)%20%7B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Access%20token%20required'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20jwt.verify(token%2C%20process.env.JWT_SECRET%2C%20(err%2C%20user)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20return%20res.status(403).json(%7B%20error%3A%20'Invalid%20token'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20req.user%20%3D%20user%3B%0A%20%20%20%20next()%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0Amodule.exports%20%3D%20%7B%20authenticateToken%20%7D%3B%0A%0A%2F%2F%20tests%2Fmiddleware%2Fauth.test.js%0Aconst%20jwt%20%3D%20require('jsonwebtoken')%3B%0Aconst%20%7B%20authenticateToken%20%7D%20%3D%20require('..%2F..%2Fmiddleware%2Fauth')%3B%0A%0A%2F%2F%20Mock%20JWT%0Ajest.mock('jsonwebtoken')%3B%0A%0Adescribe('Authentication%20Middleware'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20req%2C%20res%2C%20next%3B%0A%20%20%0A%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20req%20%3D%20%7B%0A%20%20%20%20%20%20headers%3A%20%7B%7D%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20res%20%3D%20%7B%0A%20%20%20%20%20%20status%3A%20jest.fn().mockReturnThis()%2C%0A%20%20%20%20%20%20json%3A%20jest.fn().mockReturnThis()%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20next%20%3D%20jest.fn()%3B%0A%20%20%20%20%0A%20%20%20%20process.env.JWT_SECRET%20%3D%20'test-secret'%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20afterEach(()%20%3D%3E%20%7B%0A%20%20%20%20jest.clearAllMocks()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20no%20token%20is%20provided'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20return%20401%20error'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20authenticateToken(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(res.status).toHaveBeenCalledWith(401)%3B%0A%20%20%20%20%20%20expect(res.json).toHaveBeenCalledWith(%7B%20error%3A%20'Access%20token%20required'%20%7D)%3B%0A%20%20%20%20%20%20expect(next).not.toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20invalid%20token%20is%20provided'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20req.headers.authorization%20%3D%20'Bearer%20invalid-token'%3B%0A%20%20%20%20%20%20jwt.verify.mockImplementation((token%2C%20secret%2C%20callback)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20callback(new%20Error('Invalid%20token')%2C%20null)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20return%20403%20error'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20authenticateToken(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(res.status).toHaveBeenCalledWith(403)%3B%0A%20%20%20%20%20%20expect(res.json).toHaveBeenCalledWith(%7B%20error%3A%20'Invalid%20token'%20%7D)%3B%0A%20%20%20%20%20%20expect(next).not.toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20valid%20token%20is%20provided'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20mockUser%20%3D%20%7B%20id%3A%201%2C%20email%3A%20'test%40example.com'%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20req.headers.authorization%20%3D%20'Bearer%20valid-token'%3B%0A%20%20%20%20%20%20jwt.verify.mockImplementation((token%2C%20secret%2C%20callback)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20callback(null%2C%20mockUser)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20attach%20user%20to%20request%20and%20call%20next'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20authenticateToken(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(req.user).toEqual(mockUser)%3B%0A%20%20%20%20%20%20expect(next).toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(res.status).not.toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(res.json).not.toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Testing%20async%20middleware%0A%2F%2F%20middleware%2Fvalidation.js%0Aconst%20%7B%20validationResult%20%7D%20%3D%20require('express-validator')%3B%0A%0Aconst%20handleValidationErrors%20%3D%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20errors%20%3D%20validationResult(req)%3B%0A%20%20%0A%20%20if%20(!errors.isEmpty())%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20success%3A%20false%2C%0A%20%20%20%20%20%20errors%3A%20errors.array()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Amodule.exports%20%3D%20%7B%20handleValidationErrors%20%7D%3B%0A%0A%2F%2F%20tests%2Fmiddleware%2Fvalidation.test.js%0Aconst%20%7B%20validationResult%20%7D%20%3D%20require('express-validator')%3B%0Aconst%20%7B%20handleValidationErrors%20%7D%20%3D%20require('..%2F..%2Fmiddleware%2Fvalidation')%3B%0A%0Ajest.mock('express-validator')%3B%0A%0Adescribe('Validation%20Middleware'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20req%2C%20res%2C%20next%3B%0A%20%20%0A%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20req%20%3D%20%7B%7D%3B%0A%20%20%20%20res%20%3D%20%7B%0A%20%20%20%20%20%20status%3A%20jest.fn().mockReturnThis()%2C%0A%20%20%20%20%20%20json%3A%20jest.fn().mockReturnThis()%0A%20%20%20%20%7D%3B%0A%20%20%20%20next%20%3D%20jest.fn()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20afterEach(()%20%3D%3E%20%7B%0A%20%20%20%20jest.clearAllMocks()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20validation%20passes'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20validationResult.mockReturnValue(%7B%0A%20%20%20%20%20%20%20%20isEmpty%3A%20()%20%3D%3E%20true%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20call%20next'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20handleValidationErrors(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(next).toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(res.status).not.toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20validation%20fails'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20mockErrors%20%3D%20%5B%0A%20%20%20%20%20%20%7B%20msg%3A%20'Email%20is%20required'%2C%20param%3A%20'email'%20%7D%2C%0A%20%20%20%20%20%20%7B%20msg%3A%20'Password%20is%20too%20short'%2C%20param%3A%20'password'%20%7D%0A%20%20%20%20%5D%3B%0A%20%20%20%20%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20validationResult.mockReturnValue(%7B%0A%20%20%20%20%20%20%20%20isEmpty%3A%20()%20%3D%3E%20false%2C%0A%20%20%20%20%20%20%20%20array%3A%20()%20%3D%3E%20mockErrors%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20return%20validation%20errors'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20handleValidationErrors(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(res.status).toHaveBeenCalledWith(400)%3B%0A%20%20%20%20%20%20expect(res.json).toHaveBeenCalledWith(%7B%0A%20%20%20%20%20%20%20%20success%3A%20false%2C%0A%20%20%20%20%20%20%20%20errors%3A%20mockErrors%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20expect(next).not.toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Testing%20middleware%20with%20database%20interactions%0A%2F%2F%20middleware%2FrateLimit.js%0Aconst%20User%20%3D%20require('..%2Fmodels%2FUser')%3B%0A%0Aconst%20customRateLimit%20%3D%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20userId%20%3D%20req.user%3F.id%3B%0A%20%20%20%20%0A%20%20%20%20if%20(!userId)%20%7B%0A%20%20%20%20%20%20return%20next()%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20user%20%3D%20await%20User.findById(userId)%3B%0A%20%20%20%20const%20now%20%3D%20new%20Date()%3B%0A%20%20%20%20const%20hourAgo%20%3D%20new%20Date(now.getTime()%20-%2060%20*%2060%20*%201000)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Count%20requests%20in%20last%20hour%0A%20%20%20%20const%20recentRequests%20%3D%20user.requests.filter(%0A%20%20%20%20%20%20request%20%3D%3E%20request.timestamp%20%3E%20hourAgo%0A%20%20%20%20).length%3B%0A%20%20%20%20%0A%20%20%20%20if%20(recentRequests%20%3E%3D%20user.rateLimit)%20%7B%0A%20%20%20%20%20%20return%20res.status(429).json(%7B%20error%3A%20'Rate%20limit%20exceeded'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Add%20current%20request%0A%20%20%20%20user.requests.push(%7B%20timestamp%3A%20now%20%7D)%3B%0A%20%20%20%20await%20user.save()%3B%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20next(error)%3B%0A%20%20%7D%0A%7D%3B%0A%0Amodule.exports%20%3D%20%7B%20customRateLimit%20%7D%3B%0A%0A%2F%2F%20tests%2Fmiddleware%2FrateLimit.test.js%0Aconst%20User%20%3D%20require('..%2F..%2Fmodels%2FUser')%3B%0Aconst%20%7B%20customRateLimit%20%7D%20%3D%20require('..%2F..%2Fmiddleware%2FrateLimit')%3B%0A%0Ajest.mock('..%2F..%2Fmodels%2FUser')%3B%0A%0Adescribe('Custom%20Rate%20Limit%20Middleware'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20req%2C%20res%2C%20next%3B%0A%20%20%0A%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20req%20%3D%20%7B%0A%20%20%20%20%20%20user%3A%20%7B%20id%3A%20'user123'%20%7D%0A%20%20%20%20%7D%3B%0A%20%20%20%20res%20%3D%20%7B%0A%20%20%20%20%20%20status%3A%20jest.fn().mockReturnThis()%2C%0A%20%20%20%20%20%20json%3A%20jest.fn().mockReturnThis()%0A%20%20%20%20%7D%3B%0A%20%20%20%20next%20%3D%20jest.fn()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20afterEach(()%20%3D%3E%20%7B%0A%20%20%20%20jest.clearAllMocks()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20user%20is%20not%20authenticated'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20req.user%20%3D%20null%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20call%20next%20without%20rate%20limiting'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20customRateLimit(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(next).toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(User.findById).not.toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20user%20is%20within%20rate%20limit'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20mockUser%20%3D%20%7B%0A%20%20%20%20%20%20id%3A%20'user123'%2C%0A%20%20%20%20%20%20rateLimit%3A%20100%2C%0A%20%20%20%20%20%20requests%3A%20%5B%5D%2C%0A%20%20%20%20%20%20save%3A%20jest.fn().mockResolvedValue()%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20User.findById.mockResolvedValue(mockUser)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20allow%20request%20and%20update%20user'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20customRateLimit(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(User.findById).toHaveBeenCalledWith('user123')%3B%0A%20%20%20%20%20%20expect(mockUser.save).toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(mockUser.requests).toHaveLength(1)%3B%0A%20%20%20%20%20%20expect(next).toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20user%20exceeds%20rate%20limit'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20mockUser%20%3D%20%7B%0A%20%20%20%20%20%20id%3A%20'user123'%2C%0A%20%20%20%20%20%20rateLimit%3A%202%2C%0A%20%20%20%20%20%20requests%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20timestamp%3A%20new%20Date()%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20timestamp%3A%20new%20Date()%20%7D%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20save%3A%20jest.fn()%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20User.findById.mockResolvedValue(mockUser)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20return%20429%20error'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20customRateLimit(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(res.status).toHaveBeenCalledWith(429)%3B%0A%20%20%20%20%20%20expect(res.json).toHaveBeenCalledWith(%7B%20error%3A%20'Rate%20limit%20exceeded'%20%7D)%3B%0A%20%20%20%20%20%20expect(next).not.toHaveBeenCalled()%3B%0A%20%20%20%20%20%20expect(mockUser.save).not.toHaveBeenCalled()%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20describe('when%20database%20error%20occurs'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20User.findById.mockRejectedValue(new%20Error('Database%20error'))%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20it('should%20pass%20error%20to%20next'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20customRateLimit(req%2C%20res%2C%20next)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20expect(next).toHaveBeenCalledWith(expect.any(Error))%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// middleware/auth.js
const jwt = require('jsonwebtoken');

const authenticateToken = (req, res, next) =&gt; {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }
  
  jwt.verify(token, process.env.JWT_SECRET, (err, user) =&gt; {
    if (err) {
      return res.status(403).json({ error: 'Invalid token' });
    }
    
    req.user = user;
    next();
  });
};

module.exports = { authenticateToken };

// tests/middleware/auth.test.js
const jwt = require('jsonwebtoken');
const { authenticateToken } = require('../../middleware/auth');

// Mock JWT
jest.mock('jsonwebtoken');

describe('Authentication Middleware', () =&gt; {
  let req, res, next;
  
  beforeEach(() =&gt; {
    req = {
      headers: {}
    };
    
    res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn().mockReturnThis()
    };
    
    next = jest.fn();
    
    process.env.JWT_SECRET = 'test-secret';
  });
  
  afterEach(() =&gt; {
    jest.clearAllMocks();
  });
  
  describe('when no token is provided', () =&gt; {
    it('should return 401 error', () =&gt; {
      authenticateToken(req, res, next);
      
      expect(res.status).toHaveBeenCalledWith(401);
      expect(res.json).toHaveBeenCalledWith({ error: 'Access token required' });
      expect(next).not.toHaveBeenCalled();
    });
  });
  
  describe('when invalid token is provided', () =&gt; {
    beforeEach(() =&gt; {
      req.headers.authorization = 'Bearer invalid-token';
      jwt.verify.mockImplementation((token, secret, callback) =&gt; {
        callback(new Error('Invalid token'), null);
      });
    });
    
    it('should return 403 error', () =&gt; {
      authenticateToken(req, res, next);
      
      expect(res.status).toHaveBeenCalledWith(403);
      expect(res.json).toHaveBeenCalledWith({ error: 'Invalid token' });
      expect(next).not.toHaveBeenCalled();
    });
  });
  
  describe('when valid token is provided', () =&gt; {
    const mockUser = { id: 1, email: 'test@example.com' };
    
    beforeEach(() =&gt; {
      req.headers.authorization = 'Bearer valid-token';
      jwt.verify.mockImplementation((token, secret, callback) =&gt; {
        callback(null, mockUser);
      });
    });
    
    it('should attach user to request and call next', () =&gt; {
      authenticateToken(req, res, next);
      
      expect(req.user).toEqual(mockUser);
      expect(next).toHaveBeenCalled();
      expect(res.status).not.toHaveBeenCalled();
      expect(res.json).not.toHaveBeenCalled();
    });
  });
});

// Testing async middleware
// middleware/validation.js
const { validationResult } = require('express-validator');

const handleValidationErrors = async (req, res, next) =&gt; {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      errors: errors.array()
    });
  }
  
  next();
};

module.exports = { handleValidationErrors };

// tests/middleware/validation.test.js
const { validationResult } = require('express-validator');
const { handleValidationErrors } = require('../../middleware/validation');

jest.mock('express-validator');

describe('Validation Middleware', () =&gt; {
  let req, res, next;
  
  beforeEach(() =&gt; {
    req = {};
    res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn().mockReturnThis()
    };
    next = jest.fn();
  });
  
  afterEach(() =&gt; {
    jest.clearAllMocks();
  });
  
  describe('when validation passes', () =&gt; {
    beforeEach(() =&gt; {
      validationResult.mockReturnValue({
        isEmpty: () =&gt; true
      });
    });
    
    it('should call next', async () =&gt; {
      await handleValidationErrors(req, res, next);
      
      expect(next).toHaveBeenCalled();
      expect(res.status).not.toHaveBeenCalled();
    });
  });
  
  describe('when validation fails', () =&gt; {
    const mockErrors = [
      { msg: 'Email is required', param: 'email' },
      { msg: 'Password is too short', param: 'password' }
    ];
    
    beforeEach(() =&gt; {
      validationResult.mockReturnValue({
        isEmpty: () =&gt; false,
        array: () =&gt; mockErrors
      });
    });
    
    it('should return validation errors', async () =&gt; {
      await handleValidationErrors(req, res, next);
      
      expect(res.status).toHaveBeenCalledWith(400);
      expect(res.json).toHaveBeenCalledWith({
        success: false,
        errors: mockErrors
      });
      expect(next).not.toHaveBeenCalled();
    });
  });
});

// Testing middleware with database interactions
// middleware/rateLimit.js
const User = require('../models/User');

const customRateLimit = async (req, res, next) =&gt; {
  try {
    const userId = req.user?.id;
    
    if (!userId) {
      return next();
    }
    
    const user = await User.findById(userId);
    const now = new Date();
    const hourAgo = new Date(now.getTime() - 60 * 60 * 1000);
    
    // Count requests in last hour
    const recentRequests = user.requests.filter(
      request =&gt; request.timestamp &gt; hourAgo
    ).length;
    
    if (recentRequests &gt;= user.rateLimit) {
      return res.status(429).json({ error: 'Rate limit exceeded' });
    }
    
    // Add current request
    user.requests.push({ timestamp: now });
    await user.save();
    
    next();
  } catch (error) {
    next(error);
  }
};

module.exports = { customRateLimit };

// tests/middleware/rateLimit.test.js
const User = require('../../models/User');
const { customRateLimit } = require('../../middleware/rateLimit');

jest.mock('../../models/User');

describe('Custom Rate Limit Middleware', () =&gt; {
  let req, res, next;
  
  beforeEach(() =&gt; {
    req = {
      user: { id: 'user123' }
    };
    res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn().mockReturnThis()
    };
    next = jest.fn();
  });
  
  afterEach(() =&gt; {
    jest.clearAllMocks();
  });
  
  describe('when user is not authenticated', () =&gt; {
    beforeEach(() =&gt; {
      req.user = null;
    });
    
    it('should call next without rate limiting', async () =&gt; {
      await customRateLimit(req, res, next);
      
      expect(next).toHaveBeenCalled();
      expect(User.findById).not.toHaveBeenCalled();
    });
  });
  
  describe('when user is within rate limit', () =&gt; {
    const mockUser = {
      id: 'user123',
      rateLimit: 100,
      requests: [],
      save: jest.fn().mockResolvedValue()
    };
    
    beforeEach(() =&gt; {
      User.findById.mockResolvedValue(mockUser);
    });
    
    it('should allow request and update user', async () =&gt; {
      await customRateLimit(req, res, next);
      
      expect(User.findById).toHaveBeenCalledWith('user123');
      expect(mockUser.save).toHaveBeenCalled();
      expect(mockUser.requests).toHaveLength(1);
      expect(next).toHaveBeenCalled();
    });
  });
  
  describe('when user exceeds rate limit', () =&gt; {
    const mockUser = {
      id: 'user123',
      rateLimit: 2,
      requests: [
        { timestamp: new Date() },
        { timestamp: new Date() }
      ],
      save: jest.fn()
    };
    
    beforeEach(() =&gt; {
      User.findById.mockResolvedValue(mockUser);
    });
    
    it('should return 429 error', async () =&gt; {
      await customRateLimit(req, res, next);
      
      expect(res.status).toHaveBeenCalledWith(429);
      expect(res.json).toHaveBeenCalledWith({ error: 'Rate limit exceeded' });
      expect(next).not.toHaveBeenCalled();
      expect(mockUser.save).not.toHaveBeenCalled();
    });
  });
  
  describe('when database error occurs', () =&gt; {
    beforeEach(() =&gt; {
      User.findById.mockRejectedValue(new Error('Database error'));
    });
    
    it('should pass error to next', async () =&gt; {
      await customRateLimit(req, res, next);
      
      expect(next).toHaveBeenCalledWith(expect.any(Error));
    });
  });
});
</code></pre>
</div>

<h3 id="186-how-do-you-implement-security-headers-in-express-">186. How do you implement security headers in Express?</h3>

<p><strong>Answer:</strong> Security headers protect against various attacks by instructing browsers how to handle your application's content and connections.</p>

<p><strong>Security Headers Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20helmet%20%3D%20require('helmet')%3B%0A%0A%2F%2F%20Comprehensive%20security%20headers%20setup%0Aapp.use(helmet(%7B%0A%20%20%2F%2F%20Content%20Security%20Policy%0A%20%20contentSecurityPolicy%3A%20%7B%0A%20%20%20%20directives%3A%20%7B%0A%20%20%20%20%20%20defaultSrc%3A%20%5B%22'self'%22%5D%2C%0A%20%20%20%20%20%20scriptSrc%3A%20%5B%0A%20%20%20%20%20%20%20%20%22'self'%22%2C%0A%20%20%20%20%20%20%20%20%22'unsafe-inline'%22%2C%20%2F%2F%20Only%20if%20absolutely%20necessary%0A%20%20%20%20%20%20%20%20%22https%3A%2F%2Fcdn.jsdelivr.net%22%2C%0A%20%20%20%20%20%20%20%20%22https%3A%2F%2Fcdnjs.cloudflare.com%22%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20styleSrc%3A%20%5B%0A%20%20%20%20%20%20%20%20%22'self'%22%2C%0A%20%20%20%20%20%20%20%20%22'unsafe-inline'%22%2C%20%2F%2F%20Often%20needed%20for%20CSS%0A%20%20%20%20%20%20%20%20%22https%3A%2F%2Ffonts.googleapis.com%22%2C%0A%20%20%20%20%20%20%20%20%22https%3A%2F%2Fcdn.jsdelivr.net%22%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20fontSrc%3A%20%5B%0A%20%20%20%20%20%20%20%20%22'self'%22%2C%0A%20%20%20%20%20%20%20%20%22https%3A%2F%2Ffonts.gstatic.com%22%2C%0A%20%20%20%20%20%20%20%20%22data%3A%22%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20imgSrc%3A%20%5B%0A%20%20%20%20%20%20%20%20%22'self'%22%2C%0A%20%20%20%20%20%20%20%20%22data%3A%22%2C%0A%20%20%20%20%20%20%20%20%22https%3A%22%2C%0A%20%20%20%20%20%20%20%20%22blob%3A%22%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20connectSrc%3A%20%5B%0A%20%20%20%20%20%20%20%20%22'self'%22%2C%0A%20%20%20%20%20%20%20%20%22https%3A%2F%2Fapi.example.com%22%2C%0A%20%20%20%20%20%20%20%20%22wss%3A%2F%2Fsocket.example.com%22%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20frameSrc%3A%20%5B%22'none'%22%5D%2C%0A%20%20%20%20%20%20objectSrc%3A%20%5B%22'none'%22%5D%2C%0A%20%20%20%20%20%20mediaSrc%3A%20%5B%22'self'%22%5D%2C%0A%20%20%20%20%20%20manifestSrc%3A%20%5B%22'self'%22%5D%2C%0A%20%20%20%20%20%20workerSrc%3A%20%5B%22'self'%22%5D%2C%0A%20%20%20%20%20%20upgradeInsecureRequests%3A%20%5B%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20reportOnly%3A%20false%20%2F%2F%20Set%20to%20true%20for%20testing%0A%20%20%7D%2C%0A%20%20%0A%20%20%2F%2F%20HTTP%20Strict%20Transport%20Security%0A%20%20hsts%3A%20%7B%0A%20%20%20%20maxAge%3A%2031536000%2C%20%2F%2F%201%20year%0A%20%20%20%20includeSubDomains%3A%20true%2C%0A%20%20%20%20preload%3A%20true%0A%20%20%7D%2C%0A%20%20%0A%20%20%2F%2F%20X-Frame-Options%0A%20%20frameguard%3A%20%7B%0A%20%20%20%20action%3A%20'deny'%20%2F%2F%20or%20'sameorigin'%0A%20%20%7D%2C%0A%20%20%0A%20%20%2F%2F%20X-Content-Type-Options%0A%20%20noSniff%3A%20true%2C%0A%20%20%0A%20%20%2F%2F%20X-XSS-Protection%0A%20%20xssFilter%3A%20true%2C%0A%20%20%0A%20%20%2F%2F%20Referrer%20Policy%0A%20%20referrerPolicy%3A%20%7B%0A%20%20%20%20policy%3A%20'strict-origin-when-cross-origin'%0A%20%20%7D%2C%0A%20%20%0A%20%20%2F%2F%20X-Permitted-Cross-Domain-Policies%0A%20%20permittedCrossDomainPolicies%3A%20false%2C%0A%20%20%0A%20%20%2F%2F%20X-DNS-Prefetch-Control%0A%20%20dnsPrefetchControl%3A%20%7B%0A%20%20%20%20allow%3A%20false%0A%20%20%7D%0A%7D))%3B%0A%0A%2F%2F%20Custom%20security%20headers%20middleware%0Aconst%20customSecurityHeaders%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Remove%20server%20information%0A%20%20res.removeHeader('X-Powered-By')%3B%0A%20%20%0A%20%20%2F%2F%20Custom%20security%20headers%0A%20%20res.setHeader('X-Content-Type-Options'%2C%20'nosniff')%3B%0A%20%20res.setHeader('X-Frame-Options'%2C%20'DENY')%3B%0A%20%20res.setHeader('X-XSS-Protection'%2C%20'1%3B%20mode%3Dblock')%3B%0A%20%20res.setHeader('Referrer-Policy'%2C%20'strict-origin-when-cross-origin')%3B%0A%20%20res.setHeader('Permissions-Policy'%2C%20'geolocation%3D()%2C%20microphone%3D()%2C%20camera%3D()')%3B%0A%20%20%0A%20%20%2F%2F%20Feature%20Policy%20(deprecated%2C%20use%20Permissions-Policy)%0A%20%20res.setHeader('Feature-Policy'%2C%20%0A%20%20%20%20%22geolocation%20'none'%3B%20microphone%20'none'%3B%20camera%20'none'%22%0A%20%20)%3B%0A%20%20%0A%20%20%2F%2F%20Expect-CT%20(Certificate%20Transparency)%0A%20%20res.setHeader('Expect-CT'%2C%20%0A%20%20%20%20'max-age%3D86400%2C%20enforce%2C%20report-uri%3D%22https%3A%2F%2Fexample.com%2Fct-report%22'%0A%20%20)%3B%0A%20%20%0A%20%20%2F%2F%20Cross-Origin%20policies%0A%20%20res.setHeader('Cross-Origin-Embedder-Policy'%2C%20'require-corp')%3B%0A%20%20res.setHeader('Cross-Origin-Opener-Policy'%2C%20'same-origin')%3B%0A%20%20res.setHeader('Cross-Origin-Resource-Policy'%2C%20'same-origin')%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(customSecurityHeaders)%3B%0A%0A%2F%2F%20Environment-specific%20security%20headers%0Aif%20(process.env.NODE_ENV%20%3D%3D%3D%20'production')%20%7B%0A%20%20app.use((req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Strict%20Transport%20Security%20(HTTPS%20only)%0A%20%20%20%20if%20(req.secure%20%7C%7C%20req.headers%5B'x-forwarded-proto'%5D%20%3D%3D%3D%20'https')%20%7B%0A%20%20%20%20%20%20res.setHeader('Strict-Transport-Security'%2C%20%0A%20%20%20%20%20%20%20%20'max-age%3D31536000%3B%20includeSubDomains%3B%20preload'%0A%20%20%20%20%20%20)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Public%20Key%20Pinning%20(use%20with%20caution)%0A%20%20%20%20res.setHeader('Public-Key-Pins'%2C%20%0A%20%20%20%20%20%20'pin-sha256%3D%22base64%2Bprimary%3D%3D%22%3B%20pin-sha256%3D%22base64%2Bbackup%3D%3D%22%3B%20max-age%3D5184000%3B%20includeSubDomains'%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D)%3B%0A%7D%0A%0A%2F%2F%20Content%20Security%20Policy%20with%20nonce%0Aconst%20crypto%20%3D%20require('crypto')%3B%0A%0Aconst%20cspWithNonce%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Generate%20nonce%20for%20inline%20scripts%0A%20%20const%20nonce%20%3D%20crypto.randomBytes(16).toString('base64')%3B%0A%20%20res.locals.nonce%20%3D%20nonce%3B%0A%20%20%0A%20%20const%20csp%20%3D%20%60%0A%20%20%20%20default-src%20'self'%3B%0A%20%20%20%20script-src%20'self'%20'nonce-%24%7Bnonce%7D'%20https%3A%2F%2Fcdn.jsdelivr.net%3B%0A%20%20%20%20style-src%20'self'%20'unsafe-inline'%20https%3A%2F%2Ffonts.googleapis.com%3B%0A%20%20%20%20font-src%20'self'%20https%3A%2F%2Ffonts.gstatic.com%3B%0A%20%20%20%20img-src%20'self'%20data%3A%20https%3A%3B%0A%20%20%20%20connect-src%20'self'%20https%3A%2F%2Fapi.example.com%3B%0A%20%20%20%20frame-src%20'none'%3B%0A%20%20%20%20object-src%20'none'%3B%0A%20%20%20%20base-uri%20'self'%3B%0A%20%20%20%20form-action%20'self'%3B%0A%20%20%20%20upgrade-insecure-requests%3B%0A%20%20%60.replace(%2F%5Cs%2B%2Fg%2C%20'%20').trim()%3B%0A%20%20%0A%20%20res.setHeader('Content-Security-Policy'%2C%20csp)%3B%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Use%20CSP%20with%20nonce%20for%20specific%20routes%0Aapp.get('%2Fdashboard'%2C%20cspWithNonce%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.render('dashboard'%2C%20%7B%20nonce%3A%20res.locals.nonce%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20Security%20headers%20for%20API%20routes%0Aconst%20apiSecurityHeaders%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20API-specific%20headers%0A%20%20res.setHeader('X-Content-Type-Options'%2C%20'nosniff')%3B%0A%20%20res.setHeader('X-Frame-Options'%2C%20'DENY')%3B%0A%20%20res.setHeader('Cache-Control'%2C%20'no-store%2C%20no-cache%2C%20must-revalidate%2C%20private')%3B%0A%20%20res.setHeader('Pragma'%2C%20'no-cache')%3B%0A%20%20res.setHeader('Expires'%2C%20'0')%3B%0A%20%20%0A%20%20%2F%2F%20CORS%20headers%20(if%20needed)%0A%20%20res.setHeader('Access-Control-Allow-Origin'%2C%20process.env.ALLOWED_ORIGINS%20%7C%7C%20'*')%3B%0A%20%20res.setHeader('Access-Control-Allow-Methods'%2C%20'GET%2C%20POST%2C%20PUT%2C%20DELETE%2C%20OPTIONS')%3B%0A%20%20res.setHeader('Access-Control-Allow-Headers'%2C%20'Content-Type%2C%20Authorization')%3B%0A%20%20res.setHeader('Access-Control-Max-Age'%2C%20'86400')%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use('%2Fapi'%2C%20apiSecurityHeaders)%3B%0A%0A%2F%2F%20Security%20headers%20testing%20endpoint%0Aapp.get('%2Fsecurity-test'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.json(%7B%0A%20%20%20%20message%3A%20'Security%20headers%20test'%2C%0A%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20'Content-Security-Policy'%3A%20res.getHeader('Content-Security-Policy')%2C%0A%20%20%20%20%20%20'Strict-Transport-Security'%3A%20res.getHeader('Strict-Transport-Security')%2C%0A%20%20%20%20%20%20'X-Frame-Options'%3A%20res.getHeader('X-Frame-Options')%2C%0A%20%20%20%20%20%20'X-Content-Type-Options'%3A%20res.getHeader('X-Content-Type-Options')%2C%0A%20%20%20%20%20%20'X-XSS-Protection'%3A%20res.getHeader('X-XSS-Protection')%2C%0A%20%20%20%20%20%20'Referrer-Policy'%3A%20res.getHeader('Referrer-Policy')%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%7D)%3B%0A%0A%2F%2F%20CSP%20violation%20reporting%0Aapp.post('%2Fcsp-report'%2C%20express.json(%7B%20type%3A%20'application%2Fcsp-report'%20%7D)%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20console.log('CSP%20Violation%3A'%2C%20JSON.stringify(req.body%2C%20null%2C%202))%3B%0A%20%20%0A%20%20%2F%2F%20Log%20to%20monitoring%20service%0A%20%20%2F%2F%20logger.warn('CSP%20Violation'%2C%20%7B%20report%3A%20req.body%20%7D)%3B%0A%20%20%0A%20%20res.status(204).end()%3B%0A%7D)%3B%0A%0A%2F%2F%20Security%20headers%20validation%20middleware%0Aconst%20validateSecurityHeaders%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20requiredHeaders%20%3D%20%5B%0A%20%20%20%20'X-Content-Type-Options'%2C%0A%20%20%20%20'X-Frame-Options'%2C%0A%20%20%20%20'X-XSS-Protection'%0A%20%20%5D%3B%0A%20%20%0A%20%20const%20originalSend%20%3D%20res.send%3B%0A%20%20res.send%20%3D%20function(data)%20%7B%0A%20%20%20%20%2F%2F%20Check%20if%20required%20headers%20are%20set%0A%20%20%20%20const%20missingHeaders%20%3D%20requiredHeaders.filter(%0A%20%20%20%20%20%20header%20%3D%3E%20!res.getHeader(header)%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(missingHeaders.length%20%3E%200)%20%7B%0A%20%20%20%20%20%20console.warn('Missing%20security%20headers%3A'%2C%20missingHeaders)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20originalSend.call(this%2C%20data)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Use%20in%20development%20for%20header%20validation%0Aif%20(process.env.NODE_ENV%20%3D%3D%3D%20'development')%20%7B%0A%20%20app.use(validateSecurityHeaders)%3B%0A%7D%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const helmet = require('helmet');

// Comprehensive security headers setup
app.use(helmet({
  // Content Security Policy
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: [
        "'self'",
        "'unsafe-inline'", // Only if absolutely necessary
        "https://cdn.jsdelivr.net",
        "https://cdnjs.cloudflare.com"
      ],
      styleSrc: [
        "'self'",
        "'unsafe-inline'", // Often needed for CSS
        "https://fonts.googleapis.com",
        "https://cdn.jsdelivr.net"
      ],
      fontSrc: [
        "'self'",
        "https://fonts.gstatic.com",
        "data:"
      ],
      imgSrc: [
        "'self'",
        "data:",
        "https:",
        "blob:"
      ],
      connectSrc: [
        "'self'",
        "https://api.example.com",
        "wss://socket.example.com"
      ],
      frameSrc: ["'none'"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      manifestSrc: ["'self'"],
      workerSrc: ["'self'"],
      upgradeInsecureRequests: []
    },
    reportOnly: false // Set to true for testing
  },
  
  // HTTP Strict Transport Security
  hsts: {
    maxAge: 31536000, // 1 year
    includeSubDomains: true,
    preload: true
  },
  
  // X-Frame-Options
  frameguard: {
    action: 'deny' // or 'sameorigin'
  },
  
  // X-Content-Type-Options
  noSniff: true,
  
  // X-XSS-Protection
  xssFilter: true,
  
  // Referrer Policy
  referrerPolicy: {
    policy: 'strict-origin-when-cross-origin'
  },
  
  // X-Permitted-Cross-Domain-Policies
  permittedCrossDomainPolicies: false,
  
  // X-DNS-Prefetch-Control
  dnsPrefetchControl: {
    allow: false
  }
}));

// Custom security headers middleware
const customSecurityHeaders = (req, res, next) =&gt; {
  // Remove server information
  res.removeHeader('X-Powered-By');
  
  // Custom security headers
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');
  
  // Feature Policy (deprecated, use Permissions-Policy)
  res.setHeader('Feature-Policy', 
    "geolocation 'none'; microphone 'none'; camera 'none'"
  );
  
  // Expect-CT (Certificate Transparency)
  res.setHeader('Expect-CT', 
    'max-age=86400, enforce, report-uri="https://example.com/ct-report"'
  );
  
  // Cross-Origin policies
  res.setHeader('Cross-Origin-Embedder-Policy', 'require-corp');
  res.setHeader('Cross-Origin-Opener-Policy', 'same-origin');
  res.setHeader('Cross-Origin-Resource-Policy', 'same-origin');
  
  next();
};

app.use(customSecurityHeaders);

// Environment-specific security headers
if (process.env.NODE_ENV === 'production') {
  app.use((req, res, next) =&gt; {
    // Strict Transport Security (HTTPS only)
    if (req.secure || req.headers['x-forwarded-proto'] === 'https') {
      res.setHeader('Strict-Transport-Security', 
        'max-age=31536000; includeSubDomains; preload'
      );
    }
    
    // Public Key Pinning (use with caution)
    res.setHeader('Public-Key-Pins', 
      'pin-sha256="base64+primary=="; pin-sha256="base64+backup=="; max-age=5184000; includeSubDomains'
    );
    
    next();
  });
}

// Content Security Policy with nonce
const crypto = require('crypto');

const cspWithNonce = (req, res, next) =&gt; {
  // Generate nonce for inline scripts
  const nonce = crypto.randomBytes(16).toString('base64');
  res.locals.nonce = nonce;
  
  const csp = `
    default-src 'self';
    script-src 'self' 'nonce-${nonce}' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https://api.example.com;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests;
  `.replace(/\s+/g, ' ').trim();
  
  res.setHeader('Content-Security-Policy', csp);
  next();
};

// Use CSP with nonce for specific routes
app.get('/dashboard', cspWithNonce, (req, res) =&gt; {
  res.render('dashboard', { nonce: res.locals.nonce });
});

// Security headers for API routes
const apiSecurityHeaders = (req, res, next) =&gt; {
  // API-specific headers
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, private');
  res.setHeader('Pragma', 'no-cache');
  res.setHeader('Expires', '0');
  
  // CORS headers (if needed)
  res.setHeader('Access-Control-Allow-Origin', process.env.ALLOWED_ORIGINS || '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.setHeader('Access-Control-Max-Age', '86400');
  
  next();
};

app.use('/api', apiSecurityHeaders);

// Security headers testing endpoint
app.get('/security-test', (req, res) =&gt; {
  res.json({
    message: 'Security headers test',
    headers: {
      'Content-Security-Policy': res.getHeader('Content-Security-Policy'),
      'Strict-Transport-Security': res.getHeader('Strict-Transport-Security'),
      'X-Frame-Options': res.getHeader('X-Frame-Options'),
      'X-Content-Type-Options': res.getHeader('X-Content-Type-Options'),
      'X-XSS-Protection': res.getHeader('X-XSS-Protection'),
      'Referrer-Policy': res.getHeader('Referrer-Policy')
    }
  });
});

// CSP violation reporting
app.post('/csp-report', express.json({ type: 'application/csp-report' }), (req, res) =&gt; {
  console.log('CSP Violation:', JSON.stringify(req.body, null, 2));
  
  // Log to monitoring service
  // logger.warn('CSP Violation', { report: req.body });
  
  res.status(204).end();
});

// Security headers validation middleware
const validateSecurityHeaders = (req, res, next) =&gt; {
  const requiredHeaders = [
    'X-Content-Type-Options',
    'X-Frame-Options',
    'X-XSS-Protection'
  ];
  
  const originalSend = res.send;
  res.send = function(data) {
    // Check if required headers are set
    const missingHeaders = requiredHeaders.filter(
      header =&gt; !res.getHeader(header)
    );
    
    if (missingHeaders.length &gt; 0) {
      console.warn('Missing security headers:', missingHeaders);
    }
    
    return originalSend.call(this, data);
  };
  
  next();
};

// Use in development for header validation
if (process.env.NODE_ENV === 'development') {
  app.use(validateSecurityHeaders);
}
</code></pre>
</div>

<h3 id="187-how-do-you-handle-file-upload-security-">187. How do you handle file upload security?</h3>

<p><strong>Answer:</strong> File upload security involves validating file types, sizes, names, and content to prevent malicious uploads and system compromise.</p>

<p><strong>Secure File Upload Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20multer%20%3D%20require('multer')%3B%0Aconst%20path%20%3D%20require('path')%3B%0Aconst%20crypto%20%3D%20require('crypto')%3B%0Aconst%20fs%20%3D%20require('fs')%3B%0Aconst%20sharp%20%3D%20require('sharp')%3B%20%2F%2F%20For%20image%20processing%0Aconst%20fileType%20%3D%20require('file-type')%3B%20%2F%2F%20For%20MIME%20type%20detection%0A%0A%2F%2F%20Secure%20file%20storage%20configuration%0Aconst%20storage%20%3D%20multer.diskStorage(%7B%0A%20%20destination%3A%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Create%20user-specific%20upload%20directory%0A%20%20%20%20const%20uploadDir%20%3D%20path.join(__dirname%2C%20'uploads'%2C%20req.user.id.toString())%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Ensure%20directory%20exists%0A%20%20%20%20fs.mkdirSync(uploadDir%2C%20%7B%20recursive%3A%20true%20%7D)%3B%0A%20%20%20%20cb(null%2C%20uploadDir)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20filename%3A%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20Generate%20secure%20filename%0A%20%20%20%20const%20uniqueSuffix%20%3D%20crypto.randomBytes(16).toString('hex')%3B%0A%20%20%20%20const%20sanitizedName%20%3D%20file.originalname%0A%20%20%20%20%20%20.replace(%2F%5B%5Ea-zA-Z0-9.-%5D%2Fg%2C%20'')%20%2F%2F%20Remove%20special%20characters%0A%20%20%20%20%20%20.substring(0%2C%2050)%3B%20%2F%2F%20Limit%20length%0A%20%20%20%20%0A%20%20%20%20const%20extension%20%3D%20path.extname(sanitizedName).toLowerCase()%3B%0A%20%20%20%20const%20baseName%20%3D%20path.basename(sanitizedName%2C%20extension)%3B%0A%20%20%20%20%0A%20%20%20%20cb(null%2C%20%60%24%7BbaseName%7D-%24%7BuniqueSuffix%7D%24%7Bextension%7D%60)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20File%20filter%20for%20security%0Aconst%20fileFilter%20%3D%20(req%2C%20file%2C%20cb)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Allowed%20file%20types%0A%20%20const%20allowedTypes%20%3D%20%7B%0A%20%20%20%20'image%2Fjpeg'%3A%20%5B'.jpg'%2C%20'.jpeg'%5D%2C%0A%20%20%20%20'image%2Fpng'%3A%20%5B'.png'%5D%2C%0A%20%20%20%20'image%2Fgif'%3A%20%5B'.gif'%5D%2C%0A%20%20%20%20'application%2Fpdf'%3A%20%5B'.pdf'%5D%2C%0A%20%20%20%20'text%2Fplain'%3A%20%5B'.txt'%5D%2C%0A%20%20%20%20'application%2Fmsword'%3A%20%5B'.doc'%5D%2C%0A%20%20%20%20'application%2Fvnd.openxmlformats-officedocument.wordprocessingml.document'%3A%20%5B'.docx'%5D%0A%20%20%7D%3B%0A%20%20%0A%20%20%2F%2F%20Check%20MIME%20type%0A%20%20if%20(!allowedTypes%5Bfile.mimetype%5D)%20%7B%0A%20%20%20%20return%20cb(new%20Error('Invalid%20file%20type')%2C%20false)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Check%20file%20extension%0A%20%20const%20extension%20%3D%20path.extname(file.originalname).toLowerCase()%3B%0A%20%20if%20(!allowedTypes%5Bfile.mimetype%5D.includes(extension))%20%7B%0A%20%20%20%20return%20cb(new%20Error('File%20extension%20does%20not%20match%20MIME%20type')%2C%20false)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Additional%20filename%20validation%0A%20%20if%20(file.originalname.includes('..')%20%7C%7C%20file.originalname.includes('%2F'))%20%7B%0A%20%20%20%20return%20cb(new%20Error('Invalid%20filename')%2C%20false)%3B%0A%20%20%7D%0A%20%20%0A%20%20cb(null%2C%20true)%3B%0A%7D%3B%0A%0A%2F%2F%20Multer%20configuration%0Aconst%20upload%20%3D%20multer(%7B%0A%20%20storage%3A%20storage%2C%0A%20%20fileFilter%3A%20fileFilter%2C%0A%20%20limits%3A%20%7B%0A%20%20%20%20fileSize%3A%205%20*%201024%20*%201024%2C%20%2F%2F%205MB%0A%20%20%20%20files%3A%205%2C%20%2F%2F%20Maximum%205%20files%0A%20%20%20%20fields%3A%2010%2C%20%2F%2F%20Maximum%2010%20form%20fields%0A%20%20%20%20fieldNameSize%3A%2050%2C%20%2F%2F%20Maximum%20field%20name%20length%0A%20%20%20%20fieldSize%3A%201024%20*%201024%20%2F%2F%20Maximum%20field%20value%20size%20(1MB)%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Advanced%20file%20validation%20middleware%0Aconst%20validateFile%20%3D%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(!req.file%20%26%26%20!req.files)%20%7B%0A%20%20%20%20return%20next()%3B%0A%20%20%7D%0A%20%20%0A%20%20const%20files%20%3D%20req.files%20%7C%7C%20%5Breq.file%5D%3B%0A%20%20%0A%20%20try%20%7B%0A%20%20%20%20for%20(const%20file%20of%20files)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Read%20file%20header%20to%20verify%20actual%20file%20type%0A%20%20%20%20%20%20const%20buffer%20%3D%20fs.readFileSync(file.path)%3B%0A%20%20%20%20%20%20const%20detectedType%20%3D%20await%20fileType.fromBuffer(buffer)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Verify%20MIME%20type%20matches%20detected%20type%0A%20%20%20%20%20%20if%20(!detectedType%20%7C%7C%20detectedType.mime%20!%3D%3D%20file.mimetype)%20%7B%0A%20%20%20%20%20%20%20%20fs.unlinkSync(file.path)%3B%20%2F%2F%20Delete%20uploaded%20file%0A%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20%0A%20%20%20%20%20%20%20%20%20%20error%3A%20'File%20type%20mismatch%20detected'%20%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Additional%20security%20checks%20for%20images%0A%20%20%20%20%20%20if%20(file.mimetype.startsWith('image%2F'))%20%7B%0A%20%20%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20Verify%20image%20integrity%20and%20strip%20metadata%0A%20%20%20%20%20%20%20%20%20%20const%20processedBuffer%20%3D%20await%20sharp(buffer)%0A%20%20%20%20%20%20%20%20%20%20%20%20.jpeg(%7B%20quality%3A%2090%20%7D)%20%2F%2F%20Re-encode%20to%20remove%20potential%20exploits%0A%20%20%20%20%20%20%20%20%20%20%20%20.toBuffer()%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20Replace%20original%20file%20with%20processed%20version%0A%20%20%20%20%20%20%20%20%20%20fs.writeFileSync(file.path%2C%20processedBuffer)%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20Update%20file%20size%0A%20%20%20%20%20%20%20%20%20%20file.size%20%3D%20processedBuffer.length%3B%0A%20%20%20%20%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20%20%20%20%20fs.unlinkSync(file.path)%3B%0A%20%20%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20%0A%20%20%20%20%20%20%20%20%20%20%20%20error%3A%20'Invalid%20image%20file'%20%0A%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Scan%20for%20malicious%20content%20(basic%20example)%0A%20%20%20%20%20%20const%20fileContent%20%3D%20buffer.toString('utf8'%2C%200%2C%20Math.min(buffer.length%2C%201024))%3B%0A%20%20%20%20%20%20const%20maliciousPatterns%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%2F%3Cscript%2Fi%2C%0A%20%20%20%20%20%20%20%20%2Fjavascript%3A%2Fi%2C%0A%20%20%20%20%20%20%20%20%2Fvbscript%3A%2Fi%2C%0A%20%20%20%20%20%20%20%20%2Fonload%3D%2Fi%2C%0A%20%20%20%20%20%20%20%20%2Fonerror%3D%2Fi%2C%0A%20%20%20%20%20%20%20%20%2F%3Ciframe%2Fi%2C%0A%20%20%20%20%20%20%20%20%2F%3Cobject%2Fi%2C%0A%20%20%20%20%20%20%20%20%2F%3Cembed%2Fi%0A%20%20%20%20%20%20%5D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20if%20(maliciousPatterns.some(pattern%20%3D%3E%20pattern.test(fileContent)))%20%7B%0A%20%20%20%20%20%20%20%20fs.unlinkSync(file.path)%3B%0A%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20%0A%20%20%20%20%20%20%20%20%20%20error%3A%20'Potentially%20malicious%20content%20detected'%20%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%2F%2F%20Clean%20up%20uploaded%20files%20on%20error%0A%20%20%20%20files.forEach(file%20%3D%3E%20%7B%0A%20%20%20%20%20%20if%20(fs.existsSync(file.path))%20%7B%0A%20%20%20%20%20%20%20%20fs.unlinkSync(file.path)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'File%20validation%20failed'%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Single%20file%20upload%20endpoint%0Aapp.post('%2Fupload%2Fsingle'%2C%20%0A%20%20authenticateToken%2C%0A%20%20upload.single('file')%2C%0A%20%20validateFile%2C%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20if%20(!req.file)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'No%20file%20uploaded'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%0A%20%20%20%20%20%20message%3A%20'File%20uploaded%20successfully'%2C%0A%20%20%20%20%20%20file%3A%20%7B%0A%20%20%20%20%20%20%20%20id%3A%20crypto.randomUUID()%2C%0A%20%20%20%20%20%20%20%20filename%3A%20req.file.filename%2C%0A%20%20%20%20%20%20%20%20originalname%3A%20req.file.originalname%2C%0A%20%20%20%20%20%20%20%20mimetype%3A%20req.file.mimetype%2C%0A%20%20%20%20%20%20%20%20size%3A%20req.file.size%2C%0A%20%20%20%20%20%20%20%20uploadedAt%3A%20new%20Date().toISOString()%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0A%2F%2F%20Multiple%20files%20upload%0Aapp.post('%2Fupload%2Fmultiple'%2C%0A%20%20authenticateToken%2C%0A%20%20upload.array('files'%2C%205)%2C%0A%20%20validateFile%2C%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20if%20(!req.files%20%7C%7C%20req.files.length%20%3D%3D%3D%200)%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'No%20files%20uploaded'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20files%20%3D%20req.files.map(file%20%3D%3E%20(%7B%0A%20%20%20%20%20%20id%3A%20crypto.randomUUID()%2C%0A%20%20%20%20%20%20filename%3A%20file.filename%2C%0A%20%20%20%20%20%20originalname%3A%20file.originalname%2C%0A%20%20%20%20%20%20mimetype%3A%20file.mimetype%2C%0A%20%20%20%20%20%20size%3A%20file.size%2C%0A%20%20%20%20%20%20uploadedAt%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D))%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%0A%20%20%20%20%20%20message%3A%20'Files%20uploaded%20successfully'%2C%0A%20%20%20%20%20%20files%3A%20files%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0A%2F%2F%20Secure%20file%20serving%0Aapp.get('%2Ffiles%2F%3Afilename'%2C%20authenticateToken%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20filename%20%3D%20req.params.filename%3B%0A%20%20%0A%20%20%2F%2F%20Validate%20filename%0A%20%20if%20(filename.includes('..')%20%7C%7C%20filename.includes('%2F'))%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Invalid%20filename'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20const%20filePath%20%3D%20path.join(__dirname%2C%20'uploads'%2C%20req.user.id.toString()%2C%20filename)%3B%0A%20%20%0A%20%20%2F%2F%20Check%20if%20file%20exists%20and%20user%20owns%20it%0A%20%20if%20(!fs.existsSync(filePath))%20%7B%0A%20%20%20%20return%20res.status(404).json(%7B%20error%3A%20'File%20not%20found'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Set%20security%20headers%20for%20file%20serving%0A%20%20res.setHeader('X-Content-Type-Options'%2C%20'nosniff')%3B%0A%20%20res.setHeader('Content-Disposition'%2C%20%60attachment%3B%20filename%3D%22%24%7Bfilename%7D%22%60)%3B%0A%20%20%0A%20%20%2F%2F%20Serve%20file%0A%20%20res.sendFile(filePath)%3B%0A%7D)%3B%0A%0A%2F%2F%20File%20upload%20with%20virus%20scanning%20(using%20ClamAV)%0Aconst%20%7B%20NodeClam%20%7D%20%3D%20require('clamscan')%3B%0A%0Aconst%20clamscan%20%3D%20new%20NodeClam().init(%7B%0A%20%20removeInfected%3A%20true%2C%0A%20%20quarantineInfected%3A%20false%2C%0A%20%20debugMode%3A%20false%0A%7D)%3B%0A%0Aconst%20virusScan%20%3D%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(!req.file%20%26%26%20!req.files)%20%7B%0A%20%20%20%20return%20next()%3B%0A%20%20%7D%0A%20%20%0A%20%20const%20files%20%3D%20req.files%20%7C%7C%20%5Breq.file%5D%3B%0A%20%20%0A%20%20try%20%7B%0A%20%20%20%20const%20clamAV%20%3D%20await%20clamscan%3B%0A%20%20%20%20%0A%20%20%20%20for%20(const%20file%20of%20files)%20%7B%0A%20%20%20%20%20%20const%20scanResult%20%3D%20await%20clamAV.isInfected(file.path)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20if%20(scanResult.isInfected)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20File%20is%20infected%2C%20remove%20it%0A%20%20%20%20%20%20%20%20fs.unlinkSync(file.path)%3B%0A%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20%20%20error%3A%20'Infected%20file%20detected'%2C%0A%20%20%20%20%20%20%20%20%20%20virus%3A%20scanResult.viruses%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20console.error('Virus%20scan%20failed%3A'%2C%20error)%3B%0A%20%20%20%20%2F%2F%20Continue%20without%20virus%20scan%20in%20case%20of%20scanner%20failure%0A%20%20%20%20next()%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Upload%20with%20virus%20scanning%0Aapp.post('%2Fupload%2Fsecure'%2C%0A%20%20authenticateToken%2C%0A%20%20upload.single('file')%2C%0A%20%20validateFile%2C%0A%20%20virusScan%2C%0A%20%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20%20%20res.json(%7B%0A%20%20%20%20%20%20message%3A%20'File%20uploaded%20and%20scanned%20successfully'%2C%0A%20%20%20%20%20%20file%3A%20%7B%0A%20%20%20%20%20%20%20%20filename%3A%20req.file.filename%2C%0A%20%20%20%20%20%20%20%20size%3A%20req.file.size%2C%0A%20%20%20%20%20%20%20%20scanStatus%3A%20'clean'%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A)%3B%0A%0A%2F%2F%20Error%20handling%20for%20multer%0Aapp.use((error%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(error%20instanceof%20multer.MulterError)%20%7B%0A%20%20%20%20switch%20(error.code)%20%7B%0A%20%20%20%20%20%20case%20'LIMIT_FILE_SIZE'%3A%0A%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'File%20too%20large'%20%7D)%3B%0A%20%20%20%20%20%20case%20'LIMIT_FILE_COUNT'%3A%0A%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Too%20many%20files'%20%7D)%3B%0A%20%20%20%20%20%20case%20'LIMIT_UNEXPECTED_FILE'%3A%0A%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'Unexpected%20file%20field'%20%7D)%3B%0A%20%20%20%20%20%20default%3A%0A%20%20%20%20%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'File%20upload%20error'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20%0A%20%20if%20(error.message.includes('Invalid%20file%20type'))%20%7B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20next(error)%3B%0A%7D)%3B%0A%0A%2F%2F%20Cleanup%20old%20files%20(scheduled%20task)%0Aconst%20cleanupOldFiles%20%3D%20()%20%3D%3E%20%7B%0A%20%20const%20uploadsDir%20%3D%20path.join(__dirname%2C%20'uploads')%3B%0A%20%20const%20maxAge%20%3D%2030%20*%2024%20*%2060%20*%2060%20*%201000%3B%20%2F%2F%2030%20days%0A%20%20%0A%20%20fs.readdir(uploadsDir%2C%20(err%2C%20userDirs)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20return%3B%0A%20%20%20%20%0A%20%20%20%20userDirs.forEach(userDir%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20userPath%20%3D%20path.join(uploadsDir%2C%20userDir)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20fs.readdir(userPath%2C%20(err%2C%20files)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20(err)%20return%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20files.forEach(file%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20filePath%20%3D%20path.join(userPath%2C%20file)%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20fs.stat(filePath%2C%20(err%2C%20stats)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(err)%20return%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(Date.now()%20-%20stats.mtime.getTime()%20%3E%20maxAge)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20fs.unlink(filePath%2C%20(err)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(!err)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20console.log(%60Cleaned%20up%20old%20file%3A%20%24%7BfilePath%7D%60)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20Run%20cleanup%20daily%0AsetInterval(cleanupOldFiles%2C%2024%20*%2060%20*%2060%20*%201000)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const multer = require('multer');
const path = require('path');
const crypto = require('crypto');
const fs = require('fs');
const sharp = require('sharp'); // For image processing
const fileType = require('file-type'); // For MIME type detection

// Secure file storage configuration
const storage = multer.diskStorage({
  destination: (req, file, cb) =&gt; {
    // Create user-specific upload directory
    const uploadDir = path.join(__dirname, 'uploads', req.user.id.toString());
    
    // Ensure directory exists
    fs.mkdirSync(uploadDir, { recursive: true });
    cb(null, uploadDir);
  },
  
  filename: (req, file, cb) =&gt; {
    // Generate secure filename
    const uniqueSuffix = crypto.randomBytes(16).toString('hex');
    const sanitizedName = file.originalname
      .replace(/[^a-zA-Z0-9.-]/g, '') // Remove special characters
      .substring(0, 50); // Limit length
    
    const extension = path.extname(sanitizedName).toLowerCase();
    const baseName = path.basename(sanitizedName, extension);
    
    cb(null, `${baseName}-${uniqueSuffix}${extension}`);
  }
});

// File filter for security
const fileFilter = (req, file, cb) =&gt; {
  // Allowed file types
  const allowedTypes = {
    'image/jpeg': ['.jpg', '.jpeg'],
    'image/png': ['.png'],
    'image/gif': ['.gif'],
    'application/pdf': ['.pdf'],
    'text/plain': ['.txt'],
    'application/msword': ['.doc'],
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx']
  };
  
  // Check MIME type
  if (!allowedTypes[file.mimetype]) {
    return cb(new Error('Invalid file type'), false);
  }
  
  // Check file extension
  const extension = path.extname(file.originalname).toLowerCase();
  if (!allowedTypes[file.mimetype].includes(extension)) {
    return cb(new Error('File extension does not match MIME type'), false);
  }
  
  // Additional filename validation
  if (file.originalname.includes('..') || file.originalname.includes('/')) {
    return cb(new Error('Invalid filename'), false);
  }
  
  cb(null, true);
};

// Multer configuration
const upload = multer({
  storage: storage,
  fileFilter: fileFilter,
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB
    files: 5, // Maximum 5 files
    fields: 10, // Maximum 10 form fields
    fieldNameSize: 50, // Maximum field name length
    fieldSize: 1024 * 1024 // Maximum field value size (1MB)
  }
});

// Advanced file validation middleware
const validateFile = async (req, res, next) =&gt; {
  if (!req.file && !req.files) {
    return next();
  }
  
  const files = req.files || [req.file];
  
  try {
    for (const file of files) {
      // Read file header to verify actual file type
      const buffer = fs.readFileSync(file.path);
      const detectedType = await fileType.fromBuffer(buffer);
      
      // Verify MIME type matches detected type
      if (!detectedType || detectedType.mime !== file.mimetype) {
        fs.unlinkSync(file.path); // Delete uploaded file
        return res.status(400).json({ 
          error: 'File type mismatch detected' 
        });
      }
      
      // Additional security checks for images
      if (file.mimetype.startsWith('image/')) {
        try {
          // Verify image integrity and strip metadata
          const processedBuffer = await sharp(buffer)
            .jpeg({ quality: 90 }) // Re-encode to remove potential exploits
            .toBuffer();
          
          // Replace original file with processed version
          fs.writeFileSync(file.path, processedBuffer);
          
          // Update file size
          file.size = processedBuffer.length;
        } catch (error) {
          fs.unlinkSync(file.path);
          return res.status(400).json({ 
            error: 'Invalid image file' 
          });
        }
      }
      
      // Scan for malicious content (basic example)
      const fileContent = buffer.toString('utf8', 0, Math.min(buffer.length, 1024));
      const maliciousPatterns = [
        /&lt;script/i,
        /javascript:/i,
        /vbscript:/i,
        /onload=/i,
        /onerror=/i,
        /&lt;iframe/i,
        /&lt;object/i,
        /&lt;embed/i
      ];
      
      if (maliciousPatterns.some(pattern =&gt; pattern.test(fileContent))) {
        fs.unlinkSync(file.path);
        return res.status(400).json({ 
          error: 'Potentially malicious content detected' 
        });
      }
    }
    
    next();
  } catch (error) {
    // Clean up uploaded files on error
    files.forEach(file =&gt; {
      if (fs.existsSync(file.path)) {
        fs.unlinkSync(file.path);
      }
    });
    
    res.status(500).json({ error: 'File validation failed' });
  }
};

// Single file upload endpoint
app.post('/upload/single', 
  authenticateToken,
  upload.single('file'),
  validateFile,
  (req, res) =&gt; {
    if (!req.file) {
      return res.status(400).json({ error: 'No file uploaded' });
    }
    
    res.json({
      message: 'File uploaded successfully',
      file: {
        id: crypto.randomUUID(),
        filename: req.file.filename,
        originalname: req.file.originalname,
        mimetype: req.file.mimetype,
        size: req.file.size,
        uploadedAt: new Date().toISOString()
      }
    });
  }
);

// Multiple files upload
app.post('/upload/multiple',
  authenticateToken,
  upload.array('files', 5),
  validateFile,
  (req, res) =&gt; {
    if (!req.files || req.files.length === 0) {
      return res.status(400).json({ error: 'No files uploaded' });
    }
    
    const files = req.files.map(file =&gt; ({
      id: crypto.randomUUID(),
      filename: file.filename,
      originalname: file.originalname,
      mimetype: file.mimetype,
      size: file.size,
      uploadedAt: new Date().toISOString()
    }));
    
    res.json({
      message: 'Files uploaded successfully',
      files: files
    });
  }
);

// Secure file serving
app.get('/files/:filename', authenticateToken, (req, res) =&gt; {
  const filename = req.params.filename;
  
  // Validate filename
  if (filename.includes('..') || filename.includes('/')) {
    return res.status(400).json({ error: 'Invalid filename' });
  }
  
  const filePath = path.join(__dirname, 'uploads', req.user.id.toString(), filename);
  
  // Check if file exists and user owns it
  if (!fs.existsSync(filePath)) {
    return res.status(404).json({ error: 'File not found' });
  }
  
  // Set security headers for file serving
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
  
  // Serve file
  res.sendFile(filePath);
});

// File upload with virus scanning (using ClamAV)
const { NodeClam } = require('clamscan');

const clamscan = new NodeClam().init({
  removeInfected: true,
  quarantineInfected: false,
  debugMode: false
});

const virusScan = async (req, res, next) =&gt; {
  if (!req.file && !req.files) {
    return next();
  }
  
  const files = req.files || [req.file];
  
  try {
    const clamAV = await clamscan;
    
    for (const file of files) {
      const scanResult = await clamAV.isInfected(file.path);
      
      if (scanResult.isInfected) {
        // File is infected, remove it
        fs.unlinkSync(file.path);
        return res.status(400).json({
          error: 'Infected file detected',
          virus: scanResult.viruses
        });
      }
    }
    
    next();
  } catch (error) {
    console.error('Virus scan failed:', error);
    // Continue without virus scan in case of scanner failure
    next();
  }
};

// Upload with virus scanning
app.post('/upload/secure',
  authenticateToken,
  upload.single('file'),
  validateFile,
  virusScan,
  (req, res) =&gt; {
    res.json({
      message: 'File uploaded and scanned successfully',
      file: {
        filename: req.file.filename,
        size: req.file.size,
        scanStatus: 'clean'
      }
    });
  }
);

// Error handling for multer
app.use((error, req, res, next) =&gt; {
  if (error instanceof multer.MulterError) {
    switch (error.code) {
      case 'LIMIT_FILE_SIZE':
        return res.status(400).json({ error: 'File too large' });
      case 'LIMIT_FILE_COUNT':
        return res.status(400).json({ error: 'Too many files' });
      case 'LIMIT_UNEXPECTED_FILE':
        return res.status(400).json({ error: 'Unexpected file field' });
      default:
        return res.status(400).json({ error: 'File upload error' });
    }
  }
  
  if (error.message.includes('Invalid file type')) {
    return res.status(400).json({ error: error.message });
  }
  
  next(error);
});

// Cleanup old files (scheduled task)
const cleanupOldFiles = () =&gt; {
  const uploadsDir = path.join(__dirname, 'uploads');
  const maxAge = 30 * 24 * 60 * 60 * 1000; // 30 days
  
  fs.readdir(uploadsDir, (err, userDirs) =&gt; {
    if (err) return;
    
    userDirs.forEach(userDir =&gt; {
      const userPath = path.join(uploadsDir, userDir);
      
      fs.readdir(userPath, (err, files) =&gt; {
        if (err) return;
        
        files.forEach(file =&gt; {
          const filePath = path.join(userPath, file);
          
          fs.stat(filePath, (err, stats) =&gt; {
            if (err) return;
            
            if (Date.now() - stats.mtime.getTime() &gt; maxAge) {
              fs.unlink(filePath, (err) =&gt; {
                if (!err) {
                  console.log(`Cleaned up old file: ${filePath}`);
                }
              });
            }
          });
        });
      });
    });
  });
};

// Run cleanup daily
setInterval(cleanupOldFiles, 24 * 60 * 60 * 1000);
</code></pre>
</div>

<h3 id="188-how-do-you-implement-logging-and-monitoring-in-express-">188. How do you implement logging and monitoring in Express?</h3>

<p><strong>Answer:</strong> Comprehensive logging and monitoring help track application behavior, debug issues, and monitor performance in production.</p>

<p><strong>Logging and Monitoring Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20winston%20%3D%20require('winston')%3B%0Aconst%20morgan%20%3D%20require('morgan')%3B%0Aconst%20prometheus%20%3D%20require('prom-client')%3B%0A%0A%2F%2F%20Winston%20logger%20configuration%0Aconst%20logger%20%3D%20winston.createLogger(%7B%0A%20%20level%3A%20process.env.LOG_LEVEL%20%7C%7C%20'info'%2C%0A%20%20format%3A%20winston.format.combine(%0A%20%20%20%20winston.format.timestamp()%2C%0A%20%20%20%20winston.format.errors(%7B%20stack%3A%20true%20%7D)%2C%0A%20%20%20%20winston.format.json()%0A%20%20)%2C%0A%20%20defaultMeta%3A%20%7B%20%0A%20%20%20%20service%3A%20'express-app'%2C%0A%20%20%20%20version%3A%20process.env.APP_VERSION%20%7C%7C%20'1.0.0'%0A%20%20%7D%2C%0A%20%20transports%3A%20%5B%0A%20%20%20%20%2F%2F%20Error%20logs%0A%20%20%20%20new%20winston.transports.File(%7B%20%0A%20%20%20%20%20%20filename%3A%20'logs%2Ferror.log'%2C%20%0A%20%20%20%20%20%20level%3A%20'error'%2C%0A%20%20%20%20%20%20maxsize%3A%205242880%2C%20%2F%2F%205MB%0A%20%20%20%20%20%20maxFiles%3A%205%0A%20%20%20%20%7D)%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Combined%20logs%0A%20%20%20%20new%20winston.transports.File(%7B%20%0A%20%20%20%20%20%20filename%3A%20'logs%2Fcombined.log'%2C%0A%20%20%20%20%20%20maxsize%3A%205242880%2C%0A%20%20%20%20%20%20maxFiles%3A%2010%0A%20%20%20%20%7D)%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Console%20output%20for%20development%0A%20%20%20%20...(process.env.NODE_ENV%20!%3D%3D%20'production'%20%3F%20%5B%0A%20%20%20%20%20%20new%20winston.transports.Console(%7B%0A%20%20%20%20%20%20%20%20format%3A%20winston.format.combine(%0A%20%20%20%20%20%20%20%20%20%20winston.format.colorize()%2C%0A%20%20%20%20%20%20%20%20%20%20winston.format.simple()%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%7D)%0A%20%20%20%20%5D%20%3A%20%5B%5D)%0A%20%20%5D%0A%7D)%3B%0A%0A%2F%2F%20Prometheus%20metrics%0Aconst%20collectDefaultMetrics%20%3D%20prometheus.collectDefaultMetrics%3B%0AcollectDefaultMetrics(%7B%20timeout%3A%205000%20%7D)%3B%0A%0A%2F%2F%20Custom%20metrics%0Aconst%20httpRequestDuration%20%3D%20new%20prometheus.Histogram(%7B%0A%20%20name%3A%20'http_request_duration_seconds'%2C%0A%20%20help%3A%20'Duration%20of%20HTTP%20requests%20in%20seconds'%2C%0A%20%20labelNames%3A%20%5B'method'%2C%20'route'%2C%20'status_code'%5D%2C%0A%20%20buckets%3A%20%5B0.1%2C%200.3%2C%200.5%2C%200.7%2C%201%2C%203%2C%205%2C%207%2C%2010%5D%0A%7D)%3B%0A%0Aconst%20httpRequestTotal%20%3D%20new%20prometheus.Counter(%7B%0A%20%20name%3A%20'http_requests_total'%2C%0A%20%20help%3A%20'Total%20number%20of%20HTTP%20requests'%2C%0A%20%20labelNames%3A%20%5B'method'%2C%20'route'%2C%20'status_code'%5D%0A%7D)%3B%0A%0Aconst%20activeConnections%20%3D%20new%20prometheus.Gauge(%7B%0A%20%20name%3A%20'active_connections'%2C%0A%20%20help%3A%20'Number%20of%20active%20connections'%0A%7D)%3B%0A%0Aconst%20databaseQueryDuration%20%3D%20new%20prometheus.Histogram(%7B%0A%20%20name%3A%20'database_query_duration_seconds'%2C%0A%20%20help%3A%20'Duration%20of%20database%20queries%20in%20seconds'%2C%0A%20%20labelNames%3A%20%5B'operation'%2C%20'table'%5D%0A%7D)%3B%0A%0A%2F%2F%20Request%20logging%20middleware%0Aconst%20requestLogger%20%3D%20morgan('combined'%2C%20%7B%0A%20%20stream%3A%20%7B%0A%20%20%20%20write%3A%20(message)%20%3D%3E%20%7B%0A%20%20%20%20%20%20logger.info(message.trim())%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Custom%20request%20logging%20with%20correlation%20ID%0Aconst%20correlationId%20%3D%20require('uuid').v4%3B%0A%0Aconst%20requestLogging%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Generate%20correlation%20ID%0A%20%20req.correlationId%20%3D%20correlationId()%3B%0A%20%20res.setHeader('X-Correlation-ID'%2C%20req.correlationId)%3B%0A%20%20%0A%20%20const%20start%20%3D%20Date.now()%3B%0A%20%20%0A%20%20%2F%2F%20Log%20request%0A%20%20logger.info('Request%20started'%2C%20%7B%0A%20%20%20%20correlationId%3A%20req.correlationId%2C%0A%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20url%3A%20req.url%2C%0A%20%20%20%20userAgent%3A%20req.get('User-Agent')%2C%0A%20%20%20%20ip%3A%20req.ip%2C%0A%20%20%20%20userId%3A%20req.user%3F.id%0A%20%20%7D)%3B%0A%20%20%0A%20%20%2F%2F%20Override%20res.end%20to%20log%20response%0A%20%20const%20originalEnd%20%3D%20res.end%3B%0A%20%20res.end%20%3D%20function(...args)%20%7B%0A%20%20%20%20const%20duration%20%3D%20Date.now()%20-%20start%3B%0A%20%20%20%20%0A%20%20%20%20logger.info('Request%20completed'%2C%20%7B%0A%20%20%20%20%20%20correlationId%3A%20req.correlationId%2C%0A%20%20%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20%20%20url%3A%20req.url%2C%0A%20%20%20%20%20%20statusCode%3A%20res.statusCode%2C%0A%20%20%20%20%20%20duration%3A%20%60%24%7Bduration%7Dms%60%2C%0A%20%20%20%20%20%20userId%3A%20req.user%3F.id%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Update%20Prometheus%20metrics%0A%20%20%20%20const%20route%20%3D%20req.route%3F.path%20%7C%7C%20req.url%3B%0A%20%20%20%20httpRequestDuration%0A%20%20%20%20%20%20.labels(req.method%2C%20route%2C%20res.statusCode)%0A%20%20%20%20%20%20.observe(duration%20%2F%201000)%3B%0A%20%20%20%20%0A%20%20%20%20httpRequestTotal%0A%20%20%20%20%20%20.labels(req.method%2C%20route%2C%20res.statusCode)%0A%20%20%20%20%20%20.inc()%3B%0A%20%20%20%20%0A%20%20%20%20originalEnd.apply(this%2C%20args)%3B%0A%20%20%7D%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(requestLogging)%3B%0A%0A%2F%2F%20Error%20logging%20middleware%0Aconst%20errorLogger%20%3D%20(err%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20logger.error('Unhandled%20error'%2C%20%7B%0A%20%20%20%20correlationId%3A%20req.correlationId%2C%0A%20%20%20%20error%3A%20%7B%0A%20%20%20%20%20%20message%3A%20err.message%2C%0A%20%20%20%20%20%20stack%3A%20err.stack%2C%0A%20%20%20%20%20%20name%3A%20err.name%0A%20%20%20%20%7D%2C%0A%20%20%20%20request%3A%20%7B%0A%20%20%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20%20%20url%3A%20req.url%2C%0A%20%20%20%20%20%20headers%3A%20req.headers%2C%0A%20%20%20%20%20%20body%3A%20req.body%2C%0A%20%20%20%20%20%20userId%3A%20req.user%3F.id%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%20%20%0A%20%20next(err)%3B%0A%7D%3B%0A%0A%2F%2F%20Database%20query%20logging%0Aconst%20logDatabaseQuery%20%3D%20(operation%2C%20table)%20%3D%3E%20%7B%0A%20%20return%20(query%2C%20params)%20%3D%3E%20%7B%0A%20%20%20%20const%20start%20%3D%20Date.now()%3B%0A%20%20%20%20%0A%20%20%20%20logger.debug('Database%20query%20started'%2C%20%7B%0A%20%20%20%20%20%20operation%2C%0A%20%20%20%20%20%20table%2C%0A%20%20%20%20%20%20query%3A%20query.substring(0%2C%20200)%2C%20%2F%2F%20Truncate%20long%20queries%0A%20%20%20%20%20%20params%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20return%20new%20Promise((resolve%2C%20reject)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Execute%20actual%20query%20here%0A%20%20%20%20%20%20executeQuery(query%2C%20params)%0A%20%20%20%20%20%20%20%20.then(result%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20duration%20%3D%20Date.now()%20-%20start%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20logger.debug('Database%20query%20completed'%2C%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20operation%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20table%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20duration%3A%20%60%24%7Bduration%7Dms%60%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20rowCount%3A%20result.rowCount%0A%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20databaseQueryDuration%0A%20%20%20%20%20%20%20%20%20%20%20%20.labels(operation%2C%20table)%0A%20%20%20%20%20%20%20%20%20%20%20%20.observe(duration%20%2F%201000)%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20resolve(result)%3B%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20.catch(error%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20duration%20%3D%20Date.now()%20-%20start%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20logger.error('Database%20query%20failed'%2C%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20operation%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20table%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20duration%3A%20%60%24%7Bduration%7Dms%60%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20error%3A%20error.message%0A%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20reject(error)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20Application%20metrics%20middleware%0Aconst%20metricsMiddleware%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20activeConnections.inc()%3B%0A%20%20%0A%20%20res.on('finish'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20activeConnections.dec()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20res.on('close'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20activeConnections.dec()%3B%0A%20%20%7D)%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(metricsMiddleware)%3B%0A%0A%2F%2F%20Health%20check%20endpoint%0Aapp.get('%2Fhealth'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20healthCheck%20%3D%20%7B%0A%20%20%20%20uptime%3A%20process.uptime()%2C%0A%20%20%20%20message%3A%20'OK'%2C%0A%20%20%20%20timestamp%3A%20new%20Date().toISOString()%2C%0A%20%20%20%20checks%3A%20%7B%0A%20%20%20%20%20%20database%3A%20'OK'%2C%20%2F%2F%20Add%20actual%20database%20health%20check%0A%20%20%20%20%20%20redis%3A%20'OK'%2C%20%20%20%20%2F%2F%20Add%20actual%20Redis%20health%20check%0A%20%20%20%20%20%20memory%3A%20%7B%0A%20%20%20%20%20%20%20%20used%3A%20process.memoryUsage().heapUsed%2C%0A%20%20%20%20%20%20%20%20total%3A%20process.memoryUsage().heapTotal%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%20%20%0A%20%20logger.info('Health%20check%20requested'%2C%20%7B%20healthCheck%20%7D)%3B%0A%20%20res.json(healthCheck)%3B%0A%7D)%3B%0A%0A%2F%2F%20Metrics%20endpoint%20for%20Prometheus%0Aapp.get('%2Fmetrics'%2C%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20res.set('Content-Type'%2C%20prometheus.register.contentType)%3B%0A%20%20res.end(prometheus.register.metrics())%3B%0A%7D)%3B%0A%0A%2F%2F%20Performance%20monitoring%0Aconst%20performanceMonitor%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20start%20%3D%20process.hrtime.bigint()%3B%0A%20%20%0A%20%20res.on('finish'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20end%20%3D%20process.hrtime.bigint()%3B%0A%20%20%20%20const%20duration%20%3D%20Number(end%20-%20start)%20%2F%201000000%3B%20%2F%2F%20Convert%20to%20milliseconds%0A%20%20%20%20%0A%20%20%20%20if%20(duration%20%3E%201000)%20%7B%20%2F%2F%20Log%20slow%20requests%20(%3E1s)%0A%20%20%20%20%20%20logger.warn('Slow%20request%20detected'%2C%20%7B%0A%20%20%20%20%20%20%20%20correlationId%3A%20req.correlationId%2C%0A%20%20%20%20%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20%20%20%20%20url%3A%20req.url%2C%0A%20%20%20%20%20%20%20%20duration%3A%20%60%24%7Bduration%7Dms%60%2C%0A%20%20%20%20%20%20%20%20statusCode%3A%20res.statusCode%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0Aapp.use(performanceMonitor)%3B%0A%0A%2F%2F%20Security%20event%20logging%0Aconst%20securityLogger%20%3D%20%7B%0A%20%20loginAttempt%3A%20(email%2C%20success%2C%20ip%2C%20userAgent)%20%3D%3E%20%7B%0A%20%20%20%20logger.info('Login%20attempt'%2C%20%7B%0A%20%20%20%20%20%20event%3A%20'login_attempt'%2C%0A%20%20%20%20%20%20email%2C%0A%20%20%20%20%20%20success%2C%0A%20%20%20%20%20%20ip%2C%0A%20%20%20%20%20%20userAgent%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20suspiciousActivity%3A%20(userId%2C%20activity%2C%20details)%20%3D%3E%20%7B%0A%20%20%20%20logger.warn('Suspicious%20activity%20detected'%2C%20%7B%0A%20%20%20%20%20%20event%3A%20'suspicious_activity'%2C%0A%20%20%20%20%20%20userId%2C%0A%20%20%20%20%20%20activity%2C%0A%20%20%20%20%20%20details%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20rateLimitExceeded%3A%20(ip%2C%20endpoint)%20%3D%3E%20%7B%0A%20%20%20%20logger.warn('Rate%20limit%20exceeded'%2C%20%7B%0A%20%20%20%20%20%20event%3A%20'rate_limit_exceeded'%2C%0A%20%20%20%20%20%20ip%2C%0A%20%20%20%20%20%20endpoint%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Business%20logic%20logging%0Aconst%20businessLogger%20%3D%20%7B%0A%20%20userRegistered%3A%20(userId%2C%20email)%20%3D%3E%20%7B%0A%20%20%20%20logger.info('User%20registered'%2C%20%7B%0A%20%20%20%20%20%20event%3A%20'user_registered'%2C%0A%20%20%20%20%20%20userId%2C%0A%20%20%20%20%20%20email%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20orderPlaced%3A%20(userId%2C%20orderId%2C%20amount)%20%3D%3E%20%7B%0A%20%20%20%20logger.info('Order%20placed'%2C%20%7B%0A%20%20%20%20%20%20event%3A%20'order_placed'%2C%0A%20%20%20%20%20%20userId%2C%0A%20%20%20%20%20%20orderId%2C%0A%20%20%20%20%20%20amount%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20paymentProcessed%3A%20(userId%2C%20paymentId%2C%20amount%2C%20status)%20%3D%3E%20%7B%0A%20%20%20%20logger.info('Payment%20processed'%2C%20%7B%0A%20%20%20%20%20%20event%3A%20'payment_processed'%2C%0A%20%20%20%20%20%20userId%2C%0A%20%20%20%20%20%20paymentId%2C%0A%20%20%20%20%20%20amount%2C%0A%20%20%20%20%20%20status%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Structured%20logging%20for%20different%20log%20levels%0Aconst%20structuredLogger%20%3D%20%7B%0A%20%20debug%3A%20(message%2C%20meta%20%3D%20%7B%7D)%20%3D%3E%20%7B%0A%20%20%20%20logger.debug(message%2C%20%7B%20...meta%2C%20level%3A%20'debug'%20%7D)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20info%3A%20(message%2C%20meta%20%3D%20%7B%7D)%20%3D%3E%20%7B%0A%20%20%20%20logger.info(message%2C%20%7B%20...meta%2C%20level%3A%20'info'%20%7D)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20warn%3A%20(message%2C%20meta%20%3D%20%7B%7D)%20%3D%3E%20%7B%0A%20%20%20%20logger.warn(message%2C%20%7B%20...meta%2C%20level%3A%20'warn'%20%7D)%3B%0A%20%20%7D%2C%0A%20%20%0A%20%20error%3A%20(message%2C%20error%2C%20meta%20%3D%20%7B%7D)%20%3D%3E%20%7B%0A%20%20%20%20logger.error(message%2C%20%7B%0A%20%20%20%20%20%20...meta%2C%0A%20%20%20%20%20%20level%3A%20'error'%2C%0A%20%20%20%20%20%20error%3A%20%7B%0A%20%20%20%20%20%20%20%20message%3A%20error%3F.message%2C%0A%20%20%20%20%20%20%20%20stack%3A%20error%3F.stack%2C%0A%20%20%20%20%20%20%20%20name%3A%20error%3F.name%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Log%20rotation%20and%20cleanup%0Aconst%20logRotation%20%3D%20()%20%3D%3E%20%7B%0A%20%20const%20logDir%20%3D%20path.join(__dirname%2C%20'logs')%3B%0A%20%20const%20maxAge%20%3D%2030%20*%2024%20*%2060%20*%2060%20*%201000%3B%20%2F%2F%2030%20days%0A%20%20%0A%20%20fs.readdir(logDir%2C%20(err%2C%20files)%20%3D%3E%20%7B%0A%20%20%20%20if%20(err)%20return%3B%0A%20%20%20%20%0A%20%20%20%20files.forEach(file%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20filePath%20%3D%20path.join(logDir%2C%20file)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20fs.stat(filePath%2C%20(err%2C%20stats)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20(err)%20return%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20if%20(Date.now()%20-%20stats.mtime.getTime()%20%3E%20maxAge)%20%7B%0A%20%20%20%20%20%20%20%20%20%20fs.unlink(filePath%2C%20(err)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!err)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20logger.info('Old%20log%20file%20deleted'%2C%20%7B%20file%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20Run%20log%20cleanup%20daily%0AsetInterval(logRotation%2C%2024%20*%2060%20*%2060%20*%201000)%3B%0A%0A%2F%2F%20Export%20loggers%20for%20use%20in%20other%20modules%0Amodule.exports%20%3D%20%7B%0A%20%20logger%2C%0A%20%20securityLogger%2C%0A%20%20businessLogger%2C%0A%20%20structuredLogger%2C%0A%20%20errorLogger%0A%7D%3B%0A%0A%2F%2F%20Usage%20examples%20in%20routes%0Aapp.post('%2Flogin'%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20email%2C%20password%20%7D%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20const%20user%20%3D%20await%20User.findOne(%7B%20email%20%7D)%3B%0A%20%20%20%20const%20success%20%3D%20user%20%26%26%20await%20bcrypt.compare(password%2C%20user.password)%3B%0A%20%20%20%20%0A%20%20%20%20securityLogger.loginAttempt(email%2C%20success%2C%20req.ip%2C%20req.get('User-Agent'))%3B%0A%20%20%20%20%0A%20%20%20%20if%20(success)%20%7B%0A%20%20%20%20%20%20businessLogger.userRegistered(user.id%2C%20user.email)%3B%0A%20%20%20%20%20%20res.json(%7B%20token%3A%20generateToken(user)%20%7D)%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20res.status(401).json(%7B%20error%3A%20'Invalid%20credentials'%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20structuredLogger.error('Login%20error'%2C%20error%2C%20%7B%20%0A%20%20%20%20%20%20correlationId%3A%20req.correlationId%20%0A%20%20%20%20%7D)%3B%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'Internal%20server%20error'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0Aapp.use(errorLogger)%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const winston = require('winston');
const morgan = require('morgan');
const prometheus = require('prom-client');

// Winston logger configuration
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { 
    service: 'express-app',
    version: process.env.APP_VERSION || '1.0.0'
  },
  transports: [
    // Error logs
    new winston.transports.File({ 
      filename: 'logs/error.log', 
      level: 'error',
      maxsize: 5242880, // 5MB
      maxFiles: 5
    }),
    
    // Combined logs
    new winston.transports.File({ 
      filename: 'logs/combined.log',
      maxsize: 5242880,
      maxFiles: 10
    }),
    
    // Console output for development
    ...(process.env.NODE_ENV !== 'production' ? [
      new winston.transports.Console({
        format: winston.format.combine(
          winston.format.colorize(),
          winston.format.simple()
        )
      })
    ] : [])
  ]
});

// Prometheus metrics
const collectDefaultMetrics = prometheus.collectDefaultMetrics;
collectDefaultMetrics({ timeout: 5000 });

// Custom metrics
const httpRequestDuration = new prometheus.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10]
});

const httpRequestTotal = new prometheus.Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code']
});

const activeConnections = new prometheus.Gauge({
  name: 'active_connections',
  help: 'Number of active connections'
});

const databaseQueryDuration = new prometheus.Histogram({
  name: 'database_query_duration_seconds',
  help: 'Duration of database queries in seconds',
  labelNames: ['operation', 'table']
});

// Request logging middleware
const requestLogger = morgan('combined', {
  stream: {
    write: (message) =&gt; {
      logger.info(message.trim());
    }
  }
});

// Custom request logging with correlation ID
const correlationId = require('uuid').v4;

const requestLogging = (req, res, next) =&gt; {
  // Generate correlation ID
  req.correlationId = correlationId();
  res.setHeader('X-Correlation-ID', req.correlationId);
  
  const start = Date.now();
  
  // Log request
  logger.info('Request started', {
    correlationId: req.correlationId,
    method: req.method,
    url: req.url,
    userAgent: req.get('User-Agent'),
    ip: req.ip,
    userId: req.user?.id
  });
  
  // Override res.end to log response
  const originalEnd = res.end;
  res.end = function(...args) {
    const duration = Date.now() - start;
    
    logger.info('Request completed', {
      correlationId: req.correlationId,
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration: `${duration}ms`,
      userId: req.user?.id
    });
    
    // Update Prometheus metrics
    const route = req.route?.path || req.url;
    httpRequestDuration
      .labels(req.method, route, res.statusCode)
      .observe(duration / 1000);
    
    httpRequestTotal
      .labels(req.method, route, res.statusCode)
      .inc();
    
    originalEnd.apply(this, args);
  };
  
  next();
};

app.use(requestLogging);

// Error logging middleware
const errorLogger = (err, req, res, next) =&gt; {
  logger.error('Unhandled error', {
    correlationId: req.correlationId,
    error: {
      message: err.message,
      stack: err.stack,
      name: err.name
    },
    request: {
      method: req.method,
      url: req.url,
      headers: req.headers,
      body: req.body,
      userId: req.user?.id
    }
  });
  
  next(err);
};

// Database query logging
const logDatabaseQuery = (operation, table) =&gt; {
  return (query, params) =&gt; {
    const start = Date.now();
    
    logger.debug('Database query started', {
      operation,
      table,
      query: query.substring(0, 200), // Truncate long queries
      params
    });
    
    return new Promise((resolve, reject) =&gt; {
      // Execute actual query here
      executeQuery(query, params)
        .then(result =&gt; {
          const duration = Date.now() - start;
          
          logger.debug('Database query completed', {
            operation,
            table,
            duration: `${duration}ms`,
            rowCount: result.rowCount
          });
          
          databaseQueryDuration
            .labels(operation, table)
            .observe(duration / 1000);
          
          resolve(result);
        })
        .catch(error =&gt; {
          const duration = Date.now() - start;
          
          logger.error('Database query failed', {
            operation,
            table,
            duration: `${duration}ms`,
            error: error.message
          });
          
          reject(error);
        });
    });
  };
};

// Application metrics middleware
const metricsMiddleware = (req, res, next) =&gt; {
  activeConnections.inc();
  
  res.on('finish', () =&gt; {
    activeConnections.dec();
  });
  
  res.on('close', () =&gt; {
    activeConnections.dec();
  });
  
  next();
};

app.use(metricsMiddleware);

// Health check endpoint
app.get('/health', (req, res) =&gt; {
  const healthCheck = {
    uptime: process.uptime(),
    message: 'OK',
    timestamp: new Date().toISOString(),
    checks: {
      database: 'OK', // Add actual database health check
      redis: 'OK',    // Add actual Redis health check
      memory: {
        used: process.memoryUsage().heapUsed,
        total: process.memoryUsage().heapTotal
      }
    }
  };
  
  logger.info('Health check requested', { healthCheck });
  res.json(healthCheck);
});

// Metrics endpoint for Prometheus
app.get('/metrics', (req, res) =&gt; {
  res.set('Content-Type', prometheus.register.contentType);
  res.end(prometheus.register.metrics());
});

// Performance monitoring
const performanceMonitor = (req, res, next) =&gt; {
  const start = process.hrtime.bigint();
  
  res.on('finish', () =&gt; {
    const end = process.hrtime.bigint();
    const duration = Number(end - start) / 1000000; // Convert to milliseconds
    
    if (duration &gt; 1000) { // Log slow requests (&gt;1s)
      logger.warn('Slow request detected', {
        correlationId: req.correlationId,
        method: req.method,
        url: req.url,
        duration: `${duration}ms`,
        statusCode: res.statusCode
      });
    }
  });
  
  next();
};

app.use(performanceMonitor);

// Security event logging
const securityLogger = {
  loginAttempt: (email, success, ip, userAgent) =&gt; {
    logger.info('Login attempt', {
      event: 'login_attempt',
      email,
      success,
      ip,
      userAgent,
      timestamp: new Date().toISOString()
    });
  },
  
  suspiciousActivity: (userId, activity, details) =&gt; {
    logger.warn('Suspicious activity detected', {
      event: 'suspicious_activity',
      userId,
      activity,
      details,
      timestamp: new Date().toISOString()
    });
  },
  
  rateLimitExceeded: (ip, endpoint) =&gt; {
    logger.warn('Rate limit exceeded', {
      event: 'rate_limit_exceeded',
      ip,
      endpoint,
      timestamp: new Date().toISOString()
    });
  }
};

// Business logic logging
const businessLogger = {
  userRegistered: (userId, email) =&gt; {
    logger.info('User registered', {
      event: 'user_registered',
      userId,
      email,
      timestamp: new Date().toISOString()
    });
  },
  
  orderPlaced: (userId, orderId, amount) =&gt; {
    logger.info('Order placed', {
      event: 'order_placed',
      userId,
      orderId,
      amount,
      timestamp: new Date().toISOString()
    });
  },
  
  paymentProcessed: (userId, paymentId, amount, status) =&gt; {
    logger.info('Payment processed', {
      event: 'payment_processed',
      userId,
      paymentId,
      amount,
      status,
      timestamp: new Date().toISOString()
    });
  }
};

// Structured logging for different log levels
const structuredLogger = {
  debug: (message, meta = {}) =&gt; {
    logger.debug(message, { ...meta, level: 'debug' });
  },
  
  info: (message, meta = {}) =&gt; {
    logger.info(message, { ...meta, level: 'info' });
  },
  
  warn: (message, meta = {}) =&gt; {
    logger.warn(message, { ...meta, level: 'warn' });
  },
  
  error: (message, error, meta = {}) =&gt; {
    logger.error(message, {
      ...meta,
      level: 'error',
      error: {
        message: error?.message,
        stack: error?.stack,
        name: error?.name
      }
    });
  }
};

// Log rotation and cleanup
const logRotation = () =&gt; {
  const logDir = path.join(__dirname, 'logs');
  const maxAge = 30 * 24 * 60 * 60 * 1000; // 30 days
  
  fs.readdir(logDir, (err, files) =&gt; {
    if (err) return;
    
    files.forEach(file =&gt; {
      const filePath = path.join(logDir, file);
      
      fs.stat(filePath, (err, stats) =&gt; {
        if (err) return;
        
        if (Date.now() - stats.mtime.getTime() &gt; maxAge) {
          fs.unlink(filePath, (err) =&gt; {
            if (!err) {
              logger.info('Old log file deleted', { file });
            }
          });
        }
      });
    });
  });
};

// Run log cleanup daily
setInterval(logRotation, 24 * 60 * 60 * 1000);

// Export loggers for use in other modules
module.exports = {
  logger,
  securityLogger,
  businessLogger,
  structuredLogger,
  errorLogger
};

// Usage examples in routes
app.post('/login', async (req, res) =&gt; {
  try {
    const { email, password } = req.body;
    
    const user = await User.findOne({ email });
    const success = user && await bcrypt.compare(password, user.password);
    
    securityLogger.loginAttempt(email, success, req.ip, req.get('User-Agent'));
    
    if (success) {
      businessLogger.userRegistered(user.id, user.email);
      res.json({ token: generateToken(user) });
    } else {
      res.status(401).json({ error: 'Invalid credentials' });
    }
  } catch (error) {
    structuredLogger.error('Login error', error, { 
      correlationId: req.correlationId 
    });
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.use(errorLogger);
</code></pre>
</div>

<h3 id="189-how-do-you-implement-data-validation-at-the-database-level-">189. How do you implement data validation at the database level?</h3>

<p><strong>Answer:</strong> Database-level validation ensures data integrity and consistency by enforcing constraints directly in the database schema and using database features.</p>

<p><strong>Database Validation Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="%2F%2F%20Using%20Sequelize%20ORM%20for%20SQL%20databases%0Aconst%20%7B%20Sequelize%2C%20DataTypes%2C%20Op%20%7D%20%3D%20require('sequelize')%3B%0A%0Aconst%20sequelize%20%3D%20new%20Sequelize(process.env.DATABASE_URL%2C%20%7B%0A%20%20dialect%3A%20'postgres'%2C%0A%20%20logging%3A%20(sql)%20%3D%3E%20logger.debug('Database%20query'%2C%20%7B%20sql%20%7D)%0A%7D)%3B%0A%0A%2F%2F%20User%20model%20with%20comprehensive%20validation%0Aconst%20User%20%3D%20sequelize.define('User'%2C%20%7B%0A%20%20id%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.UUID%2C%0A%20%20%20%20defaultValue%3A%20DataTypes.UUIDV4%2C%0A%20%20%20%20primaryKey%3A%20true%0A%20%20%7D%2C%0A%20%20%0A%20%20email%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.STRING%2C%0A%20%20%20%20allowNull%3A%20false%2C%0A%20%20%20%20unique%3A%20%7B%0A%20%20%20%20%20%20name%3A%20'unique_email'%2C%0A%20%20%20%20%20%20msg%3A%20'Email%20address%20already%20in%20use'%0A%20%20%20%20%7D%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20isEmail%3A%20%7B%0A%20%20%20%20%20%20%20%20msg%3A%20'Must%20be%20a%20valid%20email%20address'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20len%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B5%2C%20255%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Email%20must%20be%20between%205%20and%20255%20characters'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%2F%2F%20Custom%20validation%0A%20%20%20%20%20%20isNotDisposable(value)%20%7B%0A%20%20%20%20%20%20%20%20const%20disposableDomains%20%3D%20%5B'tempmail.com'%2C%20'10minutemail.com'%5D%3B%0A%20%20%20%20%20%20%20%20const%20domain%20%3D%20value.split('%40')%5B1%5D%3B%0A%20%20%20%20%20%20%20%20if%20(disposableDomains.includes(domain))%20%7B%0A%20%20%20%20%20%20%20%20%20%20throw%20new%20Error('Disposable%20email%20addresses%20are%20not%20allowed')%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20username%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.STRING(50)%2C%0A%20%20%20%20allowNull%3A%20false%2C%0A%20%20%20%20unique%3A%20%7B%0A%20%20%20%20%20%20name%3A%20'unique_username'%2C%0A%20%20%20%20%20%20msg%3A%20'Username%20already%20taken'%0A%20%20%20%20%7D%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20len%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B3%2C%2050%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Username%20must%20be%20between%203%20and%2050%20characters'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20is%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%2F%5E%5Ba-zA-Z0-9_%5D%2B%24%2F%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Username%20can%20only%20contain%20letters%2C%20numbers%2C%20and%20underscores'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20notIn%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B%5B'admin'%2C%20'root'%2C%20'system'%2C%20'null'%2C%20'undefined'%5D%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Username%20is%20reserved'%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20password%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.STRING%2C%0A%20%20%20%20allowNull%3A%20false%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20len%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B8%2C%20255%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Password%20must%20be%20at%20least%208%20characters'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%2F%2F%20Custom%20password%20strength%20validation%0A%20%20%20%20%20%20isStrong(value)%20%7B%0A%20%20%20%20%20%20%20%20const%20strongRegex%20%3D%20%2F%5E(%3F%3D.*%5Ba-z%5D)(%3F%3D.*%5BA-Z%5D)(%3F%3D.*%5Cd)(%3F%3D.*%5B%40%24!%25*%3F%26%5D)%5BA-Za-z%5Cd%40%24!%25*%3F%26%5D%2F%3B%0A%20%20%20%20%20%20%20%20if%20(!strongRegex.test(value))%20%7B%0A%20%20%20%20%20%20%20%20%20%20throw%20new%20Error('Password%20must%20contain%20uppercase%2C%20lowercase%2C%20number%2C%20and%20special%20character')%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20age%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.INTEGER%2C%0A%20%20%20%20allowNull%3A%20true%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20min%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%2013%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Must%20be%20at%20least%2013%20years%20old'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20max%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20120%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Age%20cannot%20exceed%20120'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20isInt%3A%20%7B%0A%20%20%20%20%20%20%20%20msg%3A%20'Age%20must%20be%20an%20integer'%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20phone%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.STRING%2C%0A%20%20%20%20allowNull%3A%20true%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20is%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%2F%5E%5C%2B%3F%5B%5Cd%5Cs%5C-%24%24%24%24%5D%2B%24%2F%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Invalid%20phone%20number%20format'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20len%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B10%2C%2020%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Phone%20number%20must%20be%20between%2010%20and%2020%20characters'%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20role%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.ENUM('user'%2C%20'admin'%2C%20'moderator')%2C%0A%20%20%20%20defaultValue%3A%20'user'%2C%0A%20%20%20%20allowNull%3A%20false%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20isIn%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B%5B'user'%2C%20'admin'%2C%20'moderator'%5D%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Invalid%20role'%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20status%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.ENUM('active'%2C%20'inactive'%2C%20'suspended'%2C%20'pending')%2C%0A%20%20%20%20defaultValue%3A%20'pending'%2C%0A%20%20%20%20allowNull%3A%20false%0A%20%20%7D%2C%0A%20%20%0A%20%20profileData%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.JSONB%2C%20%2F%2F%20PostgreSQL%20JSON%20with%20indexing%0A%20%20%20%20allowNull%3A%20true%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20%2F%2F%20Custom%20JSON%20validation%0A%20%20%20%20%20%20isValidProfile(value)%20%7B%0A%20%20%20%20%20%20%20%20if%20(value)%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20requiredFields%20%3D%20%5B'firstName'%2C%20'lastName'%5D%3B%0A%20%20%20%20%20%20%20%20%20%20const%20missingFields%20%3D%20requiredFields.filter(field%20%3D%3E%20!value%5Bfield%5D)%3B%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20if%20(missingFields.length%20%3E%200)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20throw%20new%20Error(%60Missing%20required%20profile%20fields%3A%20%24%7BmissingFields.join('%2C%20')%7D%60)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20if%20(value.firstName%20%26%26%20value.firstName.length%20%3C%202)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20throw%20new%20Error('First%20name%20must%20be%20at%20least%202%20characters')%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20if%20(value.lastName%20%26%26%20value.lastName.length%20%3C%202)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20throw%20new%20Error('Last%20name%20must%20be%20at%20least%202%20characters')%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20createdAt%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.DATE%2C%0A%20%20%20%20defaultValue%3A%20DataTypes.NOW%2C%0A%20%20%20%20allowNull%3A%20false%0A%20%20%7D%2C%0A%20%20%0A%20%20updatedAt%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.DATE%2C%0A%20%20%20%20defaultValue%3A%20DataTypes.NOW%2C%0A%20%20%20%20allowNull%3A%20false%0A%20%20%7D%0A%7D%2C%20%7B%0A%20%20%2F%2F%20Model-level%20validations%0A%20%20validate%3A%20%7B%0A%20%20%20%20%2F%2F%20Cross-field%20validation%0A%20%20%20%20adminMustHaveEmail()%20%7B%0A%20%20%20%20%20%20if%20(this.role%20%3D%3D%3D%20'admin'%20%26%26%20!this.email)%20%7B%0A%20%20%20%20%20%20%20%20throw%20new%20Error('Admin%20users%20must%20have%20an%20email%20address')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Conditional%20validation%0A%20%20%20%20phoneRequiredForModerators()%20%7B%0A%20%20%20%20%20%20if%20(this.role%20%3D%3D%3D%20'moderator'%20%26%26%20!this.phone)%20%7B%0A%20%20%20%20%20%20%20%20throw%20new%20Error('Moderators%20must%20provide%20a%20phone%20number')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20%2F%2F%20Hooks%20for%20additional%20validation%0A%20%20hooks%3A%20%7B%0A%20%20%20%20beforeValidate%3A%20(user%2C%20options)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Normalize%20email%0A%20%20%20%20%20%20if%20(user.email)%20%7B%0A%20%20%20%20%20%20%20%20user.email%20%3D%20user.email.toLowerCase().trim()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Normalize%20username%0A%20%20%20%20%20%20if%20(user.username)%20%7B%0A%20%20%20%20%20%20%20%20user.username%20%3D%20user.username.toLowerCase().trim()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20%0A%20%20%20%20beforeCreate%3A%20async%20(user%2C%20options)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Check%20for%20duplicate%20email%20with%20different%20case%0A%20%20%20%20%20%20const%20existingUser%20%3D%20await%20User.findOne(%7B%0A%20%20%20%20%20%20%20%20where%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20email%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%5BOp.iLike%5D%3A%20user.email%20%2F%2F%20Case-insensitive%20search%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20if%20(existingUser)%20%7B%0A%20%20%20%20%20%20%20%20throw%20new%20Error('Email%20address%20already%20in%20use')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20%0A%20%20%20%20beforeUpdate%3A%20async%20(user%2C%20options)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Prevent%20role%20changes%20for%20certain%20users%0A%20%20%20%20%20%20if%20(user.changed('role')%20%26%26%20user.previous('role')%20%3D%3D%3D%20'admin')%20%7B%0A%20%20%20%20%20%20%20%20const%20adminCount%20%3D%20await%20User.count(%7B%20where%3A%20%7B%20role%3A%20'admin'%20%7D%20%7D)%3B%0A%20%20%20%20%20%20%20%20if%20(adminCount%20%3C%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20throw%20new%20Error('Cannot%20remove%20the%20last%20admin%20user')%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20indexes%3A%20%5B%0A%20%20%20%20%7B%0A%20%20%20%20%20%20unique%3A%20true%2C%0A%20%20%20%20%20%20fields%3A%20%5B'email'%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20unique%3A%20true%2C%0A%20%20%20%20%20%20fields%3A%20%5B'username'%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20fields%3A%20%5B'role'%2C%20'status'%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20fields%3A%20%5B'createdAt'%5D%0A%20%20%20%20%7D%0A%20%20%5D%0A%7D)%3B%0A%0A%2F%2F%20Post%20model%20with%20relationships%20and%20validation%0Aconst%20Post%20%3D%20sequelize.define('Post'%2C%20%7B%0A%20%20id%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.UUID%2C%0A%20%20%20%20defaultValue%3A%20DataTypes.UUIDV4%2C%0A%20%20%20%20primaryKey%3A%20true%0A%20%20%7D%2C%0A%20%20%0A%20%20title%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.STRING(200)%2C%0A%20%20%20%20allowNull%3A%20false%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20len%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B5%2C%20200%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Title%20must%20be%20between%205%20and%20200%20characters'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20notEmpty%3A%20%7B%0A%20%20%20%20%20%20%20%20msg%3A%20'Title%20cannot%20be%20empty'%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20content%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.TEXT%2C%0A%20%20%20%20allowNull%3A%20false%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20len%3A%20%7B%0A%20%20%20%20%20%20%20%20args%3A%20%5B10%2C%2010000%5D%2C%0A%20%20%20%20%20%20%20%20msg%3A%20'Content%20must%20be%20between%2010%20and%2010000%20characters'%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20status%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.ENUM('draft'%2C%20'published'%2C%20'archived')%2C%0A%20%20%20%20defaultValue%3A%20'draft'%2C%0A%20%20%20%20allowNull%3A%20false%0A%20%20%7D%2C%0A%20%20%0A%20%20publishedAt%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.DATE%2C%0A%20%20%20%20allowNull%3A%20true%2C%0A%20%20%20%20validate%3A%20%7B%0A%20%20%20%20%20%20isDate%3A%20%7B%0A%20%20%20%20%20%20%20%20msg%3A%20'Published%20date%20must%20be%20a%20valid%20date'%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%2F%2F%20Custom%20validation%20for%20publish%20date%0A%20%20%20%20%20%20isValidPublishDate(value)%20%7B%0A%20%20%20%20%20%20%20%20if%20(value%20%26%26%20this.status%20%3D%3D%3D%20'published'%20%26%26%20new%20Date(value)%20%3E%20new%20Date())%20%7B%0A%20%20%20%20%20%20%20%20%20%20throw%20new%20Error('Published%20date%20cannot%20be%20in%20the%20future')%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20userId%3A%20%7B%0A%20%20%20%20type%3A%20DataTypes.UUID%2C%0A%20%20%20%20allowNull%3A%20false%2C%0A%20%20%20%20references%3A%20%7B%0A%20%20%20%20%20%20model%3A%20User%2C%0A%20%20%20%20%20%20key%3A%20'id'%0A%20%20%20%20%7D%2C%0A%20%20%20%20onDelete%3A%20'CASCADE'%2C%0A%20%20%20%20onUpdate%3A%20'CASCADE'%0A%20%20%7D%0A%7D%2C%20%7B%0A%20%20validate%3A%20%7B%0A%20%20%20%20%2F%2F%20Model-level%20validation%0A%20%20%20%20publishedPostMustHaveDate()%20%7B%0A%20%20%20%20%20%20if%20(this.status%20%3D%3D%3D%20'published'%20%26%26%20!this.publishedAt)%20%7B%0A%20%20%20%20%20%20%20%20throw%20new%20Error('Published%20posts%20must%20have%20a%20published%20date')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20hooks%3A%20%7B%0A%20%20%20%20beforeSave%3A%20(post%2C%20options)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Auto-set%20published%20date%20when%20status%20changes%20to%20published%0A%20%20%20%20%20%20if%20(post.status%20%3D%3D%3D%20'published'%20%26%26%20!post.publishedAt)%20%7B%0A%20%20%20%20%20%20%20%20post.publishedAt%20%3D%20new%20Date()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Clear%20published%20date%20when%20status%20changes%20from%20published%0A%20%20%20%20%20%20if%20(post.status%20!%3D%3D%20'published'%20%26%26%20post.publishedAt)%20%7B%0A%20%20%20%20%20%20%20%20post.publishedAt%20%3D%20null%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Define%20associations%0AUser.hasMany(Post%2C%20%7B%20foreignKey%3A%20'userId'%2C%20as%3A%20'posts'%20%7D)%3B%0APost.belongsTo(User%2C%20%7B%20foreignKey%3A%20'userId'%2C%20as%3A%20'author'%20%7D)%3B%0A%0A%2F%2F%20Custom%20validation%20functions%0Aconst%20customValidations%20%3D%20%7B%0A%20%20%2F%2F%20Async%20validation%20example%0A%20%20isUniqueSlug%3A%20async%20(slug%2C%20postId%20%3D%20null)%20%3D%3E%20%7B%0A%20%20%20%20const%20whereClause%20%3D%20%7B%20slug%20%7D%3B%0A%20%20%20%20if%20(postId)%20%7B%0A%20%20%20%20%20%20whereClause.id%20%3D%20%7B%20%5BOp.ne%5D%3A%20postId%20%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20existingPost%20%3D%20await%20Post.findOne(%7B%20where%3A%20whereClause%20%7D)%3B%0A%20%20%20%20if%20(existingPost)%20%7B%0A%20%20%20%20%20%20throw%20new%20Error('Slug%20must%20be%20unique')%3B%0A%20%20%20%20%7D%0A%20%20%7D%2C%0A%20%20%0A%20%20%2F%2F%20Complex%20business%20rule%20validation%0A%20%20canUserCreatePost%3A%20async%20(userId)%20%3D%3E%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.findByPk(userId)%3B%0A%20%20%20%20if%20(!user)%20%7B%0A%20%20%20%20%20%20throw%20new%20Error('User%20not%20found')%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(user.status%20!%3D%3D%20'active')%20%7B%0A%20%20%20%20%20%20throw%20new%20Error('Only%20active%20users%20can%20create%20posts')%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Check%20post%20limit%20for%20regular%20users%0A%20%20%20%20if%20(user.role%20%3D%3D%3D%20'user')%20%7B%0A%20%20%20%20%20%20const%20postCount%20%3D%20await%20Post.count(%7B%20%0A%20%20%20%20%20%20%20%20where%3A%20%7B%20%0A%20%20%20%20%20%20%20%20%20%20userId%2C%0A%20%20%20%20%20%20%20%20%20%20createdAt%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%5BOp.gte%5D%3A%20new%20Date(Date.now()%20-%2024%20*%2060%20*%2060%20*%201000)%20%2F%2F%20Last%2024%20hours%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20if%20(postCount%20%3E%3D%205)%20%7B%0A%20%20%20%20%20%20%20%20throw%20new%20Error('Daily%20post%20limit%20exceeded')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Database%20constraints%20using%20raw%20SQL%20(for%20complex%20constraints)%0Aconst%20addDatabaseConstraints%20%3D%20async%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20Check%20constraint%20for%20age%20validation%0A%20%20await%20sequelize.query(%60%0A%20%20%20%20ALTER%20TABLE%20%22Users%22%20%0A%20%20%20%20ADD%20CONSTRAINT%20check_age_range%20%0A%20%20%20%20CHECK%20(age%20IS%20NULL%20OR%20(age%20%3E%3D%2013%20AND%20age%20%3C%3D%20120))%0A%20%20%60)%3B%0A%20%20%0A%20%20%2F%2F%20Check%20constraint%20for%20email%20format%0A%20%20await%20sequelize.query(%60%0A%20%20%20%20ALTER%20TABLE%20%22Users%22%20%0A%20%20%20%20ADD%20CONSTRAINT%20check_email_format%20%0A%20%20%20%20CHECK%20(email%20~*%20'%5E%5BA-Za-z0-9._%25%2B-%5D%2B%40%5BA-Za-z0-9.-%5D%2B%5C%5C.%5BA-Za-z%5D%7B2%2C%7D%24')%0A%20%20%60)%3B%0A%20%20%0A%20%20%2F%2F%20Partial%20unique%20index%20(PostgreSQL%20specific)%0A%20%20await%20sequelize.query(%60%0A%20%20%20%20CREATE%20UNIQUE%20INDEX%20unique_active_username%20%0A%20%20%20%20ON%20%22Users%22%20(username)%20%0A%20%20%20%20WHERE%20status%20%3D%20'active'%0A%20%20%60)%3B%0A%7D%3B%0A%0A%2F%2F%20Validation%20middleware%20for%20Express%20routes%0Aconst%20validateUserData%20%3D%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20userData%20%3D%20req.body%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Build%20user%20instance%20for%20validation%20without%20saving%0A%20%20%20%20const%20user%20%3D%20User.build(userData)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Run%20validations%0A%20%20%20%20await%20user.validate()%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Run%20custom%20validations%0A%20%20%20%20if%20(userData.role%20%3D%3D%3D%20'admin')%20%7B%0A%20%20%20%20%20%20await%20customValidations.canUserCreatePost(userData.id)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20if%20(error.name%20%3D%3D%3D%20'SequelizeValidationError')%20%7B%0A%20%20%20%20%20%20const%20validationErrors%20%3D%20error.errors.map(err%20%3D%3E%20(%7B%0A%20%20%20%20%20%20%20%20field%3A%20err.path%2C%0A%20%20%20%20%20%20%20%20message%3A%20err.message%2C%0A%20%20%20%20%20%20%20%20value%3A%20err.value%0A%20%20%20%20%20%20%7D))%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'Validation%20failed'%2C%0A%20%20%20%20%20%20%20%20details%3A%20validationErrors%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20res.status(400).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Usage%20in%20routes%0Aapp.post('%2Fusers'%2C%20validateUserData%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20user%20%3D%20await%20User.create(req.body)%3B%0A%20%20%20%20res.status(201).json(user)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20if%20(error.name%20%3D%3D%3D%20'SequelizeUniqueConstraintError')%20%7B%0A%20%20%20%20%20%20return%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'Duplicate%20entry'%2C%0A%20%20%20%20%20%20%20%20field%3A%20error.errors%5B0%5D.path%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Transaction-based%20validation%0Aapp.post('%2Fposts'%2C%20authenticateToken%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20const%20transaction%20%3D%20await%20sequelize.transaction()%3B%0A%20%20%0A%20%20try%20%7B%0A%20%20%20%20%2F%2F%20Validate%20user%20can%20create%20post%0A%20%20%20%20await%20customValidations.canUserCreatePost(req.user.id)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Create%20post%20within%20transaction%0A%20%20%20%20const%20post%20%3D%20await%20Post.create(%7B%0A%20%20%20%20%20%20...req.body%2C%0A%20%20%20%20%20%20userId%3A%20req.user.id%0A%20%20%20%20%7D%2C%20%7B%20transaction%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20await%20transaction.commit()%3B%0A%20%20%20%20res.status(201).json(post)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20await%20transaction.rollback()%3B%0A%20%20%20%20res.status(400).json(%7B%20error%3A%20error.message%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0Amodule.exports%20%3D%20%7B%0A%20%20User%2C%0A%20%20Post%2C%0A%20%20customValidations%2C%0A%20%20validateUserData%0A%7D%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">// Using Sequelize ORM for SQL databases
const { Sequelize, DataTypes, Op } = require('sequelize');

const sequelize = new Sequelize(process.env.DATABASE_URL, {
  dialect: 'postgres',
  logging: (sql) =&gt; logger.debug('Database query', { sql })
});

// User model with comprehensive validation
const User = sequelize.define('User', {
  id: {
    type: DataTypes.UUID,
    defaultValue: DataTypes.UUIDV4,
    primaryKey: true
  },
  
  email: {
    type: DataTypes.STRING,
    allowNull: false,
    unique: {
      name: 'unique_email',
      msg: 'Email address already in use'
    },
    validate: {
      isEmail: {
        msg: 'Must be a valid email address'
      },
      len: {
        args: [5, 255],
        msg: 'Email must be between 5 and 255 characters'
      },
      // Custom validation
      isNotDisposable(value) {
        const disposableDomains = ['tempmail.com', '10minutemail.com'];
        const domain = value.split('@')[1];
        if (disposableDomains.includes(domain)) {
          throw new Error('Disposable email addresses are not allowed');
        }
      }
    }
  },
  
  username: {
    type: DataTypes.STRING(50),
    allowNull: false,
    unique: {
      name: 'unique_username',
      msg: 'Username already taken'
    },
    validate: {
      len: {
        args: [3, 50],
        msg: 'Username must be between 3 and 50 characters'
      },
      is: {
        args: /^[a-zA-Z0-9_]+$/,
        msg: 'Username can only contain letters, numbers, and underscores'
      },
      notIn: {
        args: [['admin', 'root', 'system', 'null', 'undefined']],
        msg: 'Username is reserved'
      }
    }
  },
  
  password: {
    type: DataTypes.STRING,
    allowNull: false,
    validate: {
      len: {
        args: [8, 255],
        msg: 'Password must be at least 8 characters'
      },
      // Custom password strength validation
      isStrong(value) {
        const strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/;
        if (!strongRegex.test(value)) {
          throw new Error('Password must contain uppercase, lowercase, number, and special character');
        }
      }
    }
  },
  
  age: {
    type: DataTypes.INTEGER,
    allowNull: true,
    validate: {
      min: {
        args: 13,
        msg: 'Must be at least 13 years old'
      },
      max: {
        args: 120,
        msg: 'Age cannot exceed 120'
      },
      isInt: {
        msg: 'Age must be an integer'
      }
    }
  },
  
  phone: {
    type: DataTypes.STRING,
    allowNull: true,
    validate: {
      is: {
        args: /^\+?[\d\s\-$$$$]+$/,
        msg: 'Invalid phone number format'
      },
      len: {
        args: [10, 20],
        msg: 'Phone number must be between 10 and 20 characters'
      }
    }
  },
  
  role: {
    type: DataTypes.ENUM('user', 'admin', 'moderator'),
    defaultValue: 'user',
    allowNull: false,
    validate: {
      isIn: {
        args: [['user', 'admin', 'moderator']],
        msg: 'Invalid role'
      }
    }
  },
  
  status: {
    type: DataTypes.ENUM('active', 'inactive', 'suspended', 'pending'),
    defaultValue: 'pending',
    allowNull: false
  },
  
  profileData: {
    type: DataTypes.JSONB, // PostgreSQL JSON with indexing
    allowNull: true,
    validate: {
      // Custom JSON validation
      isValidProfile(value) {
        if (value) {
          const requiredFields = ['firstName', 'lastName'];
          const missingFields = requiredFields.filter(field =&gt; !value[field]);
          
          if (missingFields.length &gt; 0) {
            throw new Error(`Missing required profile fields: ${missingFields.join(', ')}`);
          }
          
          if (value.firstName && value.firstName.length &lt; 2) {
            throw new Error('First name must be at least 2 characters');
          }
          
          if (value.lastName && value.lastName.length &lt; 2) {
            throw new Error('Last name must be at least 2 characters');
          }
        }
      }
    }
  },
  
  createdAt: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW,
    allowNull: false
  },
  
  updatedAt: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW,
    allowNull: false
  }
}, {
  // Model-level validations
  validate: {
    // Cross-field validation
    adminMustHaveEmail() {
      if (this.role === 'admin' && !this.email) {
        throw new Error('Admin users must have an email address');
      }
    },
    
    // Conditional validation
    phoneRequiredForModerators() {
      if (this.role === 'moderator' && !this.phone) {
        throw new Error('Moderators must provide a phone number');
      }
    }
  },
  
  // Hooks for additional validation
  hooks: {
    beforeValidate: (user, options) =&gt; {
      // Normalize email
      if (user.email) {
        user.email = user.email.toLowerCase().trim();
      }
      
      // Normalize username
      if (user.username) {
        user.username = user.username.toLowerCase().trim();
      }
    },
    
    beforeCreate: async (user, options) =&gt; {
      // Check for duplicate email with different case
      const existingUser = await User.findOne({
        where: {
          email: {
            [Op.iLike]: user.email // Case-insensitive search
          }
        }
      });
      
      if (existingUser) {
        throw new Error('Email address already in use');
      }
    },
    
    beforeUpdate: async (user, options) =&gt; {
      // Prevent role changes for certain users
      if (user.changed('role') && user.previous('role') === 'admin') {
        const adminCount = await User.count({ where: { role: 'admin' } });
        if (adminCount &lt;= 1) {
          throw new Error('Cannot remove the last admin user');
        }
      }
    }
  },
  
  indexes: [
    {
      unique: true,
      fields: ['email']
    },
    {
      unique: true,
      fields: ['username']
    },
    {
      fields: ['role', 'status']
    },
    {
      fields: ['createdAt']
    }
  ]
});

// Post model with relationships and validation
const Post = sequelize.define('Post', {
  id: {
    type: DataTypes.UUID,
    defaultValue: DataTypes.UUIDV4,
    primaryKey: true
  },
  
  title: {
    type: DataTypes.STRING(200),
    allowNull: false,
    validate: {
      len: {
        args: [5, 200],
        msg: 'Title must be between 5 and 200 characters'
      },
      notEmpty: {
        msg: 'Title cannot be empty'
      }
    }
  },
  
  content: {
    type: DataTypes.TEXT,
    allowNull: false,
    validate: {
      len: {
        args: [10, 10000],
        msg: 'Content must be between 10 and 10000 characters'
      }
    }
  },
  
  status: {
    type: DataTypes.ENUM('draft', 'published', 'archived'),
    defaultValue: 'draft',
    allowNull: false
  },
  
  publishedAt: {
    type: DataTypes.DATE,
    allowNull: true,
    validate: {
      isDate: {
        msg: 'Published date must be a valid date'
      },
      // Custom validation for publish date
      isValidPublishDate(value) {
        if (value && this.status === 'published' && new Date(value) &gt; new Date()) {
          throw new Error('Published date cannot be in the future');
        }
      }
    }
  },
  
  userId: {
    type: DataTypes.UUID,
    allowNull: false,
    references: {
      model: User,
      key: 'id'
    },
    onDelete: 'CASCADE',
    onUpdate: 'CASCADE'
  }
}, {
  validate: {
    // Model-level validation
    publishedPostMustHaveDate() {
      if (this.status === 'published' && !this.publishedAt) {
        throw new Error('Published posts must have a published date');
      }
    }
  },
  
  hooks: {
    beforeSave: (post, options) =&gt; {
      // Auto-set published date when status changes to published
      if (post.status === 'published' && !post.publishedAt) {
        post.publishedAt = new Date();
      }
      
      // Clear published date when status changes from published
      if (post.status !== 'published' && post.publishedAt) {
        post.publishedAt = null;
      }
    }
  }
});

// Define associations
User.hasMany(Post, { foreignKey: 'userId', as: 'posts' });
Post.belongsTo(User, { foreignKey: 'userId', as: 'author' });

// Custom validation functions
const customValidations = {
  // Async validation example
  isUniqueSlug: async (slug, postId = null) =&gt; {
    const whereClause = { slug };
    if (postId) {
      whereClause.id = { [Op.ne]: postId };
    }
    
    const existingPost = await Post.findOne({ where: whereClause });
    if (existingPost) {
      throw new Error('Slug must be unique');
    }
  },
  
  // Complex business rule validation
  canUserCreatePost: async (userId) =&gt; {
    const user = await User.findByPk(userId);
    if (!user) {
      throw new Error('User not found');
    }
    
    if (user.status !== 'active') {
      throw new Error('Only active users can create posts');
    }
    
    // Check post limit for regular users
    if (user.role === 'user') {
      const postCount = await Post.count({ 
        where: { 
          userId,
          createdAt: {
            [Op.gte]: new Date(Date.now() - 24 * 60 * 60 * 1000) // Last 24 hours
          }
        }
      });
      
      if (postCount &gt;= 5) {
        throw new Error('Daily post limit exceeded');
      }
    }
  }
};

// Database constraints using raw SQL (for complex constraints)
const addDatabaseConstraints = async () =&gt; {
  // Check constraint for age validation
  await sequelize.query(`
    ALTER TABLE "Users" 
    ADD CONSTRAINT check_age_range 
    CHECK (age IS NULL OR (age &gt;= 13 AND age &lt;= 120))
  `);
  
  // Check constraint for email format
  await sequelize.query(`
    ALTER TABLE "Users" 
    ADD CONSTRAINT check_email_format 
    CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$')
  `);
  
  // Partial unique index (PostgreSQL specific)
  await sequelize.query(`
    CREATE UNIQUE INDEX unique_active_username 
    ON "Users" (username) 
    WHERE status = 'active'
  `);
};

// Validation middleware for Express routes
const validateUserData = async (req, res, next) =&gt; {
  try {
    const userData = req.body;
    
    // Build user instance for validation without saving
    const user = User.build(userData);
    
    // Run validations
    await user.validate();
    
    // Run custom validations
    if (userData.role === 'admin') {
      await customValidations.canUserCreatePost(userData.id);
    }
    
    next();
  } catch (error) {
    if (error.name === 'SequelizeValidationError') {
      const validationErrors = error.errors.map(err =&gt; ({
        field: err.path,
        message: err.message,
        value: err.value
      }));
      
      return res.status(400).json({
        error: 'Validation failed',
        details: validationErrors
      });
    }
    
    res.status(400).json({ error: error.message });
  }
};

// Usage in routes
app.post('/users', validateUserData, async (req, res) =&gt; {
  try {
    const user = await User.create(req.body);
    res.status(201).json(user);
  } catch (error) {
    if (error.name === 'SequelizeUniqueConstraintError') {
      return res.status(400).json({
        error: 'Duplicate entry',
        field: error.errors[0].path
      });
    }
    
    res.status(500).json({ error: error.message });
  }
});

// Transaction-based validation
app.post('/posts', authenticateToken, async (req, res) =&gt; {
  const transaction = await sequelize.transaction();
  
  try {
    // Validate user can create post
    await customValidations.canUserCreatePost(req.user.id);
    
    // Create post within transaction
    const post = await Post.create({
      ...req.body,
      userId: req.user.id
    }, { transaction });
    
    await transaction.commit();
    res.status(201).json(post);
  } catch (error) {
    await transaction.rollback();
    res.status(400).json({ error: error.message });
  }
});

module.exports = {
  User,
  Post,
  customValidations,
  validateUserData
};
</code></pre>
</div>

<h3 id="190-how-do-you-implement-proper-error-handling-and-logging-for-security-events-">190. How do you implement proper error handling and logging for security events?</h3>

<p><strong>Answer:</strong> Security event logging and error handling are critical for detecting attacks, debugging security issues, and maintaining audit trails.</p>

<p><strong>Security Event Logging Implementation:</strong></p>


<div class="code-container">
    <div class="code-header">
        <span class="code-language">javascript</span>
        <button class="copy-btn" data-code="const%20winston%20%3D%20require('winston')%3B%0Aconst%20crypto%20%3D%20require('crypto')%3B%0A%0A%2F%2F%20Security-focused%20logger%20configuration%0Aconst%20securityLogger%20%3D%20winston.createLogger(%7B%0A%20%20level%3A%20'info'%2C%0A%20%20format%3A%20winston.format.combine(%0A%20%20%20%20winston.format.timestamp()%2C%0A%20%20%20%20winston.format.errors(%7B%20stack%3A%20true%20%7D)%2C%0A%20%20%20%20winston.format.json()%2C%0A%20%20%20%20winston.format.printf((%7B%20timestamp%2C%20level%2C%20message%2C%20...meta%20%7D)%20%3D%3E%20%7B%0A%20%20%20%20%20%20return%20JSON.stringify(%7B%0A%20%20%20%20%20%20%20%20timestamp%2C%0A%20%20%20%20%20%20%20%20level%2C%0A%20%20%20%20%20%20%20%20message%2C%0A%20%20%20%20%20%20%20%20...meta%2C%0A%20%20%20%20%20%20%20%20severity%3A%20getSeverityLevel(level%2C%20meta.event)%2C%0A%20%20%20%20%20%20%20%20hash%3A%20generateEventHash(message%2C%20meta)%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%0A%20%20)%2C%0A%20%20transports%3A%20%5B%0A%20%20%20%20%2F%2F%20Security%20events%20log%0A%20%20%20%20new%20winston.transports.File(%7B%0A%20%20%20%20%20%20filename%3A%20'logs%2Fsecurity.log'%2C%0A%20%20%20%20%20%20level%3A%20'warn'%2C%0A%20%20%20%20%20%20maxsize%3A%2010485760%2C%20%2F%2F%2010MB%0A%20%20%20%20%20%20maxFiles%3A%2020%0A%20%20%20%20%7D)%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20All%20security%20events%20(including%20info)%0A%20%20%20%20new%20winston.transports.File(%7B%0A%20%20%20%20%20%20filename%3A%20'logs%2Fsecurity-all.log'%2C%0A%20%20%20%20%20%20maxsize%3A%2010485760%2C%0A%20%20%20%20%20%20maxFiles%3A%2010%0A%20%20%20%20%7D)%2C%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Critical%20security%20events%0A%20%20%20%20new%20winston.transports.File(%7B%0A%20%20%20%20%20%20filename%3A%20'logs%2Fsecurity-critical.log'%2C%0A%20%20%20%20%20%20level%3A%20'error'%2C%0A%20%20%20%20%20%20maxsize%3A%205242880%2C%20%2F%2F%205MB%0A%20%20%20%20%20%20maxFiles%3A%2050%0A%20%20%20%20%7D)%0A%20%20%5D%0A%7D)%3B%0A%0A%2F%2F%20Generate%20hash%20for%20event%20integrity%0Aconst%20generateEventHash%20%3D%20(message%2C%20meta)%20%3D%3E%20%7B%0A%20%20const%20data%20%3D%20JSON.stringify(%7B%20message%2C%20...meta%20%7D)%3B%0A%20%20return%20crypto.createHash('sha256').update(data).digest('hex').substring(0%2C%2016)%3B%0A%7D%3B%0A%0A%2F%2F%20Determine%20severity%20level%0Aconst%20getSeverityLevel%20%3D%20(level%2C%20event)%20%3D%3E%20%7B%0A%20%20const%20criticalEvents%20%3D%20%5B%0A%20%20%20%20'sql_injection_attempt'%2C%0A%20%20%20%20'xss_attempt'%2C%0A%20%20%20%20'brute_force_attack'%2C%0A%20%20%20%20'privilege_escalation'%2C%0A%20%20%20%20'data_breach_attempt'%0A%20%20%5D%3B%0A%20%20%0A%20%20const%20highEvents%20%3D%20%5B%0A%20%20%20%20'multiple_failed_logins'%2C%0A%20%20%20%20'suspicious_file_upload'%2C%0A%20%20%20%20'rate_limit_exceeded'%2C%0A%20%20%20%20'unauthorized_access_attempt'%0A%20%20%5D%3B%0A%20%20%0A%20%20if%20(level%20%3D%3D%3D%20'error'%20%7C%7C%20criticalEvents.includes(event))%20return%20'CRITICAL'%3B%0A%20%20if%20(level%20%3D%3D%3D%20'warn'%20%7C%7C%20highEvents.includes(event))%20return%20'HIGH'%3B%0A%20%20if%20(level%20%3D%3D%3D%20'info')%20return%20'MEDIUM'%3B%0A%20%20return%20'LOW'%3B%0A%7D%3B%0A%0A%2F%2F%20Security%20event%20types%20and%20handlers%0Aconst%20SecurityEvents%20%3D%20%7B%0A%20%20%2F%2F%20Authentication%20events%0A%20%20LOGIN_SUCCESS%3A%20'login_success'%2C%0A%20%20LOGIN_FAILURE%3A%20'login_failure'%2C%0A%20%20LOGOUT%3A%20'logout'%2C%0A%20%20PASSWORD_CHANGE%3A%20'password_change'%2C%0A%20%20ACCOUNT_LOCKED%3A%20'account_locked'%2C%0A%20%20%0A%20%20%2F%2F%20Authorization%20events%0A%20%20UNAUTHORIZED_ACCESS%3A%20'unauthorized_access'%2C%0A%20%20PRIVILEGE_ESCALATION%3A%20'privilege_escalation'%2C%0A%20%20PERMISSION_DENIED%3A%20'permission_denied'%2C%0A%20%20%0A%20%20%2F%2F%20Attack%20attempts%0A%20%20SQL_INJECTION%3A%20'sql_injection_attempt'%2C%0A%20%20XSS_ATTEMPT%3A%20'xss_attempt'%2C%0A%20%20CSRF_ATTEMPT%3A%20'csrf_attempt'%2C%0A%20%20BRUTE_FORCE%3A%20'brute_force_attack'%2C%0A%20%20%0A%20%20%2F%2F%20System%20events%0A%20%20RATE_LIMIT_EXCEEDED%3A%20'rate_limit_exceeded'%2C%0A%20%20SUSPICIOUS_ACTIVITY%3A%20'suspicious_activity'%2C%0A%20%20DATA_BREACH_ATTEMPT%3A%20'data_breach_attempt'%2C%0A%20%20FILE_UPLOAD_VIOLATION%3A%20'file_upload_violation'%0A%7D%3B%0A%0A%2F%2F%20Security%20event%20logger%20class%0Aclass%20SecurityEventLogger%20%7B%0A%20%20static%20logEvent(event%2C%20details%20%3D%20%7B%7D%2C%20req%20%3D%20null)%20%7B%0A%20%20%20%20const%20eventData%20%3D%20%7B%0A%20%20%20%20%20%20event%2C%0A%20%20%20%20%20%20timestamp%3A%20new%20Date().toISOString()%2C%0A%20%20%20%20%20%20...details%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Add%20request%20context%20if%20available%0A%20%20%20%20if%20(req)%20%7B%0A%20%20%20%20%20%20eventData.request%20%3D%20%7B%0A%20%20%20%20%20%20%20%20ip%3A%20req.ip%2C%0A%20%20%20%20%20%20%20%20userAgent%3A%20req.get('User-Agent')%2C%0A%20%20%20%20%20%20%20%20method%3A%20req.method%2C%0A%20%20%20%20%20%20%20%20url%3A%20req.originalUrl%2C%0A%20%20%20%20%20%20%20%20correlationId%3A%20req.correlationId%2C%0A%20%20%20%20%20%20%20%20userId%3A%20req.user%3F.id%2C%0A%20%20%20%20%20%20%20%20sessionId%3A%20req.sessionID%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Log%20based%20on%20severity%0A%20%20%20%20const%20severity%20%3D%20getSeverityLevel('info'%2C%20event)%3B%0A%20%20%20%20%0A%20%20%20%20switch%20(severity)%20%7B%0A%20%20%20%20%20%20case%20'CRITICAL'%3A%0A%20%20%20%20%20%20%20%20securityLogger.error(%60Security%20Event%3A%20%24%7Bevent%7D%60%2C%20eventData)%3B%0A%20%20%20%20%20%20%20%20this.alertSecurityTeam(event%2C%20eventData)%3B%0A%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20case%20'HIGH'%3A%0A%20%20%20%20%20%20%20%20securityLogger.warn(%60Security%20Event%3A%20%24%7Bevent%7D%60%2C%20eventData)%3B%0A%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20default%3A%0A%20%20%20%20%20%20%20%20securityLogger.info(%60Security%20Event%3A%20%24%7Bevent%7D%60%2C%20eventData)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Store%20in%20database%20for%20analysis%0A%20%20%20%20this.storeSecurityEvent(eventData)%3B%0A%20%20%7D%0A%20%20%0A%20%20static%20alertSecurityTeam(event%2C%20data)%20%7B%0A%20%20%20%20%2F%2F%20Send%20immediate%20alerts%20for%20critical%20events%0A%20%20%20%20console.error(%60CRITICAL%20SECURITY%20EVENT%3A%20%24%7Bevent%7D%60%2C%20data)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20In%20production%2C%20integrate%20with%3A%0A%20%20%20%20%2F%2F%20-%20Slack%2FTeams%20notifications%0A%20%20%20%20%2F%2F%20-%20Email%20alerts%0A%20%20%20%20%2F%2F%20-%20SMS%20alerts%0A%20%20%20%20%2F%2F%20-%20Security%20incident%20management%20systems%0A%20%20%7D%0A%20%20%0A%20%20static%20async%20storeSecurityEvent(eventData)%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%2F%2F%20Store%20in%20database%20for%20analysis%20and%20reporting%0A%20%20%20%20%20%20await%20SecurityEvent.create(%7B%0A%20%20%20%20%20%20%20%20event%3A%20eventData.event%2C%0A%20%20%20%20%20%20%20%20severity%3A%20eventData.severity%2C%0A%20%20%20%20%20%20%20%20details%3A%20eventData%2C%0A%20%20%20%20%20%20%20%20ipAddress%3A%20eventData.request%3F.ip%2C%0A%20%20%20%20%20%20%20%20userId%3A%20eventData.request%3F.userId%2C%0A%20%20%20%20%20%20%20%20timestamp%3A%20new%20Date(eventData.timestamp)%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20console.error('Failed%20to%20store%20security%20event%3A'%2C%20error)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Specific%20event%20logging%20methods%0A%20%20static%20logLoginAttempt(email%2C%20success%2C%20req%2C%20additionalInfo%20%3D%20%7B%7D)%20%7B%0A%20%20%20%20this.logEvent(%0A%20%20%20%20%20%20success%20%3F%20SecurityEvents.LOGIN_SUCCESS%20%3A%20SecurityEvents.LOGIN_FAILURE%2C%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20email%2C%0A%20%20%20%20%20%20%20%20success%2C%0A%20%20%20%20%20%20%20%20...additionalInfo%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20req%0A%20%20%20%20)%3B%0A%20%20%7D%0A%20%20%0A%20%20static%20logUnauthorizedAccess(resource%2C%20req%2C%20reason%20%3D%20'')%20%7B%0A%20%20%20%20this.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS%2C%20%7B%0A%20%20%20%20%20%20resource%2C%0A%20%20%20%20%20%20reason%2C%0A%20%20%20%20%20%20severity%3A%20'HIGH'%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%7D%0A%20%20%0A%20%20static%20logSuspiciousActivity(activity%2C%20details%2C%20req)%20%7B%0A%20%20%20%20this.logEvent(SecurityEvents.SUSPICIOUS_ACTIVITY%2C%20%7B%0A%20%20%20%20%20%20activity%2C%0A%20%20%20%20%20%20details%2C%0A%20%20%20%20%20%20riskScore%3A%20this.calculateRiskScore(activity%2C%20details)%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%7D%0A%20%20%0A%20%20static%20calculateRiskScore(activity%2C%20details)%20%7B%0A%20%20%20%20%2F%2F%20Simple%20risk%20scoring%20algorithm%0A%20%20%20%20let%20score%20%3D%200%3B%0A%20%20%20%20%0A%20%20%20%20if%20(activity.includes('injection'))%20score%20%2B%3D%2090%3B%0A%20%20%20%20if%20(activity.includes('xss'))%20score%20%2B%3D%2080%3B%0A%20%20%20%20if%20(activity.includes('brute_force'))%20score%20%2B%3D%2070%3B%0A%20%20%20%20if%20(details.attemptCount%20%3E%205)%20score%20%2B%3D%2030%3B%0A%20%20%20%20if%20(details.fromTor)%20score%20%2B%3D%2040%3B%0A%20%20%20%20%0A%20%20%20%20return%20Math.min(score%2C%20100)%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20Security%20middleware%20with%20comprehensive%20error%20handling%0Aconst%20securityErrorHandler%20%3D%20(err%2C%20req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%2F%2F%20Log%20security-related%20errors%0A%20%20if%20(err.name%20%3D%3D%3D%20'UnauthorizedError')%20%7B%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS%2C%20%7B%0A%20%20%20%20%20%20error%3A%20err.message%2C%0A%20%20%20%20%20%20token%3A%20req.headers.authorization%20%3F%20'present'%20%3A%20'missing'%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%7D%0A%20%20%0A%20%20if%20(err.name%20%3D%3D%3D%20'ValidationError')%20%7B%0A%20%20%20%20%2F%2F%20Check%20for%20potential%20injection%20attempts%0A%20%20%20%20const%20suspiciousPatterns%20%3D%20%5B%0A%20%20%20%20%20%20%2Funion%5Cs%2Bselect%2Fi%2C%0A%20%20%20%20%20%20%2F%3Cscript%2Fi%2C%0A%20%20%20%20%20%20%2Fjavascript%3A%2Fi%2C%0A%20%20%20%20%20%20%2Fon%5Cw%2B%5Cs*%3D%2Fi%0A%20%20%20%20%5D%3B%0A%20%20%20%20%0A%20%20%20%20const%20inputValues%20%3D%20Object.values(req.body%20%7C%7C%20%7B%7D).join('%20')%3B%0A%20%20%20%20const%20hasSuspiciousContent%20%3D%20suspiciousPatterns.some(pattern%20%3D%3E%20%0A%20%20%20%20%20%20pattern.test(inputValues)%0A%20%20%20%20)%3B%0A%20%20%20%20%0A%20%20%20%20if%20(hasSuspiciousContent)%20%7B%0A%20%20%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.SQL_INJECTION%2C%20%7B%0A%20%20%20%20%20%20%20%20suspiciousInput%3A%20inputValues.substring(0%2C%20200)%2C%0A%20%20%20%20%20%20%20%20validationError%3A%20err.message%0A%20%20%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Handle%20rate%20limiting%20errors%0A%20%20if%20(err.status%20%3D%3D%3D%20429)%20%7B%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.RATE_LIMIT_EXCEEDED%2C%20%7B%0A%20%20%20%20%20%20limit%3A%20err.limit%2C%0A%20%20%20%20%20%20current%3A%20err.current%2C%0A%20%20%20%20%20%20resetTime%3A%20err.resetTime%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Don't%20expose%20sensitive%20error%20information%0A%20%20if%20(process.env.NODE_ENV%20%3D%3D%3D%20'production')%20%7B%0A%20%20%20%20res.status(err.status%20%7C%7C%20500).json(%7B%0A%20%20%20%20%20%20error%3A%20'An%20error%20occurred'%2C%0A%20%20%20%20%20%20correlationId%3A%20req.correlationId%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20res.status(err.status%20%7C%7C%20500).json(%7B%0A%20%20%20%20%20%20error%3A%20err.message%2C%0A%20%20%20%20%20%20stack%3A%20err.stack%2C%0A%20%20%20%20%20%20correlationId%3A%20req.correlationId%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Authentication%20security%20middleware%0Aconst%20authSecurityMiddleware%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20token%20%3D%20req.headers.authorization%3F.split('%20')%5B1%5D%3B%0A%20%20%0A%20%20if%20(!token)%20%7B%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS%2C%20%7B%0A%20%20%20%20%20%20reason%3A%20'No%20token%20provided'%2C%0A%20%20%20%20%20%20endpoint%3A%20req.originalUrl%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20return%20res.status(401).json(%7B%20error%3A%20'Access%20token%20required'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20try%20%7B%0A%20%20%20%20const%20decoded%20%3D%20jwt.verify(token%2C%20process.env.JWT_SECRET)%3B%0A%20%20%20%20req.user%20%3D%20decoded%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Log%20successful%20authentication%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.LOGIN_SUCCESS%2C%20%7B%0A%20%20%20%20%20%20userId%3A%20decoded.id%2C%0A%20%20%20%20%20%20tokenType%3A%20'JWT'%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%0A%20%20%20%20next()%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS%2C%20%7B%0A%20%20%20%20%20%20reason%3A%20'Invalid%20token'%2C%0A%20%20%20%20%20%20error%3A%20error.message%2C%0A%20%20%20%20%20%20tokenPresent%3A%20true%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%0A%20%20%20%20res.status(403).json(%7B%20error%3A%20'Invalid%20token'%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%0A%2F%2F%20Input%20validation%20with%20security%20logging%0Aconst%20secureInputValidation%20%3D%20(schema)%20%3D%3E%20%7B%0A%20%20return%20async%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20await%20schema.validate(req.body)%3B%0A%20%20%20%20%20%20next()%3B%0A%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Check%20for%20potential%20attack%20patterns%0A%20%20%20%20%20%20const%20inputString%20%3D%20JSON.stringify(req.body)%3B%0A%20%20%20%20%20%20const%20attackPatterns%20%3D%20%7B%0A%20%20%20%20%20%20%20%20sqlInjection%3A%20%2F(%5Cbunion%5Cb%7C%5Cbselect%5Cb%7C%5Cbinsert%5Cb%7C%5Cbdelete%5Cb%7C%5Cbdrop%5Cb)%2Fi%2C%0A%20%20%20%20%20%20%20%20xss%3A%20%2F(%3Cscript%7Cjavascript%3A%7Con%5Cw%2B%5Cs*%3D)%2Fi%2C%0A%20%20%20%20%20%20%20%20pathTraversal%3A%20%2F(%5C.%5C.%5C%2F%7C%5C.%5C.%5C%5C)%2F%2C%0A%20%20%20%20%20%20%20%20commandInjection%3A%20%2F(%5Cb(cat%7Cls%7Cpwd%7Cwhoami%7Cid%7Cuname)%5Cb%7C%5C%7C%7C%3B%7C%60)%2Fi%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20for%20(const%20%5BattackType%2C%20pattern%5D%20of%20Object.entries(attackPatterns))%20%7B%0A%20%20%20%20%20%20%20%20if%20(pattern.test(inputString))%20%7B%0A%20%20%20%20%20%20%20%20%20%20SecurityEventLogger.logEvent(%0A%20%20%20%20%20%20%20%20%20%20%20%20attackType%20%3D%3D%3D%20'sqlInjection'%20%3F%20SecurityEvents.SQL_INJECTION%20%3A%20SecurityEvents.XSS_ATTEMPT%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20attackType%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20suspiciousInput%3A%20inputString.substring(0%2C%20500)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20validationError%3A%20error.message%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20req%0A%20%20%20%20%20%20%20%20%20%20)%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20res.status(400).json(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'Validation%20failed'%2C%0A%20%20%20%20%20%20%20%20details%3A%20error.errors%20%7C%7C%20error.message%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%20File%20upload%20security%20with%20logging%0Aconst%20secureFileUpload%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20if%20(!req.file)%20return%20next()%3B%0A%20%20%0A%20%20const%20file%20%3D%20req.file%3B%0A%20%20const%20suspiciousExtensions%20%3D%20%5B'.exe'%2C%20'.bat'%2C%20'.cmd'%2C%20'.scr'%2C%20'.pif'%2C%20'.com'%5D%3B%0A%20%20const%20fileExtension%20%3D%20path.extname(file.originalname).toLowerCase()%3B%0A%20%20%0A%20%20%2F%2F%20Check%20for%20suspicious%20file%20types%0A%20%20if%20(suspiciousExtensions.includes(fileExtension))%20%7B%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.FILE_UPLOAD_VIOLATION%2C%20%7B%0A%20%20%20%20%20%20filename%3A%20file.originalname%2C%0A%20%20%20%20%20%20extension%3A%20fileExtension%2C%0A%20%20%20%20%20%20mimetype%3A%20file.mimetype%2C%0A%20%20%20%20%20%20size%3A%20file.size%2C%0A%20%20%20%20%20%20reason%3A%20'Suspicious%20file%20extension'%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Delete%20uploaded%20file%0A%20%20%20%20fs.unlinkSync(file.path)%3B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'File%20type%20not%20allowed'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Check%20file%20size%20limits%0A%20%20if%20(file.size%20%3E%2010%20*%201024%20*%201024)%20%7B%20%2F%2F%2010MB%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.FILE_UPLOAD_VIOLATION%2C%20%7B%0A%20%20%20%20%20%20filename%3A%20file.originalname%2C%0A%20%20%20%20%20%20size%3A%20file.size%2C%0A%20%20%20%20%20%20reason%3A%20'File%20too%20large'%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%0A%20%20%20%20fs.unlinkSync(file.path)%3B%0A%20%20%20%20return%20res.status(400).json(%7B%20error%3A%20'File%20too%20large'%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Brute%20force%20protection%20with%20logging%0Aconst%20bruteForceProtection%20%3D%20new%20Map()%3B%0A%0Aconst%20checkBruteForce%20%3D%20(req%2C%20res%2C%20next)%20%3D%3E%20%7B%0A%20%20const%20key%20%3D%20req.ip%3B%0A%20%20const%20now%20%3D%20Date.now()%3B%0A%20%20const%20windowMs%20%3D%2015%20*%2060%20*%201000%3B%20%2F%2F%2015%20minutes%0A%20%20const%20maxAttempts%20%3D%205%3B%0A%20%20%0A%20%20if%20(!bruteForceProtection.has(key))%20%7B%0A%20%20%20%20bruteForceProtection.set(key%2C%20%7B%20attempts%3A%200%2C%20resetTime%3A%20now%20%2B%20windowMs%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20const%20record%20%3D%20bruteForceProtection.get(key)%3B%0A%20%20%0A%20%20if%20(now%20%3E%20record.resetTime)%20%7B%0A%20%20%20%20record.attempts%20%3D%200%3B%0A%20%20%20%20record.resetTime%20%3D%20now%20%2B%20windowMs%3B%0A%20%20%7D%0A%20%20%0A%20%20if%20(record.attempts%20%3E%3D%20maxAttempts)%20%7B%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.BRUTE_FORCE%2C%20%7B%0A%20%20%20%20%20%20attempts%3A%20record.attempts%2C%0A%20%20%20%20%20%20windowMs%2C%0A%20%20%20%20%20%20blocked%3A%20true%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%0A%20%20%20%20return%20res.status(429).json(%7B%0A%20%20%20%20%20%20error%3A%20'Too%20many%20attempts'%2C%0A%20%20%20%20%20%20retryAfter%3A%20Math.ceil((record.resetTime%20-%20now)%20%2F%201000)%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%20%20%0A%20%20%2F%2F%20Increment%20attempts%20on%20failed%20login%0A%20%20res.on('finish'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20if%20(res.statusCode%20%3D%3D%3D%20401)%20%7B%0A%20%20%20%20%20%20record.attempts%2B%2B%3B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20if%20(record.attempts%20%3E%3D%20maxAttempts)%20%7B%0A%20%20%20%20%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.BRUTE_FORCE%2C%20%7B%0A%20%20%20%20%20%20%20%20%20%20attempts%3A%20record.attempts%2C%0A%20%20%20%20%20%20%20%20%20%20threshold%3A%20maxAttempts%2C%0A%20%20%20%20%20%20%20%20%20%20blocked%3A%20true%0A%20%20%20%20%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%20%20%0A%20%20next()%3B%0A%7D%3B%0A%0A%2F%2F%20Security%20monitoring%20dashboard%20endpoint%0Aapp.get('%2Fadmin%2Fsecurity-events'%2C%20authenticateToken%2C%20requireRole(%5B'admin'%5D)%2C%20async%20(req%2C%20res)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20const%20%7B%20startDate%2C%20endDate%2C%20event%2C%20severity%20%7D%20%3D%20req.query%3B%0A%20%20%20%20%0A%20%20%20%20const%20whereClause%20%3D%20%7B%7D%3B%0A%20%20%20%20%0A%20%20%20%20if%20(startDate%20%26%26%20endDate)%20%7B%0A%20%20%20%20%20%20whereClause.timestamp%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%5BOp.between%5D%3A%20%5Bnew%20Date(startDate)%2C%20new%20Date(endDate)%5D%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(event)%20whereClause.event%20%3D%20event%3B%0A%20%20%20%20if%20(severity)%20whereClause.severity%20%3D%20severity%3B%0A%20%20%20%20%0A%20%20%20%20const%20events%20%3D%20await%20SecurityEvent.findAll(%7B%0A%20%20%20%20%20%20where%3A%20whereClause%2C%0A%20%20%20%20%20%20order%3A%20%5B%5B'timestamp'%2C%20'DESC'%5D%5D%2C%0A%20%20%20%20%20%20limit%3A%20100%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20const%20summary%20%3D%20await%20SecurityEvent.findAll(%7B%0A%20%20%20%20%20%20attributes%3A%20%5B%0A%20%20%20%20%20%20%20%20'event'%2C%0A%20%20%20%20%20%20%20%20'severity'%2C%0A%20%20%20%20%20%20%20%20%5Bsequelize.fn('COUNT'%2C%20sequelize.col('id'))%2C%20'count'%5D%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20where%3A%20whereClause%2C%0A%20%20%20%20%20%20group%3A%20%5B'event'%2C%20'severity'%5D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%0A%20%20%20%20res.json(%7B%0A%20%20%20%20%20%20events%2C%0A%20%20%20%20%20%20summary%2C%0A%20%20%20%20%20%20totalCount%3A%20events.length%0A%20%20%20%20%7D)%3B%0A%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS%2C%20%7B%0A%20%20%20%20%20%20resource%3A%20'security-events'%2C%0A%20%20%20%20%20%20error%3A%20error.message%0A%20%20%20%20%7D%2C%20req)%3B%0A%20%20%20%20%0A%20%20%20%20res.status(500).json(%7B%20error%3A%20'Failed%20to%20retrieve%20security%20events'%20%7D)%3B%0A%20%20%7D%0A%7D)%3B%0A%0A%2F%2F%20Apply%20security%20middleware%0Aapp.use(securityErrorHandler)%3B%0Aapp.use('%2Fauth%2Flogin'%2C%20checkBruteForce)%3B%0Aapp.use('%2Fapi'%2C%20authSecurityMiddleware)%3B%0A%0A%2F%2F%20Export%20security%20utilities%0Amodule.exports%20%3D%20%7B%0A%20%20SecurityEventLogger%2C%0A%20%20SecurityEvents%2C%0A%20%20securityErrorHandler%2C%0A%20%20authSecurityMiddleware%2C%0A%20%20secureInputValidation%2C%0A%20%20secureFileUpload%2C%0A%20%20checkBruteForce%0A%7D%3B%0A">Copy</button>
    </div>
    <pre><code class="language-javascript">const winston = require('winston');
const crypto = require('crypto');

// Security-focused logger configuration
const securityLogger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json(),
    winston.format.printf(({ timestamp, level, message, ...meta }) =&gt; {
      return JSON.stringify({
        timestamp,
        level,
        message,
        ...meta,
        severity: getSeverityLevel(level, meta.event),
        hash: generateEventHash(message, meta)
      });
    })
  ),
  transports: [
    // Security events log
    new winston.transports.File({
      filename: 'logs/security.log',
      level: 'warn',
      maxsize: 10485760, // 10MB
      maxFiles: 20
    }),
    
    // All security events (including info)
    new winston.transports.File({
      filename: 'logs/security-all.log',
      maxsize: 10485760,
      maxFiles: 10
    }),
    
    // Critical security events
    new winston.transports.File({
      filename: 'logs/security-critical.log',
      level: 'error',
      maxsize: 5242880, // 5MB
      maxFiles: 50
    })
  ]
});

// Generate hash for event integrity
const generateEventHash = (message, meta) =&gt; {
  const data = JSON.stringify({ message, ...meta });
  return crypto.createHash('sha256').update(data).digest('hex').substring(0, 16);
};

// Determine severity level
const getSeverityLevel = (level, event) =&gt; {
  const criticalEvents = [
    'sql_injection_attempt',
    'xss_attempt',
    'brute_force_attack',
    'privilege_escalation',
    'data_breach_attempt'
  ];
  
  const highEvents = [
    'multiple_failed_logins',
    'suspicious_file_upload',
    'rate_limit_exceeded',
    'unauthorized_access_attempt'
  ];
  
  if (level === 'error' || criticalEvents.includes(event)) return 'CRITICAL';
  if (level === 'warn' || highEvents.includes(event)) return 'HIGH';
  if (level === 'info') return 'MEDIUM';
  return 'LOW';
};

// Security event types and handlers
const SecurityEvents = {
  // Authentication events
  LOGIN_SUCCESS: 'login_success',
  LOGIN_FAILURE: 'login_failure',
  LOGOUT: 'logout',
  PASSWORD_CHANGE: 'password_change',
  ACCOUNT_LOCKED: 'account_locked',
  
  // Authorization events
  UNAUTHORIZED_ACCESS: 'unauthorized_access',
  PRIVILEGE_ESCALATION: 'privilege_escalation',
  PERMISSION_DENIED: 'permission_denied',
  
  // Attack attempts
  SQL_INJECTION: 'sql_injection_attempt',
  XSS_ATTEMPT: 'xss_attempt',
  CSRF_ATTEMPT: 'csrf_attempt',
  BRUTE_FORCE: 'brute_force_attack',
  
  // System events
  RATE_LIMIT_EXCEEDED: 'rate_limit_exceeded',
  SUSPICIOUS_ACTIVITY: 'suspicious_activity',
  DATA_BREACH_ATTEMPT: 'data_breach_attempt',
  FILE_UPLOAD_VIOLATION: 'file_upload_violation'
};

// Security event logger class
class SecurityEventLogger {
  static logEvent(event, details = {}, req = null) {
    const eventData = {
      event,
      timestamp: new Date().toISOString(),
      ...details
    };
    
    // Add request context if available
    if (req) {
      eventData.request = {
        ip: req.ip,
        userAgent: req.get('User-Agent'),
        method: req.method,
        url: req.originalUrl,
        correlationId: req.correlationId,
        userId: req.user?.id,
        sessionId: req.sessionID
      };
    }
    
    // Log based on severity
    const severity = getSeverityLevel('info', event);
    
    switch (severity) {
      case 'CRITICAL':
        securityLogger.error(`Security Event: ${event}`, eventData);
        this.alertSecurityTeam(event, eventData);
        break;
      case 'HIGH':
        securityLogger.warn(`Security Event: ${event}`, eventData);
        break;
      default:
        securityLogger.info(`Security Event: ${event}`, eventData);
    }
    
    // Store in database for analysis
    this.storeSecurityEvent(eventData);
  }
  
  static alertSecurityTeam(event, data) {
    // Send immediate alerts for critical events
    console.error(`CRITICAL SECURITY EVENT: ${event}`, data);
    
    // In production, integrate with:
    // - Slack/Teams notifications
    // - Email alerts
    // - SMS alerts
    // - Security incident management systems
  }
  
  static async storeSecurityEvent(eventData) {
    try {
      // Store in database for analysis and reporting
      await SecurityEvent.create({
        event: eventData.event,
        severity: eventData.severity,
        details: eventData,
        ipAddress: eventData.request?.ip,
        userId: eventData.request?.userId,
        timestamp: new Date(eventData.timestamp)
      });
    } catch (error) {
      console.error('Failed to store security event:', error);
    }
  }
  
  // Specific event logging methods
  static logLoginAttempt(email, success, req, additionalInfo = {}) {
    this.logEvent(
      success ? SecurityEvents.LOGIN_SUCCESS : SecurityEvents.LOGIN_FAILURE,
      {
        email,
        success,
        ...additionalInfo
      },
      req
    );
  }
  
  static logUnauthorizedAccess(resource, req, reason = '') {
    this.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS, {
      resource,
      reason,
      severity: 'HIGH'
    }, req);
  }
  
  static logSuspiciousActivity(activity, details, req) {
    this.logEvent(SecurityEvents.SUSPICIOUS_ACTIVITY, {
      activity,
      details,
      riskScore: this.calculateRiskScore(activity, details)
    }, req);
  }
  
  static calculateRiskScore(activity, details) {
    // Simple risk scoring algorithm
    let score = 0;
    
    if (activity.includes('injection')) score += 90;
    if (activity.includes('xss')) score += 80;
    if (activity.includes('brute_force')) score += 70;
    if (details.attemptCount &gt; 5) score += 30;
    if (details.fromTor) score += 40;
    
    return Math.min(score, 100);
  }
}

// Security middleware with comprehensive error handling
const securityErrorHandler = (err, req, res, next) =&gt; {
  // Log security-related errors
  if (err.name === 'UnauthorizedError') {
    SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS, {
      error: err.message,
      token: req.headers.authorization ? 'present' : 'missing'
    }, req);
  }
  
  if (err.name === 'ValidationError') {
    // Check for potential injection attempts
    const suspiciousPatterns = [
      /union\s+select/i,
      /&lt;script/i,
      /javascript:/i,
      /on\w+\s*=/i
    ];
    
    const inputValues = Object.values(req.body || {}).join(' ');
    const hasSuspiciousContent = suspiciousPatterns.some(pattern =&gt; 
      pattern.test(inputValues)
    );
    
    if (hasSuspiciousContent) {
      SecurityEventLogger.logEvent(SecurityEvents.SQL_INJECTION, {
        suspiciousInput: inputValues.substring(0, 200),
        validationError: err.message
      }, req);
    }
  }
  
  // Handle rate limiting errors
  if (err.status === 429) {
    SecurityEventLogger.logEvent(SecurityEvents.RATE_LIMIT_EXCEEDED, {
      limit: err.limit,
      current: err.current,
      resetTime: err.resetTime
    }, req);
  }
  
  // Don't expose sensitive error information
  if (process.env.NODE_ENV === 'production') {
    res.status(err.status || 500).json({
      error: 'An error occurred',
      correlationId: req.correlationId
    });
  } else {
    res.status(err.status || 500).json({
      error: err.message,
      stack: err.stack,
      correlationId: req.correlationId
    });
  }
};

// Authentication security middleware
const authSecurityMiddleware = (req, res, next) =&gt; {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS, {
      reason: 'No token provided',
      endpoint: req.originalUrl
    }, req);
    return res.status(401).json({ error: 'Access token required' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    
    // Log successful authentication
    SecurityEventLogger.logEvent(SecurityEvents.LOGIN_SUCCESS, {
      userId: decoded.id,
      tokenType: 'JWT'
    }, req);
    
    next();
  } catch (error) {
    SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS, {
      reason: 'Invalid token',
      error: error.message,
      tokenPresent: true
    }, req);
    
    res.status(403).json({ error: 'Invalid token' });
  }
};

// Input validation with security logging
const secureInputValidation = (schema) =&gt; {
  return async (req, res, next) =&gt; {
    try {
      await schema.validate(req.body);
      next();
    } catch (error) {
      // Check for potential attack patterns
      const inputString = JSON.stringify(req.body);
      const attackPatterns = {
        sqlInjection: /(\bunion\b|\bselect\b|\binsert\b|\bdelete\b|\bdrop\b)/i,
        xss: /(&lt;script|javascript:|on\w+\s*=)/i,
        pathTraversal: /(\.\.\/|\.\.\\)/,
        commandInjection: /(\b(cat|ls|pwd|whoami|id|uname)\b|\||;|`)/i
      };
      
      for (const [attackType, pattern] of Object.entries(attackPatterns)) {
        if (pattern.test(inputString)) {
          SecurityEventLogger.logEvent(
            attackType === 'sqlInjection' ? SecurityEvents.SQL_INJECTION : SecurityEvents.XSS_ATTEMPT,
            {
              attackType,
              suspiciousInput: inputString.substring(0, 500),
              validationError: error.message
            },
            req
          );
          break;
        }
      }
      
      res.status(400).json({
        error: 'Validation failed',
        details: error.errors || error.message
      });
    }
  };
};

// File upload security with logging
const secureFileUpload = (req, res, next) =&gt; {
  if (!req.file) return next();
  
  const file = req.file;
  const suspiciousExtensions = ['.exe', '.bat', '.cmd', '.scr', '.pif', '.com'];
  const fileExtension = path.extname(file.originalname).toLowerCase();
  
  // Check for suspicious file types
  if (suspiciousExtensions.includes(fileExtension)) {
    SecurityEventLogger.logEvent(SecurityEvents.FILE_UPLOAD_VIOLATION, {
      filename: file.originalname,
      extension: fileExtension,
      mimetype: file.mimetype,
      size: file.size,
      reason: 'Suspicious file extension'
    }, req);
    
    // Delete uploaded file
    fs.unlinkSync(file.path);
    return res.status(400).json({ error: 'File type not allowed' });
  }
  
  // Check file size limits
  if (file.size &gt; 10 * 1024 * 1024) { // 10MB
    SecurityEventLogger.logEvent(SecurityEvents.FILE_UPLOAD_VIOLATION, {
      filename: file.originalname,
      size: file.size,
      reason: 'File too large'
    }, req);
    
    fs.unlinkSync(file.path);
    return res.status(400).json({ error: 'File too large' });
  }
  
  next();
};

// Brute force protection with logging
const bruteForceProtection = new Map();

const checkBruteForce = (req, res, next) =&gt; {
  const key = req.ip;
  const now = Date.now();
  const windowMs = 15 * 60 * 1000; // 15 minutes
  const maxAttempts = 5;
  
  if (!bruteForceProtection.has(key)) {
    bruteForceProtection.set(key, { attempts: 0, resetTime: now + windowMs });
  }
  
  const record = bruteForceProtection.get(key);
  
  if (now &gt; record.resetTime) {
    record.attempts = 0;
    record.resetTime = now + windowMs;
  }
  
  if (record.attempts &gt;= maxAttempts) {
    SecurityEventLogger.logEvent(SecurityEvents.BRUTE_FORCE, {
      attempts: record.attempts,
      windowMs,
      blocked: true
    }, req);
    
    return res.status(429).json({
      error: 'Too many attempts',
      retryAfter: Math.ceil((record.resetTime - now) / 1000)
    });
  }
  
  // Increment attempts on failed login
  res.on('finish', () =&gt; {
    if (res.statusCode === 401) {
      record.attempts++;
      
      if (record.attempts &gt;= maxAttempts) {
        SecurityEventLogger.logEvent(SecurityEvents.BRUTE_FORCE, {
          attempts: record.attempts,
          threshold: maxAttempts,
          blocked: true
        }, req);
      }
    }
  });
  
  next();
};

// Security monitoring dashboard endpoint
app.get('/admin/security-events', authenticateToken, requireRole(['admin']), async (req, res) =&gt; {
  try {
    const { startDate, endDate, event, severity } = req.query;
    
    const whereClause = {};
    
    if (startDate && endDate) {
      whereClause.timestamp = {
        [Op.between]: [new Date(startDate), new Date(endDate)]
      };
    }
    
    if (event) whereClause.event = event;
    if (severity) whereClause.severity = severity;
    
    const events = await SecurityEvent.findAll({
      where: whereClause,
      order: [['timestamp', 'DESC']],
      limit: 100
    });
    
    const summary = await SecurityEvent.findAll({
      attributes: [
        'event',
        'severity',
        [sequelize.fn('COUNT', sequelize.col('id')), 'count']
      ],
      where: whereClause,
      group: ['event', 'severity']
    });
    
    res.json({
      events,
      summary,
      totalCount: events.length
    });
  } catch (error) {
    SecurityEventLogger.logEvent(SecurityEvents.UNAUTHORIZED_ACCESS, {
      resource: 'security-events',
      error: error.message
    }, req);
    
    res.status(500).json({ error: 'Failed to retrieve security events' });
  }
});

// Apply security middleware
app.use(securityErrorHandler);
app.use('/auth/login', checkBruteForce);
app.use('/api', authSecurityMiddleware);

// Export security utilities
module.exports = {
  SecurityEventLogger,
  SecurityEvents,
  securityErrorHandler,
  authSecurityMiddleware,
  secureInputValidation,
  secureFileUpload,
  checkBruteForce
};
</code></pre>
</div>

            </div>
        </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        
        // Initialize TOC
        document.getElementById('toc-list').innerHTML = `<li><a href="#-fundamentals-20-questions-" class="h2-link">**Fundamentals (20 Questions)**</a></li><li><a href="#131-what-is-express-js-and-why-is-it-used-" class="h3-link" style="padding-left: 1rem;">131. What is Express.js and why is it used?</a></li><li><a href="#132-how-do-you-create-a-basic-express-server-" class="h3-link" style="padding-left: 1rem;">132. How do you create a basic Express server?</a></li><li><a href="#133-what-is-middleware-in-express-js-" class="h3-link" style="padding-left: 1rem;">133. What is middleware in Express.js?</a></li><li><a href="#134-how-does-the-middleware-stack-work-" class="h3-link" style="padding-left: 1rem;">134. How does the middleware stack work?</a></li><li><a href="#135-what-is-the-difference-between-app-use-and-app-get-" class="h3-link" style="padding-left: 1rem;">135. What is the difference between `app.use()`and `app.get()`?</a></li><li><a href="#136-what-are-route-parameters-vs-query-parameters-" class="h3-link" style="padding-left: 1rem;">136. What are route parameters vs query parameters?</a></li><li><a href="#137-how-do-you-handle-different-http-methods-in-express-" class="h3-link" style="padding-left: 1rem;">137. How do you handle different HTTP methods in Express?</a></li><li><a href="#138-what-is-the-purpose-of-the-next-function-" class="h3-link" style="padding-left: 1rem;">138. What is the purpose of the `next()`function?</a></li><li><a href="#139-how-do-you-implement-nested-routing-in-express-" class="h3-link" style="padding-left: 1rem;">139. How do you implement nested routing in Express?</a></li><li><a href="#140-what-are-express-routers-and-how-do-you-use-them-" class="h3-link" style="padding-left: 1rem;">140. What are Express routers and how do you use them?</a></li><li><a href="#141-how-do-you-serve-static-files-in-express-" class="h3-link" style="padding-left: 1rem;">141. How do you serve static files in Express?</a></li><li><a href="#142-what-is-the-purpose-of-express-json-and-express-urlencoded-" class="h3-link" style="padding-left: 1rem;">142. What is the purpose of `express.json()`and `express.urlencoded()`?</a></li><li><a href="#143-how-do-you-set-and-get-response-headers-" class="h3-link" style="padding-left: 1rem;">143. How do you set and get response headers?</a></li><li><a href="#144-what-is-res-locals-used-for-" class="h3-link" style="padding-left: 1rem;">144. What is `res.locals`used for?</a></li><li><a href="#145-how-do-you-handle-cookies-in-express-" class="h3-link" style="padding-left: 1rem;">145. How do you handle cookies in Express?</a></li><li><a href="#146-what-are-template-engines-and-how-do-you-use-them-" class="h3-link" style="padding-left: 1rem;">146. What are template engines and how do you use them?</a></li><li><a href="#147-how-do-you-implement-route-chaining-" class="h3-link" style="padding-left: 1rem;">147. How do you implement route chaining?</a></li><li><a href="#148-what-is-the-significance-of-app-all-" class="h3-link" style="padding-left: 1rem;">148. What is the significance of `app.all()`?</a></li><li><a href="#149-how-do-you-handle-404-errors-in-express-" class="h3-link" style="padding-left: 1rem;">149. How do you handle 404 errors in Express?</a></li><li><a href="#150-what-are-the-best-practices-for-structuring-an-express-application-" class="h3-link" style="padding-left: 1rem;">150. What are the best practices for structuring an Express application?</a></li><li><a href="#-advanced-concepts-20-questions-" class="h2-link">**Advanced Concepts (20 Questions)**</a></li><li><a href="#151-how-do-you-implement-error-handling-middleware-" class="h3-link" style="padding-left: 1rem;">151. How do you implement error handling middleware?</a></li><li><a href="#152-what-is-the-difference-between-synchronous-and-asynchronous-error-handling-" class="h3-link" style="padding-left: 1rem;">152. What is the difference between synchronous and asynchronous error handling?</a></li><li><a href="#153-how-do-you-implement-request-validation-middleware-" class="h3-link" style="padding-left: 1rem;">153. How do you implement request validation middleware?</a></li><li><a href="#154-how-do-you-implement-api-versioning-in-express-" class="h3-link" style="padding-left: 1rem;">154. How do you implement API versioning in Express?</a></li><li><a href="#155-what-is-content-negotiation-and-how-do-you-implement-it-" class="h3-link" style="padding-left: 1rem;">155. What is content negotiation and how do you implement it?</a></li><li><a href="#156-how-do-you-handle-file-uploads-in-express-" class="h3-link" style="padding-left: 1rem;">156. How do you handle file uploads in Express?</a></li><li><a href="#157-what-is-cors-and-how-do-you-configure-it-properly-" class="h3-link" style="padding-left: 1rem;">157. What is CORS and how do you configure it properly?</a></li><li><a href="#158-how-do-you-implement-request-response-compression-" class="h3-link" style="padding-left: 1rem;">158. How do you implement request/response compression?</a></li><li><a href="#159-how-do-you-implement-rate-limiting-in-express-" class="h3-link" style="padding-left: 1rem;">159. How do you implement rate limiting in Express?</a></li><li><a href="#160-what-is-helmet-js-and-why-do-you-use-it-" class="h3-link" style="padding-left: 1rem;">160. What is Helmet.js and why do you use it?</a></li><li><a href="#162-what-is-the-purpose-of-app-param-middleware-" class="h3-link" style="padding-left: 1rem;">162. What is the purpose of `app.param()`middleware?</a></li><li><a href="#163-how-do-you-implement-custom-response-methods-" class="h3-link" style="padding-left: 1rem;">163. How do you implement custom response methods?</a></li><li><a href="#164-how-do-you-handle-different-environments-in-express-" class="h3-link" style="padding-left: 1rem;">164. How do you handle different environments in Express?</a></li><li><a href="#165-what-is-the-difference-between-res-send-res-json-and-res-end-" class="h3-link" style="padding-left: 1rem;">165. What is the difference between `res.send()`, `res.json()`, and `res.end()`?</a></li><li><a href="#166-how-do-you-implement-graceful-shutdown-in-express-" class="h3-link" style="padding-left: 1rem;">166. How do you implement graceful shutdown in Express?</a></li><li><a href="#167-how-do-you-implement-request-timeout-handling-" class="h3-link" style="padding-left: 1rem;">167. How do you implement request timeout handling?</a></li><li><a href="#168-what-are-express-generators-and-how-do-you-use-them-" class="h3-link" style="padding-left: 1rem;">168. What are Express generators and how do you use them?</a></li><li><a href="#169-how-do-you-implement-websocket-support-in-express-" class="h3-link" style="padding-left: 1rem;">169. How do you implement WebSocket support in Express?</a></li><li><a href="#170-how-do-you-implement-server-sent-events-sse-in-express-" class="h3-link" style="padding-left: 1rem;">170. How do you implement server-sent events (SSE) in Express?</a></li><li><a href="#-testing-security-20-questions-" class="h2-link">**Testing & Security (20 Questions)**</a></li><li><a href="#171-how-do-you-write-unit-tests-for-express-routes-" class="h3-link" style="padding-left: 1rem;">171. How do you write unit tests for Express routes?</a></li><li><a href="#172-how-do-you-implement-integration-tests-for-express-apis-" class="h3-link" style="padding-left: 1rem;">172. How do you implement integration tests for Express APIs?</a></li><li><a href="#173-what-are-the-common-security-vulnerabilities-in-express-applications-" class="h3-link" style="padding-left: 1rem;">173. What are the common security vulnerabilities in Express applications?</a></li><li><a href="#174-how-do-you-implement-input-validation-and-sanitization-" class="h3-link" style="padding-left: 1rem;">174. How do you implement input validation and sanitization?</a></li><li><a href="#176-how-do-you-implement-authentication-middleware-" class="h3-link" style="padding-left: 1rem;">176. How do you implement authentication middleware?</a></li><li><a href="#177-how-do-you-implement-authorization-role-based-access-control-" class="h3-link" style="padding-left: 1rem;">177. How do you implement authorization (role-based access control)?</a></li><li><a href="#178-how-do-you-secure-express-applications-against-common-attacks-" class="h3-link" style="padding-left: 1rem;">178. How do you secure Express applications against common attacks?</a></li><li><a href="#179-how-do-you-implement-https-and-ssl-tls-in-express-" class="h3-link" style="padding-left: 1rem;">179. How do you implement HTTPS and SSL/TLS in Express?</a></li><li><a href="#180-how-do-you-implement-session-management-securely-" class="h3-link" style="padding-left: 1rem;">180. How do you implement session management securely?</a></li><li><a href="#181-how-do-you-handle-password-hashing-and-storage-" class="h3-link" style="padding-left: 1rem;">181. How do you handle password hashing and storage?</a></li><li><a href="#182-how-do-you-implement-api-key-authentication-" class="h3-link" style="padding-left: 1rem;">182. How do you implement API key authentication?</a></li><li><a href="#183-how-do-you-implement-oauth-2-0-in-express-" class="h3-link" style="padding-left: 1rem;">183. How do you implement OAuth 2.0 in Express?</a></li><li><a href="#184-how-do-you-implement-jwt-json-web-tokens-authentication-" class="h3-link" style="padding-left: 1rem;">184. How do you implement JWT (JSON Web Tokens) authentication?</a></li><li><a href="#185-how-do-you-test-express-middleware-" class="h3-link" style="padding-left: 1rem;">185. How do you test Express middleware?</a></li><li><a href="#186-how-do-you-implement-security-headers-in-express-" class="h3-link" style="padding-left: 1rem;">186. How do you implement security headers in Express?</a></li><li><a href="#187-how-do-you-handle-file-upload-security-" class="h3-link" style="padding-left: 1rem;">187. How do you handle file upload security?</a></li><li><a href="#188-how-do-you-implement-logging-and-monitoring-in-express-" class="h3-link" style="padding-left: 1rem;">188. How do you implement logging and monitoring in Express?</a></li><li><a href="#189-how-do-you-implement-data-validation-at-the-database-level-" class="h3-link" style="padding-left: 1rem;">189. How do you implement data validation at the database level?</a></li><li><a href="#190-how-do-you-implement-proper-error-handling-and-logging-for-security-events-" class="h3-link" style="padding-left: 1rem;">190. How do you implement proper error handling and logging for security events?</a></li>`;
        
        // Initialize theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        const themeButton = document.getElementById('theme-toggle');
        themeButton.textContent = savedTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
        
        // Set initial theme stylesheets
        const lightTheme = document.getElementById('light-theme');
        const darkTheme = document.getElementById('dark-theme');
        if (savedTheme === 'dark') {
            lightTheme.disabled = true;
            darkTheme.disabled = false;
        } else {
            lightTheme.disabled = false;
            darkTheme.disabled = true;
        }
        
        // Mobile menu functionality
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const isOpen = sidebar.classList.contains('mobile-open');
            
            if (isOpen) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }
        
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const button = document.getElementById('theme-toggle');
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            button.textContent = newTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
            localStorage.setItem('theme', newTheme);
            
            const lightTheme = document.getElementById('light-theme');
            const darkTheme = document.getElementById('dark-theme');
            if (newTheme === 'dark') {
                lightTheme.disabled = true;
                darkTheme.disabled = false;
            } else {
                lightTheme.disabled = false;
                darkTheme.disabled = true;
            }
            
            // Re-highlight code after theme change
            setTimeout(() => {
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            }, 100);
        }
        
        // Copy code functionality
        function copyCode(text, button) {
            // Modern clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    button.textContent = 'Copied!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                        button.textContent = 'Copy';
                        button.style.background = 'var(--accent-color)';
                    }, 2000);
                }).catch(() => {
                    fallbackCopyTextToClipboard(text, button);
                });
            } else {
                fallbackCopyTextToClipboard(text, button);
            }
        }
        
        // Fallback copy function for older browsers
        function fallbackCopyTextToClipboard(text, button) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    button.textContent = 'Copied!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                        button.textContent = 'Copy';
                        button.style.background = 'var(--accent-color)';
                    }, 2000);
                } else {
                    throw new Error('Copy command failed');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                button.textContent = 'Copy failed';
                button.style.background = '#ef4444';
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.style.background = 'var(--accent-color)';
                }, 2000);
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu button
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }
            
            // Theme toggle button
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleTheme);
            }
            
            // Copy buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('copy-btn')) {
                    const encodedCode = e.target.getAttribute('data-code');
                    if (encodedCode) {
                        const code = decodeURIComponent(encodedCode);
                        copyCode(code, e.target);
                    }
                }
            });
            
            // Overlay and TOC link clicks
            const overlay = document.getElementById('mobile-overlay');
            if (overlay) {
                overlay.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                });
            }
            
            // TOC links
            document.addEventListener('click', function(e) {
                if (e.target.matches('.toc a')) {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('mobile-overlay');
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                }
            });
            
            // Highlight code after page load
            setTimeout(() => {
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            }, 500);
        });

        

    </script>
    <script src="../sidebar-fix.js"></script>

</body>
</html>